/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kes√§aika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.DefaultSearchServiceBundleInstance",function(a){this.name="searchservice";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{createPanel:function(){var c=this;var a=c.libs.ext;var b=a.create("Ext.Panel",{region:"center",layout:"fit",height:384,items:[]});return b},start:function(){if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");this.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.searchservice.SearchModule");var a=this.createPanel();var b=this.facade.appendExtensionModule(this.impl,this.name,{},this,"E",{fi:{title:"Haku"},sv:{title:"?"},en:{title:"Haku"}},a);this.def=b;a.add(b.initialisedComponent);this.impl.start(this.facade.getSandbox());this.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this,this.def);this.def=null;this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.DefaultSearchServiceBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});Oskari.clazz.define("Oskari.mapframework.ui.module.searchservice.SearchModule",function(){this._sandbox=null;this.uiItems={}},{__name:"SearchModule",getName:function(){return this.__name},init:function(j){this._sandbox=j;var k=j;var h=this;k.printDebug("[SearchModule] Init");Ext.define("Search",{extend:"Ext.data.Model",fields:["name","village","type",{name:"lat",convert:function(m,l){var n=l.raw.lat;return n}},{name:"lon",convert:function(m,l){var n=l.raw.lon;return n}},{name:"zoomLevel",convert:function(m,l){var n=l.raw.zoomLevel;return n}},{name:"name",convert:function(m,l){var n=l.raw.name;return n}}]});var i=Ext.create("Ext.Button",{id:"search-button",style:"border: 1px solid #9D9D9D;",text:k.getText("rightpanel_search_find_places_button_value"),handler:function(){f()}});this.uiItems.searchButton=i;var c=Ext.create("Ext.Button",{id:"search-clear-button",style:"border: 1px solid #9D9D9D;",icon:Oskari.$().startup.imageLocation+"/resource/icons/poisto.png",handler:function(){e()}});this.uiItems.clearButton=c;var a=Ext.create("Ext.form.field.Text",{id:"mapwindow-search",emptyText:k.getText("rightpanel_search_find_places_textbox_value"),flex:1,autoCreate:{tag:"input",type:"text",autocomplete:"off"},enableKeyEvents:true,listeners:{focus:function(l){k.request("SearchModule",k.getRequestBuilder("DisableMapKeyboardMovementRequest")())},keyup:function(m,l){if(l.keyCode==13){f()}},blur:function(l){k.request("SearchModule",k.getRequestBuilder("EnableMapKeyboardMovementRequest")())}}});this.uiItems.searchTextBox=a;var d=Ext.create("Ext.Panel",{id:"SearchModuleResultPanel",layout:"fit"});this.uiItems.resultPanel=d;var b=k.getText("searchservice_searching_title");function e(){d.setLoading(false);d.removeAll(true);i.enable();a.enable();a.reset();a.enable();var l=Oskari.$().mapframework.runtime.findSandbox();var m=l.getEventBuilder("SearchClearedEvent")();l.notifyAll(m,true)}function f(){d.removeAll(true);i.disable();a.disable();d.setLoading(b);var o=a.getValue();var l=Oskari.$().mapframework.runtime.findSandbox();var n=function(p){Oskari.$().mapframework.runtime.findComponent("SearchModule").showResults(p)};var m=l.getRequestBuilder("SearchRequest")(encodeURIComponent(o),n,null);l.request("SearchModule",m)}var g=Ext.create("Ext.Panel",{layout:"fit",title:k.getText("searchservice_search_alert_title"),id:"SearchModule",items:[this.uiItems.resultPanel],dockedItems:[{xtype:"toolbar",dock:"top",items:[this.uiItems.searchTextBox,this.uiItems.searchButton,this.uiItems.clearButton]}],border:false,frame:false});this.uiItems.searchModulePanel=g;return g},start:function(a){a.printDebug("Starting "+this.getName())},stop:function(a){},showResults:function(e){this.uiItems.searchButton.enable();this.uiItems.searchTextBox.enable();this.uiItems.resultPanel.setLoading(false);
var a=this._sandbox;a.request(this,a.getRequestBuilder("ActionReadyRequest")("SEARCH",false));if(e.totalCount==-1){Ext.Msg.alert(a.getText("searchservice_search_alert_title"),e.errorText)}else{if(e.totalCount==0){Ext.Msg.alert(a.getText("searchservice_search_alert_title"),a.getText("searchservice_search_not_found_anything_text"))}else{var d=e;var b=Ext.create("Ext.data.Store",{model:"Search",autoLoad:true,pageSize:15,remoteSort:true,proxy:{type:"pagingmemory",data:e,reader:{type:"json",root:"locations",totalProperty:"totalCount"}}});if(d.totalCount==1){this._sendMapMove(d.locations[0].lon,d.locations[0].lat,d.locations[0].zoomLevel)}var c=Ext.create("Ext.grid.Panel",{renderTo:Ext.getBody(),store:b,layout:"fit",flex:1,displayInfo:false,columns:[{text:a.getText("searchservice_search_result_column_name"),dataIndex:"name",width:80,flex:2,renderer:this._renderLink,sortable:true},{text:a.getText("searchservice_search_result_column_village"),dataIndex:"village",width:60,flex:2,renderer:this._renderVillage,sortable:true},{text:a.getText("searchservice_search_result_column_type"),dataIndex:"type",width:55,flex:1,sortable:true}],dockedItems:[{xtype:"pagingtoolbar",store:b,dock:"bottom",hidden:d.totalCount<15,displayInfo:false}]});this.uiItems.resultPanel.add(c)}}},_sendMapMove:function(c,b,a){this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(c,b,a,true))},_renderLink:function(b,c,a){return"<b><a href=\"#\" onclick=\"Oskari.$().sandbox.requestByName('SearchModule', 'MapMoveRequest',["+a.data.lon+","+a.data.lat+","+a.data.zoomLevel+',true]);return false;">'+a.data.name+"</a>"},_renderVillage:function(b,c,a){this.village=a.data.village;return this.village},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.ui.module.searchservice.MetadataModule",function(){this._sandbox=null;this.uiItems={}},{__name:"MetadataModule",getName:function(){return this.__name},init:function(d){this._sandbox=d;var a=d;a.printDebug("Initializing metadata module...");a.registerForEventByName(this,"AfterShowMapLayerInfoEvent");a.registerForEventByName(this,"AfterGetFeatureInfoEvent");a.registerForEventByName(this,"AfterAppendFeatureInfoEvent");var c=Ext.create("Ext.Panel",{autoScroll:true,layout:"fit"});this.uiItems.resultPanel=c;var b=Ext.create("Ext.Panel",{layout:"fit",id:"MetadataModule",title:a.getText("rightpanel_material_legend_title"),items:[this.uiItems.resultPanel],border:false,frame:false});this.uiItems.metadataModulePanel=b;return b},start:function(a){a.printDebug("Starting "+this.getName())},stop:function(a){},afterShowMapLayerInfoEvent:function(c){this.uiItems.resultPanel.update("");this.uiItems.resultPanel.removeAll();var b=c.getMapLayer();var a=this._sandbox;var d=a.getText("rightpanel_map_layer_have_not_description");if(b.getLegendImage&&b.getLegendImage()){d='<img src="'+b.getLegendImage()+'" alt="'+b.getName()+'" />'}else{if(b.getCurrentStyle&&b.getCurrentStyle().getLegend()){d='<img src="'+b.getCurrentStyle().getLegend()+'" alt="'+b.getName()+'" />'}}this.uiItems.resultPanel.update(d);Oskari.$("UI.facade").expandPart("E");this.uiItems.metadataModulePanel.expand(true)},afterGetFeatureInfoEvent:function(c){this.uiItems.resultPanel.removeAll();var b=c.getResponse();var a=this._sandbox;if(b==true){var d=Ext.create("Ext.Panel",{title:"<b>"+a.getText("rightpanel_wms_getfeatureinfo_title")+"</b>",id:"inner_feature_info_panel",layout:"fit",autoScroll:true});this.uiItems.metadataModulePanel.innerInfoPanel=d;this.uiItems.resultPanel.add(d);this.uiItems.metadataModulePanel.expand(true)}else{if(c.isWfsSelected()==true){a.showPopupText("search_module_popup_layer_is_wfs_title","search_module_popup_layer_is_wfs_message")}else{a.showPopupText("mapcontrolsservice_layer_info_layer_not_selected_messagebox_title","mapcontrolsservice_layer_info_layer_not_selected_messagebox_message")}}},afterAppendFeatureInfoEvent:function(c){var b="<h3>"+c.getHeader()+"</h3>";var d=c.getMessage();if(d.startsWith("{parsed: {")){var e=Ext.decode(d);
if(e&&e.parsed){d=this._formatJsonGFI(e.parsed)}}d='<div style="padding: 5px; font: 11px Tahoma, Arial, Helvetica, sans-serif;">'+d+"</div>";this.uiItems.metadataModulePanel.innerInfoPanel.update(b+d);var a=this._sandbox;a.request(this,a.getRequestBuilder("ActionReadyRequest")("GET_FEATURE_INFO",false))},_formatJsonGFI:function(b){var a="<br/><table>";var d=false;for(attr in b){var c=b[attr];if(c.startsWith("http://")){c='<a href="'+c+'" target="_blank">'+c+"</a>"}a=a+'<tr style="padding: 5px;';if(!d){a=a+" background-color: #EEEEEE"}d=!d;a=a+'"><td style="padding: 2px">'+attr+'</td><td style="padding: 2px">'+c+"</td></tr>"}return a+"</table>"},eventHandlers:{AfterShowMapLayerInfoEvent:function(a){this.afterShowMapLayerInfoEvent(a)},AfterGetFeatureInfoEvent:function(a){this.afterGetFeatureInfoEvent(a)},AfterAppendFeatureInfoEvent:function(a){this.afterAppendFeatureInfoEvent(a)}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}},{protocol:["Oskari.mapframework.module.Module"]});