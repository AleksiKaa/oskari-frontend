/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kes√§aika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.LayerSelectionBundleInstance",function(){this.sandbox=null;this.started=false;this.plugins={};this.localization=null},{__name:"LayerSelection",getName:function(){return this.__name},setSandbox:function(a){this.sandbox=a},getSandbox:function(){return this.sandbox},getLocalization:function(a){if(!this._localization){this._localization=Oskari.getLocalization(this.getName())}if(a){return this._localization[a]}return this._localization},start:function(){var c=this;if(c.started){return}c.started=true;var a=Oskari.$("sandbox");c.sandbox=a;this.localization=Oskari.getLocalization(this.getName());a.register(c);for(p in c.eventHandlers){a.registerForEventByName(c,p)}var b=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,b);c.createUi()},init:function(){return null},update:function(){},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},eventHandlers:{AfterMapLayerRemoveEvent:function(a){this.plugins["Oskari.userinterface.Tile"].refresh();this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(a.getMapLayer(),false)},AfterMapLayerAddEvent:function(a){this.plugins["Oskari.userinterface.Tile"].refresh();this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(a.getMapLayer(),true,a.getKeepLayersOrder())},MapLayerEvent:function(d){var b=this.sandbox.getService("Oskari.mapframework.service.MapLayerService");var a=d.getLayerId();if(d.getOperation()==="update"){var c=b.findMapLayer(a);this.plugins["Oskari.userinterface.Flyout"].handleLayerModified(c)}},MapLayerVisibilityChangedEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleLayerVisibilityChanged(a.getMapLayer(),a.isInScale(),a.isGeometryMatch())},AfterChangeMapLayerOpacityEvent:function(a){if(a._creator!=this.getName()){this.plugins["Oskari.userinterface.Flyout"].handleLayerOpacityChanged(a.getMapLayer())}},AfterChangeMapLayerStyleEvent:function(a){if(a._creator!=this.getName()){this.plugins["Oskari.userinterface.Flyout"].handleLayerStyleChanged(a.getMapLayer())}}},stop:function(){var a=this.sandbox();for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}var b=a.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);a.request(this,b);this.sandbox.unregister(this);this.started=false},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.Flyout",this);this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselection2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null;this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){var a=this;this.plugins["Oskari.userinterface.Flyout"].createUi();this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]});Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.Flyout",function(a){this.instance=a;this.container=null;this.state=null;this.template=null;this.templateLayer=null;this.templateLayerTools=null;this.templateLayerOutOfScale=null;this.templateLayerOutOfContentArea=null;this.sortableBinded=false;this._sliders={}},{getName:function(){return"Oskari.mapframework.bundle.layerselection2.Flyout"},setEl:function(c,b,a){this.container=c[0];if(!jQuery(this.container).hasClass("layerselection2")){jQuery(this.container).addClass("layerselection2")}},startPlugin:function(){var a=this.instance.getLocalization("layer");this.template=jQuery('<ul class="selectedLayersList sortable" data-sortable=\'{itemCss: "li.layer.selected", handleCss: "div.layer-title" }\'></ul>');this.templateLayer=jQuery('<li class="layer selected"><div class="layer-info"><div class="layer-icon"></div><div class="layer-tool-remove"></div><div class="layer-title"><h4></h4></div></div><div class="stylesel"><label for="style">'+a.style+'</label><select name="style"></select></div><div class="layer-tools volatile"></div></li>');
this.templateLayerFooterTools=jQuery('<div class="left-tools"><div class="layer-visibility"><a href="JavaScript:void(0);">'+a.hide+'</a>&nbsp;<span class="temphidden" style="display: none;">'+a.hidden+'</span></div><div class="layer-opacity"><div class="layout-slider" id="layout-slider"></div> <div class="opacity-slider" style="display:inline-block"><input type="text" name="opacity-slider" class="opacity-slider opacity" id="opacity-slider" />%</div></div></div><div class="right-tools"><div class="layer-description"><div class="wrapper"></div></div><div class="layer-rights"></div><a href="JavaScript:void(0);"><div class="icon-info"></div></a></div>');this.templateLayerFooterHidden=jQuery('<p class="layer-msg"><a href="JavaScript:void(0);">'+a.show+"</a> "+a.hidden+"</p>");this.templateLayerFooterOutOfScale=jQuery('<p class="layer-msg">'+a["out-of-scale"]+' <a href="JavaScript:void(0);">'+a["move-to-scale"]+"</a></p>");this.templateLayerFooterOutOfContentArea=jQuery('<p class="layer-msg">'+a["out-of-content-area"]+' <a href="JavaScript:void(0);">'+a["move-to-content-area"]+"</a></p>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(a){this.state=a;console.log("Flyout.setState",this,a)},createUi:function(){var h=this;var b=jQuery(this.container);b.empty();var f=this.template.clone();b.append(f);var i=h.instance.getSandbox();var d=i.findAllSelectedMapLayers();var c=i.getMap().getScale();for(var a=d.length-1;a>=0;--a){var e=d[a];var g=this._createLayerContainer(e);f.append(g);this._appendLayerFooter(g,e,e.isInScale(c),true)}if(!this.sortableBinded){this.sortableBinded=true;".selectedLayersList".on("finish",function(j){h._layerOrderChanged(j.index)})}},_appendLayerFooter:function(a,b,d,c){var e=a.find("div.layer-tools");if(!b.isVisible()){a.addClass("hidden");e.append(this._createLayerFooterHidden(b))}else{if(!d){a.addClass("out-of-scale");e.append(this._createLayerFooterOutOfScale(b))}else{if(!c){a.addClass("out-of-content");e.append(this._createLayerFooterOutOfContentArea(b))}else{e.append(this._createLayerFooter(b,a));this._addSlider(b)}}}},_addSlider:function(a){var c=this;var b=c._sliders[a.getId()];if(!b){var b=new Slider({min:0,max:100});b.setStyle({"background-color":"transparent","background-image":'url("../../resources/framework/bundle/layerselection2/images/opacity_slider.png")',height:"5px",width:"150px",border:"0",margin:0});b.level.hide();b.handle.setStyle({"background-color":"transparent","background-image":'url("../../resources/framework/bundle/layerselection2/images/opacity_index.png")',width:"15px",height:"15px",border:"0","margin-left":0});b.on("change",function(d){c._layerOpacityChanged(a,d.value)});c._sliders[a.getId()]=b}b.setValue(a.getOpacity());if(jQuery("#layout-slider-"+a.getId()).length>0){b.insertTo("layout-slider-"+a.getId());b.assignTo("opacity-slider-"+a.getId())}},_layerOrderChanged:function(c){var d=jQuery(this.container).find(".selectedLayersList li");var f=jQuery(d[c]).attr("layer_id");if(c>-1){c=(d.length-1)-c;var a=this.instance.getSandbox();var b=a.getRequestBuilder("RearrangeSelectedMapLayerRequest");var e=b(f,c);a.request(this.instance.getName(),e)}},_createLayerContainer:function(f){var j=this;var n=j.instance.getSandbox();var a=n.getRequestBuilder("ChangeMapLayerOpacityRequest");var d=f.getId();var m=f.getOpacity();var q=this.templateLayer.clone();q.attr("layer_id",d);q.find("div.layer-title h4").append(f.getName());q.find("div.layer-title").append(f.getDescription());var l=q.find("div.stylesel");l.hide();if(f.getStyles&&f.getStyles().size>1){var g=false;var o=f.getStyles();var c=l.find("select");for(var e=0;e<o.size();e++){if(o[e].getName()){var b=jQuery('<option value="'+o[e].getName()+'">'+o[e].getTitle()+"</option>");c.append(b);g=true}}c.change(function(s){var t=c.find("option:selected").val();f.selectStyle(t);var i=n.getRequestBuilder("ChangeMapLayerStyleRequest");var r=i(f.getId(),t);n.request(j.instance.getName(),r)});if(g){c.val(f.getCurrentStyle().getName());
l.show()}}var h=this.instance.getLocalization("layer").tooltip;var k=q.find("div.layer-icon");if(f.isBaseLayer()){k.addClass("layer-base");k.attr("title",h["type-base"])}else{if(f.isLayerOfType("WMS")){if(f.isGroupLayer()){k.addClass("layer-group")}else{k.addClass("layer-wms")}k.attr("title",h["type-wms"])}else{if(f.isLayerOfType("WMTS")){k.addClass("layer-wmts");k.attr("title",h["type-wms"])}else{if(f.isLayerOfType("WFS")){k.addClass("layer-wfs");k.attr("title",h["type-wfs"])}else{if(f.isLayerOfType("VECTOR")){k.addClass("layer-vector");k.attr("title",h["type-wms"])}}}}}q.find("div.layer-tool-remove").addClass("icon-close");q.find("div.layer-tool-remove").bind("click",function(){var i=n.getRequestBuilder("RemoveMapLayerRequest");var r=i(f.getId());n.request(j.instance.getName(),r)});return q},handleLayerVisibilityChanged:function(c,g,f){var d=this;var b=d.instance.getSandbox();var a=jQuery(this.container).find("li.layer.selected[layer_id="+c.getId()+"]");var e=this.instance.getLocalization("layer");var h=a.find("div.layer-tools");h.empty();a.removeClass("hidden");a.removeClass("out-of-scale");a.removeClass("out-of-content");this._appendLayerFooter(a,c,g,f)},_layerOpacityChanged:function(c,e){var b=this.instance.getSandbox();var f=b.getRequestBuilder("ChangeMapLayerOpacityRequest");var d=f(c.getId(),e);b.request(this.instance.getName(),d);var a=jQuery(this.container).find("li.layer.selected[layer_id="+c.getId()+"]");a.find("div.layer-opacity input.opacity").attr("value",c.getOpacity())},handleLayerOpacityChanged:function(a){this._addSlider(a)},handleLayerStyleChanged:function(c){var a=jQuery(this.container).find("li.layer.selected[layer_id="+c.getId()+"]");var b=a.find("div.stylesel select");b.val(c.getCurrentStyle().getName())},_createLayerFooterOutOfScale:function(b){var c=this;var a=c.instance.getSandbox();var d=this.templateLayerFooterOutOfScale.clone();var e=a.getRequestBuilder("MapModulePlugin.MapMoveByLayerContentRequest");d.find("a").bind("click",function(){var f=e(b.getId());a.request(c.instance.getName(),f)});return d},_createLayerFooterHidden:function(c){var d=this;var a=d.instance.getSandbox();var e=this.templateLayerFooterHidden.clone();var b=a.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest");e.find("a").bind("click",function(){var f=b(c.getId(),true);a.request(d.instance.getName(),f)});return e},_createLayerFooterOutOfContentArea:function(b){var c=this;var a=c.instance.getSandbox();var d=this.templateLayerFooterOutOfContentArea.clone();var e=a.getRequestBuilder("MapModulePlugin.MapMoveByLayerContentRequest");d.find("a").bind("click",function(){var f=e(b.getId());a.request(c.instance.getName(),f)});return d},_createLayerFooter:function(f,j){var h=this;var i=h.instance.getSandbox();var e=this.templateLayerFooterTools.clone();var g=this.instance.getLocalization("layer");var d=i.getRequestBuilder("MapModulePlugin.MapLayerVisibilityRequest");e.find("div.layer-visibility a").bind("click",function(){var k=d(f.getId(),false);i.request(h.instance.getName(),k)});var c=f.getPermission("publish");if(!i.getUser().isLoggedIn()){if(c=="can_be_published"){e.find("div.layer-rights").html(g.rights["login-url"]);e.find("div.layer-rights").attr("title",g.rights["need-login"])}else{e.find("div.layer-rights").html(g.rights.no_publication_permission.label);e.find("div.layer-rights").attr("title",g.rights.no_publication_permission.tooltip)}}else{e.find("div.layer-rights").html(g.rights[c].label);e.find("div.layer-rights").attr("title",g.rights[c].tooltip)}if(!f.getDataUrl()){e.find("div.layer-description").hide()}else{e.find("div.layer-description a").attr("href",f.getDataUrl());e.find("div.layer-description a").attr("target","_blank")}var a=e.find("div.layout-slider");a.attr("id","layout-slider-"+f.getId());var b=e.find("input.opacity-slider");b.attr("id","opacity-slider-"+f.getId());return e},handleLayerSelectionChanged:function(d,a,b){if(a==true){var f=this;var j=f.instance.getSandbox();var c=j.getMap().getScale();var e=jQuery("ul.selectedLayersList");var g=this._createLayerContainer(d);var i=g.find("div.layer-tools");
if(!d.isVisible()){g.addClass("hidden");i.append(this._createLayerFooterHidden(d))}else{if(!d.isInScale(c)){g.addClass("out-of-scale");i.append(this._createLayerFooterOutOfScale(d))}else{i.append(this._createLayerFooter(d,g))}}var h=[];if(d.isBaseLayer()&&b!=true){h=e.find("li[layer_id^=base_]")}else{h=e.find(".layer.selected")}if(h.length>0){h.first().before(g)}else{e.append(g)}}else{var k=jQuery(this.container).find("li[layer_id="+d.getId()+"]");if(k){k.remove()}}},handleLayerModified:function(b){var c=this;var a=jQuery(this.container).find("li[layer_id="+b.getId()+"]");jQuery(a).find(".layer-title h4").html(b.getName())}},{protocol:["Oskari.userinterface.Flyout"]});Oskari.clazz.define("Oskari.mapframework.bundle.layerselection2.Tile",function(a){this.instance=a;this.container=null;this.template=null;this.badge=Oskari.clazz.create("Oskari.userinterface.component.Badge");this.shownLayerCount=null},{getName:function(){return"Oskari.mapframework.bundle.layerselection2.Tile"},setEl:function(d,c,a){this.container=jQuery(d);var b=this.container.children(".oskari-tile-status");this.badge.insertTo(b)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(a){console.log("Tile.setState",this,a)},refresh:function(){var e=this;var a=e.instance;var d=this.container;var c=this.template;var b=a.getSandbox();var g=b.findAllSelectedMapLayers();var f=g.length;if(this.shownLayerCount&&this.shownLayerCount){this.badge.setContent(""+f,"important")}else{this.badge.setContent(""+f)}this.shownLayerCount=f}},{protocol:["Oskari.userinterface.Tile"]});