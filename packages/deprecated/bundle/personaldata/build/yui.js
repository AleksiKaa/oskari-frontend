/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kesäaika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.PersonalDataBundleInstance",function(){this.core=null;this.sandbox=null;this.started=false;this.template=null;this.plugins={}},{__name:"PersonalData",getName:function(){return this.__name},setSandbox:function(a){this.sandbox=a},getSandbox:function(){return this.sandbox},getLocalization:function(a){if(!this._localization){this._localization=Oskari.getLocalization(this.getName())}if(a){return this._localization[a]}return this._localization},start:function(){var d=this;if(d.started){return}d.started=true;var a=Oskari.$("sandbox");d.sandbox=a;a.register(d);for(p in d.eventHandlers){a.registerForEventByName(d,p)}var c=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,c);d.createUi();var e=a.getRequestBuilder("StateHandler.SaveStateRequest");if(e){var b=a.getRequestBuilder("Toolbar.AddToolButtonRequest");a.request(d,b("save_view","viewtools",{iconCls:"tool-save-view",tooltip:"Tallenna näkymä",sticky:false,callback:function(){a.request(d,e())}}))}if(!a.getUser().isLoggedIn()){var b=a.getRequestBuilder("Toolbar.ToolButtonStateRequest");a.request(d,b("save_view","viewtools",false))}},init:function(){return null},update:function(){},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},eventHandlers:{},stop:function(){var a=this.sandbox();for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}var b=a.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);a.request(this,b);this.sandbox.unregister(this);this.started=false},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.Flyout",this);this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null;this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){var a=this;this.plugins["Oskari.userinterface.Flyout"].createUi();this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]});Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.Flyout",function(a){this.instance=a;this.container=null;this.state=null;this.templateNotLoggedIn=null;this.template=null;this.templateTabHeader=null;this.templateTabContent=null;this.tabsData=[]},{getName:function(){return"Oskari.mapframework.bundle.personaldata.Flyout"},setEl:function(c,b,a){this.container=c[0];if(!jQuery(this.container).hasClass("personaldata")){jQuery(this.container).addClass("personaldata")}},startPlugin:function(){var a=this;this.templateNotLoggedIn=jQuery("<p>"+this.instance.getLocalization("notLoggedIn")+"</p>");this.template=jQuery('<div class="oskariTabs"><ul></ul></div><br clear="all"/><div class="oskariTabsWrapper"></div>');this.templateTabHeader=jQuery('<li><a href="JavaScript:void(0);"></a></li>');this.templateTabContent=jQuery('<div class="tab-content"></div>');var b=this.instance.getLocalization("tabs");this.tabsData={myPlaces:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.MyPlacesTab",this.instance,b.myplaces),myViews:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.MyViewsTab",this.instance,b.myviews),publishedMaps:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.PublishedMapsTab",this.instance,b.publishedmaps),account:Oskari.clazz.create("Oskari.mapframework.bundle.personaldata.AccountTab",this.instance,b.account)}},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(a){this.state=a;console.log("Flyout.setState",this,a)},createUi:function(){var g=this;var j=g.instance.getSandbox();var h=jQuery(this.container);
h.empty();var e=this.template.clone();h.append(e);var a=h.find("div.oskariTabs ul");this._createTabHeaders(a);var f=h.find("div.oskariTabsWrapper");var d=true;for(var b in this.tabsData){var c=this.tabsData[b];var i=this.templateTabContent.clone();if(!d){i.css("display","none")}f.append(i);c.addTabContent(i);if(c.bindEvents){c.bindEvents()}d=false}jQuery(a).find("li a").bind("click",function(){var l=jQuery(this).parent();var k=l.index();h.find(".tab-content").hide();h.find(".tab-content:eq("+k+")").show();l.closest("ul").find("li").removeClass("active");l.addClass("active")})},_createTabHeaders:function(d){var c=true;for(var a in this.tabsData){var b=this.tabsData[a];var e=this.templateTabHeader.clone();if(c){e.addClass("active");c=false}e.find("a").html(b.getTitle());d.append(e)}}},{protocol:["Oskari.userinterface.Flyout"]});Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.Tile",function(a){this.instance=a;this.container=null;this.template=null},{getName:function(){return"Oskari.mapframework.bundle.personaldata.Tile"},setEl:function(c,b,a){this.container=jQuery(c)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){},getOptions:function(){},setState:function(a){console.log("Tile.setState",this,a)},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]});Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.MyPlacesTab",function(a,b){this.instance=a;this.template=jQuery("<p>omat templateMyPlacesTab content</p>");this.loc=b;this.dummy=false},{getTitle:function(){return this.loc.title},addTabContent:function(c){var f=this;var e=this.template.clone();c.append(e);var d=jQuery("<div>Add measure area</div>");d.bind("click",function(i){var h=f.instance.getSandbox();var j=h.getRequestBuilder("Toolbar.AddToolButtonRequest");h.request(f.instance,j("measurearea","measuretools",{iconCls:"tool-measure-area",tooltip:"Measure area",sticky:true,callback:function(){h.request(f.instance,h.getRequestBuilder("ToolSelectionRequest")("map_control_measure_area_tool"))}}))});e.append(d);e.append("<hr/>");var b=jQuery("<div>Disable/enable measure area</div>");b.bind("click",function(i){var h=f.instance.getSandbox();var j=h.getRequestBuilder("Toolbar.ToolButtonStateRequest");h.request(f.instance,j("measurearea","measuretools",f.dummy));f.dummy=!f.dummy});e.append(b);e.append("<hr/>");var a=jQuery("<div>Remove measure area</div>");a.bind("click",function(i){var h=f.instance.getSandbox();var j=h.getRequestBuilder("Toolbar.RemoveToolButtonRequest");h.request(f.instance,j("measurearea","measuretools"))});e.append(a);var g=jQuery("<div>Disable/enable all measuretools</div>");g.bind("click",function(i){var h=f.instance.getSandbox();var j=h.getRequestBuilder("Toolbar.ToolButtonStateRequest");h.request(f.instance,j(undefined,"measuretools",f.dummy));f.dummy=!f.dummy});e.append(g);e.append("<hr/>")}});Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.MyViewsTab",function(a,b){this.instance=a;this.template=jQuery('<div><a href="JavaScript: void(0);"></a></div> <div style="border: 1px solid; margin: 20px; padding: 25px;" class="response"></div><div class="viewsList"></div>');this.templateViewRow=jQuery('<div class="view"><div class="name"><a href="JavaScript:void(0);"></a></div></div>');this.templateViewTools=jQuery('<div class="tools"><div class="edit"><a href="JavaScript:void(0);"></a></div><div class="publish"><a href="JavaScript:void(0);"></a></div><div class="delete"><a href="JavaScript:void(0);"></a></div></div>');this.loc=b;this.container=null;this.debugCounter=0},{getName:function(){return"PersonalData.MyViews"},getTitle:function(){return this.loc.title},addTabContent:function(c){var e=this;var d=e.template.clone();e.container=c;d.find("a").html("> Tallenna näkymä <");c.append(d);var a=e.instance;var b=a.getSandbox();d.find("a").bind("click",function(){var f=b.getRequestBuilder("StateHandler.SaveStateRequest");if(f){b.request(a,f())}});e._refreshViewsList()},_refreshViewsList:function(){var a=this;
var b=a.container.find(".viewsList");jQuery.ajax({url:"/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=1&p_p_state=exclusive&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&_Portti2Map_WAR_portti2mapportlet_fi.mml.baseportlet.CMD=ajax.jsp&action_route=GetViews",type:"POST",dataType:"json",beforeSend:function(c){if(c&&c.overrideMimeType){c.overrideMimeType("application/j-son;charset=UTF-8")}},success:function(d){b.html("");if(d.views&&d.views.length>0){a.viewData=d.views;for(var f=0;f<a.viewData.length;f++){var c=a.viewData[f];var e=a.createViewContainer(c);b.append(e)}b.find("div.view:odd").addClass("odd");b.find("div.view:even").removeClass("odd");var h=a.instance.plugins["Oskari.userinterface.Tile"];var j=h.container;var g=jQuery(j).find(".oskari-tile-status");g.empty();g.append("("+d.views.length+")")}},error:function(){alert(a.loc.efailtogetmyviews)}})},editView:function(g){var e=this;var i=this.instance.getSandbox();var h=this.loc.edit?this.loc.edit:"Muokkaa näkymää";var a='<div class="e_noname" style="display: inline-block; color: red; display: none;">'+(this.loc.error_noname?this.loc.error_noname:"Nimi ei voi olla tyhjä!")+'<br /></div><div class="e_illegal" style="display: inline-block; color: red; display: none;"><br />'+(this.loc.error_illegalchars?this.loc.error_illegalchars:"Nimessä on virheellisiä merkkejä")+"<br /></div>"+(this.loc.msg?this.loc.msg.view_name:"Näkymän nimi")+': <input name="viewName" value="'+g.name+'" type="text" class="viewName" />';var d={name:"button_save",text:(this.loc.button?this.loc.button.save:"Tallenna"),close:false,onclick:function(k){var l=jQuery("div.modalmessage input.viewName").val();if(l){if(l.indexOf("<")>=0){jQuery("div.modalmessage div.e_illegal").show()}else{$.modal.close();jQuery.ajax({url:"/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=1&p_p_state=exclusive&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&_Portti2Map_WAR_portti2mapportlet_fi.mml.baseportlet.CMD=ajax.jsp&action_route=RenameView",type:"POST",data:"id="+g.id+"&newName="+l,dataType:"json",beforeSend:function(m){if(m&&m.overrideMimeType){m.overrideMimeType("application/j-son;charset=UTF-8")}},success:function(m){e._refreshViewsList()},error:function(){alert(e.loc.e_fail)}})}}else{jQuery("div.modalmessage div.e_noname").show()}}};var j={name:"button_cancel",text:(this.loc.button?this.loc.button.cancel:"Peruuta"),close:true};var c="userinterface.ModalDialogRequest";var b=i.getRequestBuilder(c);var f=b(h,a,[d,j]);i.request(this.instance,f)},createViewContainer:function(c){var e=this;var i=this.instance.getSandbox();var a=this.templateViewRow.clone();var d=this.templateViewTools.clone();var g=a.find("div.name a");g.append(c.name);g.bind("click",function(){var l=i.getRequestBuilder("StateHandler.SetStateRequest");if(l){var k=l(c.state);var j=(typeof c.state.mapfull.state);if(j=="string"){c.state.mapfull.state=JSON.parse(c.state.mapfull.state)}k.setCurrentViewId(c.id);i.request(e.instance,k)}});a.attr("view_id",c.id);a.append(d);var b=d.find("div.edit a");b.append(this.loc.edit);b.bind("click",function(){var j=jQuery(this).closest("div.view");var l=j.attr("view_id");var k=e.getViewById(l);e.editView(k)});var h=d.find("div.publish a");if(c.isPublic){h.append(this.loc.unpublish)}else{h.append(this.loc.publish)}h.bind("click",function(){var j=jQuery(this).closest("div.view");var l=j.attr("view_id");var k=e.getViewById(l);if(!k){return}k.isPublic=!k.isPublic;if(k.isPublic){h.html(e.loc.unpublish)}else{h.html(e.loc.publish)}jQuery.ajax({url:"/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=1&p_p_state=exclusive&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&_Portti2Map_WAR_portti2mapportlet_fi.mml.baseportlet.CMD=ajax.jsp&action_route=AdjustViewAccess&id="+l+"&isPublic="+k.isPublic,type:"POST",dataType:"json",beforeSend:function(m){if(m&&m.overrideMimeType){m.overrideMimeType("application/j-son;charset=UTF-8")}},success:function(m){e._refreshViewsList()},error:function(){alert(loc.efailtoremovemyview)}})});var f=d.find("div.delete a");f.append(this.loc["delete"]);
f.bind("click",function(){var s=jQuery(this).closest("div.view");var k=s.attr("view_id");var o=e.getViewById(k);if(o){var n={};n.name="delete_ok";n.text=e.loc.button?e.loc.button.yes:"Kyllä";n.onclick=function(){jQuery.ajax({url:"/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=1&p_p_state=exclusive&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&_Portti2Map_WAR_portti2mapportlet_fi.mml.baseportlet.CMD=ajax.jsp&action_route=DeleteView&id="+k,type:"POST",dataType:"json",beforeSend:function(t){if(t&&t.overrideMimeType){t.overrideMimeType("application/j-son;charset=UTF-8")}},success:function(t){s.remove();e._refreshViewsList()},error:function(){alert(loc.efailtoremovemyview)}})};var r={};r.name="delete_cancel";r.text=e.loc.button?e.loc.button.no:"Ei";r.close=true;var j=i.getRequestBuilder("userinterface.ModalDialogRequest");var q=e.loc.msg?e.loc.msg.confirm_delete:"Poiston varmistus";var l=e.loc.msg?e.loc.msg.delete_view:"Poistetaanko näkymä";l+=" '"+o.name+"'?";var m=j(q,l,[n,r]);i.request(e.instance,m)}else{return}});return a},getViewById:function(b){for(var a=0;a<this.viewData.length;++a){if(this.viewData[a].id==b){return this.viewData[a]}}alert("Couldnt find view for id: "+b);return null},bindEvents:function(){var a=this.instance;var b=a.getSandbox();for(p in this.eventHandlers){b.registerForEventByName(this,p)}},unbindEvents:function(){var a=this.instance;var b=a.getSandbox();for(p in this.eventHandlers){b.unregisterForEventByName(this,p)}},eventHandlers:{StateSavedEvent:function(a){this.container.find("div.response").html("Tallennettu tila: <hr/>"+this.serializeJSON(a.getState()));this.debugCounter++;this._refreshViewsList()}},serializeJSON:function(e){var d=this;var c=typeof(e);if(c!="object"||e===null){if(c=="string"){e='"'+e+'"'}return String(e)}else{var b=[],a=(e&&e.constructor==Array);jQuery.each(e,function(g,f){c=typeof(f);if(c=="string"){f='"'+f+'"'}else{if(c=="object"&f!==null){f=d.serializeJSON(f)}}b.push((a?"":'"'+g+'":')+String(f))});return(a?"[":"{")+String(b)+(a?"]":"}")}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}});Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.PublishedMapsTab",function(a,b){this.instance=a;this.template=jQuery("<p>omat templatePublishedMapsTab content</p>");this.loc=b},{getTitle:function(){return this.loc.title},addTabContent:function(a){var b=this.template.clone();a.append(b)}});Oskari.clazz.define("Oskari.mapframework.bundle.personaldata.AccountTab",function(a,b){this.instance=a;this.template=jQuery('<div class="account"><div class="info"></div><div class="bottomlinks"></div></div>');this.loc=b},{getTitle:function(){return this.loc.title},addTabContent:function(a){var b=this.template.clone();a.append(b);this._createAccount(a)},_createAccount:function(c){var k=this;var m=k.instance.getSandbox();var o=jQuery('<div class="dataField"><div class="label"></div><div class="value"></div><br clear="all" /></div>');var e=m.getUser();var n=this.loc;var d=[{label:n.firstName,value:e.getFirstName()},{label:n.lastName,value:e.getLastName()},{label:n.nickName,value:e.getNickName()},{label:n.email,value:e.getLoginName()}];var b=c.find("div.info");for(var g=0;g<d.length;++g){var f=d[g];var h=o.clone();h.find(".label").html(f.label);h.find(".value").html(f.value);b.append(h)}var j=[{label:n.changeInfo,href:"JavaScript:void(0);"},{label:n.changePassword,href:"JavaScript:void(0);"},{label:n.removeAccount,href:"JavaScript:void(0);"}];var a=c.find("div.bottomlinks");for(var g=0;g<j.length;++g){var f=j[g];var l=jQuery('<a href="'+f.href+'">'+f.label+"</a>&nbsp; ");a.append(l)}}});