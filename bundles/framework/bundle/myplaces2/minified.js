/**
 * jscolor, JavaScript Color Picker
 *
 * @version 1.3.13
 * @license GNU Lesser General Public License, http://www.gnu.org/copyleft/lesser.html
 * @author  Jan Odvarko, http://odvarko.cz
 * @created 2008-06-15
 * @updated 2012-01-19
 * @link    http://jscolor.com
 */

Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.event.FinishedDrawingEvent",function(e,t){this._drawing=e,this._modification=t==1},{__name:"MyPlaces.FinishedDrawingEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},isModification:function(){return this._modification}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/myplaces2/event/FinishedDrawingEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.event.AddedFeatureEvent",function(e,t){this._drawing=e,this._drawingMode=t},{__name:"MyPlaces.AddedFeatureEvent",getName:function(){return this.__name},getDrawing:function(){return this._drawing},getDrawingMode:function(){return this._drawingMode}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/myplaces2/event/AddedFeatureEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlaceHoverEvent",function(e,t,n){this._creator=null,this._lonlat=e,this._hoverEvent=t,this._zoom=n},{__name:"MyPlaces.MyPlaceHoverEvent",getName:function(){return this.__name},getHoverEvent:function(){return this._hoverEvent},getLonLat:function(){return this._lonlat},getZoomLevel:function(){return this._zoom}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/myplaces2/event/MyPlaceHoverEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlacesChangedEvent",function(e){},{__name:"MyPlaces.MyPlacesChangedEvent",getName:function(){return this.__name}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/myplaces2/event/MyPlacesChangedEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.myplaces.event.MyPlaceSelectedEvent",function(e,t){this._creator=null,this._myPlace=e,this._dblClick=t},{__name:"MyPlaces.MyPlaceSelectedEvent",getName:function(){return this.__name},getPlace:function(){return this._myPlace},isDblClick:function(){return this._dblClick}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/myplaces2/event/MyPlaceSelectedEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.model.MyPlace",function(){this.id=undefined,this.name=undefined,this.description=undefined,this.categoryID=undefined,this.geometry=undefined,this.link=undefined,this.createDate=undefined,this.updateDate=undefined},{setId:function(e){this.id=e},getId:function(){return this.id},setName:function(e){this.name=e},getName:function(){return this.name},setDescription:function(e){this.description=e},getDescription:function(){return this.description},setLink:function(e){this.link=e},getLink:function(){return this.link},setCategoryID:function(e){this.categoryID=e},getCategoryID:function(){return this.categoryID},setGeometry:function(e){this.geometry=e},getGeometry:function(){return this.geometry},setCreateDate:function(e){this.createDate=e},getCreateDate:function(){return this.createDate},setUpdateDate:function(e){this.updateDate=e},getUpdateDate:function(){return this.updateDate},setUUID:function(e){this.uuid=e},getUUID:function(){return this.uuid}}),define("bundles/framework/bundle/myplaces2/model/MyPlace",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory",function(){this.id=undefined,this.name=undefined,this._isDefault=!1,this._isPublic=!1,this.lineWidth=1,this.lineColor="993300",this.areaLineWidth=1,this.areaLineColor="993300",this.areaFillColor="993300",this.dotSize=4,this.dotColor="993300",this.uuid=undefined},{setId:function(e){this.id=e},getId:function(){return this.id},setName:function(e){this.name=e},getName:function(){return this.name},setDefault:function(e){this._isDefault=e==1},isDefault:function(){return this._isDefault==1},setPublic:function(e){this._isPublic=e==1},isPublic:function(){return this._isPublic==1},setLineWidth:function(e){this.lineWidth=e},getLineWidth:function(){return this.lineWidth},setLineColor:function(e){this.lineColor=e},getLineColor:function(){return this.lineColor},setAreaLineWidth:function(e){this.areaLineWidth=e},getAreaLineWidth:function(){return this.areaLineWidth},setAreaLineColor:function(e){this.areaLineColor=e},getAreaLineColor:function(){return this.areaLineColor},setAreaFillColor:function(e){this.areaFillColor=e},getAreaFillColor:function(){return this.areaFillColor},setDotSize:function(e){this.dotSize=e},getDotSize:function(){return this.dotSize},setDotColor:function(e){this.dotColor=e},getDotColor:function(){return this.dotColor},setUUID:function(e){this.uuid=e},getUUID:function(){return this.uuid}}),define("bundles/framework/bundle/myplaces2/model/MyPlacesCategory",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.plugin.DrawPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.drawControls=null,this.drawLayer=null,this.editMode=!1,this.currentDrawMode=null,this.prefix="Default.",e&&e.id&&(this.prefix=e.id+"."),e&&e.graphicFill&&(this.graphicFill=e.graphicFill),this.multipart=e&&e.multipart===!0},{__name:"DrawPlugin",getName:function(){return this.prefix+this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},startDrawing:function(e){if(e.isModify)this.modifyControls.modify.selectControl.select(this.drawLayer.features[0]);else{this.drawLayer.removeAllFeatures();if(e.geometry){this.editMode=!0;var t=[new OpenLayers.Feature.Vector(e.geometry)];this.drawLayer.addFeatures(t),this.modifyControls.modify.selectControl.select(this.drawLayer.features[0])}else this.editMode=!1,this.toggleControl(e.drawMode)}},stopDrawing:function(){this.toggleControl(),this.drawLayer.removeAllFeatures()},forceFinishDraw:function(){try{this.finishedDrawing(!0)}catch(e){this.stopDrawing();var t=this._sandbox.getEventBuilder(this.prefix+"MyPlaceSelectedEvent")();this._sandbox.notifyAll(t)}},finishedDrawing:function(e){(!this.multipart||e)&&this.toggleControl();if(!this.editMode){var t=this.drawLayer.features.length-1;this.modifyControls.modify.selectControl.select(this.drawLayer.features[t])}var n;!this.multipart||e?(n=this._sandbox.getEventBuilder(this.prefix+"FinishedDrawingEvent")(this.getDrawing(),this.editMode),this._sandbox.notifyAll(n)):(n=this._sandbox.getEventBuilder(this.prefix+"AddedFeatureEvent")(this.getDrawing(),this.currentDrawMode),this._sandbox.notifyAll(n))},toggleControl:function(e){this.currentDrawMode=e;for(var t in this.drawControls){var n=this.drawControls[t];e==t?n.activate():n.deactivate()}},init:function(e){var t=this;this.requestHandlers={startDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequestPluginHandler",e,t),stopDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.StopDrawingRequestPluginHandler",e,t),getGeometryHandler:Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequestPluginHandler",e,t)},this.drawLayer=new OpenLayers.Layer.Vector(this.prefix+"DrawLayer",{eventListeners:{featuresadded:function(e){t.finishedDrawing()}}}),this.drawControls={point:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Point),line:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Path),area:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Polygon,{handlerOptions:{holeModifier:"altKey"}}),box:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.RegularPolygon,{handlerOptions:{sides:4,irregular:!0}})};if(this.graphicFill!=null){var n=this.graphicFill,r=new OpenLayers.Format.SLD,i=r.read(n);if(i&&i.namedLayers)for(var s in i.namedLayers){this.drawLayer.styleMap.styles["default"]=i.namedLayers[s].userStyles[0],this.drawLayer.redraw();break}}this.modifyControls={modify:new OpenLayers.Control.ModifyFeature(t.drawLayer)},this._map.addLayers([t.drawLayer]);for(var o in this.drawControls)this._map.addControl(this.drawControls[o]);for(var o in this.modifyControls)this._map.addControl(this.modifyControls[o]);this.modifyControls.modify.activate()},getDrawing:function(){if(this.drawLayer.features.length===0)return null;var e=this.drawLayer.features[0].geometry.CLASS_NAME;if(e==="OpenLayers.Geometry.MultiPoint"||e==="OpenLayers.Geometry.MultiLineString"||e==="OpenLayers.Geometry.MultiPolygon")return this.drawLayer.features[0].geometry;var t=null,n=[];for(var r=0;r<this.drawLayer.features.length;r++)n.push(this.drawLayer.features[r].geometry);switch(e){case"OpenLayers.Geometry.Point":t=new OpenLayers.Geometry.MultiPoint(n);break;case"OpenLayers.Geometry.LineString":t=new OpenLayers.Geometry.MultiLineString(n);break;case"OpenLayers.Geometry.Polygon":t=new OpenLayers.Geometry.MultiPolygon(n)}return t},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this),e.addRequestHandler(this.prefix+"StartDrawingRequest",this.requestHandlers.startDrawingHandler),e.addRequestHandler(this.prefix+"StopDrawingRequest",this.requestHandlers.stopDrawingHandler),e.addRequestHandler(this.prefix+"GetGeometryRequest",this.requestHandlers.getGeometryHandler)},stopPlugin:function(e){e.removeRequestHandler(this.prefix+"StartDrawingRequest",this.requestHandlers.startDrawingHandler),e.removeRequestHandler(this.prefix+"StopDrawingRequest",this.requestHandlers.stopDrawingHandler),e.removeRequestHandler(this.prefix+"GetGeometryRequest",this.requestHandlers.getGeometryHandler),e.unregister(this),this._map=null,this._sandbox=null},start:function(e){},stop:function(e){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/myplaces2/plugin/DrawPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.plugin.HoverPlugin",function(){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null},{__name:"MyPlaces.HoverPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+this.__name},init:function(e){var t=this;OpenLayers.Control.Hover=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{delay:500,pixelTolerance:null,stopMove:!1},initialize:function(e){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Hover(this,{pause:this.onPause,move:this.onMove},this.handlerOptions)},onPause:function(e){},onMove:function(e){}}),this.hoverControl=new OpenLayers.Control.Hover({handlerOptions:{delay:500,pixelTolerance:6},onPause:function(n){var r=t._map.getLonLatFromPixel(n.xy),i=e.getEventBuilder("MyPlaces.MyPlaceHoverEvent")(r,n,t._map.getZoom());e.notifyAll(i)}}),this._map.addControl(this.hoverControl)},activate:function(){this.hoverControl.activate()},deactivate:function(){this.hoverControl.deactivate()},register:function(){},unregister:function(){},startPlugin:function(e){this._sandbox=e,e.register(this)},stopPlugin:function(e){e.unregister(this),this._map=null,this._sandbox=null},start:function(e){},stop:function(e){}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/myplaces2/plugin/HoverPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.myplaces.request.StopDrawingRequest",function(e){this._creator=null,this._isCancel=e==1},{__name:"MyPlaces.StopDrawingRequest",getName:function(){return this.__name},isCancel:function(){return this._isCancel===!0}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/StopDrawingRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequest",function(e){if(e.geometry)this._geometry=e.geometry;else if(e.continueCurrent)this._continueCurrent=e.continueCurrent;else{if(!this.drawModes[e.drawMode])throw"Unknown draw mode '"+e.drawMode+"'";this._drawMode=e.drawMode}},{__name:"MyPlaces.StartDrawingRequest",getName:function(){return this.__name},isModify:function(){return this._continueCurrent?!0:!1},drawModes:{point:"point",line:"line",area:"area",cut:"cut",box:"box"},getDrawMode:function(){return this._drawMode},getGeometry:function(){return this._geometry}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/StartDrawingRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequest",function(e){this._creator=null,this._callbackMethod=e},{__name:"MyPlaces.GetGeometryRequest",getName:function(){return this.__name},getCallBack:function(){return this._callbackMethod}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/GetGeometryRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequestPluginHandler",function(e,t){this.sandbox=e,this.drawPlugin=t},{handleRequest:function(e,t){var n=t.getCallBack();this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.GetGeometryRequestPluginHandler] geometry requested");var r=this.drawPlugin.getDrawing();n(r.geometry)}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/myplaces2/request/GetGeometryRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequestPluginHandler",function(e,t){this.sandbox=e,this.drawPlugin=t},{handleRequest:function(e,t){var n=t.getDrawMode();this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.StartDrawingRequestPluginHandler] Start Drawing: "+n),this.drawPlugin.startDrawing({drawMode:t.getDrawMode(),geometry:t.getGeometry(),isModify:t.isModify(),style:""})}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/myplaces2/request/StartDrawingRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.StopDrawingRequestPluginHandler",function(e,t){this.sandbox=e,this.drawPlugin=t},{handleRequest:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.StopDrawingRequestPluginHandler] Stop drawing"),t.isCancel()?this.drawPlugin.stopDrawing():this.drawPlugin.forceFinishDraw()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/myplaces2/request/StopDrawingRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.EditPlaceRequest",function(e){this._placeId=e},{__name:"MyPlaces.EditPlaceRequest",getName:function(){return this.__name},getId:function(){return this._placeId}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/EditPlaceRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.EditCategoryRequest",function(e){this._categoryId=e},{__name:"MyPlaces.EditCategoryRequest",getName:function(){return this.__name},getId:function(){return this._categoryId}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/EditCategoryRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.DeleteCategoryRequest",function(e){this._categoryId=e},{__name:"MyPlaces.DeleteCategoryRequest",getName:function(){return this.__name},getId:function(){return this._categoryId}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/DeleteCategoryRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.PublishCategoryRequest",function(e,t){this._categoryId=e,this._isPublic=t==1},{__name:"MyPlaces.PublishCategoryRequest",getName:function(){return this.__name},getId:function(){return this._categoryId},isPublic:function(){return this._isPublic}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/myplaces2/request/PublishCategoryRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler",function(e,t){this.sandbox=e,this.instance=t},{handleRequest:function(e,t){var n=e.getSandbox();t.getName()=="MyPlaces.EditPlaceRequest"?this._handleEditPlace(n,t):t.getName()=="MyPlaces.EditCategoryRequest"?this._handleEditCategory(n,t):t.getName()=="MyPlaces.DeleteCategoryRequest"?this._handleDeleteCategory(n,t):t.getName()=="MyPlaces.PublishCategoryRequest"&&this._handlePublishCategory(n,t)},_handleEditPlace:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] edit requested for place "+t.getId());var n=this.instance.getService(),r=n.findMyPlace(t.getId());if(r){var i=r.getGeometry().getCentroid(),s={lon:i.x,lat:i.y};this.instance.getDrawPlugin().startDrawing({geometry:r.getGeometry()}),this.instance.getMainView().showPlaceForm(s,r)}},_handleEditCategory:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] edit requested for category "+t.getId());var n=this.instance.getService(),r=n.findCategory(t.getId());r&&this.instance.getCategoryHandler().editCategory(r)},_handleDeleteCategory:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] delete requested for category "+t.getId());var n=this.instance.getService(),r=n.findCategory(t.getId());r&&this.instance.getCategoryHandler().confirmDeleteCategory(r)},_handlePublishCategory:function(e,t){this.sandbox.printDebug("[Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler] (un/)publish requested for category "+t.getId());var n=this.instance.getService(),r=n.findCategory(t.getId());r&&this.instance.getCategoryHandler().confirmPublishCategory(r,t.isPublic())}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/myplaces2/request/EditRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService",function(e,t,n,r,i){this._categoryList=[],this._placesList=[],this.wfstStore=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.service.MyPlacesWFSTStore",e,t),this._sandbox=n,this.defaultCategory=null,this.defaultCategoryName=r,this._instance=i},{__qname:"Oskari.mapframework.bundle.myplaces2.service.MyPlacesService",getQName:function(){return this.__qname},__name:"MyPlacesService",getName:function(){return this.__name},init:function(){var e=this;this.wfstStore.connect();var t=!1,n=!1,r=function(){n&&t&&e._notifyDataChanged()},i=function(n){if(n)for(var i=0;i<n.length;++i)e._addCategory(n[i]);var s=function(){t=!0,r()};e.getDefaultCategory()?s():e._createDefaultCategory(s)},s=function(t){t&&(e._placesList=t),n=!0,r()};this.wfstStore.getCategories(i),this.wfstStore.getMyPlaces(s)},_createDefaultCategory:function(e){var t=this,n=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory");n.setName(t.defaultCategoryName),t.defaultCategoryName||n.setName("My map layer"),n.setLineWidth(2),n.setLineColor("cc9900"),n.setAreaLineWidth(2),n.setAreaLineColor("cc9900"),n.setAreaFillColor("ffdc00"),n.setDotColor("cc9900"),n.setDotSize(4),n.setDefault(!0);var r=function(){t.getAllCategories().length===0?t._instance.forceDisable():e()};this.saveCategory(n,r)},_addCategory:function(e){e.isDefault()&&(this.defaultCategory=e),this._categoryList.push(e)},_movePlacesToCategory:function(e,t,n){var r=this,i=this.getPlacesInCategory(e);if(i.length==0){n(!0);return}for(var s=0;s<i.length;s++)i[s].setCategoryID(t);var o=function(e,t){r._notifyDataChanged(),n(e)};this.wfstStore.commitMyPlaces(i,o)},_deletePlacesInCategory:function(e,t){var n=this.getPlacesInCategory(e),r=[];for(var i=0;i<n.length;i++)r.push(n[i].getId());if(r.length==0){t(!0);return}var s=this,o=function(e,r){if(e){for(var i=0;i<n.length;i++)s._removeMyPlace(r[i]);s._notifyDataChanged()}t(e)};this.wfstStore.deleteMyPlaces(r,o)},parseDate:function(e){if(!e&&e.length<10)return[];var t=e.substring(0,4),n=e.substring(5,7),r=e.substring(8,10),i=[r+"."+n+"."+t],s="";if(e.length==29){s=e.substring(11);var o=s.split("+");s=o[0],s=s.split(".")[0];var u=s.split(":"),a=u[0],f=u[1],l=u[2];s=a+":"+f+":"+l,i.push(s)}return i},getPlacesInCategory:function(e){var t=[];for(var n=0;n<this._placesList.length;n++)this._placesList[n].getCategoryID()==e&&t.push(this._placesList[n]);return t},deleteCategory:function(e,t,n){var r=this,i=function(t){t?r._deleteEmptyCategory(e,n):n(t)};if(t===!0){var s=r.getDefaultCategory();r._movePlacesToCategory(e,s.getId(),i)}else r._deletePlacesInCategory(e,i)},_deleteEmptyCategory:function(e,t){var n=this,r=function(e,r){e&&n._removeCategory(r[0]),t(e),n._notifyDataChanged()};this.wfstStore.deleteCategories([e],r)},_removeCategory:function(e){for(var t=0;t<this._categoryList.length;t++)if(this._categoryList[t].getId()==e){this._categoryList.splice(t,1);break}},saveCategory:function(e,t){var n=this,r=!e.getId(),i=function(i,s){if(r&&i)n._addCategory(s[0]);else{var o=n.findCategory(s[0].getId());o?(o.setName(e.getName()),o.setDotSize(e.getDotSize()),o.setDotColor(e.getDotColor()),o.setLineWidth(e.getLineWidth()),o.setLineColor(e.getLineColor()),o.setAreaLineWidth(e.getAreaLineWidth()),o.setAreaLineColor(e.getAreaLineColor()),o.setAreaFillColor(e.getAreaFillColor()),o.setDefault(e.isDefault())):i=!1}n._notifyDataChanged(),t(i,s[0],r)};this.wfstStore.commitCategories([e],i)},getAllCategories:function(){return this._categoryList},getDefaultCategory:function(){return this.defaultCategory},_addMyPlace:function(e){this._placesList.push(e)},_removeMyPlace:function(e){var t=this.findBy(this._placesList,"id",e);t!==-1&&this._placesList.splice(t,1)},_notifyDataChanged:function(){var e=this._sandbox.getEventBuilder("MyPlaces.MyPlacesChangedEvent")();this._sandbox.notifyAll(e)},deleteMyPlace:function(e,t){var n=this,r=function(e,r){e&&(n._removeMyPlace(r[0]),n._notifyDataChanged()),t(e,r[0])};this.wfstStore.deleteMyPlaces([e],r)},findMyPlaceByLonLat:function(e,t){var n=[],r=this.getAllMyPlaces();for(var i=0;i<r.length;++i){var s=r[i].getGeometry(),o=!1;if("OpenLayers.Geometry.Point"===s.CLASS_NAME){var u=720-t*t*5;t>10?u=5:t>8?u=20:t>5&&(u=50),o=s.atPoint(e,u,u)}else o=s.atPoint(e);o&&n.push(r[i])}return n},findMyPlace:function(e){var t=this.findBy(this._placesList,"id",e);return t!==-1?this._placesList[t]:null},findCategory:function(e){var t=this.findBy(this._categoryList,"id",e);return t!==-1?this._categoryList[t]:null},findBy:function(e,t,n){for(var r=0;r<e.length;r++)if(e[r][t]===n)return r;return-1},saveMyPlace:function(e,t){var n=this,r=!e.getId(),i=function(i,s){if(r&&i)n._addMyPlace(s[0]);else{var o=n.findMyPlace(s[0].getId());o?(o.setName(e.getName()),o.setDescription(e.getDescription()),o.setLink(e.getLink()),o.setCategoryID(e.getCategoryID()),o.setGeometry(e.getGeometry()),o.setUpdateDate(s[0].getUpdateDate())):i=!1}n._notifyDataChanged(),t(i,s[0],r)};this.wfstStore.commitMyPlaces([e],i)},getAllMyPlaces:function(){return this._placesList},publishCategory:function(e,t,n){var r=this.findCategory(e);r||n(!1);var i=this,s=this._sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:{id:r.getId(),makePublic:t},url:s+"action_route=PublishMyPlaceLayer",success:function(e){e?(r.setPublic(t),n(!0),i._notifyDataChanged()):n(!1)},error:function(e,t){e.status!=0&&n(!1)}})}},{protocol:["Oskari.mapframework.service.Service"]}),define("bundles/framework/bundle/myplaces2/service/MyPlacesService",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.service.MyPlacesWFSTStore",function(e,t){this.uuid=t,this.protocols={},this.url=e},{connect:function(){var e=this.url;this.protocols.categories=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:"categories",featureNS:"http://www.paikkatietoikkuna.fi",url:e}),this.protocols.my_places=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",geometryName:"geometry",featureType:"my_places",featureNS:"http://www.paikkatietoikkuna.fi",url:e})},getCategories:function(e){var t=this.uuid,n=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:t}),r=this.protocols.categories,i=this;r.read({filter:n,callback:function(t){i._handleCategoriesResponse(t,e)}})},_handleCategoriesResponse:function(e,t){var n=this.uuid,r=e.features;if(r==null||r.length==0){t&&t();return}var i=[];for(var s=0;s<r.length;s++){var o=r[s],u=o.attributes,a=this._parseNumericId(o.fid),f=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory");f.setId(a),f.setDefault("true"===u["default"]),f.setName(u.category_name),f.setLineWidth(u.stroke_width),f.setLineColor(this._formatColorFromServer(u.stroke_color)),f.setAreaLineWidth(u.border_width),f.setAreaLineColor(this._formatColorFromServer(u.border_color)),f.setAreaFillColor(this._formatColorFromServer(u.fill_color)),f.setDotColor(this._formatColorFromServer(u.dot_color)),f.setDotSize(u.dot_size),f.setUUID(n),u.publisher_name&&f.setPublic(!0),i.push(f)}t&&t(i)},_formatColorFromServer:function(e){return e.charAt(0)=="#"?e.substring(1):e},_prefixColorForServer:function(e){return e.charAt(0)!="#"?"#"+e:e},commitCategories:function(e,t){var n=this.uuid,r=this.protocols.categories,i=this,s=[];for(var o=0;o<e.length;o++){var u=e[o],a=u.getId(),f={category_name:u.getName(),"default":u.isDefault(),stroke_width:u.getLineWidth(),stroke_color:this._prefixColorForServer(u.getLineColor()),border_width:u.getAreaLineWidth(),border_color:this._prefixColorForServer(u.getAreaLineColor()),fill_color:this._prefixColorForServer(u.getAreaFillColor()),dot_color:this._prefixColorForServer(u.getDotColor()),dot_size:u.getDotSize(),uuid:n},l=new OpenLayers.Feature.Vector(null,f);a?(l.fid=r.featureType+"."+a,l.state=OpenLayers.State.UPDATE):l.toState(OpenLayers.State.INSERT),s.push(l)}r.commit(s,{callback:function(n){i._handleCommitCategoriesResponse(n,e,t)}})},_handleCommitCategoriesResponse:function(e,t,n){if(e.success()){var r=e.reqFeatures,i,s,o=[],u=e.insertIds||[];for(var a=0,f=r.length;a<f;++a){s=r[a],i=s.state;if(i){if(i==OpenLayers.State.INSERT){s.fid=u[a],s.attributes.id=s.fid;var l=this._parseNumericId(s.fid);t[a].setId(l)}s.state=null}}n(!0,t)}else n(!1,t)},deleteCategories:function(e,t){var n=this.protocols.categories,r=this.uuid,i=[];for(var s=0;s<e.length;s++){var o=e[s];if(!o)continue;var u={uuid:r},a=new OpenLayers.Feature.Vector(null,u);a.fid=n.featureType+"."+o,a.state=OpenLayers.State.DELETE,i.push(a)}var f=this;n.commit(i,{callback:function(n){f._handleDeleteCategoriesResponse(n,e,t)}})},_handleDeleteCategoriesResponse:function(e,t,n){e.success()?n(!0,t):n(!1,t)},_parseNumericId:function(e){var t=e.split(".")[1];return t},getMyPlaces:function(e){var t=this.uuid,n=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:t}),r=this.protocols.my_places,i=this;r.read({filter:n,callback:function(t){i._handleMyPlacesResponse(t,e)}})},_handleMyPlacesResponse:function(e,t){var n=this.uuid,r=e.features;if(r==null||r.length==0){t&&t();return}var i=[];for(var s=0;s<r.length;s++){var o=r[s],u=o.attributes,a=this._parseNumericId(o.fid),f=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlace");f.setId(a),f.setName(u.name),f.setDescription(u.place_desc),f.setLink(u.link),f.setCategoryID(u.category_id),f.setCreateDate(u.created),f.setUpdateDate(u.updated),f.setGeometry(o.geometry),f.setUUID(n),i.push(f)}t&&t(i)},getMyPlacesByIdList:function(e,t){var n=this.uuid,r=this.protocols.my_places,i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:n}),new OpenLayers.Filter.FeatureId({fids:e})]}),s=this;r.read({filter:i,callback:function(e){s._handleMyPlacesResponse(e,t)}})},commitMyPlaces:function(e,t){var n=this.protocols.my_places,r=this.uuid,i=[];for(var s=0;s<e.length;s++){var o=e[s],u=o.getId(),a=o.getGeometry(),f={name:o.getName(),place_desc:o.getDescription(),link:o.getLink(),category_id:o.getCategoryID(),uuid:r},l=new OpenLayers.Feature.Vector(a,f);u?(l.fid=n.featureType+"."+u,l.state=OpenLayers.State.UPDATE):l.toState(OpenLayers.State.INSERT),i.push(l)}var c=this;n.commit(i,{callback:function(n){c._handleCommitMyPlacesResponse(n,e,t)}})},_handleCommitMyPlacesResponse:function(e,t,n){if(e.success()){var r=e.reqFeatures,i,s,o=[],u=e.insertIds||[],a=[];for(var f=0,l=r.length;f<l;++f){s=r[f],i=s.state;if(i){if(i==OpenLayers.State.INSERT){s.fid=u[f],s.attributes.id=s.fid;var c=this._parseNumericId(s.fid);t[f].setId(c),a.push(c)}else a.push(t[f].getId());s.state=null}}var h=function(e){n(!0,e)};this.getMyPlacesByIdList(a,h)}else n(!1,t)},deleteMyPlaces:function(e,t){var n=this.protocols.my_places,r=this.uuid,i=[];for(var s=0;s<e.length;s++){var o=e[s];if(!o)continue;var u={uuid:r},a=new OpenLayers.Feature.Vector(null,u);a.fid=n.featureType+"."+o,a.state=OpenLayers.State.DELETE,i.push(a)}var f=this;n.commit(i,{callback:function(n){f._handleDeleteMyPlacesResponse(n,e,t)}})},_handleDeleteMyPlacesResponse:function(e,t,n){e.success()?n(!0,t):n(!1,t)},disconnect:function(){}}),define("bundles/framework/bundle/myplaces2/service/MyPlacesWFSTStore",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.MainView",function(e){this.instance=e,this.popupId="myplacesForm",this.form=undefined},{__name:"MyPlacesMainView",getName:function(){return this.__name},getSandbox:function(){return this.instance.sandbox},init:function(){},start:function(){var e=this,t=this.instance.sandbox;t.register(e);for(var n in e.eventHandlers)t.registerForEventByName(e,n);var r=t.findRegisteredModuleInstance("MainMapModule"),i={id:"MyPlaces",multipart:!0},s=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.plugin.DrawPlugin",i);r.registerPlugin(s),r.startPlugin(s),this.drawPlugin=s},stop:function(){var e=this.instance.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this)},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{"Toolbar.ToolSelectedEvent":function(e){this._cleanupPopup()},"MyPlaces.FinishedDrawingEvent":function(e){this._handleFinishedDrawingEvent(e)}},_handleFinishedDrawingEvent:function(e){var t=e.getDrawing().getCentroid(),n={lon:t.x,lat:t.y};this.showPlaceForm(n)},showPlaceForm:function(e,t){var n=this,r=this.instance.sandbox;r.postRequestByName("DisableMapKeyboardMovementRequest");var i=this.instance.getLocalization();this.form=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.PlaceForm",this.instance);var s=this.instance.getService().getAllCategories();if(t){var o={place:{id:t.getId(),name:t.getName(),link:t.getLink(),desc:t.getDescription(),category:t.getCategoryID()}};this.form.setValues(o)}var u=[{html:n.form.getForm(s),useButtons:!0,primaryButton:i.buttons.save,actions:{}}];u[0].actions[i.buttons.cancel]=function(){n._cleanupPopup();var e=n.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();n.instance.sandbox.request(n,e)},u[0].actions[i.buttons.save]=function(){n._saveForm()};var a=r.getRequestBuilder("InfoBox.ShowInfoBoxRequest")(this.popupId,i.placeform.title,u,e,!0);r.request(n.getName(),a)},_validateForm:function(e){var t=[],n=this.instance.getCategoryHandler(),t=n.validateCategoryFormValues(e.category),r=this.instance.getLocalization("validation");return e.place.name?n.hasIllegalChars(e.place.name)&&t.push({name:"name",error:r.placeNameIllegal}):t.push({name:"name",error:r.placeName}),n.hasIllegalChars(e.place.desc)&&t.push({name:"desc",error:r.descIllegal}),t},_showValidationErrorMessage:function(e){var t=this.instance.getLocalization(),n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=n.createCloseButton(t.buttons.ok),i=jQuery("<ul></ul>");for(var s=0;s<e.length;++s){var o=jQuery("<li></li>");o.append(e[s].error),i.append(o)}n.show(t.validation.title,i,[r])},_saveForm:function(){if(!this.form)return;var e=this,t=this.form.getValues(),n=this._validateForm(t);if(t.category){var r=this.instance.getCategoryHandler().getCategoryFromFormValues(t.category),i=function(n,r,i){if(n)t.place.category=r.getId(),e.__savePlace(t.place);else{var s=e.instance.getLocalization("notification").error;i?e.instance.showMessage(s.error.title,s.error.addCategory):e.instance.showMessage(s.error.title,s.error.editCategory)}};this.instance.getService().saveCategory(r,i)}else this.__savePlace(t.place)},__savePlace:function(e){var t=this;if(!e){var n=t.instance.getLocalization("notification").error;t.instance.showMessage(n.title,n.savePlace);return}var r=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlace"),i=-1;e.id&&(r=this.instance.getService().findMyPlace(e.id),i=r.getCategoryID()),r.setId(e.id),r.setName(e.name),r.setLink(e.link),r.setDescription(e.desc),r.setCategoryID(e.category),r.setGeometry(this.drawPlugin.getDrawing());var s=this.instance.sandbox,o=function(e,n,o){if(e){var u=t.instance.getCategoryHandler()._getMapLayerId(r.getCategoryID()),a=s.getRequestBuilder("AddMapLayerRequest"),f=s.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest"),l=a(u,!0);s.request(t,l);if(!o){var c=f(u,!0);s.request(t,c),i!=r.getCategoryID()&&(u=t.instance.getCategoryHandler()._getMapLayerId(i),l=a(u,!0),s.request(t,l))}else{var c=f(u,!0);s.request(t,c)}t._cleanupPopup();var h=Oskari.clazz.create("Oskari.userinterface.component.Popup"),p=t.instance.getLocalization("notification").placeAdded;h.show(p.title,p.message),h.fadeout(),t.drawPlugin.stopDrawing()}else{var p=t.instance.getLocalization("notification").error;t.instance.showMessage(p.title,p.savePlace)}};this.instance.getService().saveMyPlace(r,o)},_cleanupPopup:function(){if(!this.form)return;var e=this.instance.sandbox,t=e.getRequestBuilder("InfoBox.HideInfoBoxRequest")(this.popupId);e.request(this,t),this.form.destroy(),this.form=undefined,e.postRequestByName("EnableMapKeyboardMovementRequest"),this.instance.enableGfi(!0)}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/myplaces2/view/MainView",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.PlaceForm",function(e){this.instance=e,this.newCategoryId="-new-",this.placeId=undefined,this.initialValues=undefined;var t=e.getLocalization("placeform");this.template=jQuery('<div class="myplacesform"><div class="field"><div class="help icon-info" title="'+t.tooltip+'"></div>'+'<input type="text" name="placename" placeholder="'+t.placename.placeholder+'"/>'+"</div>"+'<div class="field">'+'<input type="text" name="placelink" placeholder="'+t.placelink.placeholder+'"/>'+"</div>"+'<div class="field">'+'<textarea name="placedesc" placeholder="'+t.placedesc.placeholder+'">'+"</textarea>"+"</div>"+'<div class="field">'+'<label for="category">'+t.category.label+'</label><br clear="all" />'+'<select name="category" autofocus>'+"</select>"+"</div>"+"</div>"),this.templateOption=jQuery("<option></option>"),this.categoryForm=undefined},{getForm:function(e){var t=this.template.clone(),n=this.instance.getLocalization("placeform");if(e){var r=t.find("select[name=category]"),i=this.templateOption.clone();i.append(n.category["new"]),i.attr("value",this.newCategoryId),r.append(i);for(var s=0;s<e.length;++s){var o=e[s],i=this.templateOption.clone();i.append(o.getName()),i.attr("value",o.getId()),this.initialValues?this.initialValues.place.category==o.getId()&&i.attr("selected","selected"):o.isDefault()&&i.attr("selected","selected"),r.append(i)}this._bindCategoryChange()}return this.initialValues&&(t.find("input[name=placename]").attr("value",this.initialValues.place.name),t.find("input[name=placelink]").attr("value",this.initialValues.place.link),t.find("textarea[name=placedesc]").append(this.initialValues.place.desc)),t},getValues:function(){var e={},t=this._getOnScreenForm();if(t.length>0){var n=t.find("input[name=placename]").val(),r=t.find("input[name=placelink]").val();if(r){if(r.indexOf("://")==-1||r.indexOf("://")>6)r="http://"+r;r=r.replace("<",""),r=r.replace(">","")}var i=t.find("textarea[name=placedesc]").val(),s=t.find("select[name=category]").val();e.place={name:n,link:r,desc:i,category:s},this.placeId&&(e.place.id=this.placeId)}return this.categoryForm&&(e.category=this.categoryForm.getValues()),e},setValues:function(e){this.placeId=e.place.id;var t=this._getOnScreenForm();t.length>0&&(t.find("input[name=placename]").val(e.place.name),t.find("input[name=placelink]").val(e.place.link),t.find("textarea[name=placedesc]").val(e.place.desc),t.find("select[name=category]").val(e.place.category)),this.initialValues=e},_bindCategoryChange:function(){var e=this,t=this._getOnScreenForm();t.find("select[name=category]").live("change",function(){var t=jQuery(this).val(),n=e._getOnScreenForm();t==e.newCategoryId?(e.categoryForm=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.CategoryForm",e.instance),n.append(e.categoryForm.getForm())):e.categoryForm&&(e.categoryForm.destroy(),e.categoryForm=undefined)})},destroy:function(){var e=this._getOnScreenForm();e.find("select[name=category]").die(),this.categoryForm&&(this.categoryForm.destroy(),this.categoryForm=undefined)},_getOnScreenForm:function(){return jQuery("div.myplacesform")}}),define("bundles/framework/bundle/myplaces2/view/PlaceForm",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.view.CategoryForm",function(e){this.instance=e,jscolor.dir="/Oskari/libraries/jscolor/";var t=e.getLocalization("categoryform");this.template=jQuery('<div class="myplacescategoryform"><div class="field"><label for="categoryname">'+t.name.label+'</label><br clear="all" />'+'<input type="text" name="categoryname" placeholder="'+t.name.placeholder+'"/>'+"</div>"+'<div class="field drawing">'+"<label>"+t.drawing.label+'</label><br clear="all" />'+"<table></table>"+"</div>"+"</div>"),this.templateTableRow=jQuery("<tr></tr>"),this.templateTableCell=jQuery("<td></td>"),this.templateTextInput=jQuery('<input type="text"/>'),this.defaults={dotSize:4,dotColor:"cc9900",lineSize:2,lineColor:"cc9900",areaLineSize:2,areaLineColor:"cc9900",areaFillColor:"ffdc00"},this.categoryId=undefined,this._isDefault=undefined,this.initialValues=undefined},{getForm:function(){var e=this.template.clone(),t=e.find("div.drawing table");this._populatePointTool(t),this._populateLineTool(t),this._populateAreaTool(t);if(this.initialValues){e.find("input[name=categoryname]").attr("value",this.initialValues.name),e.find("input[name=dotSize]").attr("value",this.initialValues.dot.size);var n=e.find("input[name=dotColor]");n.attr("value",this.initialValues.dot.color),new jscolor.color(n[0]),e.find("input[name=lineSize]").attr("value",this.initialValues.line.size);var r=e.find("input[name=lineColor]");r.attr("value",this.initialValues.line.color),new jscolor.color(r[0]),e.find("input[name=areaLineSize]").attr("value",this.initialValues.area.size);var i=e.find("input[name=areaLineColor]");i.attr("value",this.initialValues.area.lineColor),new jscolor.color(i[0]);var s=e.find("input[name=areaFillColor]");s.attr("value",this.initialValues.area.fillColor),new jscolor.color(s[0])}return e},getValues:function(){var e={},t=this._getOnScreenForm();if(t.length>0){var n=t.find("input[name=categoryname]").val();e.name=n,this.categoryId&&(e.id=this.categoryId),e._isDefault=this._isDefault||!1;var r=t.find("input[name=dotSize]").val(),i=t.find("input[name=dotColor]").val();e.dot={size:r,color:i};var s=t.find("input[name=lineSize]").val(),o=t.find("input[name=lineColor]").val();e.line={size:s,color:o};var u=t.find("input[name=areaLineSize]").val(),a=t.find("input[name=areaLineColor]").val(),f=t.find("input[name=areaFillColor]").val();e.area={size:u,lineColor:a,fillColor:f}}return e},setValues:function(e){this.categoryId=e.id,this._isDefault=e._isDefault;var t=this._getOnScreenForm();t.length>0&&(t.find("input[name=categoryname]").val(e.name),t.find("input[name=dotSize]").val(e.dot.size),t.find("input[name=dotColor]").val(e.dot.color),t.find("input[name=lineSize]").val(e.line.size),t.find("input[name=lineColor]").val(e.line.color),t.find("input[name=areaLineSize]").val(e.area.size),t.find("input[name=areaLineColor]").val(e.area.lineColor),t.find("input[name=areaFillColor]").val(e.area.fillColor)),this.initialValues=e},_createInput:function(e,t,n){var r=this.templateTextInput.clone();return r.attr("name",e),r.attr("value",t),n&&r.attr("class",n),n=="oskaricolor"&&(r.picker=new jscolor.color(r[0])),r},_populatePointTool:function(e){var t=this.instance.getLocalization("categoryform").drawing.point,n=this.templateTableRow.clone();for(var r in t){var i=this.templateTableCell.clone();i.append(t[r]),n.append(i)}n.append(this.templateTableCell.clone());var s=this.templateTableRow.clone();s.append(this.templateTableCell.clone());var o=this.templateTableCell.clone();o.append(this._createInput("dotColor",this.defaults.dotColor,"oskaricolor")),s.append(o);var u=this.templateTableCell.clone();u.append(this._createInput("dotSize",this.defaults.dotSize)),s.append(u),s.append(this.templateTableCell.clone()),e.append(n),e.append(s)},_populateLineTool:function(e){var t=this.instance.getLocalization("categoryform").drawing.line,n=this.templateTableRow.clone();for(var r in t){var i=this.templateTableCell.clone();i.append(t[r]),n.append(i)}n.append(this.templateTableCell.clone());var s=this.templateTableRow.clone();s.append(this.templateTableCell.clone());var o=this.templateTableCell.clone();o.append(this._createInput("lineColor",this.defaults.lineColor,"oskaricolor")),s.append(o);var u=this.templateTableCell.clone();u.append(this._createInput("lineSize",this.defaults.lineSize)),s.append(u),s.append(this.templateTableCell.clone()),e.append(n),e.append(s)},_populateAreaTool:function(e){var t=this.instance.getLocalization("categoryform").drawing.area,n=this.templateTableRow.clone();for(var r in t){var i=this.templateTableCell.clone();i.append(t[r]),n.append(i)}var s=this.templateTableRow.clone();s.append(this.templateTableCell.clone());var o=this.templateTableCell.clone();o.append(this._createInput("areaFillColor",this.defaults.areaFillColor,"oskaricolor")),s.append(o);var u=this.templateTableCell.clone();u.append(this._createInput("areaLineColor",this.defaults.areaLineColor,"oskaricolor")),s.append(u);var a=this.templateTableCell.clone();a.append(this._createInput("areaLineSize",this.defaults.areaLineSize)),s.append(a),e.append(n),e.append(s)},_getOnScreenForm:function(){return jQuery("div.myplacescategoryform")},destroy:function(){var e=this._getOnScreenForm();e.remove()}}),define("bundles/framework/bundle/myplaces2/view/CategoryForm",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.ButtonHandler",function(e){this.instance=e,this.buttonGroup="myplaces",this.ignoreEvents=!1,this.dialog=null;var t=this;this.buttons={point:{iconCls:"myplaces-draw-point",tooltip:"",sticky:!0,callback:function(){t.startNewDrawing({drawMode:"point"})}},line:{iconCls:"myplaces-draw-line",tooltip:"",sticky:!0,callback:function(){t.startNewDrawing({drawMode:"line"})}},area:{iconCls:"myplaces-draw-area",tooltip:"",sticky:!0,callback:function(){t.startNewDrawing({drawMode:"area"})}}},this.templateGuide=jQuery('<div><div class="guide"></div><div class="buttons"><div class="cancel button"></div><div class="finish button"></div></div></div>')},{__name:"MyPlacesButtonHandler",getName:function(){return this.__name},init:function(){var e=this.instance.getLocalization("tools"),t=this.instance.sandbox.getUser(),n=" - "+this.instance.getLocalization("guest").loginShort;for(var r in this.buttons){var i=e[r].tooltip;t.isLoggedIn()||(i+=n),this.buttons[r].tooltip=i}},start:function(){var e=this,t=this.instance.sandbox;t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p);var n=t.getRequestBuilder("Toolbar.AddToolButtonRequest");for(var r in this.buttons)t.request(this,n(r,this.buttonGroup,this.buttons[r]));var i=this.instance.sandbox.getUser();i.isLoggedIn()||this.disableButtons()},disableButtons:function(){var e=this.instance.sandbox,t=e.getRequestBuilder("Toolbar.ToolButtonStateRequest");e.request(this,t(undefined,this.buttonGroup,!1))},startNewDrawing:function(e){var t=this.instance.sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")();this.instance.sandbox.notifyAll(t),this.sendDrawRequest(e),this.instance.enableGfi(!1)},sendDrawRequest:function(e){var t=this,n=this.instance.sandbox.getRequestBuilder("MyPlaces.StartDrawingRequest")(e);this.instance.sandbox.request(this,n),e.geometry||this._showDrawHelper(e.drawMode)},_showDrawHelper:function(e){var t=this,n=this.instance.getLocalization("tools")[e],r=this.instance.getLocalization("buttons"),i=this.instance.getLocalization("title"),s=n["new"],o=Oskari.clazz.create("Oskari.userinterface.component.Popup");this.dialog=o;var u=[],a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(r.cancel),a.setHandler(function(){var e=t.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();t.instance.sandbox.request(t,e),t.sendStopDrawRequest(!0)}),u.push(a);var f=Oskari.clazz.create("Oskari.userinterface.component.Button");f.setTitle(r.finish),f.addClass("primary"),f.setHandler(function(){t.sendStopDrawRequest()}),u.push(f),o.show(i,s,u),o.addClass("myplaces2"),o.moveTo("#toolbar div.toolrow[tbgroup=myplaces]","top")},sendStopDrawRequest:function(e){var t=this,n=this.instance.sandbox.getRequestBuilder("MyPlaces.StopDrawingRequest")(e);this.instance.sandbox.request(this,n),this.dialog&&this.dialog.close()},stop:function(){jQuery("div.myplaces2 div.button").die()},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{"Toolbar.ToolSelectedEvent":function(e){this.ignoreEvents||(this.sendStopDrawRequest(!0),this.instance.enableGfi(!0))},"MyPlaces.MyPlaceSelectedEvent":function(e){if(!e.getPlace()){var t=this.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();this.instance.sandbox.request(this,t)}},"MyPlaces.FinishedDrawingEvent":function(e){this.ignoreEvents=!0;var t=this.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();this.instance.sandbox.request(this,t),this.ignoreEvents=!1,this.instance.enableGfi(!1),this.dialog&&this.dialog.close()},"MyPlaces.AddedFeatureEvent":function(e){if(typeof e.getDrawingMode()!="undefined"&&e.getDrawingMode()!==null){var t=this.instance.getLocalization("tools"),n=t[e.getDrawingMode()].next;this.dialog.getContent()!==n&&(this.dialog.setContent(n),this.dialog.moveTo("#toolbar div.toolrow[tbgroup=myplaces]","top"))}}}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/myplaces2/ButtonHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.CategoryHandler",function(e){this.instance=e,this.initialLoad=!0,this.validateTool=Oskari.clazz.create("Oskari.userinterface.component.FormInput")},{__name:"MyPlacesCategoryHandler",getName:function(){return this.__name},init:function(){},start:function(){var e=this,t=this.instance.sandbox,n=t.getUser();if(n.isLoggedIn()){t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p)}},stop:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{"MyPlaces.MyPlacesChangedEvent":function(e){this._handlePlacesChanged()}},_handlePlacesChanged:function(){var e=this.instance.sandbox,t=e.getService("Oskari.mapframework.service.MapLayerService"),n=this.instance.getService().getAllCategories(),r=t.getAllLayersByMetaType(this.instance.idPrefix);for(var i=0;i<r.length;++i){var s=r[i],o=!1;for(var u=0;u<n.length;++u){var a=n[u];this._getMapLayerId(a.getId())===s.getId()&&(o=!0)}o||(e.requestByName(this.getName(),"RemoveMapLayerRequest",[s.getId()]),t.removeLayer(s.getId()))}for(var u=0;u<n.length;++u){var a=n[u],o=!1;for(var i=0;i<r.length;++i)if(this._getMapLayerId(a.getId())===r[i].getId()){o=!0;if(a.getName()!==r[i].getName()){var f={name:a.getName()};t.updateLayer(r[i].getId(),f)}}if(!o){var l=this._getMapLayerJson(a),c=t.createMapLayer(l);t.addLayer(c)}}this.initialLoad&&(this._processStartupLinkLayers(e),this.initialLoad=!1)},addLayerToMap:function(e){var t=this._getMapLayerId(e),n=this.sandbox.findMapLayerFromSelectedMapLayers(t);if(!n){var r=this.sandbox.getRequestBuilder("AddMapLayerRequest")(t,!0);this.sandbox.request(this.getName(),r)}},addLayerToService:function(e){var t=this._sandbox.getService("Oskari.mapframework.service.MapLayerService"),n=this._getMapLayerJson(e),r=t.createMapLayer(n);t.addLayer(r)},_getMapLayerId:function(e){if(!e){var t=this.myPlacesService.getDefaultCategory();t?e=t.getId():e="-99"}return this.instance.idPrefix+"_"+e},_getMapLayerJson:function(e){var t=this._getMapLayerJsonBase();return t.wmsUrl=this.instance.conf.wmsUrl+e.getId()+"&",t.name=e.getName(),t.id=this._getMapLayerId(e.getId()),e.isPublic()?t.permissions={publish:"publication_permission_ok"}:t.permissions={publish:"no_publication_permission"},t},_getMapLayerJsonBase:function(){var e=this.instance.getLocalization("category"),t={wmsName:"ows:my_places_categories",type:"wmslayer",isQueryable:!0,opacity:50,metaType:this.instance.idPrefix,orgName:e.organization,inspire:e.inspire};return t},_processStartupLinkLayers:function(e){var t=e.getRequestParameter("mapLayers");if(t===null||t==="")return;var n=t.split(","),r=!0;for(var i=0;i<n.length;i++){var s=n[i].split("+"),o=s[0],u=s[1];if(o!==null&&o.indexOf(this.instance.idPrefix)!==-1){var a=null,f=null;a=e.getRequestBuilder("AddMapLayerRequest"),f=a(o,r),e.request(this.getName(),f),a=e.getRequestBuilder("ChangeMapLayerOpacityRequest"),f=a(o,u),e.request(this.getName(),f)}}},editCategory:function(e){var t=this;this.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest");var n=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.CategoryForm",t.instance),r={name:e.getName(),id:e.getId(),_isDefault:e.isDefault(),dot:{size:e.getDotSize(),color:e.getDotColor()},line:{size:e.getLineWidth(),color:e.getLineColor()},area:{size:e.getAreaLineWidth(),lineColor:e.getAreaLineColor(),fillColor:e.getAreaFillColor()}};n.setValues(r);var i=n.getForm(),s=Oskari.clazz.create("Oskari.userinterface.component.Popup"),o=[],u=Oskari.clazz.create("Oskari.userinterface.component.Button"),a=this.instance.getLocalization("buttons"),f=this.instance.getLocalization("categoryform").edit;u.setTitle(a.save),u.addClass("primary"),u.setHandler(function(){var e=n.getValues(),r=t.validateCategoryFormValues(e);if(r.length!=0){t.showValidationErrorMessage(r);return}var i=t.getCategoryFromFormValues(e);t.saveCategory(i),s.close(),t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var l=Oskari.clazz.create("Oskari.userinterface.component.Button");l.setTitle(a.cancel),l.setHandler(function(){s.close()}),o.push(l),o.push(u),s.show(f.title,i,o),s.moveTo("div.personaldata ul li select","right"),s.makeModal()},showValidationErrorMessage:function(e){var t=this.instance.getLocalization(),n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=Oskari.clazz.create("Oskari.userinterface.component.Button");r.setTitle(t.buttons.ok),r.addClass("primary"),r.setHandler(function(){n.close(!0)});var i=jQuery("<ul></ul>");for(var s=0;s<e.length;++s){var o=jQuery("<li></li>");o.append(e[s].error),i.append(o)}n.show(t.validation.title,i,[r])},_showMessage:function(e,t){var n=this.instance.getLocalization(),r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(n.buttons.ok),i.addClass("primary"),i.setHandler(function(){r.close(!0)}),r.show(e,t,[i])},hasIllegalChars:function(e){return this.validateTool.setValue(e),!this.validateTool.checkValue()},_validateNumber:function(e,t,n){return this.validateTool.validateNumberRange(e,t,n)},_isColor:function(e){return this.validateTool.validateHexColor(e)},validateCategoryFormValues:function(e){var t=[];if(!e)return t;var n=this.instance.getLocalization("validation");return e.name?this.hasIllegalChars(e.name)&&t.push({field:"name",error:n.categoryNameIllegal}):t.push({field:"name",error:n.categoryName}),this._validateNumber(e.dot.size,1,50)||t.push({field:"dotSize",error:n.dotSize}),this._isColor(e.dot.color)||t.push({field:"dotColor",error:n.dotColor}),this._validateNumber(e.line.size,1,50)||t.push({field:"lineSize",error:n.lineSize}),this._isColor(e.line.color)||t.push({field:"lineColor",error:n.lineColor}),this._validateNumber(e.area.size,0,50)||t.push({field:"areaLineSize",error:n.areaLineSize}),this._isColor(e.area.lineColor)||t.push({field:"areaLineColor",error:n.areaLineColor}),this._isColor(e.area.fillColor)||t.push({field:"areaFillColor",error:n.areaFillColor}),t},getCategoryFromFormValues:function(e){var t=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.model.MyPlacesCategory");return t.setName(e.name),t.setId(e.id),t.setDotSize(e.dot.size),t.setDotColor(e.dot.color),t.setLineWidth(e.line.size),t.setLineColor(e.line.color),t.setAreaLineWidth(e.area.size),t.setAreaLineColor(e.area.lineColor),t.setAreaFillColor(e.area.fillColor),t.setDefault(e._isDefault),t},saveCategory:function(e){var t=this,n=t.instance.getLocalization("notification"),r=function(r,i,s){if(r){var o=Oskari.clazz.create("Oskari.userinterface.component.Popup");o.show(n.categorySaved.title,n.categorySaved.message),o.fadeout();var u=t._getMapLayerId(e.getId()),a=t.instance.sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(u,!0);t.instance.sandbox.request(t,a)}else s?t.instance.showMessage(n.error.title,n.error.addCategory):t.instance.showMessage(n.error.title,n.error.editCategory)};this.instance.getService().saveCategory(e,r)},confirmDeleteCategory:function(e){var t=this,n=t.instance.getLocalization("buttons"),r=this.instance.getService(),i=r.getDefaultCategory(),s=Oskari.clazz.create("Oskari.userinterface.component.Popup");if(i.getId()==e.getId()){var o=t.instance.getLocalization(),u=s.createCloseButton(o.buttons.ok);s.show(o.notification.error.title,o.notification.error.deleteDefault,[u]);return}var a=r.getPlacesInCategory(e.getId()),f=[],l=s.createCloseButton(n.cancel);f.push(l);var o=t.instance.getLocalization("notification"),c="";if(a.length>0){var h=Oskari.clazz.create("Oskari.userinterface.component.Button");h.setTitle(n.deleteCategoryAndPlaces),h.setHandler(function(){s.close(),t._deleteCategory(e,!1)}),f.push(h);var p=Oskari.clazz.create("Oskari.userinterface.component.Button");p.setTitle(n.movePlaces),p.addClass("primary"),p.setHandler(function(){s.close(),t._deleteCategory(e,!0)}),f.push(p);var d=[e.getName(),a.length,i.getName()];c=this._formatMessage(o.categoryDelete.deleteConfirmMove,d)}else{var h=Oskari.clazz.create("Oskari.userinterface.component.Button");h.setTitle(n.deleteCategory),h.addClass("primary"),f.push(h),h.setHandler(function(){s.close(),t._deleteCategory(e,!1)}),c=this._formatMessage(o.categoryDelete.deleteConfirm,[e.getName()])}s.show(o.categoryDelete.title,c,f),s.makeModal()},_formatMessage:function(e,t){var n=e;for(var r=0;r<t.length;++r)n=n.replace("{"+r+"}",t[r]);return n},_deleteCategory:function(e,t){var n=this,r=e.getId(),i=function(e){n._deleteCategoryCallback(e,t,r)},s=this.instance.getService();s.deleteCategory(r,t,i)},_deleteCategoryCallback:function(e,t,n){var r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=this.instance.getService(),s=this;if(e){if(t){var o=i.getDefaultCategory(),u=this._getMapLayerId(o.getId()),a=this.instance.sandbox.getRequestBuilder("MapModulePlugin.MapLayerUpdateRequest")(u,!0);this.instance.sandbox.request(this,a)}var f=s.instance.getLocalization();r.show(f.notification.categoryDelete.title,f.notification.categoryDelete.deleted),r.fadeout()}else{var f=s.instance.getLocalization(),l=r.createCloseButton(btnLoc.buttons.ok);r.show(f.notification.error.title,f.notification.error.deleteCategory,[l])}},confirmPublishCategory:function(e,t){var n=this,r=n.instance.getLocalization(),i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=this.instance.getService(),o=[],u=i.createCloseButton(r.buttons.cancel);o.push(u);var a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.addClass("primary"),a.setHandler(function(){s.publishCategory(e.getId(),t,function(r){n._handlePublishCategory(e,t,r)}),i.close()}),o.push(a);var f=[e.getName()];if(t){a.setTitle(r.buttons.changeToPublic);var l=this._formatMessage(r.notification.categoryToPublic.message,f);i.show(r.notification.categoryToPublic.title,l,o)}else{a.setTitle(r.buttons.changeToPrivate);var l=this._formatMessage(r.notification.categoryToPrivate.message,f);i.show(r.notification.categoryToPrivate.title,l,o)}},_handlePublishCategory:function(e,t,n){if(!n){var r=this.instance.getLocalization("notification");this._showMessage(r.error.title,r.error.generic);return}var i=this.instance.sandbox,s=i.getService("Oskari.mapframework.service.MapLayerService"),o=this._getMapLayerId(e.getId()),u=s.findMapLayer(o);if(!u){var r=this.instance.getLocalization("notification");this._showMessage(r.error.title,r.error.generic);return}t?u.addPermission("publish","publication_permission_ok"):u.addPermission("publish","no_publication_permission");var a=i.getEventBuilder("MapLayerEvent")(o,"update");i.notifyAll(a)}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/myplaces2/CategoryHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.myplaces2.MyPlacesBundleInstance",function(){this._localization=null,this.sandbox=null,this.buttons=undefined,this.categoryHandler=undefined,this.myPlacesService=undefined,this.idPrefix="myplaces"},{__name:"MyPlaces2",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization&&this._localization[e]?this._localization[e]:e:this._localization},showMessage:function(e,t){var n=this.getLocalization(),r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(n.buttons.ok),i.addClass("primary"),i.setHandler(function(){r.close(!0)}),r.show(e,t,[i])},forceDisable:function(){this.buttons.disableButtons();var e=this.getLocalization();this.showMessage(e.category.organization+" - "+e.notification.error.title,e.notification.error.generic)},enableGfi:function(e){var t=this.sandbox.getRequestBuilder("MapModulePlugin.GetFeatureInfoActivationRequest");t&&this.sandbox.request(this.buttons,t(e))},getService:function(){return this.myPlacesService},getDrawPlugin:function(){return this.view.drawPlugin},getCategoryHandler:function(){return this.categoryHandler},getMainView:function(){return this.view},update:function(){},start:function(){var e=this,t=e.conf,n=(t?t.sandbox:null)||"sandbox",r=Oskari.getSandbox(n);this.sandbox=r;var e=this;r.printDebug("Initializing my places module..."),this.buttons=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.ButtonHandler",this),this.buttons.start();var i=r.getUser();if(!i.isLoggedIn())return;this.categoryHandler=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.CategoryHandler",this),this.categoryHandler.start();var s=this.getLocalization("category").defaultName,o=this.conf.queryUrl;this.myPlacesService=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.service.MyPlacesService",o,i.getUuid(),r,s,this),this.sandbox.registerService(this.myPlacesService),this.myPlacesService.init(),this.view=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.view.MainView",this),this.view.start(),this.editRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces2.request.EditRequestHandler",r,e),r.addRequestHandler("MyPlaces.EditPlaceRequest",this.editRequestHandler),r.addRequestHandler("MyPlaces.EditCategoryRequest",this.editRequestHandler),r.addRequestHandler("MyPlaces.DeleteCategoryRequest",this.editRequestHandler),r.addRequestHandler("MyPlaces.PublishCategoryRequest",this.editRequestHandler)},stop:function(){this.sandbox=null}},{protocol:["Oskari.bundle.BundleInstance"]}),define("bundles/framework/bundle/myplaces2/instance",function(){});var jscolor={dir:"",bindClass:"color",binding:!0,preloading:!0,install:function(){jscolor.addEvent(window,"load",jscolor.init)},init:function(){jscolor.binding&&jscolor.bind(),jscolor.preloading&&jscolor.preload()},getDir:function(){if(!jscolor.dir){var e=jscolor.detectDir();jscolor.dir=e!==!1?e:"jscolor/"}return jscolor.dir},detectDir:function(){var e=location.href,t=document.getElementsByTagName("base");for(var n=0;n<t.length;n+=1)t[n].href&&(e=t[n].href);var t=document.getElementsByTagName("script");for(var n=0;n<t.length;n+=1)if(t[n].src&&/(^|\/)jscolor\.js([?#].*)?$/i.test(t[n].src)){var r=new jscolor.URI(t[n].src),i=r.toAbsolute(e);return i.path=i.path.replace(/[^\/]+$/,""),i.query=null,i.fragment=null,i.toString()}return!1},bind:function(){var matchClass=new RegExp("(^|\\s)("+jscolor.bindClass+")\\s*(\\{[^}]*\\})?","i"),e=document.getElementsByTagName("input");for(var i=0;i<e.length;i+=1){var m;if(!e[i].color&&e[i].className&&(m=e[i].className.match(matchClass))){var prop={};if(m[3])try{eval("prop="+m[3])}catch(eInvalidProp){}e[i].color=new jscolor.color(e[i],prop)}}},preload:function(){for(var e in jscolor.imgRequire)jscolor.imgRequire.hasOwnProperty(e)&&jscolor.loadImage(e)},images:{pad:[181,101],sld:[16,101],cross:[15,15],arrow:[7,11]},imgRequire:{},imgLoaded:{},requireImage:function(e){jscolor.imgRequire[e]=!0},loadImage:function(e){jscolor.imgLoaded[e]||(jscolor.imgLoaded[e]=new Image,jscolor.imgLoaded[e].src=jscolor.getDir()+e)},fetchElement:function(e){return typeof e=="string"?document.getElementById(e):e},addEvent:function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n)},fireEvent:function(e,t){if(!e)return;if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!0),e.dispatchEvent(n)}else if(document.createEventObject){var n=document.createEventObject();e.fireEvent("on"+t,n)}else e["on"+t]&&e["on"+t]()},getElementPos:function(e){var t=e,n=e,r=0,i=0;if(t.offsetParent)do r+=t.offsetLeft,i+=t.offsetTop;while(t=t.offsetParent);while((n=n.parentNode)&&n.nodeName.toUpperCase()!=="BODY")r-=n.scrollLeft,i-=n.scrollTop;return[r,i]},getElementSize:function(e){return[e.offsetWidth,e.offsetHeight]},getRelMousePos:function(e){var t=0,n=0;return e||(e=window.event),typeof e.offsetX=="number"?(t=e.offsetX,n=e.offsetY):typeof e.layerX=="number"&&(t=e.layerX,n=e.layerY),{x:t,y:n}},getViewPos:function(){return typeof window.pageYOffset=="number"?[window.pageXOffset,window.pageYOffset]:document.body&&(document.body.scrollLeft||document.body.scrollTop)?[document.body.scrollLeft,document.body.scrollTop]:document.documentElement&&(document.documentElement.scrollLeft||document.documentElement.scrollTop)?[document.documentElement.scrollLeft,document.documentElement.scrollTop]:[0,0]},getViewSize:function(){return typeof window.innerWidth=="number"?[window.innerWidth,window.innerHeight]:document.body&&(document.body.clientWidth||document.body.clientHeight)?[document.body.clientWidth,document.body.clientHeight]:document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)?[document.documentElement.clientWidth,document.documentElement.clientHeight]:[0,0]},URI:function(e){function t(e){var t="";while(e)if(e.substr(0,3)==="../"||e.substr(0,2)==="./")e=e.replace(/^\.+/,"").substr(1);else if(e.substr(0,3)==="/./"||e==="/.")e="/"+e.substr(3);else if(e.substr(0,4)==="/../"||e==="/..")e="/"+e.substr(4),t=t.replace(/\/?[^\/]*$/,"");else if(e==="."||e==="..")e="";else{var n=e.match(/^\/?[^\/]*/)[0];e=e.substr(n.length),t+=n}return t}this.scheme=null,this.authority=null,this.path="",this.query=null,this.fragment=null,this.parse=function(e){var t=e.match(/^(([A-Za-z][0-9A-Za-z+.-]*)(:))?((\/\/)([^\/?#]*))?([^?#]*)((\?)([^#]*))?((#)(.*))?/);return this.scheme=t[3]?t[2]:null,this.authority=t[5]?t[6]:null,this.path=t[7],this.query=t[9]?t[10]:null,this.fragment=t[12]?t[13]:null,this},this.toString=function(){var e="";return this.scheme!==null&&(e=e+this.scheme+":"),this.authority!==null&&(e=e+"//"+this.authority),this.path!==null&&(e+=this.path),this.query!==null&&(e=e+"?"+this.query),this.fragment!==null&&(e=e+"#"+this.fragment),e},this.toAbsolute=function(e){var e=new jscolor.URI(e),n=this,r=new jscolor.URI;return e.scheme===null?!1:(n.scheme!==null&&n.scheme.toLowerCase()===e.scheme.toLowerCase()&&(n.scheme=null),n.scheme!==null?(r.scheme=n.scheme,r.authority=n.authority,r.path=t(n.path),r.query=n.query):(n.authority!==null?(r.authority=n.authority,r.path=t(n.path),r.query=n.query):(n.path===""?(r.path=e.path,n.query!==null?r.query=n.query:r.query=e.query):(n.path.substr(0,1)==="/"?r.path=t(n.path):(e.authority!==null&&e.path===""?r.path="/"+n.path:r.path=e.path.replace(/[^\/]+$/,"")+n.path,r.path=t(r.path)),r.query=n.query),r.authority=e.authority),r.scheme=e.scheme),r.fragment=n.fragment,r)},e&&this.parse(e)},color:function(target,prop){function RGB_HSV(e,t,n){var r=Math.min(Math.min(e,t),n),i=Math.max(Math.max(e,t),n),s=i-r;if(s===0)return[null,0,i];var o=e===r?3+(n-t)/s:t===r?5+(e-n)/s:1+(t-e)/s;return[o===6?0:o,s/i,i]}function HSV_RGB(e,t,n){if(e===null)return[n,n,n];var r=Math.floor(e),i=r%2?e-r:1-(e-r),s=n*(1-t),o=n*(1-t*i);switch(r){case 6:case 0:return[n,o,s];case 1:return[o,n,s];case 2:return[s,n,o];case 3:return[s,o,n];case 4:return[o,s,n];case 5:return[n,s,o]}}function removePicker(){delete jscolor.picker.owner,document.getElementsByTagName("body")[0].removeChild(jscolor.picker.boxB)}function drawPicker(e,t){function a(){var e=THIS.pickerInsetColor.split(/\s+/),t=e.length<2?e[0]:e[1]+" "+e[0]+" "+e[0]+" "+e[1];s.btn.style.borderColor=t}if(!jscolor.picker){jscolor.picker={box:document.createElement("div"),boxB:document.createElement("div"),pad:document.createElement("div"),padB:document.createElement("div"),padM:document.createElement("div"),sld:document.createElement("div"),sldB:document.createElement("div"),sldM:document.createElement("div"),btn:document.createElement("div"),btnS:document.createElement("span"),btnT:document.createTextNode(THIS.pickerCloseText)};for(var n=0,r=4;n<jscolor.images.sld[1];n+=r){var i=document.createElement("div");i.style.height=r+"px",i.style.fontSize="1px",i.style.lineHeight="0",jscolor.picker.sld.appendChild(i)}jscolor.picker.sldB.appendChild(jscolor.picker.sld),jscolor.picker.box.appendChild(jscolor.picker.sldB),jscolor.picker.box.appendChild(jscolor.picker.sldM),jscolor.picker.padB.appendChild(jscolor.picker.pad),jscolor.picker.box.appendChild(jscolor.picker.padB),jscolor.picker.box.appendChild(jscolor.picker.padM),jscolor.picker.btnS.appendChild(jscolor.picker.btnT),jscolor.picker.btn.appendChild(jscolor.picker.btnS),jscolor.picker.box.appendChild(jscolor.picker.btn),jscolor.picker.boxB.appendChild(jscolor.picker.box)}var s=jscolor.picker;s.box.onmouseup=s.box.onmouseout=function(){target.focus()},s.box.onmousedown=function(){abortBlur=!0},s.box.onmousemove=function(e){if(holdPad||holdSld)holdPad&&setPad(e),holdSld&&setSld(e),document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges(),dispatchImmediateChange()},s.padM.onmouseup=s.padM.onmouseout=function(){holdPad&&(holdPad=!1,jscolor.fireEvent(valueElement,"change"))},s.padM.onmousedown=function(e){switch(modeID){case 0:THIS.hsv[2]===0&&THIS.fromHSV(null,null,1);break;case 1:THIS.hsv[1]===0&&THIS.fromHSV(null,1,null)}holdPad=!0,setPad(e),dispatchImmediateChange()},s.sldM.onmouseup=s.sldM.onmouseout=function(){holdSld&&(holdSld=!1,jscolor.fireEvent(valueElement,"change"))},s.sldM.onmousedown=function(e){holdSld=!0,setSld(e),dispatchImmediateChange()};var o=getPickerDims(THIS);s.box.style.width=o[0]+"px",s.box.style.height=o[1]+"px",s.boxB.style.position="absolute",s.boxB.style.clear="both",s.boxB.style.left=e+"px",s.boxB.style.top=t+"px",s.boxB.style.zIndex=THIS.pickerZIndex,s.boxB.style.border=THIS.pickerBorder+"px solid",s.boxB.style.borderColor=THIS.pickerBorderColor,s.boxB.style.background=THIS.pickerFaceColor,s.pad.style.width=jscolor.images.pad[0]+"px",s.pad.style.height=jscolor.images.pad[1]+"px",s.padB.style.position="absolute",s.padB.style.left=THIS.pickerFace+"px",s.padB.style.top=THIS.pickerFace+"px",s.padB.style.border=THIS.pickerInset+"px solid",s.padB.style.borderColor=THIS.pickerInsetColor,s.padM.style.position="absolute",s.padM.style.left="0",s.padM.style.top="0",s.padM.style.width=THIS.pickerFace+2*THIS.pickerInset+jscolor.images.pad[0]+jscolor.images.arrow[0]+"px",s.padM.style.height=s.box.style.height,s.padM.style.cursor="crosshair",s.sld.style.overflow="hidden",s.sld.style.width=jscolor.images.sld[0]+"px",s.sld.style.height=jscolor.images.sld[1]+"px",s.sldB.style.display=THIS.slider?"block":"none",s.sldB.style.position="absolute",s.sldB.style.right=THIS.pickerFace+"px",s.sldB.style.top=THIS.pickerFace+"px",s.sldB.style.border=THIS.pickerInset+"px solid",s.sldB.style.borderColor=THIS.pickerInsetColor,s.sldM.style.display=THIS.slider?"block":"none",s.sldM.style.position="absolute",s.sldM.style.right="0",s.sldM.style.top="0",s.sldM.style.width=jscolor.images.sld[0]+jscolor.images.arrow[0]+THIS.pickerFace+2*THIS.pickerInset+"px",s.sldM.style.height=s.box.style.height;try{s.sldM.style.cursor="pointer"}catch(u){s.sldM.style.cursor="hand"}s.btn.style.display=THIS.pickerClosable?"block":"none",s.btn.style.position="absolute",s.btn.style.left=THIS.pickerFace+"px",s.btn.style.bottom=THIS.pickerFace+"px",s.btn.style.padding="0 15px",s.btn.style.height="18px",s.btn.style.border=THIS.pickerInset+"px solid",a(),s.btn.style.color=THIS.pickerButtonColor,s.btn.style.font="12px sans-serif",s.btn.style.textAlign="center";try{s.btn.style.cursor="pointer"}catch(u){s.btn.style.cursor="hand"}s.btn.onmousedown=function(){THIS.hidePicker()},s.btnS.style.lineHeight=s.btn.style.height;switch(modeID){case 0:var f="hs.png";break;case 1:var f="hv.png"}s.padM.style.backgroundImage="url('"+jscolor.getDir()+"cross.gif')",s.padM.style.backgroundRepeat="no-repeat",s.sldM.style.backgroundImage="url('"+jscolor.getDir()+"arrow.gif')",s.sldM.style.backgroundRepeat="no-repeat",s.pad.style.backgroundImage="url('"+jscolor.getDir()+f+"')",s.pad.style.backgroundRepeat="no-repeat",s.pad.style.backgroundPosition="0 0",redrawPad(),redrawSld(),jscolor.picker.owner=THIS,document.getElementsByTagName("body")[0].appendChild(s.boxB)}function getPickerDims(e){var t=[2*e.pickerInset+2*e.pickerFace+jscolor.images.pad[0]+(e.slider?2*e.pickerInset+2*jscolor.images.arrow[0]+jscolor.images.sld[0]:0),e.pickerClosable?4*e.pickerInset+3*e.pickerFace+jscolor.images.pad[1]+e.pickerButtonHeight:2*e.pickerInset+2*e.pickerFace+jscolor.images.pad[1]];return t}function redrawPad(){switch(modeID){case 0:var e=1;break;case 1:var e=2}var t=Math.round(THIS.hsv[0]/6*(jscolor.images.pad[0]-1)),n=Math.round((1-THIS.hsv[e])*(jscolor.images.pad[1]-1));jscolor.picker.padM.style.backgroundPosition=THIS.pickerFace+THIS.pickerInset+t-Math.floor(jscolor.images.cross[0]/2)+"px "+(THIS.pickerFace+THIS.pickerInset+n-Math.floor(jscolor.images.cross[1]/2))+"px";var r=jscolor.picker.sld.childNodes;switch(modeID){case 0:var i=HSV_RGB(THIS.hsv[0],THIS.hsv[1],1);for(var s=0;s<r.length;s+=1)r[s].style.backgroundColor="rgb("+i[0]*(1-s/r.length)*100+"%,"+i[1]*(1-s/r.length)*100+"%,"+i[2]*(1-s/r.length)*100+"%)";break;case 1:var i,o,u=[THIS.hsv[2],0,0],s=Math.floor(THIS.hsv[0]),a=s%2?THIS.hsv[0]-s:1-(THIS.hsv[0]-s);switch(s){case 6:case 0:i=[0,1,2];break;case 1:i=[1,0,2];break;case 2:i=[2,0,1];break;case 3:i=[2,1,0];break;case 4:i=[1,2,0];break;case 5:i=[0,2,1]}for(var s=0;s<r.length;s+=1)o=1-1/(r.length-1)*s,u[1]=u[0]*(1-o*a),u[2]=u[0]*(1-o),r[s].style.backgroundColor="rgb("+u[i[0]]*100+"%,"+u[i[1]]*100+"%,"+u[i[2]]*100+"%)"}}function redrawSld(){switch(modeID){case 0:var e=2;break;case 1:var e=1}var t=Math.round((1-THIS.hsv[e])*(jscolor.images.sld[1]-1));jscolor.picker.sldM.style.backgroundPosition="0 "+(THIS.pickerFace+THIS.pickerInset+t-Math.floor(jscolor.images.arrow[1]/2))+"px"}function isPickerOwner(){return jscolor.picker&&jscolor.picker.owner===THIS}function blurTarget(){valueElement===target&&THIS.importColor(),THIS.pickerOnfocus&&THIS.hidePicker()}function blurValue(){valueElement!==target&&THIS.importColor()}function setPad(e){var t=jscolor.getRelMousePos(e),n=t.x-THIS.pickerFace-THIS.pickerInset,r=t.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(n*(6/(jscolor.images.pad[0]-1)),1-r/(jscolor.images.pad[1]-1),null,leaveSld);break;case 1:THIS.fromHSV(n*(6/(jscolor.images.pad[0]-1)),null,1-r/(jscolor.images.pad[1]-1),leaveSld)}}function setSld(e){var t=jscolor.getRelMousePos(e),n=t.y-THIS.pickerFace-THIS.pickerInset;switch(modeID){case 0:THIS.fromHSV(null,null,1-n/(jscolor.images.sld[1]-1),leavePad);break;case 1:THIS.fromHSV(null,1-n/(jscolor.images.sld[1]-1),null,leavePad)}}function dispatchImmediateChange(){THIS.onImmediateChange&&(typeof THIS.onImmediateChange=="string"?eval(THIS.onImmediateChange):THIS.onImmediateChange(THIS))}this.required=!0,this.adjust=!0,this.hash=!1,this.caps=!0,this.slider=!0,this.valueElement=target,this.styleElement=target,this.onImmediateChange=null,this.hsv=[0,0,1],this.rgb=[1,1,1],this.pickerOnfocus=!0,this.pickerMode="HSV",this.pickerPosition="bottom",this.pickerSmartPosition=!0,this.pickerButtonHeight=20,this.pickerClosable=!1,this.pickerCloseText="Close",this.pickerButtonColor="ButtonText",this.pickerFace=10,this.pickerFaceColor="ThreeDFace",this.pickerBorder=1,this.pickerBorderColor="ThreeDHighlight ThreeDShadow ThreeDShadow ThreeDHighlight",this.pickerInset=1,this.pickerInsetColor="ThreeDShadow ThreeDHighlight ThreeDHighlight ThreeDShadow",this.pickerZIndex=1e4;for(var p in prop)prop.hasOwnProperty(p)&&(this[p]=prop[p]);this.hidePicker=function(){isPickerOwner()&&removePicker()},this.showPicker=function(){if(!isPickerOwner()){var e=jscolor.getElementPos(target),t=jscolor.getElementSize(target),n=jscolor.getViewPos(),r=jscolor.getViewSize(),i=getPickerDims(this),s,o,u;switch(this.pickerPosition.toLowerCase()){case"left":s=1,o=0,u=-1;break;case"right":s=1,o=0,u=1;break;case"top":s=0,o=1,u=-1;break;default:s=0,o=1,u=1}var a=(t[o]+i[o])/2;if(!this.pickerSmartPosition)var f=[e[s],e[o]+t[o]-a+a*u];else var f=[-n[s]+e[s]+i[s]>r[s]?-n[s]+e[s]+t[s]/2>r[s]/2&&e[s]+t[s]-i[s]>=0?e[s]+t[s]-i[s]:e[s]:e[s],-n[o]+e[o]+t[o]+i[o]-a+a*u>r[o]?-n[o]+e[o]+t[o]/2>r[o]/2&&e[o]+t[o]-a-a*u>=0?e[o]+t[o]-a-a*u:e[o]+t[o]-a+a*u:e[o]+t[o]-a+a*u>=0?e[o]+t[o]-a+a*u:e[o]+t[o]-a-a*u];drawPicker(f[s],f[o])}},this.importColor=function(){valueElement?this.adjust?!this.required&&/^\s*$/.test(valueElement.value)?(valueElement.value="",styleElement.style.backgroundImage=styleElement.jscStyle.backgroundImage,styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor,styleElement.style.color=styleElement.jscStyle.color,this.exportColor(leaveValue|leaveStyle)):this.fromString(valueElement.value)||this.exportColor():this.fromString(valueElement.value,leaveValue)||(styleElement.style.backgroundImage=styleElement.jscStyle.backgroundImage,styleElement.style.backgroundColor=styleElement.jscStyle.backgroundColor,styleElement.style.color=styleElement.jscStyle.color,this.exportColor(leaveValue|leaveStyle)):this.exportColor()},this.exportColor=function(e){if(!(e&leaveValue)&&valueElement){var t=this.toString();this.caps&&(t=t.toUpperCase()),this.hash&&(t="#"+t),valueElement.value=t}!(e&leaveStyle)&&styleElement&&(styleElement.style.backgroundImage="none",styleElement.style.backgroundColor="#"+this.toString(),styleElement.style.color=.213*this.rgb[0]+.715*this.rgb[1]+.072*this.rgb[2]<.5?"#FFF":"#000"),!(e&leavePad)&&isPickerOwner()&&redrawPad(),!(e&leaveSld)&&isPickerOwner()&&redrawSld()},this.fromHSV=function(e,t,n,r){e<0&&(e=0)||e>6&&(e=6),t<0&&(t=0)||t>1&&(t=1),n<0&&(n=0)||n>1&&(n=1),this.rgb=HSV_RGB(e===null?this.hsv[0]:this.hsv[0]=e,t===null?this.hsv[1]:this.hsv[1]=t,n===null?this.hsv[2]:this.hsv[2]=n),this.exportColor(r)},this.fromRGB=function(e,t,n,r){e<0&&(e=0)||e>1&&(e=1),t<0&&(t=0)||t>1&&(t=1),n<0&&(n=0)||n>1&&(n=1);var i=RGB_HSV(e===null?this.rgb[0]:this.rgb[0]=e,t===null?this.rgb[1]:this.rgb[1]=t,n===null?this.rgb[2]:this.rgb[2]=n);i[0]!==null&&(this.hsv[0]=i[0]),i[2]!==0&&(this.hsv[1]=i[1]),this.hsv[2]=i[2],this.exportColor(r)},this.fromString=function(e,t){var n=e.match(/^\W*([0-9A-F]{3}([0-9A-F]{3})?)\W*$/i);return n?(n[1].length===6?this.fromRGB(parseInt(n[1].substr(0,2),16)/255,parseInt(n[1].substr(2,2),16)/255,parseInt(n[1].substr(4,2),16)/255,t):this.fromRGB(parseInt(n[1].charAt(0)+n[1].charAt(0),16)/255,parseInt(n[1].charAt(1)+n[1].charAt(1),16)/255,parseInt(n[1].charAt(2)+n[1].charAt(2),16)/255,t),!0):!1},this.toString=function(){return(256|Math.round(255*this.rgb[0])).toString(16).substr(1)+(256|Math.round(255*this.rgb[1])).toString(16).substr(1)+(256|Math.round(255*this.rgb[2])).toString(16).substr(1)};var THIS=this,modeID=this.pickerMode.toLowerCase()==="hvs"?1:0,abortBlur=!1,valueElement=jscolor.fetchElement(this.valueElement),styleElement=jscolor.fetchElement(this.styleElement),holdPad=!1,holdSld=!1,leaveValue=1,leaveStyle=2,leavePad=4,leaveSld=8;jscolor.addEvent(target,"focus",function(){THIS.pickerOnfocus&&THIS.showPicker()}),jscolor.addEvent(target,"blur",function(){abortBlur?abortBlur=!1:window.setTimeout(function(){abortBlur||blurTarget(),abortBlur=!1},0)});if(valueElement){var updateField=function(){THIS.fromString(valueElement.value,leaveValue),dispatchImmediateChange()};jscolor.addEvent(valueElement,"keyup",updateField),jscolor.addEvent(valueElement,"input",updateField),jscolor.addEvent(valueElement,"blur",blurValue),valueElement.setAttribute("autocomplete","off")}styleElement&&(styleElement.jscStyle={backgroundImage:styleElement.style.backgroundImage,backgroundColor:styleElement.style.backgroundColor,color:styleElement.style.color});switch(modeID){case 0:jscolor.requireImage("hs.png");break;case 1:jscolor.requireImage("hv.png")}jscolor.requireImage("cross.gif"),jscolor.requireImage("arrow.gif"),this.importColor()}};jscolor.install(),define("libraries/jscolor/jscolor.js",function(){}),define("normalize",["require","module"],function(e,t){function o(e,t,n){if(e.indexOf("data:")===0)return e;e=r(e);if(e.match(/^\//)||e.match(s))return e;var i=n.match(s),o=t.match(s);return o&&(!i||i[1]!=o[1]||i[2]!=o[2])?u(e,t):a(u(e,t),n)}function u(e,t){e.substr(0,2)=="./"&&(e=e.substr(2));var n=t.split("/"),r=e.split("/");n.pop();while(curPart=r.shift())curPart==".."?n.pop():n.push(curPart);return n.join("/")}function a(e,t){var n=t.split("/");n.pop(),t=n.join("/")+"/",i=0;while(t.substr(i,1)==e.substr(i,1))i++;while(t.substr(i,1)!="/")i--;t=t.substr(i+1),e=e.substr(i+1),n=t.split("/");var r=e.split("/");out="";while(n.shift())out+="../";while(curPart=r.shift())out+=curPart+"/";return out.substr(0,out.length-1)}var n=/([^:])\/+/g,r=function(e){return e.replace(n,"$1/")},s=/[^\:\/]*:\/\/([^\/])*/,f=function(e,t,n,i){t=r(t),n=r(n);var s=/@import\s*("([^"]*)"|'([^']*)')|url\s*\(\s*(\s*"([^"]*)"|'([^']*)'|[^\)]*\s*)\s*\)/ig,u,a,e;while(u=s.exec(e)){a=u[3]||u[2]||u[5]||u[6]||u[4];var f;i&&a.substr(0,1)=="/"?f=i+a:f=o(a,t,n);var l=u[5]||u[6]?1:0;e=e.substr(0,s.lastIndex-a.length-l-1)+f+e.substr(s.lastIndex-l-1),s.lastIndex=s.lastIndex+(f.length-a.length)}return e};return f.convertURIBase=o,f}),define("css",["./normalize"],function(e){function t(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}if(typeof window=="undefined")return{load:function(e,t,n){n()}};var n=!1,r=document.getElementsByTagName("head")[0],i=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/),s=!1;!i||(i[1]||i[7]?(s=parseInt(i[1])<6||parseInt(i[7])<=9,i="trident"):i[2]?(s=!0,i="webkit"):i[3]||(i[4]?(s=parseInt(i[4])<18,i="gecko"):n&&alert("Engine detection failed")));var o={},u=/^\/|([^\:\/]*:)/;o.pluginBuilder="./css-builder";var a=[],f={},l=[];o.addBuffer=function(e){if(t(a,e)!=-1)return;if(t(l,e)!=-1)return;a.push(e),l.push(e)},o.setBuffer=function(t,n){var r=window.location.pathname.split("/");r.pop(),r=r.join("/")+"/";var i=require.toUrl("base_url").split("/");i.pop();var s=i.join("/")+"/";s=e.convertURIBase(s,r,"/"),s.match(u)||(s="/"+s),s.substr(s.length-1,1)!="/"&&(s+="/"),o.inject(e(t,s,r));for(var l=0;l<a.length;l++)(n&&a[l].substr(a[l].length-5,5)==".less"||!n&&a[l].substr(a[l].length-4,4)==".css")&&(function(e){f[e]=f[e]||!0,setTimeout(function(){typeof f[e]=="function"&&f[e](),delete f[e]},7)}(a[l]),a.splice(l--,1))},o.attachBuffer=function(e,n){for(var r=0;r<a.length;r++)if(a[r]==e)return f[e]=n,!0;if(f[e]===!0)return f[e]=n,!0;if(t(l,e)!=-1)return n(),!0};var c=function(e,t){setTimeout(function(){for(var n=0;n<document.styleSheets.length;n++){var r=document.styleSheets[n];if(r.href==e.href)return t()}c(e,t)},10)},h=function(e,t){setTimeout(function(){try{return e.sheet.cssRules,t()}catch(n){}h(e,t)},10)};if(i=="trident"&&s)var p=[],d=[],v=0,m=function(e,t){var n;d.push({url:e,cb:t}),n=p.shift(),!n&&v++<31&&(n=document.createElement("style"),r.appendChild(n)),n&&g(n)},g=function(e){var t=d.shift();if(!t){e.onload=b,p.push(e);return}e.onload=function(){t.cb(t.ss),g(e)};var n=e.styleSheet;t.ss=n.imports[n.addImport(t.url)]};var y=function(e){var t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.href=e,t},b=function(){};o.linkLoad=function(e,t){var o=setTimeout(function(){n&&alert("timeout"),t()},L*1e3-100),u=function(){clearTimeout(o),a&&(a.onload=b),setTimeout(t,7)};if(!s){var a=y(e);a.onload=u,r.appendChild(a)}else if(i=="webkit"){var a=y(e);c(a,u),r.appendChild(a)}else if(i=="gecko"){var f=document.createElement("style");f.textContent='@import "'+e+'"',h(f,u),r.appendChild(f)}else i=="trident"&&m(e,u)};var w=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],E={},S=function(e,t,n){if(E[e]){t(E[e]);return}var r,i,s;if(typeof XMLHttpRequest!="undefined")r=new XMLHttpRequest;else if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){s=w[i];try{r=new ActiveXObject(s)}catch(o){}if(r){w=[s];break}}r.open("GET",e,requirejs.inlineRequire?!1:!0),r.onreadystatechange=function(i){var s,o;r.readyState===4&&(s=r.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=r,n(o)):(E[e]=r.responseText,t(r.responseText)))},r.send(null)},x=0,T;o.inject=function(e){x<31&&(T=document.createElement("style"),T.type="text/css",r.appendChild(T),x++),T.styleSheet?T.styleSheet.cssText+=e:T.appendChild(document.createTextNode(e))};var N=/@import\s*(url)?\s*(('([^']*)'|"([^"]*)")|\(('([^']*)'|"([^"]*)"|([^\)]*))\))\s*;?/g,C=window.location.pathname.split("/");C.pop(),C=C.join("/")+"/";var k=function(t,n,r){t.match(u)||(t="/"+e.convertURIBase(t,C,"/")),S(t,function(i){i=e(i,t,C);var s=[],o=[],u=[],a;while(a=N.exec(i)){var f=a[4]||a[5]||a[7]||a[8]||a[9];s.push(f),o.push(N.lastIndex-a[0].length),u.push(a[0].length)}var l=0;for(var c=0;c<s.length;c++)(function(e){k(s[e],function(t){i=i.substr(0,o[e])+t+i.substr(o[e]+u[e]);var r=t.length-u[e];for(var a=e+1;a<s.length;a++)o[a]+=r;l++,l==s.length&&n(i)},r)})(c);s.length==0&&n(i)},r)};o.normalize=function(e,t){return e.substr(e.length-4,4)==".css"&&(e=e.substr(0,e.length-4)),t(e)};var L,A=!1;return o.load=function(e,t,r,i,u){L=L||i.waitSeconds||7;var a=e+(u?".less":".css");if(o.attachBuffer(a,r))return;var f=t.toUrl(a);!A&&n&&(alert(s?"hacking links":"not hacking"),A=!0),u?k(f,function(e){u&&(e=u(e,function(e){o.inject(e),setTimeout(r,7)}))}):o.linkLoad(f,r)},n&&(o.inspect=function(){if(stylesheet.styleSheet)return stylesheet.styleSheet.cssText;if(stylesheet.innerHTML)return stylesheet.innerHTML}),o}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("resources/framework/bundle/myplaces2/css/myplaces.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,Oskari.registerLocalization({lang:"fi",key:"MyPlaces2",value:{title:"Kohteet",desc:"",category:{defaultName:"Oma karttataso",organization:"Omat kohteet",inspire:"Kohteet"},guest:{loginShort:"Kirjaudu sisään käyttääksesi"},tools:{point:{tooltip:"Lisää piste","new":"Lisää piste klikkaamalla karttaa.",next:"Voit tallentaa tai piirtää pisteitä samaan kohteeseen.",edit:"Siirrä pistettä raahaamalla.",save:"Tallenna sijainti"},line:{tooltip:"Lisää viiva","new":"Lisää viivan taitepiste klikkaamalla karttaa. Lopeta piirto tuplaklikkauksella tai painamalla 'Lopeta piirto'.",next:"Voit tallentaa tai piirtää lisää viivoja samaan kohteeseen.",edit:"Muokkaa viivaa raahaamalla viivan taitepisteitä.",save:"Tallenna muoto"},area:{tooltip:"Lisää alue","new":"Lisää alueen taitepisteet klikkaamalla karttaa. Lopeta piirto tuplaklikkauksella tai painamalla 'Lopeta piirto'. Voit piirtää alueeseen reiän pitämällä pohjassa Alt-näppäintä.",next:"Voit tallentaa tai piirtää lisää alueita samaan kohteeseen.",edit:"Muokkaa muotoa raahaamalla reunaviivan taitepisteitä.",save:"Tallenna muoto"}},buttons:{ok:"OK",cancel:"Peruuta",finish:"Lopeta piirto",save:"Tallenna",movePlaces:"Siirrä kohteet ja poista",deleteCategory:"Poista",deleteCategoryAndPlaces:"Poista kohteineen",changeToPublic:"Muuta julkiseksi",changeToPrivate:"Muuta yksityiseksi"},placeform:{title:"Kohteen tiedot",tooltip:"Kun lisäät kohteen kartalle, se tallentuu Omiin tietoihisi. Anna kohteelle nimi ja kuvaus. Voit valita, mille karttatasolle tallennat kohteen tai lisätä uuden karttatason valitsemalla 'Uusi taso' karttatasojen pudotusvalikosta.",placename:{placeholder:"Anna kohteelle nimi"},placelink:{placeholder:"Anna URL-osoite"},placedesc:{placeholder:"Kuvaile kohdetta"},category:{label:"Karttataso","new":"Uusi taso..."}},categoryform:{name:{label:"Nimi",placeholder:"Anna tasolle nimi"},drawing:{label:"Piirtojälki",point:{label:"Piste",color:"Väri",size:"Koko"},line:{label:"Viiva",color:"Väri",size:"Paksuus"},area:{label:"Alue",fillcolor:"Täyttöväri",linecolor:"Viivan väri",size:"Viivan paksuus"}},edit:{title:"Muokkaa karttatasoa",save:"Tallenna",cancel:"Peruuta"}},notification:{placeAdded:{title:"Kohde tallennettu",message:"Löydät kohteen Omat Tiedot -valikosta."},categorySaved:{title:"Karttataso tallennettu",message:"Karttatason muutokset on tallennettu."},categoryDelete:{title:"Karttatason poisto",deleteConfirmMove:"Karttataso: {0} sisältää kohteita {1} kpl. Haluatko poistaa tason ja siirtää sen kohteet oletuskarttatasolle {2}?",deleteConfirm:"Haluatko poistaa karttatason {0}?",deleted:"Karttataso poistettu."},categoryToPublic:{title:"Muuta karttataso julkiseksi",message:'Olet muuttamassa karttatasoa "{0}" julkiseksi. Voit jakaa julkisen karttatason verkossa tai julkaista sen karttana toiseen verkkopalveluun. Muut käyttäjät voivat myös katsoa karttatasoa Paikkatietoikkunassa.'},categoryToPrivate:{title:"Muuta karttataso yksityiseksi",message:'Olet muuttamassa karttatasoa "{0}" yksityiseksi. Tämän jälkeen et voi jakaa tai julkaista karttana, eivätkä muut käyttäjät näe sitä Paikkatietoikkunassa.'},error:{addCategory:"Tason tallennus epäonnistui. Kohdetta ei ole tallennettu.",editCategory:"Tason tallennus epäonnistui.",savePlace:"Kohteen tallentaminen ei onnistunut.",title:"Virhe!",generic:"Järjestelmässä tapahtui virhe. Yritä uudelleen myöhemmin.",deleteCategory:"Virhe poistossa!",deleteDefault:"Oletuskarttatasoa ei voi poistaa."}},validation:{title:"Tiedoissa puutteita:",placeName:"Kohteen nimi puuttuu.",categoryName:"Tason nimi puuttuu.",placeNameIllegal:"Kohteen nimessä on luvattomia merkkejä. Sallittuja merkkejä ovat kaikki suomen kielen aakkoset, numerot sekä välilyönti ja yhdysmerkki.",descIllegal:"Kohteen kuvauksessa on luvattomia merkkejä. Sallittuja merkkejä ovat kaikki suomen kielen aakkoset, numerot sekä välilyönti ja yhdysmerkki.",categoryNameIllegal:"Tason nimessä on luvattomia merkkejä. Sallittuja merkkejä ovat kaikki suomen kielen aakkoset, numerot sekä välilyönti ja yhdysmerkki.",dotSize:"Pisteen koko ei ole sallituissa rajoissa (1-50).",dotColor:"Pisteen väri virheellinen.",lineSize:"Viivan koko ei ole sallituissa rajoissa (1-50).",lineColor:"Viivan väri virheellinen.",areaLineSize:"Alueen viivan koko ei ole sallituissa rajoissa (0-50).",areaLineColor:"Alueen viivan väri virheellinen.",areaFillColor:"Alueen täyttöväri virheellinen."}}}),define("bundles/framework/bundle/myplaces2/locale/fi",function(){}),Oskari.registerLocalization({lang:"sv",key:"MyPlaces2",value:{title:"Objekt",desc:"",category:{defaultName:"Mitt kartlager",organization:"Mina objekt",inspire:"Objekt"},guest:{loginShort:"Logga in för att använda"},tools:{point:{tooltip:"Tillägg punkt","new":"Tillägg punkt genom att klicka på kartan.",next:"Du kan lagra eller tillägga fler punkter till samma området.",edit:"Flytta på punkten genom att klicka och dra.",save:"Lagra läge"},line:{tooltip:"Tillägg linje","new":"Tillägg en brytningspunkt på linjen genom att klicka på kartan. Sluta rita genom att dubbelklicka eller klicka på 'Sluta rita'.",next:"Du kan lagra eller tillägga fler linjer till samma området.",edit:"Editera linjen genom att klicka och dra brytningspunkterna.",save:"Lagra form"},area:{tooltip:"Tillägg område","new":"Tillägg områdets hörnpunkter genom att klicka på kartan. Sluta rita genom att dubbelklicka eller klicka på 'Sluta rita'. Håll ned Alt-tangenten för att skapa hål i polygonerna.",next:"Du kan lagra eller tillägga fler polygoner till samma området.",edit:"Editera områdets form genom att klicka och dra brytningspunkterna på omkretslinjen.",save:"Lagra form"}},buttons:{ok:"OK",cancel:"Tillbaka",finish:"Sluta rita",save:"Lagra",movePlaces:"Flytta objekt och ta bort",deleteCategory:"Ta bort",deleteCategoryAndPlaces:"Ta bort kategori inklusive objekt",changeToPublic:"Ändra till offentlig",changeToPrivate:"Ändra till privat"},placeform:{title:"Uppgifter om objektet",tooltip:"När du lägger ett objekt på kartan lagras det i dina objekt. Ge objektet ett namn och en beskrivning. Du kan välja vilket kartlager du vill lagra objektet på eller tillägga ett nytt kartlager genom att välja 'Ny nivå' från rullgardinsmenyn för kartlager.",placename:{placeholder:"Namnge objektet"},placelink:{placeholder:"Ge URL-address"},placedesc:{placeholder:"Beskriv objektet"},category:{label:"Kartlager","new":"Ny nivå..."}},categoryform:{name:{label:"Namn",placeholder:"Namnge kartlagret"},drawing:{label:"Stil",point:{label:"Punkt",color:"Färg",size:"Storlek"},line:{label:"Linje",color:"Färg",size:"Tjocklek"},area:{label:"Område",fillcolor:"Ifyllnadsfärg",linecolor:"Linjens färg",size:"Linjens tjocklek"}},edit:{title:"Editera kartlagret",save:"Lagra",cancel:"Tillbaka"}},notification:{placeAdded:{title:"Objektet har lagrats",message:"Objektet finns i menyn Mina uppgifter"},categorySaved:{title:"Kartlagret har lagrats",message:"दndringar i kartlagret har lagrats"},categoryDelete:{title:"Ta bort kartlager",deleteConfirmMove:"Kartlager: {0} innehåller {1} st. objekt. Vill du ta bort nivån och flytta objekten på den till det förvalda kartlagret {2} ?",deleteConfirm:"Vill du ta bort kartlagret {0}?",deleted:"Kartlagret borttaget"},categoryToPublic:{title:"Offentliggör kartlagret",message:'Du håller på att offentliggöra kartlagret "{0}". Du kan skicka länkar till ett offentligt kartlager till andra internetanvändare eller inbädda det som en karta i en annan webbtjänst. Andra användare kan även titta på kartlagret i Paikkatietoikkuna.'},categoryToPrivate:{title:"Gör kartlagret privat",message:'Du håller på att göra kartlagret "{0}" privat. Efter detta kan du inte längre skicka länkar från kart-lagret eller inbädda det som en karta, andra användare kan inte heller titta på det i Paikkatietoikkuna.'},error:{addCategory:"Kartlagret kunde inte lagras. Objektet har inte lagrats.",editCategory:"Kartlagret kunde inte lagras.",savePlace:"Objektet kunde inte lagras.",title:"Fel!",generic:"Systemfel. Försök på nytt senare.",deleteCategory:"Fel i borttagningen!",deleteDefault:"Den förvalda kartlagret kan inte tas bort."}},validation:{title:"Brister i uppgifterna:",placeName:"Objektets namn saknas.",categoryName:"kartlagrets namn saknas.",placeNameIllegal:"I objekts namnet ingår otillåtna tecken. Tillåtna är alla bokstäver i det svenska alfabetet, siffror, mellanslag och bindestreck.",descIllegal:"I objekts beskrivning ingår otillåtna tecken. Tillåtna är alla bokstäver i det svenska alfabetet, siffror, mellanslag och bindestreck.",categoryNameIllegal:"I kartlagers beskrivning ingår otillåtna tecken. Tillåtna är alla bokstäver i det svenska alfabetet, siffror, mellanslag och bindestreck.",dotSize:"Punkternas storlek är utanför de tillåtna gränserna (1-50).",dotColor:"Punktens färg är felaktig.",lineSize:"Linjens storlek är utanför de tillåtna gränserna (1-50).",lineColor:"Linjens färg är felaktig.",areaLineSize:"Områdets konturlinje är utanför de tillåtna gränserna (0-50).",areaLineColor:"Färgen på områdets omkretslinje är felaktig.",areaFillColor:"Områdets ifyllnadsfärg är felaktig."}}}),define("bundles/framework/bundle/myplaces2/locale/sv",function(){}),Oskari.registerLocalization({lang:"en",key:"MyPlaces2",value:{title:"Places",desc:"",category:{defaultName:"My map layer",organization:"My places",inspire:"Places"},guest:{loginShort:"Log in to use"},tools:{point:{tooltip:"Add point","new":"Add point by clicking the map.",next:"You can save or draw more points into the same drawing.",edit:"Move point by clicking and dragging.",save:"Save location"},line:{tooltip:"Add line","new":"Add a break point on the line by clicking the map. Stop drawing by double clicking or by clicking 'Finish drawing'.",next:"You can save or draw more lines into the same drawing.",edit:"Edit the line by clicking and dragging its break points.",save:"Save shape"},area:{tooltip:"Add area","new":"Add break points to your area polygon by clicking the map. Stop drawing by double clicking or by clicking 'Finish drawing'. To create holes in polygons, hold down the Alt key.",next:"You can save or draw more polygons into the same drawing.",edit:"Edit the shape of the area by clicking and dragging the break points on its edge line.",save:"Save shape"}},buttons:{ok:"OK",cancel:"Cancel",finish:"Finish drawing",save:"Save",movePlaces:"Move places and delete",deleteCategory:"Delete",deleteCategoryAndPlaces:"Delete category and places",changeToPublic:"Make public",changeToPrivate:"Make private"},placeform:{title:"Place data",tooltip:"A place put on the map will be saved in My places. Give the place a name and describe it. You can select the map layer where the place will be stored, or choose a new map layer by selecting 'New layer' in the map layer drop-down menu.",placename:{placeholder:"Give the place a name"},placelink:{placeholder:"Give a URL"},placedesc:{placeholder:"Describe the place"},category:{label:"Map layer","new":"New layer..."}},categoryform:{name:{label:"Name",placeholder:"Give the map layer a name"},drawing:{label:"Style",point:{label:"Point",color:"Colour",size:"Size"},line:{label:"Line",color:"Colour",size:"Thickness"},area:{label:"Area",fillcolor:"Fill-in colour",linecolor:"Line colour",size:"Line thickness"}},edit:{title:"Edit map layer",save:"Save",cancel:"Back"}},notification:{placeAdded:{title:"The place has been saved",message:"The place can be found in the My data menu"},categorySaved:{title:"Map layer saved",message:"Map layer edits saved"},categoryDelete:{title:"Delete map layer",deleteConfirmMove:"Map layer {0} contains {1} objects. Do you want to delete the map layer and move the places on it to the default map layer {2} ?",deleteConfirm:"Delete map layer {0}?",deleted:"Map layer deleted"},categoryToPublic:{title:"Make map layer public",message:'You are making the map layer "{0}" public. You can share links to a public map layer with other internet users or embed the map layer as a map window on another website. Other users can also view the map layer in Paikkatietoikkuna.'},categoryToPrivate:{title:"Make map layer private",message:'You are making the map layer "{0}" private. After this it will no longer be possible to share it with other users or embed it on another website. Other users can no longer view the map layer in Paikkatietoikkuna.'},error:{addCategory:"The map layer could not be saved. The place has not been saved.",editCategory:"The map layer could not be saved.",savePlace:"The place could not be saved.",title:"Error!",generic:"System error. Please try again later.",deleteCategory:"Error occurred while deleting!",deleteDefault:"The default map layer cannot be deleted."}},validation:{title:"Data contains errors:",placeName:"Place name missing.",categoryName:"Map layer name missing.",placeNameIllegal:"The object name contains disallowed characters. Allowed characters are the letters a-z as well as å, ä and ö, numbers, backspaces and hyphens.",descIllegal:"The object description contains disallowed characters. Allowed characters are the letters a-z as well as å, ä and ö, numbers, backspaces and hyphens.",categoryNameIllegal:"The layer description contains disallowed characters. Allowed characters are the letters a-z as well as å, ä and ö, numbers, backspaces and hyphens.",dotSize:"The dot size does not fit the size limits (1-50).",dotColor:"Wrong dot colour.",lineSize:"The line size does not fit the size limits (1-50).",lineColor:"Wrong line colour.",areaLineSize:"The area edge size does not fit the limits (0-50).",areaLineColor:"Wrong area edge line colour.",areaFillColor:"Wrong fill-in colour."}}}),define("bundles/framework/bundle/myplaces2/locale/en",function(){}),define("bundles/framework/bundle/myplaces2/module",["oskari","jquery","./event/FinishedDrawingEvent","./event/AddedFeatureEvent","./event/MyPlaceHoverEvent","./event/MyPlacesChangedEvent","./event/MyPlaceSelectedEvent","./model/MyPlace","./model/MyPlacesCategory","./plugin/DrawPlugin","./plugin/HoverPlugin","./request/StopDrawingRequest","./request/StartDrawingRequest","./request/GetGeometryRequest","./request/GetGeometryRequestHandler","./request/StartDrawingRequestHandler","./request/StopDrawingRequestHandler","./request/EditPlaceRequest","./request/EditCategoryRequest","./request/DeleteCategoryRequest","./request/PublishCategoryRequest","./request/EditRequestHandler","./service/MyPlacesService","./service/MyPlacesWFSTStore","./view/MainView","./view/PlaceForm","./view/CategoryForm","./ButtonHandler","./CategoryHandler","./instance","libraries/jscolor/jscolor.js","css!resources/framework/bundle/myplaces2/css/myplaces.css","./locale/fi","./locale/sv","./locale/en"],function(e,t){return e.bundleCls("myplaces2").category({create:function(){return e.clazz.create("Oskari.mapframework.bundle.myplaces2.MyPlacesBundleInstance")},update:function(e,t,n,r){e.alert("RECEIVED update notification "+r)}})}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer("div.myplacesform div.help {\r\n  float: right; }\r\n\r\n/* Wide fields for place inputs  */\r\ndiv.myplacesform div.field {\r\n  padding-bottom: 10px; }\r\n\r\ndiv.myplacesform input {\r\n  width: 80%; }\r\n\r\ndiv.myplacesform textarea {\r\n  width: 80%; }\r\n\r\ndiv.myplacesform select {\r\n  width: 80%; }\r\n\r\n/* Smaller fields for category inputs in table */\r\ndiv.myplacescategoryform table input {\r\n  width: 50px; }\r\n\r\ndiv.myplacescategoryform input.oskaricolor {\r\n  height: 20px;\r\n  width: 50px;\r\n  border: 1px solid;\r\n  padding: 3px;\r\n  border-radius: 5px;\r\n  font-size: 0; }\r\n\r\ndiv.myplaces2 div.buttons div.button {\r\n  margin: 10px;\r\n  padding: 10px;\r\n  border: 1px solid;\r\n  border-radius: 5px;\r\n  box-shadow: 5px 5px 5px #888; }\r\n\r\n.divmanazerpopup.myplaces2 {\r\n  max-width: 260px; }\r\n")}),requirejs.s.contexts._.nextTick=requirejs.nextTick;