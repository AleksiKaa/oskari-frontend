<link rel="import"
      href="libs/polymer/polymer.html">

<link rel="import" href="libs/select-with-options/select-with-options.html">
<link href="libs/promise-polyfill/promise-polyfill.html" rel="import">
<link href="libs/iron-ajax/iron-ajax.html" rel="import">
<link href="oskari-userindicator.html" rel="import">
<link href="oskari-spinner.html" rel="import">

<dom-module id="oskari-indicatorselector">

  <template>
    <iron-ajax
      auto
      url="{{ajaxUrl}}"
      params='{"action_route": "GetIndicatorsMetadata"}'
      handle-as="json"
      last-response="{{sources}}"
      debounce-duration="300"
      id="indicatorsAjax"
      on-response="hideSpinner"
      on-error="ajaxError"></iron-ajax>
    <oskari-spinner visible="[[showSpinner]]" spinner-id="indicatorsMetadataSpinner">
    </oskari-spinner>
    <div id="indicatorCollapse" class$="[[expanded(indicatorExpanded)]]">
      <div class$="[[hideIndicatorSelectorClass(embedded, showUserIndicatorView)]]" id="indicatorSelectorDiv">
        <form class="statsgrid2_indicator_selector">
          <div>
            <label for="datasource-selector">[[locale.tab.grid.organization]]</label>
            <select is="select-with-options" options="[[getDatasources(sources)]]"
                option-value="val" option-label="text" 
                id="datasource-selector" style="width: 300px;"
                value="{{datasourceId::change}}">
            </select>
            <button type="button" on-click="onAddUserIndicator">[[locale.addDataButton]]</button>
          </div>
          <label for="indicator-selector">[[locale.indicators]]</label>
          <select is="select-with-options" id="indicator-selector"
              options="[[getIndicators(sources,datasourceId)]]"
              option-value="val" option-label="text"
              style="width: 300px;" value="{{indicatorId::change}}">
          </select>
          <div class="icon-info" on-click="showIndicatorInfo" class$="[[hidden(!indicatorSelected)]]"></div>
          <!-- The optional selectors will be populated here when the above have been selected. -->
          <div id="indicatorSelectors" class$="[[hidden(!indicatorSelected)]]">
            <template is="dom-repeat" items="[[selectorItems]]" as="selector">
              <label for="[[selector.name]]">[[selectorOption.label]]</label>
              <select is="select-with-options" id="[[selector.name]]"
                  style="width: 300px;" value="{{selector.value::change}}"
                  on-change="selectorsChanged"
                  options="[[selector.values]]"
                  option-value="val" option-label="text">
              </select>
            </template>
          </div>
          <button type="button" on-click="onAddIndicatorToGrid" class$="[[hidden(!indicatorSelected)]]"
            disabled$="[[!allSelectorsSelected]]">[[locale.addColumn]]</button>
        </form>
      </div>
    </div>
    <oskari-statsgrid locale="[[locale]]" language="[[language]]" ajax-url="[[ajaxUrl]]"
      sources="{{sources}}" selected-indicators="{{selectedIndicators}}" selected-layer="{{selectedLayer}}"
      layer-info="{{layerInfo}}" region-info="{{regionInfo}}"
      selector-selected-indicator-key="{{selectorSelectedIndicatorKey}}" selected-indicator-key="{{selectedIndicatorKey}}"
      sandbox="{{sandbox}}" class$="[[hidden(hideGrid)]]"
      id="statsgrid" embedded="[[embedded]]" indicator-expanded="{{indicatorExpanded}}"></oskari-statsgrid>
    <div class$="[[hidden(!showUserIndicatorView)]]" id="userindicatordiv">
      <oskari-userindicator ajax-url="[[ajaxUrl]]"
        locale="[[locale]]" language="[[language]]" user="[[user]]"
        sources="{{sources}}" selected-layer="{{selectedLayer}}"
        layer-info="[[layerInfo]]" region-info="[[regionInfo]]"
        show-user-indicator-view="{{showUserIndicatorView}}" sandbox="{{sandbox}}"></oskari-userindicator>
    </div>
    <content></content>
  </template>

  <script src="polymerjs/oskari-indicatorselector.js">
  </script>
</dom-module>
