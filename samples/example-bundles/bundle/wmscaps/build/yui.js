/* This is a packed Oskari bundle (bundle script version Wed Feb 15 2012 20:10:12 GMT+0200 (Suomen normaaliaika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.WmsCapsUI",function(b,a){this.libs=b;this.form=null;this.ui=null;this.store=null;this.form=null;this.grid=null;this.bundle=a;this.lang=null},{clear:function(){this.store=null;this.form=null;this.libs=null;this.ui=null;this.grid=null},setLibs:function(a){this.libs=a},get:function(){return this.form},setStore:function(a){this.store=a},getStore:function(){return this.store},getGrid:function(){return this.grid},setLang:function(a){this.lang=a},getLang:function(){return this.lang},playWmsLayer:function(a){this.bundle.playWmsLayer(a)},stopWmsLayer:function(a){this.bundle.stopWmsLayer(a)},refresh:function(){this.grid.getView().refresh()},create:function(){var a=this.libs.ext;var a=this.libs.ext;var d=this;var f=d.lang;var e={xtype:"actioncolumn",width:64,items:[{icon:"../resource/silk-icons/control_play_blue.png",handler:function(h,j,g){var i=d.getStore().getAt(j);d.playWmsLayer(i)},getClass:function(g,i,j){var h=j.get("name");if(d.bundle.layerManager.layers[h]){return"hidden"}else{return""}}},{icon:"../resource/silk-icons/control_stop.png",handler:function(h,j,g){var i=d.getStore().getAt(j);d.stopWmsLayer(i)},getClass:function(g,i,j){var h=j.get("name");if(!d.bundle.layerManager.layers[h]){return"hidden"}else{return""}}}]};var b=a.create("Ext.grid.Panel",{store:d.getStore(),title:"Layers",columns:[e,{text:"Title",flex:1,dataIndex:"title"},{text:"Layer Name",dataIndex:"name",flex:1}]});this.grid=b;var c=new a.create("Ext.Panel",{bodyStyle:"padding:5px 5px 0",height:384,layout:"fit",defaults:{bodyPadding:4},items:[b]});this.form=c;return c}});Oskari.clazz.define("Oskari.mapframework.bundle.WmsCapsBundleInstance",function(a){this.name="WmsCaps";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{defaults:{minScale:40000,maxScale:1},start:function(){if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");var a=this.facade.getSandbox();this.sandbox=a;this.adapt(a);this.createModels();this.createStores();var b=this.facade.appendExtensionModule(this,this.name,this.eventHandlers,this,"E",{fi:{title:"WmsCaps"},sv:{title:"?"},en:{title:"Sade"}});this.def=b;this.loadWmsCaps();this.mediator.setState("started");return this},fixLayerNameTemp:function(a){return a},playWmsLayer:function(e){var d=e.get("name");var b=e.get("name");var a=this.caps.capability.request.getmap.href;var c="image/png";this.layerManager.createLayer(this.fixLayerNameTemp(b),d,true,null,a,c)},stopWmsLayer:function(b){var a=b.get("name");this.layerManager.destroyLayer(this.fixLayerNameTemp(a))},loadWmsCaps:function(){var b={};var a={url:"wms.xml",params:OpenLayers.Util.upperCaseObject(b),callback:function(c){this.handleResponse(c)},scope:this};OpenLayers.Request.GET(a)},handleResponse:function(b){var d=new OpenLayers.Format.WMSCapabilities();var c=b.responseXML;if(!c||!c.documentElement){c=b.responseText}var a=d.read(c);window.caps=a;this.caps=a;this.getStore().loadData(a.capability.layers)},getStore:function(){return this.store},init:function(a){var b=Oskari.clazz.create("Oskari.mapframework.bundle.WmsCapsUI",this.libs,this);var c=a.getLanguage();b.setLang(c);this.ui=b;b.setLibs(this.libs);b.setStore(this.getStore());b.create();return b.get()},createModels:function(){var a=this.libs.ext;var b=this;if(!a.ClassManager.get("WmsLayer")){a.define("WmsLayer",{extend:"Ext.data.Model",fields:["abstract","authorityURLs","bbox","cascaded","dimensions","fixedHeight","fixedWidth","formats","identifiers","keywords","llbbox","metadataURLs","name","nestedLayers","noSubsets","opaque","prefix","queryable","srs","styles","title"]})}},createStores:function(){var d=[];var b=this.libs.ext;var c=this;var a=b.create("Ext.data.Store",{model:"WmsLayer",autoLoad:false,data:d,proxy:{type:"memory",reader:{type:"json",model:"WmsLayer",root:"layers"}}});this.store=a},adapt:function(a){var b=this.libs.ext;var e=this;var c=this;function g(j,h,i){this.layerId=h;this.layer=null;this.spec=i;this.layerImpl=null;this.lm=j}g.prototype={setOpacity:function(h){this.opacity=h},getVisibility:function(){return true
},addFeatures:function(h){var i=this.lm.sandbox.getEventBuilder("FeaturesAvailableEvent")(this.layer,h,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");this.lm.sandbox.notifyAll(i)},destroyFeatures:function(h){}};function f(h,j,i){this.layers={};this.defaults=j;this.sandbox=h;this.shared=i}f.prototype={getName:function(){return c.getName()},createLayer:function(j,i,l,v,k,s){if(this.shared&&this.sharedLayer){return this.sharedLayer}var u="1",n=true,h=false;var t={name:j,wmsName:i,type:"maplayer",styles:{title:"",legend:"",name:""},descriptionLink:"http://en.wikipedia.org/",legendImage:"",info:"",isQueryable:true,formats:{value:"text/html"},id:u,minScale:this.defaults.minScale,maxScale:this.defaults.maxScale,style:"",dataUrl:"",wmsUrl:k,opacity:100,checked:"false"};var r=new g(this,j,t);this.layers[j]=r;if(this.shared&&!this.sharedLayer){this.sharedLayer=r}try{var q=this.sandbox.getRequestBuilder("AddExternalMapLayerRequest")(u,t);this.sandbox.request(this.getName(),q)}catch(o){}var m=this.sandbox.getRequestBuilder("AddMapLayerRequest")(u,n,null,true);m._isBasemap=false;this.sandbox.request(this.getName(),m);return r},unregisterLayerImpl:function(h){if(this.shared){this.sharedLayer=null}else{this.layers[h]=null}},registerLayerImpl:function(h){if(this.shared){this.sharedLayer.layer=h}else{var i=this.layers[h.getId()];if(i){i.layer=h}}},destroyLayers:function(){for(p in this.layers){this.destroyLayer(p)}},destroyLayer:function(h){var i=this.sandbox.getRequestBuilder("RemoveMapLayerRequest")(h);this.sandbox.request(this.getName(),i);var j=this.sandbox.getRequestBuilder("RemoveExternalMapLayerRequest")(h);this.sandbox.request(this.getName(),j)}};var d=new f(a,this.defaults,false);this.layerManager=d},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.layerManager.destroyLayers();this.facade.removeExtensionModule(this,this.name,this.eventHandlers,this,this.def);this.def=null;this.mediator.setState("stopped");return this},eventHandlers:{AfterMapMoveEvent:function(c){var b=this;var a=this.sandbox;var f=c.getScale();if(!(f<this.defaults.minScale&&f>this.defaults.maxScale)){return}var g=c.getCenterY();var d=c.getCenterX()},FeaturesGetInfoEvent:function(a){var f=a.getMapLayer();var d=f.getId();if(!this.layerManager.layers[d]){return}var i=this.sandbox;i.printDebug("Handling FeaturesGetInfoEvent for "+d);var c=this.libs.ext;var b=a.getLon();var h=a.getLat();var g=this;var e=new OpenLayers.LonLat(b,h)},AfterAddExternalMapLayerEvent:function(b){var a=b.getLayer();this.layerManager.registerLayerImpl(a);this.ui.refresh()},AfterRemoveExternalMapLayerEvent:function(b){var a=b.getMapLayerId();this.layerManager.unregisterLayerImpl(a);this.ui.refresh()},AfterMapLayerAddEvent:function(a){this.ui.refresh()},AfterMapLayerRemoveEvent:function(a){this.ui.refresh()}},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.WmsCapsBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.mapframework.bundle.extension.Extension","Oskari.mapframework.bundle.extension.EventListener"]});