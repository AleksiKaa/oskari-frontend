/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kes√§aika)) */ 
Oskari.clazz.define("Oskari.mapframework.ui.module.mapasker.GridModule",function(){this._sandbox=null;this._currentData={};this._definedModels=[];this._selectedLayer=null;this._initialized=false;this._service=null;this._mainPanel=null;this._tabPanel=null;this._latestResponseId=-1},{__name:"GridModule",getName:function(){return this.__name},init:function(a){var b=this;this._sandbox=a;a.printDebug("Initializing grid module...");a.registerForEventByName(this,"AfterWfsGetFeaturesJsonFlowForTableFormatEvent");a.registerForEventByName(this,"AfterMapLayerRemoveEvent");a.registerForEventByName(this,"AfterHighlightMapLayerEvent");a.registerForEventByName(this,"AfterDimMapLayerEvent");a.registerForEventByName(this,"AfterMapMoveEvent");a.registerForEventByName(this,"AfterHighlightWFSFeatureRowEvent");this._service=this._sandbox.getService("Oskari.mapframework.service.OgcSearchService");this.noFoundFeaturesError=a.getText("grid_module_not_found_info_for_selected_area");this.notInScaleError=a.getText("grid_module_wfs_maplayer_not_visible_this_scale");this.loadingText=a.getText("grid_module_loading_info");this._msgPanel=Ext.create("Ext.panel.Panel",{id:"grid-msg-tab",border:true,layout:"fit",frame:false,split:false,loadMask:false,title:a.getText("grid_module_gridpanel_no_title"),containerScroll:false});this._mainPanel=Ext.create("Ext.panel.Panel",{id:"grid-module",border:true,layout:"fit",frame:false,split:false,title:a.getText("grid_module_gridpanel_no_title"),containerScroll:true});this._customTooltip=Ext.create("Ext.tip.ToolTip",{autoHide:false});return this._mainPanel},start:function(a){a.printDebug("Starting "+this.getName())},stop:function(a){},_findInList:function(c,a){var d=-1;for(var b=0;b<c.length;++b){if(c[b]==a){return b}}return d},_cleanUp:function(){this._mainPanel.suspendLayout=true;if(this._currentData){for(var a in this._currentData){if(a.grid){a.grid.suspendLayout=true;this._tabPanel.remove(a.grid);a.grid.destroy();a.grid=null;this._currentData[a]=null}}}this._currentData=null;this._currentData={};this._tabPanel.removeAll(false);this._tabPanel.removeAll(true);this._tabPanel.destroy();this._tabPanel=null;this._mainPanel.suspendLayout=false;this._mainPanel.removeAll(true)},getSelectedFeatures:function(a){var c=a;if(!c&&this._tabPanel){c=this._tabPanel.getActiveTab()}if(!c.getSelectionModel){c=null}var d=[];if(c){var e=c.getSelectionModel().getSelection();for(var b=0;b<e.length;++b){d.push(e[b].get("featureId"))}}return d},selectRows:function(e,a){var d=a;if(!d&&this._tabPanel){d=this._tabPanel.getActiveTab()}if(!d.getSelectionModel){d=null}var c=[];if(d){var b=d.getStore();if(e&&e.length>0){index=b.findBy(function(f,j){var h=f.get("featureId");for(var g=0;g<e.length;++g){if(h==e[g]){c.push(f);break}}})}}if(c.length>0){d.getSelectionModel().select(c);d.getView().focusRow(c[0])}else{if(d&&d.getSelectionModel){d.getSelectionModel().deselectAll()}}return c.length},_isValidData:function(b){var d=(b!==null);var c=b.getData();if(c==null||c.headers==null||c.featureDatas==null){d=false}if(d){for(var a=0;a<c.featureDatas.length;a++){if(c.featureDatas[a].children==null){d=false;break}}}return d},showMessage:function(b){if(b){for(var a=0;a<this._tabPanel.items.items.length;a++){if(this._tabPanel.items.items[a].getStore){this._tabPanel.items.items[a].getStore().removeAll()}}if(this._tabPanel.items.items.length==0||!this._isInScale()){this._tabPanel.add(this._msgPanel)}this._msgPanel.update('<div style="margin:5px;">'+b+"</div>");this._tabPanel.setActiveTab(this._msgPanel)}else{this._tabPanel.remove(this._msgPanel,false)}},_initUiComponents:function(j){this._sandbox.printDebug("["+this.getName()+"] Grid model changed");var h=this;var l=[];l.push("mapframeworkFeatureTitle");for(var e=0;e<j.length;e++){var q=j[e]["feature_fi"];var p=this._parseAndInitFeatureDataModel(j[e]);this._currentData[q]={};this._currentData[q].feature=p;var o=this._createFeatureGrid(p);this._currentData[q].grid=o;this._tabPanel.add(o);for(var f=0;f<p.modelAttributes.length;f++){var g=p.modelAttributes[f];var b=this._findInList(l,g);if(b!==-1){}else{l.push(g)}}}var c="GridAllTabsModel-"+Ext.id();
Ext.define(c,{extend:"Ext.data.Model",fields:l});var m=Ext.create("Ext.data.Store",{model:c});var a=[];for(var f=0;f<l.length;f++){var k=l[f];var n=false;if(k=="featureId"||k=="qName"){n=true}var d={dataIndex:""+k+"",text:""+k+"",hidden:n,sortable:true,renderer:function(u,t,i,w,s,v,r){return h._customRenderer(u,t,i,w,s,v,r)}};if(k==="mapframeworkFeatureTitle"){d.text=this._sandbox.getText("grid_module_feature_type_title");d.width=200}a.push(d)}this._allDataGrid=Ext.create("Ext.grid.Panel",{id:"grid-all",multiSelect:true,store:m,loadMask:false,title:this._sandbox.getText("grid_module_all_tab_title"),trackMouseOver:false,autoScroll:true,viewConfig:{stripeRows:true,deferEmptyText:false,emptyText:h.noFoundFeaturesError},columns:a,listeners:{itemclick:function(s,i,t,r,u){h._sendUpdatedSelectionEvent()},cellClick:function(u,r,t,i,s,x,w,v){h._cellClicked(u,r,t,i,s,x,w,v)}}});this._tabPanel.add(this._allDataGrid);this._tabPanel.setActiveTab(0);this._initialized=true},_handleAfterWfsGetFeaturesJsonFlowForTableFormatEvent:function(d){this._mainPanel.setLoading(false);if(d.getData().wfsQueryId){var a=parseInt(d.getData().wfsQueryId);if(a<this._latestResponseId){this._sandbox.printDebug("["+this.getName()+"] Grid data response got old data. Current: "+this._latestResponseId+", got: "+a);return}this._latestResponseId=a}this._sandbox.request(this,this._sandbox.getRequestBuilder("ActionReadyRequest")("WFS_GRID",false));if(!this._isValidData(d)){this.showMessage(this.noFoundFeaturesError);return}var c=d.getData();if(!this._initialized){this._initUiComponents(c.featureDatas)}var e=this.getSelectedFeatures();this._updateData(d.getData().featureDatas);this.showMessage();var b=this.selectRows(e);if(b>0){this._sendUpdatedSelectionEvent()}},_updateData:function(f){this._sandbox.printDebug("["+this.getName()+"] Grid data changed");var a=[];for(var d=0;d<f.length;d++){var b=f[d];var j=b.feature_fi;var g=this._currentData[j].grid.getStore();g.loadData(b.children.slice(0));for(var e=0;e<b.children.length;e++){var c=b.children[e];c.mapframeworkFeatureTitle=this._currentData[j].feature.title;a.push(c)}}var h=this._allDataGrid.getStore();h.loadData(a)},_parseAndInitFeatureDataModel:function(d){var g=this._sandbox.getLanguage();var e={};e.title=d["feature_"+g];if(!e.title){e.title=d.feature_fi}e.modelAttributes=[];var c=d.children;if(c.length>0){for(var f in c[0]){e.modelAttributes.push(f)}}e.modelName="GridModel."+e.title;var a=false;for(var b=0;b<this._definedModels.length;++b){if(this._definedModels[b]===e.modelName){a=true;break}}if(!a){Ext.define(e.modelName,{extend:"Ext.data.Model",fields:e.modelAttributes});this._definedModels.push(e.modelName)}return e},_createFeatureGrid:function(c){var g=this;var e=[];for(var f=0;f<c.modelAttributes.length;++f){var b=c.modelAttributes[f];var i=false;if(b=="featureId"||b=="qName"){i=true}var d={dataIndex:""+b+"",text:""+b+"",hidden:i,sortable:true,renderer:function(n,m,j,p,l,o,k){return g._customRenderer(n,m,j,p,l,o,k)}};e.push(d)}var h=Ext.create("Ext.data.Store",{model:c.modelName});var a=Ext.create("Ext.grid.Panel",{id:"grid-"+c.title,store:h,displayInfo:false,loadMask:false,title:c.title,multiSelect:true,trackMouseOver:false,autoScroll:true,columns:e,viewConfig:{stripeRows:true,deferEmptyText:false,emptyText:g.noFoundFeaturesError},listeners:{itemclick:function(l,j,m,k,n){g._sendUpdatedSelectionEvent()},cellClick:function(n,k,m,j,l,q,p,o){g._cellClicked(n,k,m,j,l,q,p,o)}}});return a},_cellClicked:function(i,c,o,f,d,l,a,k){var n=i.getGridColumns()[o].dataIndex;var m=f.get(n);var j=typeof m;if(j==="object"){var b="<table cellspacing='5'>";for(var h in m){var e=typeof m[h];var g=m[h];b=b+"<tr><td>"+h+"</td><td>"+m[h]+"</td></tr>"}b=b+"</table>";this._customTooltip.update(b);this._customTooltip.show();this._customTooltip.alignTo(c)}},_customRenderer:function(g,a,c,f,h,i,d){var e=typeof g;if(e!=="object"){return g}else{var b='<img src="'+Oskari.$().startup.imageLocation+'/resource/icons/kysymysmerkki.png" />';return b}},_showDataLoadMessage:function(){if(this._isInScale()){this._mainPanel.setLoading(this.loadingText)
}else{this._mainPanel.setLoading(false);this.showMessage(this.notInScaleError);this._sandbox.request(this,this._sandbox.getRequestBuilder("ActionReadyRequest")("WFS_GRID",false))}},_handleAfterHighlightWFSFeatureRowEvent:function(e){this._mainPanel.setLoading(false);var d=this;var a=e.getWfsFeatureIds();var c=[];if(a.length>0){if(e.isKeepSelection()){c=this.getSelectedFeatures()}for(var b=0;b<a.length;++b){var f=d._arrayContainsValue(c,a[b]);if(!f){c.push(a[b])}else{}}d.selectRows(c)}else{if(!e.isKeepSelection()){d.selectRows(c)}}this._sendUpdatedSelectionEvent()},_arrayContainsValue:function(c,d){var b=c.length;for(var a=0;a<b;a++){if(c[a]==d){return true}}return false},_sendUpdatedSelectionEvent:function(){var o="";var c=this._tabPanel.getActiveTab();if(!c){this._sandbox.printDebug("[grid-module] Tab is not ready.");return}var j=c.getSelectionModel();if(!j){this._sandbox.printDebug("[grid-module] Tab is not ready.");return}var n=c.getSelectionModel().getSelection();if(!n){this._sandbox.printDebug("[grid-module] Tab is not ready.");return}var f=":::";var g=[];for(var e=0;e<n.length;++e){var h=n[e];var d=h.get("featureId");var k=h.get("qName");o+=d+f+k;if(e<n.length-1){o+=","}}var m=this._getSelectedMapLayer();var l=this._sandbox.getRequestBuilder("HighlightWFSFeatureRequest");var a=l(o,m.getId());this._sandbox.request("GridModule",a)},enable:function(a){var b=this;this._tabPanel=Ext.create("Ext.tab.Panel",{id:"grid-module-tab-panel",frame:false,loadMask:false,border:false,autoWidth:true,height:200,defaults:{layout:"fit"},listeners:{tabchange:function(f,g,e){if(!e.getSelectionModel||e.getSelectionModel().getSelection().length==0){return}if(b._allDataGrid==g||b._allDataGrid==e){var d=b.getSelectedFeatures(e);b.selectRows(d,g)}}}});var c=Ext.getCmp("main-app-bottom");if(c&&!c.isVisible()){c.expand()}this._mainPanel.add(this._tabPanel);this._setSelectedMapLayer(a);this._showDataLoadMessage()},disable:function(){this._mainPanel.update("");this._tabPanel.hide();this._mainPanel.setLoading(false);this._service.removeWFSLayerGridRequests(this._selectedLayer);this._mainPanel.setTitle(this._sandbox.getText("grid_module_gridpanel_no_title"));this._cleanUp();this._selectedLayer=null;var a=Ext.getCmp("main-app-bottom");if(a&&a.isVisible()){a.collapse()}},_getSelectedMapLayer:function(){return this._selectedLayer},_setSelectedMapLayer:function(a){this._selectedLayer=a;this._initialized=false;this._mainPanel.setTitle(this._sandbox.getText("grid_module_gridpanel_title",[a.getName()]))},_isActive:function(){if(this._selectedLayer){return true}return false},_isInScale:function(){if(this._isActive()){return this._getSelectedMapLayer().isInScale()}return false},_updateServiceData:function(){if(this._isInScale()){this._service.removeWFSLayerGridRequests(this._selectedLayer);var a=this._sandbox.getMap();this._service.scheduleWFSGridUpdate(this._getSelectedMapLayer(),a.getBbox(),a.getWidth(),a.getHeight(),this.getName())}},onEvent:function(b){if(b.getName()=="AfterHighlightMapLayerEvent"){var a=b.getMapLayer();if(a.isLayerOfType("WFS")){this.enable(a);this._updateServiceData()}}else{if(this._isActive()){if(b.getName()=="AfterWfsGetFeaturesJsonFlowForTableFormatEvent"){if(this._isInScale()){this._handleAfterWfsGetFeaturesJsonFlowForTableFormatEvent(b)}}else{if(b.getName()=="AfterHighlightWFSFeatureRowEvent"){this._handleAfterHighlightWFSFeatureRowEvent(b)}else{if(b.getName()=="AfterMapMoveEvent"){this._showDataLoadMessage();this._updateServiceData()}else{if(b.getName()=="AfterDimMapLayerEvent"||b.getName()=="AfterMapLayerRemoveEvent"){if(this._getSelectedMapLayer().getId()===b.getMapLayer().getId()){this.disable()}}}}}}}}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.bundle.DefaultWFSBundleInstance",function(a){this.name="mapasker";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{start:function(){if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");this.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.mapasker.GridModule");
var a=this.facade.appendExtensionModule(this.impl,this.name,this.eventHandlers,this,"S",{fi:{title:"WFS"},sv:{title:"?"},en:{title:""}});this.def=a;this.impl.start(this.facade.getSandbox());this.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.eventHandlers,this,this.def);this.def=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.DefaultWFSBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});