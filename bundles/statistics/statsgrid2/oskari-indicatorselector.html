<link rel="import"
      href="libs/polymer/polymer.html">

<link href="libs/promise-polyfill/promise-polyfill.html" rel="import">
<link href="libs/iron-ajax/iron-ajax.html" rel="import">

<dom-module id="oskari-indicatorselector">

<template>
  <iron-ajax
    auto
    url="{{ajaxUrl}}"
    params='{"action_route": "GetIndicatorsMetadata"}'
    handle-as="json"
    last-response="{{sources}}"
    debounce-duration="300"
    id="indicatorsAjax"></iron-ajax>
    <form class="statsgrid2_indicator_selector">
      <div class="indicator-cont">
        <label>
          <span>{{locale.tab.grid.organization}}</span>
          <select name="datasource" style="width: 300px;" value="{{datasourceId::change}}">
            <template is="dom-repeat" items="[[getDatasources(sources)]]">
              <option value="{{item.val}}">{{item.text}}</option>
            </template>
          </select>
        </label>
        <label>
          <span>{{locale.indicators}}</span>
          <select name="indicator" style="width: 300px;" value="{{indicatorId::change}}">
            <template is="dom-repeat" items="[[getIndicators(sources,datasourceId)]]">
              <option value="{{item.val}}">{{item.text}}</option>
            </template>
          </select>
        </label>
        <div class="icon-info" on-click="showIndicatorInfo"></div>
        <!-- The optional selectors will be populated here when the above have been selected. -->
        <div id="indicatorSelectors">
          <template is="dom-repeat" items="[[getSelectors(sources,datasourceId,indicatorId)]]" as="selector">
            <label>
              <span>{{selectorOption.label}}</span>
              <select name="{{selector.name}}" style="width: 300px;" value="{{selector.value::change}}">
                <template is="dom-repeat" items="{{selector.values}}" as="selectorOption">
                  <option value="{{selectorOption.val}}">{{selectorOption.text}}</option>
                </template>
              </select>
            </label>
          </template>
        </div>
        <button type="button" on-click="onAdd">{{locale.addColumn}}</button>
      </div>
      <div class="parameters-cont"></div><div class="buttons-cont"></div>
      <content></content>
    </form>
  </template>

  <script>
    Polymer({
      "is": "oskari-indicatorselector",
      "properties": {
          "ajaxUrl": String,
          "locale": Object,
          "language": String,
          "sources": {
              "type": Object,
              "notify": true
          },
          "datasourceId": String,
          "indicatorId": String,
          "selectors": {
              "type": Array,
              "value": []
          },
          "selectedIndicators": {
              "type": Array,
              "value": [],
              "notify": true
          },
          "dialog": Object
      },
      "getLocalizationFrom": function(localizedNames, fallback, lang) {
          var name = localizedNames[lang];
          if (!name) {
              name = localizedNames["fi"];
          }
          if (!name) {
              name = localizedNames["en"];
          }
          if (!name) {
              if (Object.keys(localizedNames) > 0) {
                  // Taking the first one.
                  name = localizedNames[Object.keys(localizedNames)[0]];
              } else {
                  name = fallback;
              }
          }
          return name;
      },
      "showIndicatorInfo": function() {
          var me = this,
              indicatorCont = new jQuery('<div>' +
                  '<h4 class="indicator-msg-popup-title"></h4>' +
                  '<p class="indicator-msg-popup-title"></p>' +
                  '<h4 class="indicator-msg-popup-source"></h4>' +
                  '<p class="indicator-msg-popup-source"></p>' +
                  '</div>'),
              indicators = me.sources[me.datasourceId].indicators,
              indicator = indicators[me.indicatorId],
              source = indicator.source,
              description = indicator.description;
          indicatorCont.find('h4.indicator-msg-popup-title').append(me.locale.stats.descriptionTitle);
          indicatorCont.find('p.indicator-msg-popup-title').append(
                  me.getLocalizationFrom(description, "", me.language));
          indicatorCont.find('h4.indicator-msg-popup-source').append(me.locale.stats.sourceTitle);
          indicatorCont.find('p.indicator-msg-popup-source').append(
                  me.getLocalizationFrom(source, "", me.language));
          me.showDialog(me.getLocalizationFrom(indicator.name, "", me.language), indicatorCont);
      },
      "showDialog": function(title, message, buttons) {
          var me = this;
          // Oskari components aren't available in a published map.
          if (me.dialog) {
              me.dialog.close(true);
              me.dialog = null;
              return;
          }

          me.dialog = Oskari.clazz.create('Oskari.userinterface.component.Popup');
          if (buttons) {
              me.dialog.show(title, message, buttons);
          } else {
              var okBtn = Oskari.clazz.create('Oskari.userinterface.component.buttons.OkButton');
              okBtn.setHandler(function () {
                  me.dialog.close(true);
                  me.dialog = null;
              });
              me.dialog.show(title, message, [okBtn]);
          }
      },
      "getDatasources": function(sources) {
          var me = this;
          return [{text: me.locale.selectDataSource}].concat(Object.keys(sources).map(function(sourceId) {
              return {
                  val: sourceId,
                  text: me.locale.statistic.plugins[sources[sourceId].localizationKey]
              };
          }));
      },
      "getIndicators": function(sources, datasourceId) {
          var me = this,
            indicators = sources[datasourceId] && sources[datasourceId].indicators || [];
          return [{text: me.locale.selectIndicator}].concat(Object.keys(indicators).map(function(indicatorId) {
              var indicator = indicators[indicatorId];
              return {
                  val: indicatorId,
                  text: indicator.name[me.language]
              };
          }));
      },
      "getSelectors": function(sources, datasourceId, indicatorId) {
          var me = this,
            indicator = sources[datasourceId].indicators[indicatorId],
            selectors = indicator && indicator.selectors || [];
          return selectors.map(function(selector) {
              return {
                  name: selector.id,
                  values: [{text: me.locale.selectorPlaceholders[selector.id]}].concat(
                          selector.allowedValues.map(function (allowedValue) {
                      return {
                          val: allowedValue,
                          text: allowedValue
                      };
                  }))
              };
          });
      },
      "onAdd": function(e) {
          var selectors = this.$.indicatorSelectors;
          var selects = selectors.querySelectorAll("select");
          var values = [];
          // Sorry about this, selects is a NodeList, not an Array, so no .map().
          for (var i = 0; i < selects.length; ++i) {
              var select = selects[i];
              values.push({
                  selectorId: select.name,
                  value: select.value
              });
          }
          this.push('selectedIndicators', {
              datasourceId: this.datasourceId,
              indicatorId: this.indicatorId,
              selectors: values
          });
          console.log("Selected indicators: " + JSON.stringify(this.selectedIndicators));
      }
    });
  </script>
</dom-module>
