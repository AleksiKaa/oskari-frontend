/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kesäaika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.publisher.PublisherBundleInstance",function(){this.sandbox=null;this.started=false;this.plugins={};this.localization=null},{__name:"Publisher",getName:function(){return this.__name},setSandbox:function(a){this.sandbox=a},getSandbox:function(){return this.sandbox},getLocalization:function(a){if(!this._localization){this._localization=Oskari.getLocalization(this.getName())}if(a){return this._localization[a]}return this._localization},start:function(){var c=this;if(c.started){return}c.started=true;var a=Oskari.$("sandbox");c.sandbox=a;this.localization=Oskari.getLocalization(this.getName());a.register(c);for(p in c.eventHandlers){a.registerForEventByName(c,p)}var b=a.getRequestBuilder("userinterface.AddExtensionRequest")(this);a.request(this,b);c.createUi()},init:function(){return null},update:function(){},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},eventHandlers:{AfterMapLayerRemoveEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},AfterMapLayerAddEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},MapLayerEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},AfterMapMoveEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleMapMoved()}},stop:function(){var a=this.sandbox();for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}var b=a.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);a.request(this,b);this.sandbox.unregister(this);this.started=false},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.Flyout",this);this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null;this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){var a=this;this.plugins["Oskari.userinterface.Flyout"].createUi();this.plugins["Oskari.userinterface.Tile"].refresh()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]});Oskari.clazz.define("Oskari.mapframework.bundle.publisher.Flyout",function(a){this.instance=a;this.container=null;this.state=null;this.template=null;this.view=null},{getName:function(){return"Oskari.mapframework.bundle.publisher.Flyout"},setEl:function(c,b,a){this.container=c[0];if(!jQuery(this.container).hasClass("publisher")){jQuery(this.container).addClass("publisher")}},startPlugin:function(){this.template=jQuery("<div></div>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(a){this.state=a;console.log("Flyout.setState",this,a)},createUi:function(){var c=this;var b=jQuery(this.container);b.empty();var a=c.instance.getSandbox();if(false){this.view=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.NotLoggedIn",this.instance,this.instance.getLocalization("NotLoggedView"))}else{this.view=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.BasicPublisher",this.instance,this.instance.getLocalization("BasicView"))}this.view.render(b)},handleLayerSelectionChanged:function(){if(this.view&&this.view.handleLayerSelectionChanged){this.view.handleLayerSelectionChanged()}},handleMapMoved:function(){if(this.view&&this.view.handleMapMoved){this.view.handleMapMoved()}}},{protocol:["Oskari.userinterface.Flyout"]});Oskari.clazz.define("Oskari.mapframework.bundle.publisher.Tile",function(a){this.instance=a;this.container=null;this.template=null},{getName:function(){return"Oskari.mapframework.bundle.publisher.Tile"},setEl:function(c,b,a){this.container=jQuery(c)},startPlugin:function(){this.refresh()
},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(a){console.log("Tile.setState",this,a)},refresh:function(){var f=this;var a=f.instance;var e=this.container;var d=this.template;var c=a.getSandbox();var b=e.children(".oskari-tile-status")}},{protocol:["Oskari.userinterface.Tile"]});Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.NotLoggedIn",function(a,b){this.instance=a;this.template=jQuery("<p></p>");this.loc=b},{render:function(a){var c=this;var b=this.template.clone();b.append(this.loc.text);a.append(b)}});Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.BasicPublisher",function(a,d,c){var b=this;this.instance=a;this.template=jQuery('<div class="basic_publisher"><div class="form"><div class="field"><div class="help icon-info" title="TODO: tooltip"></div><label for="domain">'+d.domain.label+'</label><br clear="all" /><input name="domain" placeholder="'+d.domain.placeholder+'"/></div><div class="field"><div class="help icon-info" title="TODO: tooltip"></div><label for="name">'+d.name.label+'</label><br clear="all" /><input name="name" placeholder="'+d.name.placeholder+'"/></div><div class="field"><div class="help icon-info" title="TODO: tooltip"></div><label for="language">'+d.language.label+'</label><br clear="all" /><select name="language"></select></div><div class="options"></div><div class="buttons"></div></div><div class="map">'+d.preview+'<div class="preview"></div><div class="maplocation">'+d.location+'<div class="locationdata"></div></div></div></div>');this.templateHelp=jQuery('<div class="help icon-info"></div>');this.templateTool=jQuery('<div class="tool "><input type="checkbox"/><span></span></div>');this.templateSizeOptionTool=jQuery('<div class="tool "><input type="radio" name="size" /><span></span></div>');this.templateCustomSize=jQuery('<div class="customsize"><input type="text" disabled="true" name="width" placeholder="'+d.sizes.width+'"/> x <input type="text" disabled="true" name="height" placeholder="'+d.sizes.height+'"/></div>');this.templateLayerRow=jQuery('<tr data-id=""><td><input type="checkbox" /></td><td></td></tr>');this.templateUseAsDefault=jQuery('<a href="JavaScript:void(0);">'+d.layers.useAsDefaultLayer+"</a>");this.tools=[{id:"Oskari.mapframework.bundle.mapmodule.plugin.ScaleBarPlugin",name:"Mittakaavajana",selected:false},{id:"Oskari.mapframework.bundle.mapmodule.plugin.IndexMapPlugin",name:"Indeksikartta",selected:false},{id:"Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar",name:"Mittakaavan säätö",selected:true,config:{location:{top:"10px",left:"10px"}}},{id:"Oskari.mapframework.bundle.mapmodule.plugin.SearchPlugin",name:"Osoite- ja paikannimihaku",selected:false}];this.showLayerSelection=false;this.sizeOptions=[{id:"small",width:375,height:300},{id:"medium",width:500,height:400,selected:true},{id:"large",width:640,height:512},{id:"custom",width:"max 1000",height:1000,minWidth:50,minHeight:20,maxWidth:1000,maxHeight:1000}];this.loc=d;this.config={layers:{promote:[{text:"Haluatko näyttää myös ilmakuvia?",id:[24]}],preselect:"base_35"}};this.accordion=null;this.setupLayersList();this.defaultBaseLayer=null;if(this.config.layers.preselect){this.defaultBaseLayer=this.config.layers.preselect}this.maplayerPanel=null;this.previewMap=null;this.mainPanel=null},{render:function(b){var g=this;var f=this.template.clone();this.mainPanel=f;var e=f.find("select[name=language]");var h=this.loc.language.options;for(var d in h){e.append('<option value="'+d+'">'+h[d]+"</option>")}var c=f.find("div.map div.preview");this.map=this._createMap();this.map.render(c.get()[0]);this.handleMapMoved();b.append(f);var a=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=a;a.addPanel(this._createSizePanel());a.addPanel(this._createToolsPanel());this.maplayerPanel=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");this.maplayerPanel.setTitle(this.loc.layers.label);
this._populateMapLayerPanel();a.addPanel(this.maplayerPanel);a.insertTo(f.find("div.options"));this._addButtons(f)},_createMap:function(){var e=Oskari.clazz.create("Oskari.mapframework.ui.module.common.MapModule","Preview",false,false,true,false);this.previewMap=e;var b=this.instance.getSandbox();var g=b.register(e);var a=[];a.push("Oskari.mapframework.mapmodule.WmsLayerPlugin");a.push("Oskari.mapframework.mapmodule.TilesGridPlugin");a.push("Oskari.mapframework.mapmodule.WfsLayerPlugin");a.push("Oskari.mapframework.wmts.mapmodule.plugin.WmtsLayerPlugin");for(var d=0;d<a.length;d++){var f=Oskari.clazz.create(a[d]);e.registerPlugin(f)}e.setStealth(true);e.start(b);var c=new OpenLayers.Control.PorttiMouse({sandbox:b,mapmodule:e});e.addMapControl("mouseControls",c);e.updateCurrentState();return g},_createSizePanel:function(){var j=this;var a=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");a.setTitle(this.loc.size.label);var l=a.getContainer();var g=this.templateHelp.clone();g.attr("title","TODO: tooltip");l.append(g);var c=function(i){return function(){var q=l.find("input[name=size]:checked").val();var m=l.find("div.customsize input");if(q=="custom"){m.removeAttr("disabled")}else{m.attr("disabled",true);for(var o=0;o<j.sizeOptions.length;++o){var r=j.sizeOptions[o];if(r.id==q){var n=j.mainPanel.find("div.map div.preview");n.width(r.width);n.height(r.height);break}}}}};for(var d=0;d<this.sizeOptions.length;++d){var e=this.sizeOptions[d];var b=this.templateSizeOptionTool.clone();var k=this.loc.sizes[e.id];k=k+" ("+e.width+" x "+e.height+"px)";b.find("span").append(k);if(e.selected){b.find("input").attr("checked","checked");var h=j.mainPanel.find("div.map div.preview");h.width(e.width);h.height(e.height)}l.append(b);b.find("input").attr("value",e.id);b.find("input").change(c(e))}var f=this.templateCustomSize.clone();l.append(f);return a},_populateMapLayerPanel:function(){var f=this;var h=this.maplayerPanel.getContainer();var e=this.templateHelp.clone();e.attr("title","TODO: tooltip");h.append(e);var a=this.templateTool.clone();a.find("span").append(this.loc.layerselection.label);if(this.showLayerSelection){a.find("input").attr("checked","checked")}h.append(a);h.append(this.loc.layerselection.info);a.find("input").change(function(){var i=jQuery(this);var l=i.is(":checked");f.showLayerSelection=l;h.empty();f._populateMapLayerPanel()});if(!this.showLayerSelection){return}var k=jQuery("<table></table>");var b=function(l,i){return function(){var n=jQuery(this);var o=n.is(":checked");var m=l.find("td");i.selected=o;if(o){f.defaultBaseLayer=i.id}else{if(f.defaultBaseLayer==i.id){f.defaultBaseLayer=null}}}};for(var c=0;c<this.layers.length;++c){var d=this.layers[c];var j=this.templateLayerRow.clone();j.attr("data-id",d.id);var g=j.find("td");if(this.defaultBaseLayer&&this.defaultBaseLayer==d.id){jQuery(g[0]).find("input").attr("checked","checked");d.selected=true}jQuery(g[0]).find("input").change(b(j,d));jQuery(g[1]).append(d.name);k.append(j)}h.append(k);if(this.config.layers.promote&&this.config.layers.promote.length>0){this._populateLayerPromotion(h)}},_populateLayerPromotion:function(o){var g=this;var m=this.instance.getSandbox();var a=m.getRequestBuilder("AddMapLayerRequest");var c=function(i){return function(){m.request(g.instance.getName(),a(i.getId(),true))}};for(var e=0;e<this.config.layers.promote.length;++e){var b=this.config.layers.promote[e];var h=jQuery("<ul></ul>");var l=false;for(var d=0;d<b.id.length;++d){if(!m.isLayerAlreadySelected(b.id[d])){var n=jQuery('<li><a href="JavaScript:void(0);"></a></li>');var f=m.findMapLayerFromAllAvailable(b.id[d]);if(f){var k=n.find("a");k.append(f.getName());k.bind("click",c(f));h.append(n);l=true}}}if(l){o.append(b.text);o.append(h)}}},handleLayerSelectionChanged:function(){this.setupLayersList();var a=this.maplayerPanel.getContainer();a.empty();this._populateMapLayerPanel()},handleMapMoved:function(){var b=this.instance.sandbox.getMap();var d=b.getX();var c=b.getY();var a=b.getZoom();this.previewMap.moveMapToLanLot(new OpenLayers.LonLat(d,c));this.previewMap.setZoomLevel(a,true);
this.mainPanel.find("div.locationdata").html("N: "+c+" E: "+d+" "+this.loc.zoomlevel+": "+a)},setupLayersList:function(){this.layers=[];var c=this.instance.sandbox.findAllSelectedMapLayers();for(var b=0;b<c.length;++b){var a={id:c[b].getId(),name:c[b].getName()};this.layers.push(a)}},_createToolsPanel:function(){var g=this;var b=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");b.setTitle(this.loc.tools.label);var h=b.getContainer();var a=this.templateHelp.clone();a.attr("title","TODO: tooltip");h.append(a);var f=function(j,i){if(!j.plugin){j.plugin=Oskari.clazz.create(j.id,j.config);g.previewMap.registerPlugin(j.plugin)}if(i){j.plugin.startPlugin(g.instance.sandbox)}else{j.plugin.stopPlugin(g.instance.sandbox)}};var d=function(i){return function(){var j=jQuery(this);var k=j.is(":checked");i.selected=k;f(i,k)}};for(var e=0;e<this.tools.length;++e){var c=this.templateTool.clone();c.find("span").append(this.tools[e].name);if(this.tools[e].selected){c.find("input").attr("checked","checked");f(this.tools[e],true)}h.append(c);c.find("input").change(d(this.tools[e]))}return b},_addButtons:function(a){var b=this;var e=a.find("div.buttons");var d=jQuery('<input type="button" name="save" />');d.val(this.loc.buttons.save);d.bind("click",function(){b._gatherSelections(a)});var c=jQuery('<input type="button" name="cancel" />');c.val(this.loc.buttons.cancel);c.bind("click",function(){b.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[b.instance,"close"])});e.append(c);e.append(d)},_gatherSelections:function(b){var e=b.find("input[name=domain]").val();if(!this._checkLength(e,1)){alert(this.loc.error.domain);return}if(e.startsWith("http")||e.startsWith("www")){alert(this.loc.error.domainStart);return}var a=b.find("input[name=name]").val();if(!this._checkLength(a,1)){alert(this.loc.error.name);return}var f=b.find("select[name=language]").val();var k=b.find("input[name=size]:checked").val();var d={domain:e,name:a,language:f,plugins:[],layers:[]};for(var g=0;g<this.tools.length;++g){if(this.tools[g].selected){d.plugins.push({id:this.tools[g].id})}}if(k=="custom"){var c=b.find("div.customsize input[name=width]").val();var j=b.find("div.customsize input[name=height]").val();if(this._validateSize(c,j)){d.size={width:c,height:j}}else{alert(this.loc.error.size);return}}else{for(var g=0;g<this.sizeOptions.length;++g){var h=this.sizeOptions[g];if(h.id==k){d.size={width:h.width,height:h.height};break}}}if(this.showLayerSelection){d.tools.push("layerselection");for(var g=0;g<this.layers.length;++g){if(this.layers[g].selected){d.layers.push({id:this.layers[g].id})}}}jQuery.ajax({url:"/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=1&p_p_state=exclusive&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&_Portti2Map_WAR_portti2mapportlet_fi.mml.baseportlet.CMD=ajax.jsp&action_route=Publish",type:"POST",data:"pubdata="+JSON.stringify(d),dataType:"json",beforeSend:function(i){if(i&&i.overrideMimeType){i.overrideMimeType("application/j-son;charset=UTF-8")}},success:function(i){alert("Ok")},error:function(){alert("Fail")}})},_checkLength:function(d,b,a){if(d){var c=jQuery.trim(d.toString());if(b&&c.length<b){return false}if(a&&c.length>a){return false}return true}return false},_isNumber:function(a){return !isNaN(parseInt(a))&&isFinite(a)},_validateSize:function(d,a){if(!this._isNumber(d)||!this._isNumber(a)){return false}var e=null;for(var b=0;b<this.sizeOptions.length;++b){var c=this.sizeOptions[b];if(c.id=="custom"){e=c;break}}if(d<e.minWidth||d>e.maxWidth){return false}if(a<e.minHeight||a>e.maxHeight){return false}return true}});