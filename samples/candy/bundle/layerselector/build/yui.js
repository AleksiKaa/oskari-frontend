/* This is a packed Oskari bundle (bundle script version Mon Feb 27 2012 09:28:33 GMT+0200 (Suomen normaaliaika)) */ 
Oskari.clazz.define("Oskari.mapframework.ui.module.layerselector.AllLayersModule",function(){this.libs={ext:Oskari.$("Ext")};this.sandbox=null;var a=Oskari.$("startup");this.conf=a;this.stores={};this.items={};this.selected={};this.scale=null;this.refreshTools=null;this.refreshLayerNames=null},{__name:"AllLayersModule",getName:function(){return this.__name},refresh:function(){this.items.grid.getView().refresh()},init:function(a){this.sandbox=a;a.printDebug("[AllLayersModule] Initializing all layers module...");this.scale=a.getMap().getScale();for(var c in this.eventHandlers){a.registerForEventByName(this,c)}this.createModels();this.createStores();var b=this.createUI();this.updateCurrentState();return b},updateCurrentState:function(){var b=this.sandbox;var e=b.findAllSelectedMapLayers();for(var d=0;d<e.length;d++){var c=e[d];var a=c.getId();this.selected[a]=c;b.printDebug("[AllLayersModule] preselecting "+a)}},createModels:function(){var b=this.libs.ext;if(!b.ClassManager.get("MapLayer")){var a=["id","type","name","inspire","orgName","dataUrl","minScale","maxScale","orderNumber"];b.define("MapLayer",{extend:"Ext.data.Model",fields:a})}},getLayersData:function(){var e=this;var b=e.sandbox.getService("Oskari.mapframework.service.MapLayerService");var f=b.getAllLayers();var a=new Array();for(var d=0;d<f.length;d++){var c=Ext.create("MapLayer",{id:f[d].getId(),name:f[d].getName(),inspire:f[d].getInspireName(),orgName:f[d].getOrganizationName(),dataUrl:f[d].getDataUrl(),minScale:f[d].getMinScale(),maxScale:f[d].getMaxScale(),orderNumber:f[d].getOrderNumber()});if(f[d].isBaseLayer()){c.set("type","base")}else{if(f[d].isLayerOfType("WMS")){if(f[d].isGroupLayer()){c.set("type","group")}else{c.set("type","wmslayer")}}else{if(f[d].isLayerOfType("WFS")){c.set("type","wfslayer")}else{if(f[d].isLayerOfType("VECTOR")){c.set("type","vector")}}}}a.push(c)}return a},createStores:function(){var b=this.getLayersData();var a=Ext.create("Ext.data.Store",{model:"MapLayer",autoLoad:true,groupField:"inspire",data:[b]});this.regStore("allLayersStore",a)},regStore:function(b,a){this.stores[b]=a},getStore:function(a){return this.stores[a]},createUI:function(){var q=this;var f=this.libs.ext;var r=q.sandbox.getLanguage();function m(s,t,u){return'<div id="layerName_'+u.get("id")+'">'+g(s,u)+"</div>"}function g(s,u){var t=u.get("minScale");var v=u.get("maxScale");if(q.scale>v&&q.scale<t){return s}else{return'<span style="color: #c0c0c0;">'+s+"</span>"}}function o(t,u,s){return'<div id="layerTools_'+s.get("id")+'">'+d(s)+"</div>"}Ext.QuickTips.init();function d(t){var w="/resource/icons/taso.png";var v="mapservice_maplayer_image_tooltip";if(t.get("type")=="wfslayer"){w="/resource/silk-icons/database.png";v="selected_layers_module_wfs_icon_tooltip"}else{if(t.get("type")=="group"){w="/resource/icons/group.png";v="mapservice_basemap_image_tooltip"}else{if(t.get("type")=="base"){w="/resource/icons/pino.png";v="mapservice_basemap_image_tooltip"}}}var u='<img src="'+Oskari.$().startup.imageLocation+w+'" style="vertical-align: top;" data-qtip="'+q.sandbox.getText(v)+'"/> ';var s=t.get("id");if(isNaN(s)){s="'"+s+"'"}if(q.selected[t.get("id")]){u=u+'<a href="#" onclick="Oskari.$().sandbox.requestByName(\''+q.getName()+"', 'RemoveMapLayerRequest',["+s+']);return false;" data-qtip="'+q.sandbox.getText("mapservice_layer_delete_title")+'"><img src="'+Oskari.$().startup.imageLocation+'/resource/icons/poisto.png" height="15" /></a>'}else{if("base"==t.get("type")){u=u+'<a href="#" onclick="Oskari.$().sandbox.requestByName(\''+q.getName()+"', 'AddMapLayerRequest',["+s+',false]);return false;" data-qtip="'+q.sandbox.getText("leftpanel_add_layer")+'"><img src="'+Oskari.$().startup.imageLocation+'/resource/icons/lisays_vihrea.png" height="15" /></a>'}else{u=u+'<a href="#" onclick="Oskari.$().sandbox.requestByName(\''+q.getName()+"', 'AddMapLayerRequest',["+s+',true]);return false;" data-qtip="'+q.sandbox.getText("leftpanel_add_layer")+'"><img src="'+Oskari.$().startup.imageLocation+'/resource/icons/lisays_vihrea.png" height="15" /></a>'}}var x=t.get("dataUrl");if(x){u=u+' <a href="#" onclick="Oskari.$().sandbox.requestByName(\''+q.getName()+"', 'ShowOverlayPopupRequest',['"+x+'\']);return false;" data-qtip="'+q.sandbox.getText("mapservice_layer_show_info_title")+'"><img src="'+Oskari.$().startup.imageLocation+'/resource/icons/kysymysmerkki.png" height="15"/></a>'
}return u}function p(t){var u=q.getStore("allLayersStore").findBy(function(w){return w.get("id")==t});var s=q.getStore("allLayersStore").getAt(u);var v=Ext.get("layerTools_"+t);if(v){v.update(d(s))}}q.refreshTools=p;function h(){q.getStore("allLayersStore").each(function(t){var s=Ext.get("layerName_"+t.get("id"));if(s){var u=t.get("name");s.update(g(u,t))}})}q.refreshLayerNames=h;var i="Nimi";if(r=="sv"){i="Namn"}else{if(r=="en"){i="Name"}}var j=[{header:"Actions",width:64,renderer:o},{header:i,dataIndex:"name",flex:1,renderer:m}];var e=this.sandbox;var l=f.create("Ext.form.TextField",{height:25,emptyText:q.sandbox.getText("leftpanel_find_maplayers_value"),margin:0,padding:0,listeners:{focus:function(s){Oskari.$().sandbox.request("SearchModule",Oskari.$().sandbox.getRequestBuilder("DisableMapKeyboardMovementRequest")())},blur:function(s){Oskari.$().sandbox.request("SearchModule",Oskari.$().sandbox.getRequestBuilder("EnableMapKeyboardMovementRequest")())},change:{fn:a,scope:this,buffer:100}}});this.items.searchtf=l;var k=f.create("Ext.grid.feature.Grouping",{groupHeaderTpl:"{name} ({rows.length})",startCollapsed:true});var b=f.create("Ext.grid.Panel",{flex:1,margin:0,padding:0,bodyCls:"blanco",frame:false,hideHeaders:true,bodyBorder:false,store:q.getStore("allLayersStore"),viewConfig:{stripeRows:true},features:[k],columns:j});b.getStore().sort([{property:"inspire",direction:"ASC"},{property:"orderNumber",direction:"ASC"}]);this.items.grid=b;var n=Ext.createWidget("tabpanel",{flex:1,activeTab:0,defaults:{bodyPadding:0},listeners:{tabchange:function(u,v,t,s){t.removeAll(false);b.getStore().clearGrouping();b.getStore().group(v.getId());b.getStore().sort([{property:v.getId(),transform:function(w){return w.toLowerCase()},direction:"ASC"},{property:"orderNumber",direction:"ASC"}]);v.add(b)}},items:[{title:q.sandbox.getText("leftpanel_thema_title"),id:"inspire",layout:"fit",items:b},{title:q.sandbox.getText("leftpanel_organisation_title"),id:"orgName",layout:"fit"}]});function a(){var t=l.getValue();var s=(t!="");k.startCollapsed=true;q.getStore("allLayersStore").clearFilter(s);if(s){k.startCollapsed=false;q.getStore("allLayersStore").filterBy(function(u,y){var x=u.get("name");var v=u.get("orgName");var w=new RegExp(t,"gi");if(w.test(x)||w.test(v)){return true}})}}var c=f.create("Ext.panel.Panel",{bodyPadding:0,margin:0,id:"AllLayersModule",padding:0,layout:{type:"vbox",padding:0,align:"stretch"},items:[l,n]});return c},start:function(a){a.printDebug("[AllLayersModule] Starting "+this.getName())},stop:function(a){},checkLayerScales:function(a){},afterMapLayerAddEvent:function(c){var a=c.getMapLayer();var b=this;b.selected[a.getId()]=a;this.refreshTools(a.getId())},afterMapLayerRemoveEvent:function(c){var a=c.getMapLayer();var b=this;b.selected[a.getId()]=undefined;this.refreshTools(a.getId())},afterMapMoveEvent:function(b){var a=b.getScale();if(a==this.scale||!a){return}this.scale=a;this.refreshLayerNames()},handleMapLayerChange:function(b){var a=this;var c=this.getLayersData();a.getStore("allLayersStore").loadData(c)},eventHandlers:{AfterMapLayerAddEvent:function(a){this.afterMapLayerAddEvent(a)},AfterMapLayerRemoveEvent:function(a){this.afterMapLayerRemoveEvent(a)},AfterMapMoveEvent:function(a){this.afterMapMoveEvent(a)},MapLayerEvent:function(a){this.handleMapLayerChange(a)}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.bundle.DefaultLayerSelectorBundleInstance",function(a){this.name="layerselector";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{createPanel:function(){var c=this;var a=c.libs.ext;var b=a.create("Ext.Panel",{region:"center",layout:"fit",height:384,items:[]});return b},start:function(){if(this.mediator.getState()=="started"){return}var b=this;b.libs={ext:Oskari.$("Ext")};b.facade=Oskari.$("UI.facade");b.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.layerselector.AllLayersModule");var a=this.createPanel();var c=b.facade.appendExtensionModule(b.impl,b.name,{},b,"E",{fi:{title:"Kaikki tasot"},sv:{title:"?"},en:{title:"Map Layers"}},a);
b.def=c;a.add(c.initialisedComponent);b.impl.start(this.facade.getSandbox());b.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this,this.def);this.def=null;this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.DefaultLayerSelectorBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});