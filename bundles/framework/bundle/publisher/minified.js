Oskari.clazz.define("Oskari.mapframework.bundle.publisher.PublisherBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null,this.publisher=null,this.disabledLayers=null},{__name:"Publisher",getName:function(){return this.__name},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(e.started)return;e.started=!0;var t=this.conf,n=(t?t.sandbox:null)||"sandbox",r=Oskari.getSandbox(n);e.sandbox=r,this.localization=Oskari.getLocalization(this.getName()),r.register(e);for(p in e.eventHandlers)r.registerForEventByName(e,p);var i=r.getRequestBuilder("userinterface.AddExtensionRequest")(this);r.request(this,i),e._createUi(),e.publishMapEditorRequestHandler=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.request.PublishMapEditorRequestHandler",e),r.addRequestHandler("Publisher.PublishMapEditorRequest",e.publishMapEditorRequestHandler)},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},AfterMapLayerAddEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},MapLayerEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged()},"Publisher.MapPublishedEvent":function(e){var t=this.getLocalization(),n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=n.createCloseButton(t.BasicView.buttons.ok);r.addClass("primary");var i=t.published.urlPrefix+"/published/"+e.getLanguage()+"/"+e.getId(),s='<iframe src="'+i+'" width="'+e.getWidth()+'" height="'+e.getHeight()+'"></iframe>',o='<textarea rows="3" cols="80">'+s+"</textarea>",u=t.published.desc+"<br/>"+o;n.show(t.published.title,u,[r]),this.setPublishMode(!1)}},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},_createUi:function(){var e=this;this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setPublishMode:function(e,t,n){var r=this,i=jQuery("#contentMap"),s=jQuery("#maptools"),o=r.sandbox.findAllSelectedMapLayers(),u=null;for(var a=0;a<o.length;a++){var f=o[a];if(f.getLayerType()==="stats"){var l=this.sandbox.getRequestBuilder("StatsGrid.StatsGridRequest")(!1,f);this.sandbox.request(r.getName(),l),u=f;break}}if(e==1){this.disabledLayers=t,this.oskariLang=Oskari.getLang(),this._removeLayers(),i.addClass("mapPublishMode");var l=this.sandbox.getRequestBuilder("userinterface.UpdateExtensionRequest")(r,"close",r.getName());this.sandbox.request(r.getName(),l),this.publisher=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.BasicPublisher",this,this.getLocalization("BasicView"),n),this.publisher.render(i),this.publisher.setEnabled(!0),u&&this.publisher.initGrid(u)}else jQuery("#contentMap").width(""),jQuery(".oskariui-left").css({width:"",height:"100%","float":""}).removeClass("published-grid-left").empty(),jQuery(".oskariui-center").css({width:"100%","float":""}).removeClass("published-grid-center"),Oskari.setLang(this.oskariLang),this.publisher&&(this.publisher.setEnabled(!1),this.publisher.destroy()),i.removeClass("mapPublishMode"),this._addLayers();var c=r.sandbox.getRequestBuilder("MapFull.MapResizeEnabledRequest");if(c){var l=c(!e);r.sandbox.request(r,l)}},_addLayers:function(){var e=this,t=this.sandbox,n=t.getRequestBuilder("AddMapLayerRequest");if(this.disabledLayers)for(var r=0;r<this.disabledLayers.length;++r){var i=this.disabledLayers[r];t.request(e,n(i.getId(),!0))}},_removeLayers:function(){var e=this,t=this.sandbox,n=t.getRequestBuilder("RemoveMapLayerRequest");if(this.disabledLayers)for(var r=0;r<this.disabledLayers.length;++r){var i=this.disabledLayers[r];t.request(e,n(i.getId()))}},hasPublishRight:function(e){return e.getPermission("publish")=="publication_permission_ok"},getLayersWithoutPublishRights:function(){var e=[],t=this.sandbox.findAllSelectedMapLayers();for(var n=0;n<t.length;++n){var r=t[n];this.hasPublishRight(r)||e.push(r)}return e}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),define("bundles/framework/bundle/publisher/instance",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.Flyout",function(e){this.instance=e,this.container=null,this.state=null,this.template=null,this.view=null},{getName:function(){return"Oskari.mapframework.bundle.publisher.Flyout"},setEl:function(e,t,n){this.container=e[0],jQuery(this.container).hasClass("publisher")||jQuery(this.container).addClass("publisher")},startPlugin:function(){this.template=jQuery("<div></div>")},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("flyouttitle")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},createUi:function(){var e=this,t=jQuery(this.container);t.empty();var n=e.instance.getSandbox();n.getUser().isLoggedIn()?this.view=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.StartView",this.instance,this.instance.getLocalization("StartView")):this.view=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.NotLoggedIn",this.instance,this.instance.getLocalization("NotLoggedView")),this.view.render(t)},handleLayerSelectionChanged:function(){this.view&&this.view.handleLayerSelectionChanged&&this.view.handleLayerSelectionChanged()}},{protocol:["Oskari.userinterface.Flyout"]}),define("bundles/framework/bundle/publisher/Flyout",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.publisher.Tile"},setEl:function(e,t,n){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),define("bundles/framework/bundle/publisher/Tile",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.event.MapPublishedEvent",function(e,t,n,r){this._id=e,this._width=t,this._height=n,this._language=r},{__name:"Publisher.MapPublishedEvent",getName:function(){return this.__name},getId:function(){return this._id},getWidth:function(){return this._width},getHeight:function(){return this._height},getLanguage:function(){return this._language}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/publisher/event/MapPublishedEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.NotLoggedIn",function(e,t){this.instance=e,this.template=jQuery("<div class='notLoggedIn'></div>"),this.signupTemplate=jQuery("<div class='notLoggedIn'><a></a></div>"),this.registerTemplate=jQuery("<div class='notLoggedIn'><a></a></div>"),this.loc=t},{render:function(e){var t=this,n=this.template.clone(),r=this.signupTemplate.clone(),i=this.registerTemplate.clone();n.append(this.loc.text);var s=r.find("a");s.attr("href",this.loc.signupUrl),s.append(this.loc.signup);var o=i.find("a");o.attr("href",this.loc.registerUrl),o.append(this.loc.register),e.append(n),e.append(r),e.append(i)}}),define("bundles/framework/bundle/publisher/view/NotLoggedIn",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.StartView",function(e,t){this.instance=e,this.template=jQuery("<div class='startview'><div class='content'></div><div class='tou'><a href='JavaScript:void(0;)'></a></div><div class='buttons'></div></div>"),this.templateLayerList=jQuery("<div class='layerlist'><h4></h4><ul></ul></div>"),this.templateListItem=jQuery("<li></li>"),this.templateError=jQuery('<div class="error"><ul></ul></div>'),this.templateInfo=jQuery("<div class='icon-info'></div>"),this.loc=t,this.content=undefined,this.buttons={},this.hasAcceptedTou=!1},{render:function(e){var t=this,n=this.template.clone();this.content=n,n.find("div.content").before(this.loc.text),e.append(n);var r=n.find("div.tou a");r.append(this.loc.touLink),r.bind("click",function(){return t._showTermsOfUse(),!1});var i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.addClass("primary"),i.setHandler(function(){t.hasAcceptedTou||t._markTouAccepted();var e=t.instance.getLayersWithoutPublishRights();t.instance.setPublishMode(!0,e)}),this.buttons["continue"]=i,this._updateContinueButton(),i.insertTo(n.find("div.buttons"));var s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(this.loc.buttons.cancel),s.setHandler(function(){t.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[t.instance,"close"])}),this.buttons.cancel=s,s.insertTo(n.find("div.buttons")),this._renderLayerLists(),this._checkTouAccepted()},_renderLayerLists:function(){var e=this.content.find("div.content");e.find("div.error").remove(),e.find("div.layerlist").remove();var t=[],n=[],r=this.instance.sandbox.findAllSelectedMapLayers();for(var i=0;i<r.length;++i){var s=r[i];this.instance.hasPublishRight(s)?t.push(s):n.push(s)}if(t.length>0){var o=this._getRenderedLayerList(t),u=o.find("h4"),a="loc.layerlist_title";this.loc&&this.loc.layerlist_title&&(a=this.loc.layerlist_title),u.append(a),e.append(o),this.buttons["continue"].setEnabled(!0);if(n.length>0){var f=this._getRenderedLayerList(n),u=f.find("h4");u.append(this.loc.layerlist_denied);var l=this.templateInfo.clone();l.attr("title",this.loc.denied_tooltip),u.before(l),e.append(f)}}else{var c=this.templateError.clone(),h=this.templateListItem.clone();h.append(this.loc.layerlist_empty),c.find("ul").append(h),e.append(c),this.buttons["continue"].setEnabled(!1)}},_getRenderedLayerList:function(e){var t=this.templateLayerList.clone(),n=t.find("ul");for(var r=0;r<e.length;++r){var i=e[r],s=this.templateListItem.clone();s.append(i.getName()),n.append(s)}return t},handleLayerSelectionChanged:function(){this._renderLayerLists()},_showTermsOfUse:function(){var e=this;if(!this.termsOfUse){var t=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",e.instance.sandbox);t.getHelpArticle("termsofuse, mappublication, "+Oskari.getLang(),function(t,n){t&&(e.termsOfUse=n,e._showTermsOfUse())});return}var n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=n.createCloseButton(this.loc.buttons.close);n.show(e.termsOfUse.title,e.termsOfUse.body,[r])},_checkTouAccepted:function(){var e=this;jQuery.ajax({url:e.instance.sandbox.getAjaxUrl(),type:"GET",data:{action_route:"HasAcceptedPublishedTermsOfUse"},dataType:"json",error:function(){this.success(!1)},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){e.hasAcceptedTou=t,e._updateContinueButton()}})},_updateContinueButton:function(){this.hasAcceptedTou?this.buttons["continue"].setTitle(this.loc.buttons["continue"]):this.buttons["continue"].setTitle(this.loc.buttons.continueAndAccept)},_markTouAccepted:function(){var e=this;jQuery.ajax({url:e.instance.sandbox.getAjaxUrl(),type:"GET",data:{action_route:"AcceptPublishedTermsOfUse"},dataType:"json",error:function(){this.success(!1)},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){e.hasAcceptedTou=t,e._updateContinueButton()}})}}),define("bundles/framework/bundle/publisher/view/StartView",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.BasicPublisher",function(e,t,n){this.data=n;var r=this;this.instance=e,this.template=jQuery('<div class="basic_publisher"><div class="header"><div class="icon-close"></div><h3></h3></div><div class="content"></div></div>'),r.templates={publishedGridTemplate:'<div class="publishedgrid"></div>'},this.templateButtonsDiv=jQuery('<div class="buttons"></div>'),this.templateHelp=jQuery('<div class="help icon-info"></div>'),this.templateTool=jQuery('<div class="tool "><input type="checkbox"/><span></span></div>'),this.templateData=jQuery('<div class="data "><input type="checkbox"/><label></label></div>'),this.templateSizeOptionTool=jQuery('<div class="tool "><input type="radio" name="size" /><span></span></div>'),this.templateCustomSize=jQuery('<div class="customsize"><input type="text" name="width" placeholder="'+t.sizes.width+'"/> x '+'<input type="text" name="height" placeholder="'+t.sizes.height+'"/></div>'),this.tools=[{id:"Oskari.mapframework.bundle.mapmodule.plugin.ScaleBarPlugin",selected:!1},{id:"Oskari.mapframework.bundle.mapmodule.plugin.IndexMapPlugin",selected:!1},{id:"Oskari.mapframework.bundle.mapmodule.plugin.PanButtons",selected:!1,config:{location:{top:"10px",left:"10px"}}},{id:"Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar",selected:!0,config:{location:{top:"10px",left:"10px"}}},{id:"Oskari.mapframework.bundle.mapmodule.plugin.SearchPlugin",selected:!1},{id:"Oskari.mapframework.mapmodule.ControlsPlugin",selected:!0},{id:"Oskari.mapframework.mapmodule.GetInfoPlugin",selected:!0}],this.sizeOptions=[{id:"small",width:580,height:387},{id:"medium",width:700,height:525,selected:!0},{id:"large",width:1240,height:700},{id:"custom",minWidth:30,minHeight:20,maxWidth:4e3,maxHeight:2e3}],this.grid={},this.grid.selected=!0;if(n){n.lang&&Oskari.setLang(n.lang);var i=!1,s=this.data.state.mapfull.config.size.width,o=this.data.state.mapfull.config.size.height;for(var u=0;u<this.sizeOptions.length;++u){var a=this.sizeOptions[u];s===a.width&&o==a.height?(a.selected=!0,i=!0):a.selected=!1}if(!i){var f=this.sizeOptions[this.sizeOptions.length-1];f.selected=!0,f.width=s,f.height=o}var l=this.data.state.mapfull.config.plugins;this.data.hasLayerSelectionPlugin=!1;for(var u=0;u<this.tools.length;++u){var a=this.tools[u];for(var c=0;c<l.length;++c){var h=l[c];if(a.id==h.id){a.selected=!0;break}a.selected=!1,h.id=="Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin"&&(this.data.hasLayerSelectionPlugin=h.config)}}}this.loc=t,this.accordion=null,this.maplayerPanel=null,this.mainPanel=null,this.normalMapPlugins=[],this.logoPlugin=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.plugin.LogoPlugin"),this.latestGFI=null},{render:function(e){var t=this,n=this.template.clone();this.mainPanel=n,e.append(n);var r=n.find("div.content"),i=Oskari.clazz.create("Oskari.userinterface.component.Accordion");this.accordion=i;var s=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.PublisherLocationForm",this.loc,this);this.locationForm=s,this.data?(n.find("div.header h3").append(this.loc.titleEdit),s.init({domain:this.data.domain,name:this.data.name,lang:this.data.lang})):(n.find("div.header h3").append(this.loc.title),s.init());var o=s.getPanel();o.open(),i.addPanel(o);var u=this.instance.getSandbox(),a=u.findAllSelectedMapLayers(),f=!1;for(var l=0;l<a.length;l++){var c=a[l];c.getLayerType()==="stats"&&(f=!0)}if(f){var h=u.findRegisteredModuleInstance("MainMapModule");t.mapModule=h;var e=jQuery(t.templates.publishedGridTemplate);t.statsContainer=e;var p=this._createDataPanel();p.open(),i.addPanel(p)}i.addPanel(this._createSizePanel()),i.addPanel(this._createToolsPanel()),this.maplayerPanel=Oskari.clazz.create("Oskari.mapframework.bundle.publisher.view.PublisherLayerForm",this.loc,this.instance),this.maplayerPanel.init(),i.addPanel(this.maplayerPanel.getPanel()),i.insertTo(r),e.find("div.header div.icon-close").bind("click",function(){t.instance.setPublishMode(!1)}),r.append(this._getButtons());var d=this.mainPanel.find("input[type=text]");d.focus(function(){t.instance.sandbox.postRequestByName("DisableMapKeyboardMovementRequest")}),d.blur(function(){t.instance.sandbox.postRequestByName("EnableMapKeyboardMovementRequest")});var v=Oskari.clazz.create("Oskari.userinterface.component.UIHelper",this.instance.sandbox);v.processHelpLinks(this.loc.help,n,this.loc.error.title,this.loc.error.nohelp)},_setSelectedSize:function(){var e=this,t=this.mainPanel.find("div.customsize input[name=width]");t.removeClass("error");var n=this.mainPanel.find("div.customsize input[name=height]");n.removeClass("error");var r=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");for(var i=0;i<e.sizeOptions.length;++i){var s=e.sizeOptions[i];if(s.selected){var o=jQuery(r.getMap().div);if(s.id=="custom"){var u=t.val();this._validateNumberRange(u,s.minWidth,s.maxWidth)?(o.width(u),e.adjustDataContainer()):t.addClass("error");var a=n.val();this._validateNumberRange(a,s.minHeight,s.maxHeight)?o.height(a):n.addClass("error");break}o.width(s.width),o.height(s.height),e.adjustDataContainer();break}}r.updateSize()},_createSizePanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.size.label);var n=t.getContainer(),r=this.templateHelp.clone();r.attr("title",this.loc.size.tooltip),n.append(r);var i=function(t){return function(){var r=n.find("input[name=size]:checked").val();for(var i=0;i<e.sizeOptions.length;++i)e.sizeOptions[i].selected=!1;t.selected=!0,e._setSelectedSize()}},s=!1;for(var o=0;o<this.sizeOptions.length;++o){var u=this.sizeOptions[o],a=this.templateSizeOptionTool.clone(),f=this.loc.sizes[u.id];u.width&&u.height&&"custom"!=u.id&&(f=e._getSizeLabel(f,u)),a.find("span").addClass("sizeoption_"+u.id).append(f),u.selected&&(a.find("input").attr("checked","checked"),"custom"==u.id&&(s=!0)),n.append(a),a.find("input").attr("value",u.id),a.find("input").change(i(u))}var l=this.templateCustomSize.clone(),c=l.find("input");c.focus(function(){var e=n.find("input[name=size][value=custom]");e.attr("checked","checked"),e.trigger("change")}),c.bind("keyup",function(){e._setSelectedSize()});if(s){var h=l.find("input[name=width]");h.val(u.width);var p=l.find("input[name=height]");p.val(u.height)}return n.append(l),t},_getSizeLabel:function(e,t){var n=this.isDataVisible?this._calculateGridWidth():0;return e+" ("+(t.width+n)+" x "+t.height+"px)"},_setSizeLabels:function(){for(var e=0;e<this.sizeOptions.length;++e){var t=this.sizeOptions[e],n=jQuery("span.sizeoption_"+t.id),r=this.loc.sizes[t.id];t.width&&t.height&&"custom"!=t.id&&(r=this._getSizeLabel(r,t)),n.text(r)}},_createToolsPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.tools.label);var n=t.getContainer(),r=this.templateHelp.clone();r.attr("title",this.loc.tools.tooltip),n.append(r);var i=function(t){return function(){var n=jQuery(this),r=n.is(":checked");t.selected=r,e._activatePreviewPlugin(t,r)}};for(var s=0;s<this.tools.length;++s){var o=this.templateTool.clone(),u=this.tools[s].id;u=u.substring(u.lastIndexOf(".")+1);var a=this.loc.tools[u];o.find("span").append(a),this.tools[s].selected&&o.find("input").attr("checked","checked"),n.append(o),o.find("input").change(i(this.tools[s]))}return t},_createDataPanel:function(){var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");t.setTitle(this.loc.data.label);var n=t.getContainer(),r=this.templateHelp.clone();r.attr("title",this.loc.data.tooltip),n.append(r);var i=this.templateData.clone();return i.find("input").attr("id","show-grid-checkbox").change(function(){var t=jQuery(this),n=t.is(":checked");e.isDataVisible=n,e.adjustDataContainer(),e._setSizeLabels()}),i.find("label").attr("for","show-grid-checkbox").append(this.loc.data.grid),this.grid.selected&&(i.find("input").attr("checked","checked"),e.isDataVisible=this.grid.selected,e.adjustDataContainer()),n.append(i),t},adjustDataContainer:function(){if(!this.statsContainer)return;var e=this,t=jQuery("#contentMap"),n=t.width(),r=t.css("margin-left").split("px")[0],i=jQuery(window).width()-r-40,s=jQuery("#mapdiv").width(),o=jQuery("#mapdiv").height(),u=this._calculateGridWidth(),a=o,f=jQuery(".oskariui-left"),l=jQuery(".oskariui-center");this.isDataVisible?(u>400&&(u=400),f.removeClass("oskari-closed"),jQuery("#contentMap").width(u+s),u+="px",a+="px",s+="px"):(f.addClass("oskari-closed"),jQuery("#contentMap").width(""),u="0px",a="0px",n="100%"),f.css({width:u,height:a,"float":"left"}).addClass("published-grid-left"),l.css({width:s,"float":"left"}).addClass("published-grid-center"),this.statsContainer.height(o),this.gridPlugin&&this.gridPlugin.setGridHeight()},_calculateGridWidth:function(){var e=this,t=Oskari.getSandbox("sandbox"),n,r=t.getStatefulComponents().statsgrid;if(r&&r.state&&r.state.indicators!=null){var i=r.state.indicators.length+2;n=i*80}else n=160;return n+20},getDataContainer:function(){return jQuery(".oskariui-left")},addDataGrid:function(e){this.getDataContainer.html(e)},handleMapMoved:function(){var e=this.instance.sandbox.getMap(),t=e.getX(),n=e.getY(),r=e.getZoom()},_activatePreviewPlugin:function(e,t){if(!e.plugin&&t){var n=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");e.plugin=Oskari.clazz.create(e.id,e.config),n.registerPlugin(e.plugin)}if(!e.plugin)return;t?(e.plugin.startPlugin(this.instance.sandbox),e._isPluginStarted=!0):e._isPluginStarted&&(e._isPluginStarted=!1,e.plugin.stopPlugin(this.instance.sandbox)),this._adjustMapNavigationLocation(e,t)},_getButtons:function(){var e=this,t=this.templateButtonsDiv.clone(),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(this.loc.buttons.cancel),n.setHandler(function(){e.instance.setPublishMode(!1)}),n.insertTo(t);var r=Oskari.clazz.create("Oskari.userinterface.component.Button");r.setTitle(this.loc.buttons.save),r.addClass("primary");if(this.data){var i=function(){var t=e._gatherSelections();t&&e._publishMap(t)};r.setTitle(this.loc.buttons.saveNew),r.setHandler(function(){e.data.id=null,delete e.data.id,i()}),r.insertTo(t);var s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(this.loc.buttons.replace),s.addClass("primary"),s.setHandler(function(){e._showReplaceConfirm(i)}),s.insertTo(t)}else r.setTitle(this.loc.buttons.save),r.setHandler(function(){var t=e._gatherSelections();t&&e._publishMap(t)}),r.insertTo(t);return t},_showReplaceConfirm:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=Oskari.clazz.create("Oskari.userinterface.component.Button");n.setTitle(this.loc.buttons.replace),n.addClass("primary"),n.setHandler(function(){t.close(),e()});var r=t.createCloseButton(this.loc.buttons.cancel);t.show(this.loc.confirm.replace.title,this.loc.confirm.replace.msg,[r,n])},_showValidationErrorMessage:function(e){var t=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=t.createCloseButton(this.loc.buttons.ok),r=jQuery("<ul></ul>");for(var i=0;i<e.length;++i){var s=jQuery("<li></li>");s.append(e[i].error),r.append(s)}t.show(this.loc.error.title,r,[n])},_gatherSelections:function(){var e=this.mainPanel,t=this.instance.getSandbox(),n=this.locationForm.validate(),r=this.locationForm.getValues(),i=e.find("input[name=size]:checked").val(),s=this._calculateGridWidth(),o={domain:r.domain,name:r.name,language:r.language,plugins:[]};this.data&&this.data.id&&(o.id=this.data.id);for(var u=0;u<this.tools.length;++u)if(this.tools[u].selected){var a={id:this.tools[u].id};this.tools[u].config&&(a.config=this.tools[u].config),o.plugins.push(a)}if(i=="custom"){var f=e.find("div.customsize input[name=width]").val(),l=e.find("div.customsize input[name=height]").val();this._validateSize(f,l)?o.size={width:f,height:l}:n.push({field:"size",error:this.loc.error.size})}else for(var u=0;u<this.sizeOptions.length;++u){var c=this.sizeOptions[u];if(c.id==i){o.size={width:c.width,height:c.height};break}}var h=this.maplayerPanel.getValues();h.layerSelection&&(o.plugins.push(h.layerSelection),o.defaultBase=h.defaultBase,o.baseLayers=h.baseLayers);if(this.isDataVisible){var p=this.sandbox.getStatefulComponents().statsgrid;o.gridState=p.state}var d=t.getStatefulComponents().mapfull.getState();o.mapstate=d,t.getStatefulComponents().infobox&&(o.infobox=t.getStatefulComponents().infobox.getState());if(n.length>0){this._showValidationErrorMessage(n);return}return o},_adjustMapNavigationLocation:function(e,t){var n,r,i,s={top:"110px",left:"45px"},o={top:"10px",left:"10px"};for(var u=0;u<this.tools.length;++u)this.tools[u].id==="Oskari.mapframework.bundle.mapmodule.plugin.Portti2Zoombar"&&(n=this.tools[u]),this.tools[u].id==="Oskari.mapframework.bundle.mapmodule.plugin.PanButtons"&&(r=this.tools[u]);if(e.id===n.id)r._isPluginStarted?i=s:i=o;else{if(e.id!==r.id)return;t?i=s:i=o}n._isPluginStarted&&(n.config.location=i,n.plugin.setZoombarLocation(i))},_publishMap:function(e){var t=this,n=this.instance.getSandbox(),r=n.getAjaxUrl(),i=t.isDataVisible?e.size.width+t._calculateGridWidth():e.size.width,s=function(){var e=Oskari.clazz.create("Oskari.userinterface.component.Popup"),n=e.createCloseButton(t.loc.buttons.ok);e.show(t.loc.error.title,t.loc.error.saveFailed,[n])};jQuery.ajax({url:r+"&action_route=Publish",type:"POST",dataType:"json",data:{pubdata:JSON.stringify(e)},beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},success:function(t){if(t.id>0){var r=n.getEventBuilder("Publisher.MapPublishedEvent")(t.id,i,e.size.height,e.language);n.notifyAll(r)}else s()},error:s})},_validateNumberRange:function(e,t,n){return isNaN(parseInt(e))?!1:isFinite(e)?e<t||e>n?!1:!0:!1},_validateSize:function(e,t){var n=null;for(var r=0;r<this.sizeOptions.length;++r){var i=this.sizeOptions[r];if(i.id=="custom"){n=i;break}}var s=this._validateNumberRange(e,n.minWidth,n.maxWidth)&&this._validateNumberRange(t,n.minHeight,n.maxHeight);return s},_enablePreview:function(){var e=this,t=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule"),n=t.getPluginInstances();for(var r in n){var i=n[r];i.hasUI&&i.hasUI()&&(i.stopPlugin(e.instance.sandbox),t.unregisterPlugin(i),this.normalMapPlugins.push(i))}this.maplayerPanel.start(),this.data&&this.data.hasLayerSelectionPlugin&&this.maplayerPanel.useConfig(this.data.hasLayerSelectionPlugin),this._setSelectedSize();for(var s=0;s<this.tools.length;++s)this.tools[s].selected&&this._activatePreviewPlugin(this.tools[s],!0);t.registerPlugin(this.logoPlugin),this.logoPlugin.startPlugin(e.instance.sandbox)},_disablePreview:function(){var e=this,t=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule"),n=t.getPluginInstances();for(var r=0;r<this.tools.length;++r)this.tools[r].plugin&&(this._activatePreviewPlugin(this.tools[r],!1),t.unregisterPlugin(this.tools[r].plugin),this.tools[r].plugin=undefined,delete this.tools[r].plugin);this.maplayerPanel.stop();var i=jQuery(t.getMap().div);i.width(""),i.height(jQuery(window).height()),t.updateSize();for(var r=0;r<this.normalMapPlugins.length;++r){var s=this.normalMapPlugins[r];t.registerPlugin(s),s.startPlugin(e.instance.sandbox)}this.normalMapPlugins=[],t.unregisterPlugin(this.logoPlugin),this.logoPlugin.stopPlugin(e.instance.sandbox)},setEnabled:function(e){e?this._enablePreview():this._disablePreview()},destroy:function(){this.mainPanel.remove()},setPluginLanguage:function(e){Oskari.setLang(e);for(var t=0;t<this.tools.length;++t){var n=this.tools[t];n._isPluginStarted&&(this._activatePreviewPlugin(n,!1),this._activatePreviewPlugin(n,!0))}this._resetLayerSelectionPlugin(),this.logoPlugin.stopPlugin(this.instance.sandbox),this.logoPlugin.startPlugin(this.instance.sandbox)},_resetLayerSelectionPlugin:function(){if(this.maplayerPanel.isEnabled()){var e=this.maplayerPanel.plugin.getBaseLayers();this.maplayerPanel.enablePlugin(!1),this.maplayerPanel.enablePlugin(!0);var t=e.baseLayers,n=e.defaultBaseLayer;for(var r=0;r<t.length;++r){var i=this.instance.sandbox.findMapLayerFromSelectedMapLayers(t[r]);this.maplayerPanel.plugin.addBaseLayer(i)}this.maplayerPanel.plugin.selectBaseLayer(n)}},initGrid:function(e){var t=this,n=t.conf,r=Oskari.getLocalization("StatsGrid"),i=!0,s="sandbox",o=Oskari.getSandbox(s);t.sandbox=o,o.register(t.instance);var u=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.StatisticsService",t);o.registerService(u),t.statsService=u;var a=t.sandbox.getStatefulComponents().statsgrid;if(a&&a.state&&i){var f={published:!0,layer:e,state:a.state},l=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageStatsPlugin",f,r);t.mapModule.registerPlugin(l),t.mapModule.startPlugin(l),t.gridPlugin=l;var c=Oskari.clazz.create("Oskari.statistics.bundle.statsgrid.plugin.ManageClassificationPlugin",n,r);t.mapModule.registerPlugin(c),t.mapModule.startPlugin(c),t.classifyPlugin=c;var h=t.getDataContainer();h.html(t.statsContainer),t.gridPlugin.createStatsOut(t.statsContainer)}}}),define("bundles/framework/bundle/publisher/view/BasicPublisher",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.PublisherLocationForm",function(e,t){this.loc=e,this._publisher=t,this.fields={domain:{label:e.domain.label,placeholder:e.domain.placeholder,helptags:"portti,help,publisher,domain",tooltip:e.domain.tooltip},name:{label:e.name.label,placeholder:e.name.placeholder,helptags:"portti,help,publisher,name",tooltip:e.name.tooltip}},this.langField={template:jQuery('<div class="field"><div class="help icon-info" title="'+e.language.tooltip+'" helptags="portti,help,publisher,language"></div>'+'<label for="language">'+e.language.label+'</label><br clear="all" />'+'<select name="language"></select>'+"</div>"),optionTemplate:jQuery("<option></option>")}},{init:function(e){var t=this;for(var n in this.fields){var r=this.fields[n],i=Oskari.clazz.create("Oskari.userinterface.component.FormInput",n);i.setLabel(r.label),i.setTooltip(r.tooltip,r.helptags),i.setPlaceholder(r.placeholder),r.field=i}this.fields.domain.field.setRequired(!0,this.loc.error.domain),this.fields.domain.field.setContentCheck(!0,this.loc.error.domainIllegalCharacters),this.fields.domain.field.setValidator(function(e){var n=e.getValue(),r=e.getName(),i=[];return n.indexOf("http")===0||n.indexOf("www")===0?(i.push({field:r,error:t.loc.error.domainStart}),i):i}),this.fields.name.field.setRequired(!0,this.loc.error.name),this.fields.name.field.setContentCheck(!0,this.loc.error.nameIllegalCharacters),e&&(this.fields.domain.field.setValue(e.domain),this.fields.name.field.setValue(e.name));var s=this.langField.template.clone(),o=s.find("select[name=language]"),u=this.loc.language.options,a=Oskari.getLang();e&&e.lang&&(a=e.lang);for(var f in u){var l=this.langField.optionTemplate.clone();l.attr("value",f),a==f&&l.attr("selected","selected"),l.append(u[f]),o.append(l)}o.change(function(){t._publisher.setPluginLanguage(jQuery(this).attr("value"))}),this.langField.field=s},getPanel:function(){var e=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");e.setTitle(this.loc.domain.title);var t=e.getContainer();for(var n in this.fields){var r=this.fields[n];t.append(r.field.getField())}return t.append(this.langField.field),e},getValues:function(){var e={};for(var t in this.fields){var n=this.fields[t];e[t]=n.field.getValue()}return e.language=this.langField.field.find("select[name=language]").val(),e},validate:function(){var e=[];for(var t in this.fields){var n=this.fields[t];e=e.concat(n.field.validate())}return e}}),define("bundles/framework/bundle/publisher/view/PublisherLocationForm",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.view.PublisherLayerForm",function(e,t){this.loc=e,this.instance=t,this.panel=null,this.plugin=null,this.isDataVisible=!1,this.templateHelp=jQuery('<div class="help icon-info"></div>'),this.templateTool=jQuery('<div class="tool"><input type="checkbox"/><label></label></div>'),this.config={layers:{promote:[{text:this.loc.layerselection.promote,id:[24]}],preselect:["base_35"]}},this.showLayerSelection=!1},{init:function(){this.panel||(this.panel=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel"),this.panel.setTitle(this.loc.layers.label)),this.plugin=Oskari.clazz.create("Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin")},useConfig:function(e){e&&(Object.prototype.toString.call(e.baseLayers)==="[object Array]"&&e.baseLayers.length>0?this.config.layers.preselect=e.baseLayers:this.config.layers.preselect=[],this.showLayerSelection=!0,this.enablePlugin(!0),this._populateMapLayerPanel())},getPanel:function(){return this._populateMapLayerPanel(),this.panel},enablePlugin:function(e){e?this.plugin.startPlugin(this.instance.sandbox):this.plugin.stopPlugin(this.instance.sandbox)},isEnabled:function(){return this.showLayerSelection},start:function(){var e=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");e.registerPlugin(this.plugin),this.showLayerSelection&&this.enablePlugin(!0)},stop:function(){this.enablePlugin(!1);var e=this.instance.sandbox.findRegisteredModuleInstance("MainMapModule");e.unregisterPlugin(this.plugin)},getValues:function(){var e={};if(this.showLayerSelection){e.layerSelection={id:"Oskari.mapframework.bundle.mapmodule.plugin.LayerSelectionPlugin",config:{}};var t=this.plugin.getBaseLayers();t.defaultBaseLayer&&(e.layerSelection.config.baseLayers=t.baseLayers,e.layerSelection.config.defaultBaseLayer=t.defaultBaseLayer)}return e},validate:function(){var e=[];return e},_getLayersList:function(){var e=[],t=this.instance.sandbox.findAllSelectedMapLayers();return t},_populateMapLayerPanel:function(){var e=this,t=this.panel.getContainer();t.empty();var n=this.templateHelp.clone();n.attr("title",this.loc.layerselection.tooltip),t.append(n);var r=this.templateTool.clone();r.find("label").attr("for","show-map-layers-checkbox").append(this.loc.layerselection.label),this.showLayerSelection&&r.find("input").attr("checked","checked"),t.append(r),t.append(this.loc.layerselection.info),r.find("input").attr("id","show-map-layers-checkbox").change(function(){var n=jQuery(this),r=n.is(":checked");e.showLayerSelection=r,e.enablePlugin(r),t.empty(),e._populateMapLayerPanel()});if(!this.showLayerSelection)return;var i=function(t){return function(){var n=jQuery(this),r=n.is(":checked");t.selected=r,r?e.plugin.addBaseLayer(t):e.plugin.removeBaseLayer(t)}},s=function(t){var n=jQuery.inArray(""+t,e.config.layers.preselect);return n!=-1},o=this._getLayersList();for(var u=0;u<o.length;++u){var a=o[u],f=this.templateTool.clone();f.attr("data-id",a.getId()),f.find("label").attr("for","checkbox"+a.getId()).append(a.getName());var l=f.find("input");l.attr("id","checkbox"+a.getId()),s(a.getId())&&(l.attr("checked","checked"),a.selected=!0,this.plugin.addBaseLayer(a)),l.change(i(a)),t.append(f)}this.config.layers.promote&&this.config.layers.promote.length>0&&this._populateLayerPromotion(t)},_populateLayerPromotion:function(e){var t=this,n=this.instance.getSandbox(),r=n.getRequestBuilder("AddMapLayerRequest"),i=n.getRequestBuilder("RemoveMapLayerRequest"),s=function(e){return function(){var s=jQuery(this),o=s.is(":checked");o?(n.request(t.instance,r(e.getId(),!0)),t.plugin.addBaseLayer(e)):n.request(t.instance,i(e.getId()))}};for(var o=0;o<this.config.layers.promote.length;++o){var u=this.config.layers.promote[o],a=this._getActualPromotionLayers(u.id);if(a.length>0){e.append(u.text);for(var f=0;f<a.length;++f){var l=a[f],c=this.templateTool.clone();c.attr("data-id",l.getId()),c.find("label").attr("for","checkbox"+l.getId()).append(l.getName());var h=c.find("input");h.attr("id","checkbox"+l.getId()),h.change(s(l)),e.append(c)}}}},_getActualPromotionLayers:function(e){var t=this.instance.getSandbox(),n=[];for(var r=0;r<e.length;++r)if(!t.isLayerAlreadySelected(e[r])){var i=t.findMapLayerFromAllAvailable(e[r]);i&&n.push(i)}return n}}),define("bundles/framework/bundle/publisher/view/PublisherLayerForm",function(){}),define("normalize",["require","module"],function(e,t){function o(e,t,n){if(e.indexOf("data:")===0)return e;e=r(e);if(e.match(/^\//)||e.match(s))return e;var i=n.match(s),o=t.match(s);return o&&(!i||i[1]!=o[1]||i[2]!=o[2])?u(e,t):a(u(e,t),n)}function u(e,t){e.substr(0,2)=="./"&&(e=e.substr(2));var n=t.split("/"),r=e.split("/");n.pop();while(curPart=r.shift())curPart==".."?n.pop():n.push(curPart);return n.join("/")}function a(e,t){var n=t.split("/");n.pop(),t=n.join("/")+"/",i=0;while(t.substr(i,1)==e.substr(i,1))i++;while(t.substr(i,1)!="/")i--;t=t.substr(i+1),e=e.substr(i+1),n=t.split("/");var r=e.split("/");out="";while(n.shift())out+="../";while(curPart=r.shift())out+=curPart+"/";return out.substr(0,out.length-1)}var n=/([^:])\/+/g,r=function(e){return e.replace(n,"$1/")},s=/[^\:\/]*:\/\/([^\/])*/,f=function(e,t,n,i){t=r(t),n=r(n);var s=/@import\s*("([^"]*)"|'([^']*)')|url\s*\(\s*(\s*"([^"]*)"|'([^']*)'|[^\)]*\s*)\s*\)/ig,u,a,e;while(u=s.exec(e)){a=u[3]||u[2]||u[5]||u[6]||u[4];var f;i&&a.substr(0,1)=="/"?f=i+a:f=o(a,t,n);var l=u[5]||u[6]?1:0;e=e.substr(0,s.lastIndex-a.length-l-1)+f+e.substr(s.lastIndex-l-1),s.lastIndex=s.lastIndex+(f.length-a.length)}return e};return f.convertURIBase=o,f}),define("css",["./normalize"],function(e){function t(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}if(typeof window=="undefined")return{load:function(e,t,n){n()}};var n=!1,r=document.getElementsByTagName("head")[0],i=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/),s=!1;!i||(i[1]||i[7]?(s=parseInt(i[1])<6||parseInt(i[7])<=9,i="trident"):i[2]?(s=!0,i="webkit"):i[3]||(i[4]?(s=parseInt(i[4])<18,i="gecko"):n&&alert("Engine detection failed")));var o={},u=/^\/|([^\:\/]*:)/;o.pluginBuilder="./css-builder";var a=[],f={},l=[];o.addBuffer=function(e){if(t(a,e)!=-1)return;if(t(l,e)!=-1)return;a.push(e),l.push(e)},o.setBuffer=function(t,n){var r=window.location.pathname.split("/");r.pop(),r=r.join("/")+"/";var i=require.toUrl("base_url").split("/");i.pop();var s=i.join("/")+"/";s=e.convertURIBase(s,r,"/"),s.match(u)||(s="/"+s),s.substr(s.length-1,1)!="/"&&(s+="/"),o.inject(e(t,s,r));for(var l=0;l<a.length;l++)(n&&a[l].substr(a[l].length-5,5)==".less"||!n&&a[l].substr(a[l].length-4,4)==".css")&&(function(e){f[e]=f[e]||!0,setTimeout(function(){typeof f[e]=="function"&&f[e](),delete f[e]},7)}(a[l]),a.splice(l--,1))},o.attachBuffer=function(e,n){for(var r=0;r<a.length;r++)if(a[r]==e)return f[e]=n,!0;if(f[e]===!0)return f[e]=n,!0;if(t(l,e)!=-1)return n(),!0};var c=function(e,t){setTimeout(function(){for(var n=0;n<document.styleSheets.length;n++){var r=document.styleSheets[n];if(r.href==e.href)return t()}c(e,t)},10)},h=function(e,t){setTimeout(function(){try{return e.sheet.cssRules,t()}catch(n){}h(e,t)},10)};if(i=="trident"&&s)var p=[],d=[],v=0,m=function(e,t){var n;d.push({url:e,cb:t}),n=p.shift(),!n&&v++<31&&(n=document.createElement("style"),r.appendChild(n)),n&&g(n)},g=function(e){var t=d.shift();if(!t){e.onload=b,p.push(e);return}e.onload=function(){t.cb(t.ss),g(e)};var n=e.styleSheet;t.ss=n.imports[n.addImport(t.url)]};var y=function(e){var t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.href=e,t},b=function(){};o.linkLoad=function(e,t){var o=setTimeout(function(){n&&alert("timeout"),t()},L*1e3-100),u=function(){clearTimeout(o),a&&(a.onload=b),setTimeout(t,7)};if(!s){var a=y(e);a.onload=u,r.appendChild(a)}else if(i=="webkit"){var a=y(e);c(a,u),r.appendChild(a)}else if(i=="gecko"){var f=document.createElement("style");f.textContent='@import "'+e+'"',h(f,u),r.appendChild(f)}else i=="trident"&&m(e,u)};var w=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],E={},S=function(e,t,n){if(E[e]){t(E[e]);return}var r,i,s;if(typeof XMLHttpRequest!="undefined")r=new XMLHttpRequest;else if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){s=w[i];try{r=new ActiveXObject(s)}catch(o){}if(r){w=[s];break}}r.open("GET",e,requirejs.inlineRequire?!1:!0),r.onreadystatechange=function(i){var s,o;r.readyState===4&&(s=r.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=r,n(o)):(E[e]=r.responseText,t(r.responseText)))},r.send(null)},x=0,T;o.inject=function(e){x<31&&(T=document.createElement("style"),T.type="text/css",r.appendChild(T),x++),T.styleSheet?T.styleSheet.cssText+=e:T.appendChild(document.createTextNode(e))};var N=/@import\s*(url)?\s*(('([^']*)'|"([^"]*)")|\(('([^']*)'|"([^"]*)"|([^\)]*))\))\s*;?/g,C=window.location.pathname.split("/");C.pop(),C=C.join("/")+"/";var k=function(t,n,r){t.match(u)||(t="/"+e.convertURIBase(t,C,"/")),S(t,function(i){i=e(i,t,C);var s=[],o=[],u=[],a;while(a=N.exec(i)){var f=a[4]||a[5]||a[7]||a[8]||a[9];s.push(f),o.push(N.lastIndex-a[0].length),u.push(a[0].length)}var l=0;for(var c=0;c<s.length;c++)(function(e){k(s[e],function(t){i=i.substr(0,o[e])+t+i.substr(o[e]+u[e]);var r=t.length-u[e];for(var a=e+1;a<s.length;a++)o[a]+=r;l++,l==s.length&&n(i)},r)})(c);s.length==0&&n(i)},r)};o.normalize=function(e,t){return e.substr(e.length-4,4)==".css"&&(e=e.substr(0,e.length-4)),t(e)};var L,A=!1;return o.load=function(e,t,r,i,u){L=L||i.waitSeconds||7;var a=e+(u?".less":".css");if(o.attachBuffer(a,r))return;var f=t.toUrl(a);!A&&n&&(alert(s?"hacking links":"not hacking"),A=!0),u?k(f,function(e){u&&(e=u(e,function(e){o.inject(e),setTimeout(r,7)}))}):o.linkLoad(f,r)},n&&(o.inspect=function(){if(stylesheet.styleSheet)return stylesheet.styleSheet.cssText;if(stylesheet.innerHTML)return stylesheet.innerHTML}),o}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("resources/framework/bundle/publisher/css/style.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,Oskari.clazz.define("Oskari.mapframework.bundle.publisher.request.PublishMapEditorRequest",function(e){this._viewData=e},{__name:"Publisher.PublishMapEditorRequest",getName:function(){return this.__name},getEditMap:function(){return this._viewData}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/publisher/request/PublishMapEditorRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.publisher.request.PublishMapEditorRequestHandler",function(e){this.instance=e},{handleRequest:function(e,t){this.instance.publishId=t.getEditMap().id,this.instance.setPublishMode(!0,this.instance.getLayersWithoutPublishRights(),t.getEditMap()),this._showEditNotification()},_showEditNotification:function(){var e=this.instance.getLocalization("edit"),t=Oskari.clazz.create("Oskari.userinterface.component.Popup");t.show(e.popup.title,e.popup.msg),t.fadeout()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/publisher/request/PublishMapEditorRequestHandler",function(){}),Oskari.registerLocalization({lang:"fi",key:"Publisher",value:{title:"Julkaise kartta",flyouttitle:"Siirry julkaisemaan",desc:"",published:{title:"Kartta julkaistu",desc:"Voit liittää kartan internet-sivustollesi lisäämällä sinne alla olevan HTML-koodin:",urlPrefix:"http://www.paikkatietoikkuna.fi"},edit:{popup:{title:"Muokataan julkaisua",msg:"Päivitetään aiemmin julkaistun kartan tietoja"}},BasicView:{title:"Julkaise kartta",titleEdit:"Muokkaa julkaisua",domain:{title:"Julkaisupaikka",label:"Sivusto, jolla kartta julkaistaan",placeholder:"ilman http- tai www-etuliitteitä",tooltip:"Kirjoita sivuston www-osoite eli domain-nimi ilman http- ja www-etuliitteitä tai alasivun osoitetta. Esimerkiksi omakotisivu.com."},name:{label:"Kartan nimi",placeholder:"pakollinen",tooltip:"Anna kartalle kuvaileva nimi. Huomioi käyttöliittymän kieli."},language:{label:"Kieli",options:{fi:"Suomi",sv:"Ruotsi",en:"Englanti"},tooltip:"Valitse kartan käyttöliittymän ja aineiston kieli."},size:{label:"Koko",tooltip:"Valitse tai määrittele kartalle koko, jossa haluat esittää sen sivuillasi. Näet vaikutuksen esikatselukartassa."},tools:{label:"Näytettävät työkalut",tooltip:"Valitse kartalla näytettävät työkalut. Näet niiden sijoittelun esikatselukartassa.",ScaleBarPlugin:"Mittakaavajana",IndexMapPlugin:"Indeksikartta",PanButtons:"Panorointitoiminto",Portti2Zoombar:"Mittakaavasäädin",ControlsPlugin:"Kartan liikuttaminen",SearchPlugin:"Osoite- ja paikannimihaku",GetInfoPlugin:"Kohdetietojen kyselytyökalu"},data:{label:"Tilastot",tooltip:"Näytä karttaan liittyvä taulukko.",grid:"Näytä tilastotaulukko"},layers:{label:"Karttatasot",defaultLayer:"(Oletusvalinta)",useAsDefaultLayer:"Käytä oletuksena"},sizes:{small:"Pieni",medium:"Keskikokoinen",large:"Suuri",custom:"Määritä oma koko",width:"leveys",height:"korkeus"},buttons:{save:"Tallenna",saveNew:"Tallenna uusi",ok:"OK",replace:"Korvaa",cancel:"Peruuta"},confirm:{replace:{title:"Haluatko korvata julkaisun?",msg:"Korvaamalla muutokset näkyvät suoraan julkaisemassasi kartassa. Sinun ei tarvitse lisätä koodia verkkosivuillesi uudelleen."}},layerselection:{label:"Näytä karttatasot valikossa",info:"Valitse karttapohjat. Voit tehdä oletusvalinnan esikatselunäkymästä.",tooltip:"Karttapohja näkyy kartan alimmaisena kerroksena. Kun valitset karttatasoja karttapohjaksi, vain yksi valituista tasoista näkyy kerralla ja käyttäjä voi vaihdella niiden välillä. Oletusvalinnan voit tehdä esikatselukartassa.",promote:"Haluatko näyttää myös ilmakuvia?"},preview:"Julkaistavan kartan esikatselu",location:"Sijainti ja mittakaavataso",zoomlevel:"Mittakaavataso",help:"Ohje",error:{title:"Virhe!",size:"Virhe kokomäärityksissä",domain:"Sivusto on pakollinen tieto",domainStart:"Anna sivusto ilman http- tai www-etuliitteitä",name:"Nimi on pakollinen tieto",nohelp:"Ohjetta ei löytynyt",saveFailed:"Kartan julkaisu epäonnistui. Yritä myöhemmin uudelleen.",nameIllegalCharacters:"Nimessä on luvattomia merkkejä. Sallittuja merkkejä ovat kaikki suomen kielen aakkoset, numerot sekä välilyönti ja yhdysmerkki.",domainIllegalCharacters:"Sivuston nimessä on luvattomia merkkejä. Sallittuja merkkejä ovat kaikki suomen kielen aakkoset, numerot sekä välilyönti ja yhdysmerkki."}},NotLoggedView:{text:"Voit käyttää julkaisutoimintoa kirjauduttuasi palveluun.",signup:"Kirjaudu sisään",signupUrl:"/web/fi/login",register:"Rekisteröidy",registerUrl:"/web/fi/login?p_p_id=58&p_p_lifecycle=1&p_p_state=maximized&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&saveLastPath=0&_58_struts_action=%2Flogin%2Fcreate_account"},StartView:{text:"Voit julkaista tässä tekemäsi karttanäkymän osana esim. omaa tai yrityksesi sivustoa.",touLink:"Näytä karttajulkaisun käyttöehdot",layerlist_title:"Julkaistavissa olevat karttatasot",layerlist_empty:"Valitsemiasi karttatasoja ei voida julkaista. Valitut karttatasot -valikosta näet, voiko karttatason julkaista.",layerlist_denied:"Ei julkaistavissa",denied_tooltip:"Kartta-aineistojen tuottajat eivät ole antaneet näille aineistoilleen julkaisuoikeutta muissa verkkopalveluissa. Tarkista julkaisuoikeus Valitut karttatasot -valikosta ennen julkaisua.",buttons:{"continue":"Jatka",continueAndAccept:"Hyväksy ehdot ja jatka",cancel:"Peruuta",close:"Sulje"},tou:{notfound:"Käyttöehtoja ei löytynyt",reject:"Hylkää",accept:"Hyväksy"}}}}),define("bundles/framework/bundle/publisher/locale/fi",function(){}),Oskari.registerLocalization({lang:"sv",key:"Publisher",value:{title:"Definiera karta",flyouttitle:"Definiera karta",desc:"",published:{title:"Kartan har avskilts",desc:"Inbädda kartan genom att tillägga HTML-koden nedan på din webbplats.",urlPrefix:"http://www.paikkatietoikkuna.fi"},edit:{popup:{title:"Den inbäddade kartan editeras",msg:"Den tidigare inbäddade kartans uppgifter uppdateras"}},BasicView:{title:"Inbädda kartan",titleEdit:"Editera inbäddad karta",domain:{title:"Webbsidan där kartan inbäddas",label:"Webbplatsen där kartan inbäddas",placeholder:"utan http- eller www-prefix",tooltip:"Skriv namnet på webbplatsens hemsida dvs. domainnamn utan prefixerna http och www samt utan undersida. Exempel: minhemsida.com"},name:{label:"Kartans namn",placeholder:"obligatorisk uppgift",tooltip:"Ge kartan ett beskrivande namn. Observera användargränssnittets språk"},language:{label:"Språk",options:{fi:"Finska",sv:"Svenska",en:"Engelska"},tooltip:"Välj språk för kartmaterial och användargränssnitt."},size:{label:"Storlek",tooltip:"Välj eller definiera storleken på kartan som visas på din webbplats. Kartan förhandsvisas i den valda storleken."},tools:{label:"Verktyg",tooltip:"Välj verktygen som visas på kartan. Du kan se deras placering på den förhandsvisade kartan.",ScaleBarPlugin:"Skalsträcka",IndexMapPlugin:"Indexkarta",PanButtons:"Panoreringsverktyg",Portti2Zoombar:"Skalans glidreglage",ControlsPlugin:"Panorering på",SearchPlugin:"Adress- och ortnamnssökning",GetInfoPlugin:"Verktyg för förfrågan som gäller uppgifter om objektet"},data:{label:"Satistik",tooltip:"Show the data related to map.",grid:"Visa statistik bord"},layers:{label:"Kartlager",defaultLayer:"(Förvald kartlager)",useAsDefaultLayer:"Använd som förvald kartlager"},sizes:{small:"Liten",medium:"Medelstor",large:"Stor",custom:"Definiera storlek",width:"bredd",height:"höjd"},buttons:{save:"Lagra",saveNew:"Lagra ny",ok:"OK",replace:"Ersätt",cancel:"Avbryt"},confirm:{replace:{title:"Vill du ersätta den inbäddade kartan?",msg:"Om du ersätter kartan syns ändringarna på den inbäddade kartan genast. Du behöver inte lägga in koden på din webbsida på nytt."}},layerselection:{label:"Visa kartlagren i menyn",info:"Välj bakgrundskartor. Du kan göra förval i förhandsgranskningsvyn.",tooltip:"Bakgrundskartan syns som kartans nedersta lager. När du väljer kartan som används som bakgrundskarta syns endast ett lager i taget och du kan växla mellan dem. Du kan göra förval i förhandsgranskningsvyn.",promote:"Visa flygbilder?"},preview:"Förhandsgranskningsvy för karta som ska avskiljas och inbäddas.",location:"Läge och skalnivå.",zoomlevel:"Skalnivå",help:"Anvisning",error:{title:"Fel!",size:"Fel i storleksdefinitionerna",domain:"Webbplatsen är en nödvändig uppgift",domainStart:"Skriv webbplatsen utan prefixerna http och www",name:"Namnet är en nödvändig uppgift",nohelp:"Ingen anvisning",saveFailed:"Avskiljandet av kartan misslyckades. Försök på nytt senare.",nameIllegalCharacters:"I namnet ingår otillåtna tecken. Tillåtna är alla bokstäver i det svenska alfabetet, siffror, mellanslag och bindestreck.",domainIllegalCharacters:"I webbsidans namnet ingår otillåtna tecken. Tillåtna är alla bokstäver i det svenska alfabetet, siffror, mellanslag och bindestreck."}},NotLoggedView:{text:"Logga in i tjänsten för att definiera en karta som ska inbäddas.",signup:"Logga in",signupUrl:"/web/sv/login",register:"Registrera dig",registerUrl:"/web/sv/login?p_p_id=58&p_p_lifecycle=1&p_p_state=maximized&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&saveLastPath=0&_58_struts_action=%2Flogin%2Fcreate_account"},StartView:{text:"Du kan inbädda den kartvy som du definierat här på din egen eller din arbetsgivares webbplats.",touLink:"Vis användningsvillkor till kartinbäddningen",layerlist_title:"Kartlager som kan inbäddas",layerlist_empty:"Kartlagren som du valt kan inte avskiljas. Menyn Valda kartlager visar vilka kartlager kan avskiljas.",layerlist_denied:"Kan inte avskiljas",denied_tooltip:"Kartdataproducenterna har inte gett publiceringstillstånd till dessa material i andra webbtjänster. Kontrollera publiceringstillståndet i menyn Valda kartlager innan du avskiljer dem.",buttons:{"continue":"Fortsätt",continueAndAccept:"Godkänn användningsvillkor och fortsätt",cancel:"Tillbaka",close:"Avbryt"},tou:{notfound:"Användningsvillkor kan inte hittas",reject:"Avvisa",accept:"Acceptera"}}}}),define("bundles/framework/bundle/publisher/locale/sv",function(){}),Oskari.registerLocalization({lang:"en",key:"Publisher",value:{title:"Create map",flyouttitle:"Create map",desc:"",published:{title:"Your map has been created",desc:"Embed the map by adding the HTML code below to your website.",urlPrefix:"http://www.paikkatietoikkuna.fi"},edit:{popup:{title:"Editing embedded map",msg:"The map data of a previously embedded map is being updated"}},BasicView:{title:"Embed map",titleEdit:"Edit embedded map",domain:{title:"Webpage where the map will be embedded",label:"Website where the map will be embedded",placeholder:"without the prefixes http or www",tooltip:"Write the name of your website's index page, e.g. its domain name without the prefixes http or www, or the address of a subpage. Example: myhomepage.com"},name:{label:"The name of the map",placeholder:"required",tooltip:"Give your map a descriptive name. Please note the language of the user interface."},language:{label:"Language",options:{fi:"Finnish",sv:"Swedish",en:"English"},tooltip:"Select the language of the map interface and map data."},size:{label:"Size",tooltip:"Select or define the size of the map to be embedded on your website. The map preview is displayed in the selected size."},tools:{label:"Tools",tooltip:"Select the tools to be shown on the map. Their placement is displayed in the map preview.",ScaleBarPlugin:"Scale line",IndexMapPlugin:"Index map",PanButtons:"Panning tool",Portti2Zoombar:"Scale scrollbar",ControlsPlugin:"Panning on",SearchPlugin:"Address and place name search",GetInfoPlugin:"Query tool for place data"},data:{label:"Statistics",tooltip:"Show the data related to map.",grid:"Show statistic grid"},layers:{label:"Map layers",defaultLayer:"(Default layer)",useAsDefaultLayer:"Use as default layer"},sizes:{small:"Small",medium:"Medium",large:"Large",custom:"Custom size",width:"width",height:"height"},buttons:{save:"Save",saveNew:"Save new",ok:"OK",replace:"Replace",cancel:"Cancel"},confirm:{replace:{title:"Do you wish to replace the embedded map?",msg:"Use replace to show changes on the embedded map without delay. It is not necessary to add the html-code to your webpage again."}},layerselection:{label:"Show map layers in menu",info:"Select background maps. You can set the default background map in the map preview window.",tooltip:"The background map is shown as the bottom layer of the map. When you select map layers to be used as the bottom layer, only one layer is visible at a time and you can switch between them. You can set the default background map in the map preview.",promote:"Show aerial images?"},preview:"Preview of the map to be embedded.",location:"Location and zoom level",zoomlevel:"Zoom level",help:"Help",error:{title:"Error!",size:"Error in size definitions",domain:"Website is required information",domainStart:"Omit prefixes http or www from the website name",name:"Name is required information",nohelp:"No help is available",saveFailed:"Map publishing failed. Try again later.",nameIllegalCharacters:"The name contains disallowed characters. Allowed characters are the letters a-z as well as å, ä and ö, numbers, backspaces and hyphens.",domainIllegalCharacters:"The web site name contains disallowed characters. Allowed characters are the letters a-z as well as å, ä and ö, numbers, backspaces and hyphens."}},NotLoggedView:{text:"You need to log in before using the embedding function.",signup:"Log in",signupUrl:"/web/en/login",register:"Register",registerUrl:"/web/en/login?p_p_id=58&p_p_lifecycle=1&p_p_state=maximized&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&saveLastPath=0&_58_struts_action=%2Flogin%2Fcreate_account"},StartView:{text:"You can embed the map view you just created on your own or your employer's website.",touLink:"Show Terms of use for Embedded maps",layerlist_title:"Embeddable map layers",layerlist_empty:"The map layers you selected cannot be embedded. The menu Selected map layers shows whether or not a map layer can be embedded.",layerlist_denied:"Cannot be embedded",denied_tooltip:"The providers of this map data have not granted permission to publish these materials on other websites. Check rights to publish in the menu Selected map layers before embedding.",buttons:{"continue":"Continue",continueAndAccept:"Accept Terms of use and continue",cancel:"Cancel",close:"Close"},tou:{notfound:"Can not find Terms of Use",reject:"Reject",accept:"Accept"}}}}),define("bundles/framework/bundle/publisher/locale/en",function(){}),define("bundles/framework/bundle/publisher/module",["oskari","jquery","./instance","./Flyout","./Tile","./event/MapPublishedEvent","./view/NotLoggedIn","./view/StartView","./view/BasicPublisher","./view/PublisherLocationForm","./view/PublisherLayerForm","css!resources/framework/bundle/publisher/css/style.css","./request/PublishMapEditorRequest","./request/PublishMapEditorRequestHandler","./locale/fi","./locale/sv","./locale/en"],function(e,t){return e.bundleCls("publisher").category({create:function(){var t=this,n=e.clazz.create("Oskari.mapframework.bundle.publisher.PublisherBundleInstance");return n},update:function(e,t,n,r){}})}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer("div.notLoggedIn {\r\n  padding: 10px; }\r\n\r\n\r\n#contentMap.mapPublishMode {\r\n  margin-left: 255px; }\r\n\r\ndiv.publisher div.startview div.icon-info, div.basic_publisher div.icon-info {\r\n  float: right; }\r\n\r\ndiv.publisher div.startview div.content {\r\n  margin-top: 5px; }\r\n\r\ndiv.publisher div.startview div.tou {\r\n  margin: 15px 0; }\r\n\r\ndiv.publisher div.startview div.layerlist {\r\n  border: 1px solid;\r\n  padding: 10px; }\r\n\r\ndiv.publisher div.startview div.layerlist h4 {\r\n  font-size: 14px;\r\n  line-height: 15px;\r\n  padding-bottom: 5px; }\r\n\r\ndiv.publisher div.startview ul {\r\n  list-style: disc inside none;\r\n  padding: 5px; }\r\n\r\ndiv.publisher div.startview div.error ul li {\r\n  color: red; }\r\n\r\n#contentMap div.basic_publisher {\r\n  background: white;\r\n  position: absolute;\r\n  height: 100%;\r\n  top: 0;\r\n  left: 40px;\r\n  /* sidebar has 3, we want to open it on top of this */\r\n  z-index: 2;\r\n  width: 255px; }\r\n\r\n#contentMap div.basic_publisher div.content {\r\n  padding: 10px; }\r\n\r\ndiv.basic_publisher > div.header {\r\n  background-color: #FDF8D9;\r\n  padding: 5px 10px; }\r\n\r\ndiv.basic_publisher > div.header div.icon-close {\r\n  float: right; }\r\n\r\ndiv.basic_publisher div.customsize input {\r\n  width: 40px; }\r\n\r\ndiv.basic_publisher div.customsize input.error {\r\n  border: 1px solid red; }\r\n\r\ndiv.basic_publisher div.form div.field input, div.field select {\r\n  width: 100%;\r\n  width: 80%0/;\r\n  /* unquote for libsass bug */\r\n  background-color: white0/;\r\n  /* unquote for libsass */\r\n  filter: Alpha(opacity=100)0/ !important;\r\n  font-weight: bolder; }\r\n\r\ndiv.basic_publisher > div.content {\r\n  overflow: auto;\r\n  height: 89%; }\r\n\r\ndiv.basic_publisher div.tool {\r\n  margin: 5px; }\r\n\r\ndiv.basic_publisher div.tool input, div.basic_publisher div.data input {\r\n  margin-right: 10px; }\r\n\r\n/* Buttons */\r\ndiv.basic_publisher div.buttons, div.publisher div.startview div.buttons {\r\n  text-align: center;\r\n  margin-top: 10px; }\r\n\r\ndiv.basic_publisher div.buttons input, div.publisher div.startview div.buttons input {\r\n  margin: 5px 2px; }\r\n")}),requirejs.s.contexts._.nextTick=requirejs.nextTick;