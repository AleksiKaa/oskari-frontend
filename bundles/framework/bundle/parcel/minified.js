Oskari.clazz.define("Oskari.mapframework.bundle.parcel.event.FinishedDrawingEvent",function(){},{getName:function(){return"Parcel.FinishedDrawingEvent"}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/parcel/event/FinishedDrawingEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.event.SaveDrawingEvent",function(e){this._drawing=e},{getName:function(){return"Parcel.SaveDrawingEvent"},getDrawing:function(){return this._drawing}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/parcel/event/SaveDrawingEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.Parcel.event.ParcelSelectedEvent",function(e){this._parcel=e},{getName:function(){return"Parcel.ParcelSelectedEvent"},getPlace:function(){return this._parcel}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/parcel/event/ParcelSelectedEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.event.ParcelInfoLayerRegisterEvent",function(e){this._layer=e},{getName:function(){return"ParcelInfo.ParcelLayerRegisterEvent"},getLayer:function(){return this._layer}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/parcel/event/ParcelInfoLayerRegisterEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.event.ParcelLayerUnregisterEvent",function(e){this._layer=e},{getName:function(){return"ParcelInfo.ParcelLayerUnregisterEvent"},getLayer:function(){return this._layer}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/parcel/event/ParcelInfoLayerUnregisterEvent",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.plugin.DrawPlugin",function(e){this.instance=e,this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this.controls=null,this.drawControls=null,this.drawLayer=null,this.editLayer=null,this.markerLayer=null,this.currentDrawMode=null,this.currentFeatureType=null,this.splitter=null,this.backupFeatures=[],this.splitSelection=!1,this.basicStyle=null,this.selectStyle=null,this.selectedFeature=-2,this.selectInfoControl=null},{getName:function(){return this.pluginName},getMap:function(){return this._map},processFeatures:function(){var e=this,t=e._sandbox.getEventBuilder("Parcel.FinishedDrawingEvent")();e._sandbox.notifyAll(t),e.toggleControl(),e.splitFeature()},init:function(e){var t=this;this.drawLayer=new OpenLayers.Layer.Vector("Parcel Draw Layer",{eventListeners:{featuresadded:function(e){if(e.features[0].geometry.CLASS_NAME==="OpenLayers.Geometry.LineString"){var n=t.instance.getLocalization("notification").calculating,r=Oskari.clazz.create("Oskari.userinterface.component.Popup");r.show(n.title,""),setTimeout(function(){t.processFeatures(),r.close()},200)}else t.processFeatures()}}}),this.drawLayer.quantumStep=5e3,this.editLayer=new OpenLayers.Layer.Vector("Parcel Edit Layer",{eventListeners:{featuremodified:function(e){this.updateLine()}}}),this.editLayer.updateLine=function(){var e=this.features[0];if(e.geometry.CLASS_NAME==="OpenLayers.Geometry.MultiLineString"){for(var n=0;n<e.geometry.components.length;n++){var r=e.geometry.components[n];for(var i=0;i<r.components.length;i++){var s=r.components[i],o=[];if(typeof s.references=="undefined"){var u=r.components[i-1],a=r.components[i+1];for(var f=0;f<u.references.length;f++){var l=u.references[f],c=!1;for(var h=0;h<a.references.length;h++)if(a.references[h]===l){c=!0;break}if(!c)continue;var p=null;for(h=0;h<t.drawLayer.features.length;h++){var d=t.drawLayer.features[h];if(d.geometry.CLASS_NAME==="OpenLayers.Geometry.Polygon"&&d.geometry.id===l){p=d.geometry;break}}var v=p.components[0].components,m=v.length-1;for(h=0;h<m;h++){var g=h+1;if(v[h]===u&&v[g]===a){v.splice(g,0,s),o.push(p.id);break}if(v[g]===u&&v[h]===a){v.splice(g,0,s),o.push(p.id);break}}}s.references=o}}r.components[0].references.length===2&&(r.components[0].x=r.components[0].x0,r.components[0].y=r.components[0].y0);var y=r.components.length-1;r.components[y].references.length===2&&(r.components[y].x=r.components[y].x0,r.components[y].y=r.components[y].y0),t.controls.modify.selectFeature(e)}this.refresh(),t.drawLayer.refresh()}this.redraw(),t.drawLayer.redraw()},this.basicStyle=OpenLayers.Util.applyDefaults(this.basicStyle,OpenLayers.Feature.Vector.style["default"]),this.basicStyle.fillColor="#ffff00",this.basicStyle.fillOpacity=.4,this.selectStyle=OpenLayers.Util.applyDefaults(this.selectStyle,OpenLayers.Feature.Vector.style["default"]),this.selectStyle.fillColor="#ff0000",this.selectStyle.fillOpacity=.4,this.markerLayer=new OpenLayers.Layer.Markers("Parcel Markers Layer",{});var n=new OpenLayers.Control.SelectFeature([t.editLayer,t.drawLayer]);this._map.addControl(n),this.selectInfoControl=new OpenLayers.Control.SelectFeature(t.drawLayer),this._map.addControl(this.selectInfoControl);var r=new OpenLayers.Control.ModifyFeature(t.editLayer);this._map.addControl(r),this.controls={select:n,modify:r},this.drawControls={line:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Path),area:new OpenLayers.Control.DrawFeature(t.drawLayer,OpenLayers.Handler.Polygon)},this._map.addLayers([t.drawLayer]);for(var i in this.drawControls)this._map.addControl(this.drawControls[i]);this._map.addLayers([t.editLayer]),this._map.addLayers([t.markerLayer]),this._map.setLayerIndex(t.drawLayer,10),this._map.setLayerIndex(t.editLayer,100),this._map.setLayerIndex(t.markerLayer,1e3),OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!0,pixelTolerance:10,stopSingle:!0,stopDouble:!0},initialize:function(e){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){var n=t._map.getLonLatFromPixel(e.xy),r=new OpenLayers.Geometry.Point(n.lon,n.lat),i,s=t.selectedFeature,o=t.drawLayer.features;for(i=0;i<o.length;i++){var u=o[i].geometry;if(u.CLASS_NAME=="OpenLayers.Geometry.Polygon"&&u.containsPoint(r)){t.selectedFeature=i,t.selectInfoControl.select(o[i]);break}i===o.length-1&&(t.selectedFeature=-2)}if(s!=t.selectedFeature){for(i=0;i<o.length;i++)t.drawLayer.features[i].style=i===t.selectedFeature?t.selectStyle:t.basicStyle;t.editLayer.redraw(),t.drawLayer.redraw()}}});var s=new OpenLayers.Control.Click;this._map.addControl(s),s.activate(),this.requestHandlers={startDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.parcel.request.StartDrawingRequestHandler",t),stopDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.parcel.request.StopDrawingRequestHandler",t),cancelDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.parcel.request.CancelDrawingRequestHandler",t),saveDrawingHandler:Oskari.clazz.create("Oskari.mapframework.bundle.parcel.request.SaveDrawingRequestHandler",t)},this.splitter=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.split.ParcelSplit",this),this.splitter.init()},startPlugin:function(e){this._sandbox=e,e.register(this),e.addRequestHandler("Parcel.StartDrawingRequest",this.requestHandlers.startDrawingHandler),e.addRequestHandler("Parcel.StopDrawingRequest",this.requestHandlers.stopDrawingHandler),e.addRequestHandler("Parcel.CancelDrawingRequest",this.requestHandlers.cancelDrawingHandler),e.addRequestHandler("Parcel.SaveDrawingRequest",this.requestHandlers.saveDrawingHandler)},stopPlugin:function(e){var t=e.getEventBuilder("ParcelInfo.ParcelLayerUnregisterEvent")([this.getDrawingLayer(),this.getEditLayer()]);e.notifyAll(t),e.removeRequestHandler("Parcel.StartDrawingRequest",this.requestHandlers.startDrawingHandler),e.removeRequestHandler("Parcel.StopDrawingRequest",this.requestHandlers.stopDrawingHandler),e.removeRequestHandler("Parcel.CancelDrawingRequest",this.requestHandlers.cancelDrawingHandler),e.removeRequestHandler("Parcel.SaveDrawingRequest",this.requestHandlers.saveDrawingHandler),e.unregister(this),this._map=null,this._sandbox=null},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this._map=e.getMap(),this.pluginName=e.getName()+"Parcel.DrawPlugin"},drawFeature:function(e,t){this.clear(),this.currentFeatureType=null;var n=this._sandbox.getEventBuilder("ParcelInfo.ParcelLayerRegisterEvent")([this.getDrawingLayer(),this.getEditLayer()]);this._sandbox.notifyAll(n);var r=[];for(var i=0;i<e.length;i++)r.push(e[i].geometry);this.drawLayer.addFeatures([new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon(r))]),this.currentFeatureType=t,this._map.zoomToExtent(this.drawLayer.getDataExtent()),this.buttons||(this.buttons=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.handler.ButtonHandler",this.instance),this.buttons.start())},startDrawing:function(e){this.toggleControl(e.drawMode)},finishSketchDraw:function(){try{this.drawControls[this.currentDrawMode].finishSketch(),this.toggleControl()}catch(e){var t=this._sandbox.getEventBuilder("Parcel.ParcelSelectedEvent")();this._sandbox.notifyAll(t)}},cancelDrawing:function(){this.toggleControl()},saveDrawing:function(){if(this.selectedFeature>-2){var e=this.getDrawing();this.controls.select.select(e),this.toggleControl();var t=this._sandbox.getEventBuilder("Parcel.SaveDrawingEvent")(e);this._sandbox.notifyAll(t)}},toggleControl:function(e){this.currentDrawMode=e;for(var t in this.drawControls){var n=this.drawControls[t];e==t?n.activate():n.deactivate()}},getDrawingLayer:function(){return this.drawLayer},getEditLayer:function(){return this.editLayer},getMarkerLayer:function(){return this.markerLayer},getDrawing:function(){return this.selectedFeature>-1?this.drawLayer.features[this.selectedFeature]:this.drawLayer.features[0]},setFeatureType:function(e){this.currentFeatureType=e},getFeatureType:function(){return this.currentFeatureType},getSandbox:function(){return this._sandbox},start:function(e){},stop:function(e){var t=e.getEventBuilder("ParcelInfo.ParcelLayerUnregisterEvent")([this.getDrawingLayer(),this.getEditLayer()]);e.notifyAll(t)},register:function(){},unregister:function(){},clear:function(){this.drawLayer.removeAllFeatures(),this.editLayer.removeAllFeatures();var e=this.markerLayer.markers.length-1;for(var t=e;t>=0;t--)this.markerLayer.markers[t].destroy();this.markerLayer.markers=[],this._map.activeMarker=null,this.splitSelection=!1,this.instance.getService().clearParcelMap()},splitFeature:function(e){var t=typeof e=="undefined"?!1:e,n=this.splitter.split(t);if(n!=undefined){this.controls.select.select(n),this.controls.modify.selectFeature(n),this.controls.modify.activate();var r=Math.max(this._map.Z_INDEX_BASE.Feature,this.markerLayer.getZIndex())+1;this.markerLayer.setZIndex(r),this.updateInfobox()}},updateInfobox:function(){if(this.selectedFeature>-1)this.selectInfoControl.select(this.drawLayer.features[this.selectedFeature]);else{var e=this.drawLayer.features;if(e){this.selectedFeature=0;for(i=0;i<e.length;i++)this.drawLayer.features[i].style=i===this.selectedFeature?this.selectStyle:this.basicStyle;this.drawLayer.redraw(),this.selectInfoControl.select(this.drawLayer.features[this.selectedFeature])}}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/parcel/plugin/DrawPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.parcel.request.SaveDrawingRequest",function(){},{getName:function(){return"Parcel.SaveDrawingRequest"}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/parcel/request/SaveDrawingRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.parcel.request.StopDrawingRequest",function(){},{getName:function(){return"Parcel.StopDrawingRequest"}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/parcel/request/StopDrawingRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.parcel.request.CancelDrawingRequest",function(){},{getName:function(){return"Parcel.CancelDrawingRequest"}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/parcel/request/CancelDrawingRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.request.StartDrawingRequest",function(e){if(!this.drawModes[e.drawMode])throw"Unknown draw mode '"+e.drawMode+"'";this._drawMode=e.drawMode},{getName:function(){return"Parcel.StartDrawingRequest"},drawModes:{point:"point",line:"line",area:"area",box:"box"},getDrawMode:function(){return this._drawMode}},{protocol:["Oskari.mapframework.request.Request"]}),define("bundles/framework/bundle/parcel/request/StartDrawingRequest",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.request.SaveDrawingRequestHandler",function(e){this.drawPlugin=e},{handleRequest:function(e,t){this.drawPlugin.saveDrawing()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/parcel/request/SaveDrawingRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.request.StopDrawingRequestHandler",function(e){this.drawPlugin=e},{handleRequest:function(e,t){this.drawPlugin.finishSketchDraw()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/parcel/request/StopDrawingRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.request.CancelDrawingRequestHandler",function(e){this.drawPlugin=e},{handleRequest:function(e,t){this.drawPlugin.cancelDrawing()}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/parcel/request/CancelDrawingRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.request.StartDrawingRequestHandler",function(e){this.drawPlugin=e},{handleRequest:function(e,t){var n=t.getDrawMode();this.drawPlugin.startDrawing({drawMode:t.getDrawMode()})}},{protocol:["Oskari.mapframework.core.RequestHandler"]}),define("bundles/framework/bundle/parcel/request/StartDrawingRequestHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.service.ParcelService",function(e){this._instance=e,this._wfst=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.service.ParcelWfst",e),this._plot=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.service.ParcelPlot",e)},{getQName:function(){return"Oskari.mapframework.bundle.parcel.service.ParcelService"},getName:function(){return"ParcelService"},init:function(){},loadParcel:function(e,t){this._wfst.loadParcel(e,t)},loadRegisterUnit:function(e,t){this._wfst.loadRegisterUnit(e,t)},savePlace:function(e,t,n,r,i){e&&t?t===this._instance.conf.parcelFeatureType?this.saveParcel(e,n,r,i):t===this._instance.conf.registerUnitFeatureType?this.saveRegisterUnit(e,n,r,i):i():i()},saveParcel:function(e,t,n,r){e&&this._plot.plotParcel(e,t,n,r)},clearParcelMap:function(){this._plot.clearParcelMap()},saveRegisterUnit:function(e,t,n,r){e&&this._plot.plotParcel(e,t,n,r)}},{protocol:["Oskari.mapframework.service.Service"]}),define("bundles/framework/bundle/parcel/service/ParcelService",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.service.ParcelWfst",function(e){this.instance=e,this.protocols={},this.protocols.parcel=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:e.conf.parcelFeatureType,featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs",url:e.conf.queryUrl}),this.protocols.registerUnit=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:e.conf.registerUnitFeatureType,featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs",url:e.conf.queryUrl});var t=e.conf.transactionUrl||e.conf.queryUrl;this.protocols.parcelCommit=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:this.instance.conf.parcelFeatureType,featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs",url:t}),this.protocols.registerUnitCommit=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:this.instance.conf.registerUnitFeatureType,featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs",url:t})},{loadParcel:function(e,t){this._downloadFeature(e,this.protocols.parcel,t)},loadRegisterUnit:function(e,t){this._downloadFeature(e,this.protocols.registerUnit,t)},saveParcel:function(e,t,n,r){this._commitFeature(e,t,n,this.protocols.parcelCommit,r)},saveRegisterUnit:function(e,t,n,r){this._commitFeature(e,t,n,this.protocols.registerUnitCommit,r)},_downloadFeature:function(e,t,n){var r=this,i;if(e.indexOf("-")===-1)i=e;else{var s,o;i="";var u=e.split("-");if(u.length!==4)return;for(s=0;s<2;s++){for(o=0;o<3-u[s].length;o++)i=i.concat("0");for(o=0;o<u[s].length;o++)i=i.concat(u[s].charAt(o))}for(s=2;s<4;s++){for(o=0;o<4-u[s].length;o++)i=i.concat("0");for(o=0;o<u[s].length;o++)i=i.concat(u[s].charAt(o))}}var a=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"ktjkiiwfs:kiinteistotunnus",value:i}),f=this.instance.getLocalization("notification").placeLoading,l=Oskari.clazz.create("Oskari.userinterface.component.Popup");l.show(f.title,f.message),t.read({filter:a,callback:function(e){l.close();if(e&&e.features&&e.features.length>0)n(e.features);else{var t=r.instance.getLocalization("notification").error;r.instance.showMessage(t.title,t.loadPlace),n()}}})},_commitFeature:function(e,t,n,r,i){var s=this;if(e.attributes){t&&(e.attributes.nimi=t);if(n||typeof n=="string")e.attributes.kuvaus=n}var o=e.state;this.instance.conf.transactionUrl&&this.instance.conf.queryUrl!=this.instance.conf.transactionUrl?e.toState(OpenLayers.State.INSERT):(e.toState(OpenLayers.State.UPDATE),e.state=OpenLayers.State.UPDATE),e.fid=s._parseFidNumber(e.fid);var u=Oskari.clazz.create("Oskari.userinterface.component.Popup"),a=this.instance.getLocalization("notification").placeAdding;u.show(a.title,a.message),r.commit([e],{callback:function(t){u.close(),e.state=o;var n=t&&!t.error;if(!n){var r=s.instance.getLocalization("notification").error;s.instance.showMessage(r.title,r.savePlace)}i(n)}})},_parseFidNumber:function(e){var t=e;return t&&typeof t=="string"&&t.length>0&&!isNaN(t.substr(length-1))&&(t=parseInt(t.match(/(\d+)$/)[0],10)),t}}),define("bundles/framework/bundle/parcel/service/ParcelWfst",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.service.ParcelPlot",function(e){this.instance=e,this.parcelLayer=null,this.boundaryLayer=null,this.pointLayer=null,this._map=null;var t=new OpenLayers.StyleMap({"default":{strokeColor:"#00FF00",strokeOpacity:1,strokeWidth:0,fillColor:"#FF0000",fillOpacity:.2,labelAlign:"bm",label:"${nimi}\n${area} ha",fontColor:"#000000",fontSize:"22px",fontFamily:"SansSerif",fontWeight:"bold"}});this.parcelLayer=new OpenLayers.Layer.Vector("NewParcel",{styleMap:t});var n=new OpenLayers.StyleMap({"default":{strokeColor:"#FF0000",strokeOpacity:1,strokeWidth:2,strokeDashstyle:"dash",fillColor:"#FF0000",fillOpacity:1,label:"- ${length} -",labelAlign:"cm",labelXOffset:"${deltax}",labelYOffset:"${deltay}"}});this.boundaryLayer=new OpenLayers.Layer.Vector("NewBoundary",{styleMap:n});var r=new OpenLayers.StyleMap({"default":{strokeColor:"#FF0000",strokeOpacity:1,strokeWidth:1,fillColor:"#FF0000",fillOpacity:.5,pointRadius:6,label:"${pnro}",graphicName:"triangle",labelXOffset:10,labelYOffset:10,fontFamily:"Arial",fontSize:"12px"}});this.pointLayer=new OpenLayers.Layer.Vector("NewPoints",{styleMap:r})},{plotParcel:function(e,t,n,r){this._plotNewParcel(e,t,n,r),this._plotNewBoundary(e,r),r(!0),this._createGeoJSON(),this.instance.sandbox.postRequestByName("userinterface.UpdateExtensionRequest",[undefined,"attach","Printout"])},clearParcelMap:function(){this.parcelLayer&&this.parcelLayer.removeAllFeatures(),this.boundaryLayer&&this.boundaryLayer.removeAllFeatures(),this.pointLayer&&this.pointLayer.removeAllFeatures()},_plotNewParcel:function(e,t,n,r){var i=this,s=new OpenLayers.Feature.Vector(e.geometry,null,this.parcelLayer.style);if(s.attributes){t&&(s.attributes.nimi=t);if(n||typeof n=="string")s.attributes.kuvaus=n}if(s){var o=this.instance.getDrawPlugin();o.getMap().getLayerIndex(this.parcelLayer)==-1&&(o.getMap().addLayer(this.parcelLayer),o.getMap().setLayerIndex(this.parcelLayer,1001)),this.parcelLayer.removeAllFeatures();var u=s.geometry.getArea()/1e4;s.attributes.area=u.toFixed(2),s.style=this.parcelLayer.style;var a=[s];this.parcelLayer.addFeatures(a),o.drawLayer.removeAllFeatures(),this.parcelLayer.redraw()}},_plotNewBoundary:function(e,t){var n=this,r=[],i=[],s=this.instance.getDrawPlugin();s.getMap().getLayerIndex(this.boundaryLayer)==-1&&(s.getMap().addLayer(this.boundaryLayer),s.getMap().setLayerIndex(this.boundaryLayer,1002)),s.getMap().getLayerIndex(this.pointLayer==-1)&&(s.getMap().addLayer(this.pointLayer),s.getMap().setLayerIndex(this.pointLayer,1003)),this.boundaryLayer.removeAllFeatures(),this.pointLayer.removeAllFeatures();var o=1,u=s.editLayer.features[0];if(u!==null&&u!==undefined){for(var a=0;a<u.geometry.components.length;a++){var f=u.geometry.components[a],l=f.getVertices();for(var c=0;c<l.length-1;c++){var h=l[c].x,p=l[c].y,d=l[c+1].x,v=l[c+1].y,m=new OpenLayers.LonLat(h,p),g=s._map.getPixelFromLonLat(m),y=new OpenLayers.LonLat(d,v),b=s._map.getPixelFromLonLat(y),w=(b.x+g.x)/2-g.x,E=(b.y+g.y)/2-g.y,S=new Array(new OpenLayers.Geometry.Point(h,p),new OpenLayers.Geometry.Point(d,v)),x=new OpenLayers.Geometry.LineString(S),T=new OpenLayers.Feature.Vector(x,null,this.boundaryLayer.style);T.attributes.length=T.geometry.getLength().toFixed(2),T.attributes.deltax=w,T.attributes.deltay=-E,r.push(T);var N=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(h,p),null,this.pointLayer.style);N.attributes.pnro=o++,i.push(N);if(c==l.length-2){var N=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(d,v),null,this.pointLayer.style);N.attributes.pnro=o++,i.push(N)}}if(f.CLASS_NAME=="OpenLayers.Geometry.Polygon"||f.CLASS_NAME=="OpenLayers.Geometry.LinearRing"){var h=l[l.length-1].x,p=l[l.length-1].y,d=l[0].x,v=l[0].y,m=new OpenLayers.LonLat(h,p),g=s._map.getPixelFromLonLat(m),y=new OpenLayers.LonLat(d,v),b=s._map.getPixelFromLonLat(y),w=(b.x+g.x)/2-g.x,E=(b.y+g.y)/2-g.y,S=new Array(new OpenLayers.Geometry.Point(h,p),new OpenLayers.Geometry.Point(d,v)),x=new OpenLayers.Geometry.LineString(S),T=new OpenLayers.Feature.Vector(x,null,this.boundaryLayer.style);T.attributes.length=T.geometry.getLength().toFixed(2),T.attributes.deltax=w,T.attributes.deltay=-E,r.push(T)}}i.length>0&&(this.pointLayer.addFeatures(i),this.pointLayer.redraw()),r.length>0&&(this.boundaryLayer.addFeatures(r),this.boundaryLayer.redraw())}s.getEditLayer().removeAllFeatures(),s.getMarkerLayer().clearMarkers()},_createGeoJSON:function(){var e=new OpenLayers.Format.GeoJSON,t=[],n=JSON.parse(e.write(this.parcelLayer.features)),r={type:"geojson",name:this.parcelLayer.name,id:this.parcelLayer.name,data:{type:"FeatureCollection",features:n.features},styles:[]};r.styles.push(this._getDefaultStyle(this.parcelLayer.styleMap)),t.push(r);var i=JSON.parse(e.write(this.boundaryLayer.features)),r={type:"geojson",name:this.boundaryLayer.name,id:this.boundaryLayer.name,data:{type:"FeatureCollection",features:i.features},styles:[]};r.styles.push(this._getDefaultStyle(this.boundaryLayer.styleMap)),t.push(r);var s=JSON.parse(e.write(this.pointLayer.features)),r={type:"geojson",name:this.pointLayer.name,id:this.pointLayer.name,data:{type:"FeatureCollection",features:s.features},styles:[]};r.styles.push(this._getDefaultStyle(this.pointLayer.styleMap)),t.push(r);var o=this.instance.sandbox.getEventBuilder("Printout.PrintableContentEvent");if(o){var u=o(this.instance.getName(),null,null,t);this.instance.sandbox.notifyAll(u)}},_getDefaultStyle:function(e){var t=e.styles["default"].defaultStyle,n=e.styles["default"].id,r={title:"Standard",name:n,styleMap:{"default":{}}};return r.styleMap["default"]=this._cleanStyle(t,["labelXOffset","labelYOffset"]),r},_cleanStyle:function(e,t){var n=jQuery.extend(!0,{},e);for(var r=0;r<t.length;r++){var i=t[r];n[i]&&n[i].toString().indexOf("${delta")>-1&&delete n[i]}return n}}),define("bundles/framework/bundle/parcel/service/ParcelPlot",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.split.ParcelSplit",function(e){this.drawPlugin=e,this.intersectionPoints=[],this.markerSize=new OpenLayers.Size(21,25),this.markerOffset=new OpenLayers.Pixel(-(this.markerSize.w/2),-this.markerSize.h),this.markerIcon=new OpenLayers.Icon("/Oskari/resources/parcel/images/marker.png",this.markerSize,this.markerOffset),this.splitPolygons=[],this.map=this.drawPlugin.getMapModule().getMap(),this.map.activeMarker=null},{init:function(){},split:function(e){var t=this;if(this.drawPlugin.splitSelection)return;var n=this.drawPlugin.drawLayer,r=this.drawPlugin.editLayer;this.map.moveActiveMarker=function(e){var i=this.getLonLatFromPixel(new OpenLayers.Pixel(e.xy.x,e.xy.y));i.lon-=this.activeMarker.markerMouseOffset.lon,i.lat-=this.activeMarker.markerMouseOffset.lat,this.activeMarker.lonlat=this.activeMarkerProjection(i),this.activeMarker.reference.point.x=this.activeMarker.lonlat.lon,this.activeMarker.reference.point.x0=this.activeMarker.lonlat.lon,this.activeMarker.reference.point.y=this.activeMarker.lonlat.lat,this.activeMarker.reference.point.y0=this.activeMarker.lonlat.lat,r.updateLine(),r.redraw(),n.redraw(),t.drawPlugin.updateInfobox(),this.getLayersByName("Parcel Markers Layer")[0].redraw(),OpenLayers.Event.stop(e)},this.map.freezeActiveMarker=function(e){this.events.unregister("mousemove",this,this.moveActiveMarker),this.events.unregister("mouseup",this,this.freezeActiveMarker),OpenLayers.Event.stop(e);var i=this.getLonLatFromPixel(new OpenLayers.Pixel(e.xy.x,e.xy.y));i.lon-=this.activeMarker.markerMouseOffset.lon,i.lat-=this.activeMarker.markerMouseOffset.lat,this.activeMarker.lonlat=this.activeMarkerProjection(i),this.activeMarker.reference.point.x=this.activeMarker.lonlat.lon,this.activeMarker.reference.point.x0=this.activeMarker.lonlat.lon,this.activeMarker.reference.point.y=this.activeMarker.lonlat.lat,this.activeMarker.reference.point.y0=this.activeMarker.lonlat.lat,r.updateLine(),r.redraw(),n.redraw(),t.drawPlugin.updateInfobox()},this.map.pointProjection=function(e,t,n){var r=function(e,t){return e.x*t.x+e.y*t.y},i=n.x-t.x,s=n.y-t.y,o=e.x*(n.x-t.x)+e.y*(n.y-t.y),u=t.y-n.y,a=n.x-t.x,f=t.y*(n.x-t.x)-t.x*(n.y-t.y),l={x:-(o*a-s*f)/(s*u-i*a),y:(o*u-i*f)/(s*u-i*a)},c={x:n.x-t.x,y:n.y-t.y},h={x:n.x-l.x,y:n.y-l.y},p=r(c,h),d=r(c,c);return p<0?(l.x=n.x,l.y=n.y):p>d&&(l.x=t.x,l.y=t.y),isNaN(l.x)||isNaN(l.y)?t:l},this.map.distance=function(e,t){var n,r=function(t){return!isNaN(parseFloat(t))&&isFinite(t)};if(r(e.lon))n=e.lon;else if(r(e.x))n=e.x;else{if(!r(e[0]))return null;n=e[0]}var i;if(r(e.lat))i=e.lat;else if(r(e.y))i=e.y;else{if(!r(e[1]))return null;i=e[1]}var s;if(r(t.lon))s=t.lon;else if(r(t.x))s=t.x;else{if(!r(t[0]))return null;s=t[0]}var o;if(r(t.lat))o=t.lat;else if(r(t.y))o=t.y;else{if(!r(t[1]))return null;o=t[1]}return Math.sqrt(Math.pow(s-n,2)+Math.pow(o-i,2))},this.map.activeMarkerProjection=function(e){var t=this.getLayersByName("Parcel Draw Layer")[0],n={x:e.lon,y:e.lat},r=[],i=[],s=this.activeMarker.reference.segments,o=0;for(var u=0;u<s.polygons.length;u++){for(var a=0;a<t.features.length;a++)if(t.features[a].geometry.CLASS_NAME==="OpenLayers.Geometry.Polygon"&&t.features[a].geometry.id===s.polygons[u]){var f=t.features[a].geometry.components[0].components;break}var l={x:s.p[0][u].x,y:s.p[0][u].y},c={x:s.p[1][u].x,y:s.p[1][u].y};r.push(this.pointProjection(n,l,c)),i.push(this.distance(n,r[u]));var h=i.length-1;i[h]<i[o]&&(o=h)}return new OpenLayers.LonLat(r[o].x,r[o].y)},this.drawPlugin.splitSelection=!0;var i=n.features[0];if(i.geometry.CLASS_NAME!=="OpenLayers.Geometry.MultiPolygon")return;this.drawPlugin.backupFeatures=[i.clone()];if(e){var s=this.drawPlugin.backupFeatures[0].geometry.components;this.drawPlugin.drawLayer.removeAllFeatures(),this.drawPlugin.editLayer.removeAllFeatures();for(var o=0;o<s.length;o++)this.drawPlugin.drawLayer.addFeatures(new OpenLayers.Feature.Vector(this.drawPlugin.backupFeatures[0].geometry.components[o])),this.drawPlugin.drawLayer.features[o].style=this.drawPlugin.basicStyle;return this.drawPlugin.drawLayer.features[0].style=this.drawPlugin.selectStyle,this.drawPlugin.selectedFeature=0,n.redraw(),r.redraw(),null}var u=n.features.length-1;if(u<1)return;var a=n.features[u];switch(a.geometry.CLASS_NAME){case"OpenLayers.Geometry.Polygon":this.splitHole(i,a);break;case"OpenLayers.Geometry.LineString":var f=this.splitLine(i,a);this.drawPlugin.drawLayer.removeAllFeatures();for(var o=0;o<f[0].geometry.components.length;o++)this.drawPlugin.drawLayer.addFeatures(new OpenLayers.Feature.Vector(f[0].geometry.components[o])),this.drawPlugin.drawLayer.features[o].style=this.drawPlugin.basicStyle;this.drawPlugin.editLayer.addFeatures(f[1])}return OpenLayers.Feature.Vector.style["default"].strokeWidth="2",n.redraw(),r.redraw(),r.features[0]},splitHole:function(e,t){var n=this.drawPlugin.drawLayer,r=this.drawPlugin.editLayer,i=e.geometry.components;for(var s=0;s<i.length;s++){var o=i[s],u=!0;for(var a=0;a<t.geometry.components[0].components.length;a++)if(!o.containsPoint(t.geometry.components[0].components[a])){u=!1;break}if(!u)continue;if(o.components[0].intersects(t.geometry.components[0])||this.checkSelfIntersection(t.geometry.components[0])){n.destroyFeatures(t);continue}o.addComponent(t.geometry.components[0]),n.removeAllFeatures();for(a=0;a<i.length;a++){var f=new OpenLayers.Feature.Vector(i[a]);f.style=this.drawPlugin.basicStyle,n.addFeatures([f])}t.style=this.drawPlugin.basicStyle,r.addFeatures([t]),n.addFeatures([t]);break}},scaleup:function(e,t){var n,r;t||(t=1);for(n=0;n<e.length;n++)for(r=0;r<e[n].length;r++)e[n][r].X=Math.floor(e[n][r].X*t),e[n][r].Y=Math.floor(e[n][r].Y*t);return e},splitLine:function(e,t){var n=new OpenLayers.Geometry.Point(0,0),r=[e.geometry.components[0].components[0].components[0].x,e.geometry.components[0].components[0].components[0].y],i=1e4;e.geometry.move(-r[0],-r[1]),e.geometry.resize(i,n),t.geometry.move(-r[0],-r[1]),t.geometry.resize(i,n);var s={strokeColor:"#0000ff",strokeOpacity:1,strokeWidth:2},o=e.geometry.components.concat(t.geometry),u=[new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon),new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString,null,s)],a=u[0].geometry.components,f=u[1].geometry.components,l=[],c=[],h=[],p,d=[],v=[],m=[],g=[],y,b=[],w,E,S=new jsts.io.OpenLayersParser,x,T,N=[],C=[],k=null,L,A,O,M,_=[],D=[],P=[],H=[],B,j,F,I,q,R,U,z,W=[],X=[],V=!1,$=!1,J=!1,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot=1e6,ut=1,at,ft="";for(K=0;K<o.length;K++)if(o[K].id.indexOf("Polygon")!==-1){T=S.read(o[K]);if(!T.isValid())return-1+ft;N.push(T),O=new ClipperLib.Polygon,y=o[K].components,y[0].getArea()>=0?d=y[0].components:d=y[0].components.reverse();for(Q=0;Q<d.length-1;Q++)L=new ClipperLib.IntPoint(d[Q].x,d[Q].y),O.push(L);Y=D.length,D[Y]=[],D[Y].push(O);for(Q=1;Q<y.length;Q++){M=new ClipperLib.Polygon,y[Q].getArea()<=0?d=y[Q].components:d=y[Q].components.reverse();for(G=0;G<d.length-1;G++)L=new ClipperLib.IntPoint(d[G].x,d[G].y),M.push(L);D[K].push(M)}Y=D.length-1,D[Y]=this.scaleup(D[Y],ut)}else o[K].id.indexOf("OpenLayers.Geometry.LineString")!==-1&&(k=S.read(o[K]));ft+=" olOldFeatures ",ft+=o,ft+=" clipSourcePolygons ",ft+=D,ft+=" jstsOldPolygons ",ft+=N,ft+=" jstsLine ",ft+=k;if(k===null)return[o];for(K=0;K<N.length;K++){ft+=" i ",ft+=K.toString()+" / "+N.length,k!==null?U=N[K].getExteriorRing().union(k):U=N[K],z=new jsts.operation.polygonize.Polygonizer,z.add(U),C=z.getPolygons(),ft+=" jstsNewPolygons ",ft+=C,A=[],d=[],c=[];for(Q=0;Q<C.array.length;Q++){ft+="j",ft+=Q+" / "+C.array.length,H=[],O=new ClipperLib.Polygon,x=C.array[Q].shell.points;for(G=0;G<x.length-1;G++)L=new ClipperLib.IntPoint(x[G].x,x[G].y),O.push(L);H.push(O),H=this.scaleup(H,ut),I=new ClipperLib.Clipper,I.AddPolygons(D[K],ClipperLib.PolyType.ptSubject),I.AddPolygons(H,ClipperLib.PolyType.ptClip),j=new ClipperLib.Polygons,R=ClipperLib.ClipType.ctIntersection,q=I.Execute(R,j);if(!q)return-2+ft;ft+=" clipSourcePolygons[i] ",ft+=D[K],ft+=" clipTargetPolygons ",ft+=H,ft+=" clipSolutionPolygons ",ft+=j;if(j.length===0)continue;W=[],l=[],V=!1;for(G=0;G<j.length;G++){if(Math.abs(I.Area(j[G]))<ot)continue;_.push(j[G]);if(I.Area(j[G])>0){B=j[G],g=[];for(Y=0;Y<B.length;Y++){L=B[Y],st=-1;for(Z=0;Z<A.length;Z++)if(L.X===A[Z].X&&L.Y===A[Z].Y){st=Z;break}st>=0?g.push(d[st]):(A.push(L),d.push(new OpenLayers.Geometry.Point(L.X/ut,L.Y/ut)),rt=d.length-1,d[rt].references=[],g.push(d[rt]))}l.push(new OpenLayers.Geometry.Polygon(new OpenLayers.Geometry.LinearRing(g))),rt=l.length-1;for(Y=0;Y<l[rt].components[0].components.length-1;Y++)l[rt].components[0].components[Y].references.push(l[rt].id);W.push(G)}}ft+=" olPoints ",ft+=d,ft+=" olLinearRingPoints ",ft+=g,ft+=" olNewPolygons ",ft+=l;for(G=0;G<j.length;G++){ft+=" Holes k ",ft+=G+" / "+j.length;if(I.Area(j[G])<0){H=[],H.push(j[G]);for(Y=0;Y<W.length;Y++){I=new ClipperLib.Clipper,P=[],P.push(j[W[Y]]),I.AddPolygons(P,ClipperLib.PolyType.ptSubject),I.AddPolygons(H,ClipperLib.PolyType.ptClip),F=new ClipperLib.Polygons,R=ClipperLib.ClipType.ctIntersection,q=I.Execute(R,F);if(!q)return-3+ft;ft+=" clipSubjectPolygons ",ft+=P,ft+=" clipTargetPolygons ",ft+=H,ft+=" clipSolutionHoles ",ft+=F;if(F.length>0){M=j[G],v=[];for(Z=0;Z<M.length;Z++)L=M[Z],v.push(new OpenLayers.Geometry.Point(L.X/ut,L.Y/ut));l[Y].components.push(new OpenLayers.Geometry.LinearRing(v));break}}}}ft+=" olNewPolygons ",ft+=l;for(G=0;G<l.length;G++)a.push(l[G])}}d=u[0].geometry.getVertices(),X=[];for(K=0;K<d.length;K++)X.indexOf(d[K].id)<0&&(d[K].x=d[K].x/i+r[0],d[K].y=d[K].y/i+r[1],X.push(d[K].id));for(K=0;K<a.length;K++){d=a[K].components[0].components,V=d[0].references.length>1,$=V,b=[],h=[],V&&b.push(d[0]);for(Q=1;Q<d.length-1;Q++)this.equalArrays(d[Q].references,d[Q-1].references)||V&&(d[Q].references.length>2&&b.push(d[Q]),h.push(new OpenLayers.Geometry.LineString(b)),b=[]),V=d[Q].references.length>1,V&&b.push(d[Q]);if(V)if($&&h.length>0&&this.equalArrays(d[d.length-2].references,d[0].references))for(Q=b.length-1;Q>=0;Q--)h[0].components.splice(0,0,b[Q]);else d[0].references.length>2&&b.push(d[0]),h.push(new OpenLayers.Geometry.LineString(b));for(Q=0;Q<h.length;Q++)c.push(h[Q])}e:for(G=0;G<c.length;G++){for(Y=0;Y<f.length;Y++){for(Z=0;Z<c[G].components.length;Z++){p=c[G].components[Z],J=!1;for(et=0;et<f[Y].components.length;et++)if(p.id===f[Y].components[et].id){J=!0;break}if(!J)break}if(J)continue e}it=m.length,rt=c[G].components.length-1,m[it]=[c[G].components[0],c[G].components[rt]],m[it][0].x0=m[it][0].x,m[it][0].y0=m[it][0].y,m[it][1].x0=m[it][1].x,m[it][1].y0=m[it][1].y,f.push(c[G])}for(G=0;G<f.length;G++)t:for(Y=0;Y<2;Y++){if(m[G][Y].references.length!==2)continue;for(Z=0;Z<this.drawPlugin.markerLayer.markers.length;Z++)if(this.drawPlugin.markerLayer.markers[Z].reference.point.id===m[G][Y].id)continue t;at=new OpenLayers.Marker(new OpenLayers.LonLat(m[G][Y].x,m[G][Y].y),this.markerIcon.clone()),at.reference={point:m[G][Y],segments:{polygons:[],p:[[],[]]}},at.markerMouseOffset=new OpenLayers.LonLat(0,0);for(Z=0;Z<m[G][Y].references.length;Z++)for(et=0;et<a.length;et++)if(m[G][Y].references[Z]===a[et].id){E=a[et],d=E.components[0].components;for(tt=0;tt<d.length-1;tt++)if(d[tt].id===at.reference.point.id){tt===0?rt=d.length-2:rt=tt-1,p=d[rt],V=!1;for(nt=0;nt<p.references.length;nt++)if(p.references[nt]!==a[et].id){J=!1;n:for(K=0;K<m.length;K++)for(Q=0;Q<2;Q++)if(m[K][Q].id===p.id){if(m[K][Q].references.length!==2)continue;if(f[G].components.length===2&&this.equalArrays(d[tt].references,p.references))continue;J=!0;break n}if(!J){V=!0;break}}if(V){V=!1,tt===d.length-1?rt=0:rt=tt+1,p=d[rt];for(nt=0;nt<p.references.length;nt++)if(p.references[nt]!==a[et].id){n:for(K=0;K<m.length;K++)for(Q=0;Q<2;Q++)if(m[K][Q].id===p.id){if(m[K][Q].references.length!==2)continue;if(f[G].components.length===2&&this.equalArrays(d[tt].references,p.references))continue;J=!0;break n}if(!J){V=!0;break}}}V||(at.reference.segments.polygons.push(E.id),at.reference.segments.p[0].push(d[tt]),at.reference.segments.p[1].push(d[rt]))}break}at.events.register("mousedown",at,this.selectActiveMarker),this.drawPlugin.markerLayer.addMarker(at)}return u},selectActiveMarker:function(e){OpenLayers.Event.stop(e);var t=this.map.events.getMousePosition(e),n=new OpenLayers.Pixel(t.x,t.y),r=this.map.getLonLatFromPixel(n);this.map.activeMarker=e.object,this.map.activeMarker.markerMouseOffset.lon=r.lon-this.map.activeMarker.lonlat.lon,this.map.activeMarker.markerMouseOffset.lat=r.lat-this.map.activeMarker.lonlat.lat,this.map.events.register("mouseup",this.map,this.map.freezeActiveMarker),this.map.events.register("mousemove",this.map,this.map.moveActiveMarker)},checkSelfIntersection:function(e){var t=e.components,n=[];for(var r=1;r<t.length;r++){var i=new OpenLayers.Geometry.LineString([t[r-1].clone(),t[r].clone()]);n.push(i)}for(var s=0;s<n.length;s++)if(this.segmentIntersects(n[s],n))return!0;return!1},segmentIntersects:function(e,t){for(var n=0;n<t.length;n++)if(!t[n].equals(e)&&t[n].intersects(e)&&!this.startOrStopEquals(t[n],e))return!0;return!1},startOrStopEquals:function(e,t){return e.components[0].equals(t.components[0])?!0:e.components[0].equals(t.components[1])?!0:e.components[1].equals(t.components[0])?!0:e.components[1].equals(t.components[1])},equalArrays:function(e,t){var n=[],r,i;if(!e[0]||!t[0])return!1;if(e.length!=t.length)return!1;for(i=0;i<e.length;i++)r=typeof e[i]+"~"+e[i],n[r]?n[r]++:n[r]=1;for(i=0;i<t.length;i++){r=typeof t[i]+"~"+t[i];if(!n[r])return!1;if(n[r]==0)return!1;n[r]--}return!0}}),define("bundles/framework/bundle/parcel/split/ParcelSplit",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.view.MainView",function(e){this.instance=e,this.popupId="parcelForm",this.form=undefined},{getName:function(){return"ParcelMainView"},getSandbox:function(){return this.instance.sandbox},init:function(){},start:function(){var e=this,t=this.instance.sandbox;t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p);var n=t.findRegisteredModuleInstance("MainMapModule"),r=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.plugin.DrawPlugin",this.instance);n.registerPlugin(r),n.startPlugin(r),this.drawPlugin=r},stop:function(){var e=this.instance.sandbox;for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this)},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{"Toolbar.ToolSelectedEvent":function(e){this._cleanupPopup()},"Parcel.SaveDrawingEvent":function(e){this._handleFinishedDrawingEvent(e)}},_handleFinishedDrawingEvent:function(e){var t=e.getDrawing().geometry.getCentroid(),n={lon:t.x,lat:t.y};this.showPlaceForm(n)},showPlaceForm:function(e){var t=this,n=this.instance.sandbox;n.postRequestByName("DisableMapKeyboardMovementRequest");var r=this.instance.getLocalization();this.form=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.view.PlaceForm",this.instance);var i={place:{}},s=this.drawPlugin.getDrawing();s.attributes&&(i.place.name=s.attributes.nimi,i.place.desc=s.attributes.kuvaus),this.form.setValues(i);var o=[{html:t.form.getForm(),useButtons:!0,primaryButton:r.buttons.save,actions:{}}];o[0].actions[r.buttons.cancel]=function(){t._cleanupPopup();var e=t.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();t.instance.sandbox.request(t,e)},o[0].actions[r.buttons.save]=function(){t._saveForm()};var u=n.getRequestBuilder("InfoBox.ShowInfoBoxRequest")(this.popupId,r.placeform.title,o,e,!0);n.request(t.getName(),u)},_validateForm:function(e){var t=[],n=this.instance.getLocalization("validation");return e.place.name||t.push({name:"name",error:n.placeName}),t},_showValidationErrorMessage:function(e){var t=this.instance.getLocalization(),n=Oskari.clazz.create("Oskari.userinterface.component.Popup"),r=n.createCloseButton(t.buttons.ok),i=jQuery("<ul></ul>");for(var s=0;s<e.length;++s){var o=jQuery("<li></li>");o.append(e[s].error),i.append(o)}n.show(t.validation.title,i,[r])},_saveForm:function(){if(!this.form)return;var e=this,t=this.form.getValues(),n=this._validateForm(t);if(n.length!=0){this._showValidationErrorMessage(n);return}this.__savePlace(t.place)},__savePlace:function(e){var t=this;if(!e){var n=t.instance.getLocalization("notification").error;t.instance.showMessage(n.title,n.savePlace);return}var r=function(e){e&&t._cleanupPopup()},i=e?e.name:undefined,s=e?e.desc:undefined;this.instance.getService().savePlace(this.drawPlugin.getDrawing(),this.drawPlugin.getFeatureType(),i,s,r)},_cleanupPopup:function(){if(!this.form)return;var e=this.instance.sandbox,t=e.getRequestBuilder("InfoBox.HideInfoBoxRequest")(this.popupId);e.request(this,t),this.form.destroy(),this.form=undefined,e.postRequestByName("EnableMapKeyboardMovementRequest")}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/parcel/view/MainView",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.view.PlaceForm",function(e){this.instance=e,this.initialValues=undefined;var t=e.getLocalization("placeform");this.template=jQuery('<div class="parcelform"><div class="field"><div class="help icon-info" title="'+t.tooltip+'"></div>'+'<input type="text" name="placename" placeholder="'+t.placename.placeholder+'"/>'+"</div>"+'<div class="field">'+'<textarea name="placedesc" placeholder="'+t.placedesc.placeholder+'">'+"</textarea>"+"</div>"+"</div>")},{getForm:function(){var e=this.template.clone(),t=this.instance.getLocalization("placeform");return this.initialValues&&(e.find("input[name=placename]").attr("value",this.initialValues.place.name),e.find("textarea[name=placedesc]").append(this.initialValues.place.desc)),e},getValues:function(){var e={},t=this._getOnScreenForm();if(t.length>0){var n=t.find("input[name=placename]").val(),r=t.find("textarea[name=placedesc]").val();e.place={name:n,desc:r}}return e},setValues:function(e){var t=this._getOnScreenForm();t.length>0&&(t.find("input[name=placename]").val(e.place.name),t.find("textarea[name=placedesc]").val(e.place.desc)),this.initialValues=e},destroy:function(){var e=this._getOnScreenForm()},_getOnScreenForm:function(){return jQuery("div.parcelform")}}),define("bundles/framework/bundle/parcel/view/PlaceForm",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.handler.ButtonHandler",function(e){this.instance=e,this.buttonGroup="parcel",this.ignoreEvents=!1,this.dialog=null;var t=this;this.buttons={line:{iconCls:"parcel-draw-line",tooltip:"",sticky:!0,callback:function(){t.instance.view.drawPlugin.splitSelection=!1,t._startNewDrawing({drawMode:"line"})}},area:{iconCls:"parcel-draw-area",tooltip:"",sticky:!0,callback:function(){t.instance.view.drawPlugin.splitSelection=!1,t._startNewDrawing({drawMode:"area"})}},selector:{iconCls:"parcel-selector",tooltip:"",sticky:!0,callback:function(){t.instance.view.drawPlugin.splitSelection=!1,t.instance.view.drawPlugin.splitFeature(!0)}},clear:{iconCls:"parcel-clear",tooltip:"",sticky:!0,callback:function(){var e=t.instance.view.drawPlugin;e.clear(),e.drawLayer.addFeatures(e.backupFeatures)}},save:{iconCls:"tool-save-view",tooltip:"",sticky:!0,callback:function(){t._saveDrawing()}}}},{getName:function(){return"ParcelButtonHandler"},init:function(){var e=this.instance.getLocalization("tools");for(var t in this.buttons){var n=e[t].tooltip;this.buttons[t].tooltip=n}},start:function(){var e=this,t=this.instance.getSandbox();t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p);var n=t.getRequestBuilder("Toolbar.AddToolButtonRequest");for(var r in this.buttons)t.request(this,n(r,this.buttonGroup,this.buttons[r]))},_startNewDrawing:function(e){if(this.instance.view.drawPlugin.drawLayer.features[0].geometry.CLASS_NAME!=="OpenLayers.Geometry.MultiPolygon")return;if(this.instance.view.drawPlugin.editLayer.features.length!==0)return;var t=this.instance.sandbox.getEventBuilder("Parcel.ParcelSelectedEvent")();this.instance.sandbox.notifyAll(t),this._sendDrawRequest(e)},_saveDrawing:function(){var e=this.instance.sandbox.getRequestBuilder("Parcel.SaveDrawingRequest")();this.instance.sandbox.request(this,e)},_sendDrawRequest:function(e){var t=this.instance.sandbox.getRequestBuilder("Parcel.StartDrawingRequest")(e);this.instance.sandbox.request(this,t),e.geometry||this._showDrawHelper(e.drawMode)},_showDrawHelper:function(e){var t=this,n=this.instance.getLocalization("tools")[e],r=this.instance.getLocalization("buttons"),i=this.instance.getLocalization("title"),s=n["new"],o=Oskari.clazz.create("Oskari.userinterface.component.Popup");this.dialog=o;var u=[],a=Oskari.clazz.create("Oskari.userinterface.component.Button");a.setTitle(r.cancel),a.setHandler(function(){var e=t.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();t.instance.sandbox.request(t,e),t.sendCancelDrawRequest()}),u.push(a),o.show(i,s,u),o.addClass("parcel"),o.moveTo("#toolbar div.toolrow[tbgroup=parcel]","top")},sendStopDrawRequest:function(){var e=this,t=this.instance.sandbox.getRequestBuilder("Parcel.StopDrawingRequest")();this.instance.sandbox.request(this,t),this.dialog&&this.dialog.close()},sendCancelDrawRequest:function(){var e=this,t=this.instance.sandbox.getRequestBuilder("Parcel.CancelDrawingRequest")();this.instance.sandbox.request(this,t),this.dialog&&this.dialog.close()},stop:function(){jQuery("div.parcel div.button").die()},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{"Toolbar.ToolSelectedEvent":function(e){this.ignoreEvents||this.sendCancelDrawRequest()},"Parcel.ParcelSelectedEvent":function(e){if(!e.getPlace()){var t=this.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();this.instance.sandbox.request(this,t)}},"Parcel.FinishedDrawingEvent":function(e){this.ignoreEvents=!0;var t=this.instance.sandbox.getRequestBuilder("Toolbar.SelectToolButtonRequest")();this.instance.sandbox.request(this,t),this.ignoreEvents=!1,this.dialog&&this.dialog.close()}}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/parcel/handler/ButtonHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.handler.ParcelSelectorHandler",function(e){this.instance=e,this.ignoreEvents=!1},{getName:function(){return"ParcelSelectorHandler"},init:function(){},start:function(){var e=this,t=this.instance.sandbox;t.register(e);for(p in e.eventHandlers)t.registerForEventByName(e,p)},stop:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{"ParcelSelector.ParcelSelectedEvent":function(e){var t=this;this.ignoreEvents||e&&e.getFid()&&this.instance.getService().loadParcel(e.getFid(),function(e){t._loadCallback.call(t,e,t.instance.conf.parcelFeatureType)})},"ParcelSelector.RegisterUnitSelectedEvent":function(e){var t=this;this.ignoreEvents||e&&e.getFid()&&this.instance.getService().loadRegisterUnit(e.getFid(),function(e){t._loadCallback.call(t,e,t.instance.conf.registerUnitFeatureType)})}},_loadCallback:function(e,t){e&&this.instance.getDrawPlugin().drawFeature(e,t)}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/parcel/handler/ParcelSelectorHandler",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.parcel.DrawingToolInstance",function(){this._localization=null,this.sandbox=null,this.parcelService=undefined,this.idPrefix="parcel"},{getName:function(){return"Parcel"},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization&&this._localization[e]?this._localization[e]:e:this._localization},showMessage:function(e,t){var n=this.getLocalization(),r=Oskari.clazz.create("Oskari.userinterface.component.Popup"),i=Oskari.clazz.create("Oskari.userinterface.component.Button");i.setTitle(n.buttons.ok),i.addClass("primary"),i.setHandler(function(){r.close(!0)}),r.show(e,t,[i])},getService:function(){return this.parcelService},getDrawPlugin:function(){return this.view.drawPlugin},getMainView:function(){return this.view},update:function(){},start:function(){var e=Oskari.$("sandbox");this.sandbox=e;var t=this.sandbox.getService("Oskari.mapframework.service.MapLayerService"),n=this;this.conf&&this.conf.proxyUrl&&(OpenLayers.ProxyHost=this.conf.proxyUrl);if(this.conf&&this.conf.stickyLayerIds)for(var r in this.conf.stickyLayerIds){var i=this.conf.stickyLayerIds[r];t.makeLayerSticky(i,!0)}this.parcelService=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.service.ParcelService",this),this.sandbox.registerService(this.parcelService),this.parcelService.init(),this.view=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.view.MainView",this),this.view.start(),this.parcelSelectorHandler=Oskari.clazz.create("Oskari.mapframework.bundle.parcel.handler.ParcelSelectorHandler",this),this.parcelSelectorHandler.start()},stop:function(){this.sandbox=null}},{protocol:["Oskari.bundle.BundleInstance"]}),define("bundles/framework/bundle/parcel/instance",function(){}),define("normalize",["require","module"],function(e,t){function o(e,t,n){if(e.indexOf("data:")===0)return e;e=r(e);if(e.match(/^\//)||e.match(s))return e;var i=n.match(s),o=t.match(s);return o&&(!i||i[1]!=o[1]||i[2]!=o[2])?u(e,t):a(u(e,t),n)}function u(e,t){e.substr(0,2)=="./"&&(e=e.substr(2));var n=t.split("/"),r=e.split("/");n.pop();while(curPart=r.shift())curPart==".."?n.pop():n.push(curPart);return n.join("/")}function a(e,t){var n=t.split("/");n.pop(),t=n.join("/")+"/",i=0;while(t.substr(i,1)==e.substr(i,1))i++;while(t.substr(i,1)!="/")i--;t=t.substr(i+1),e=e.substr(i+1),n=t.split("/");var r=e.split("/");out="";while(n.shift())out+="../";while(curPart=r.shift())out+=curPart+"/";return out.substr(0,out.length-1)}var n=/([^:])\/+/g,r=function(e){return e.replace(n,"$1/")},s=/[^\:\/]*:\/\/([^\/])*/,f=function(e,t,n,i){t=r(t),n=r(n);var s=/@import\s*("([^"]*)"|'([^']*)')|url\s*\(\s*(\s*"([^"]*)"|'([^']*)'|[^\)]*\s*)\s*\)/ig,u,a,e;while(u=s.exec(e)){a=u[3]||u[2]||u[5]||u[6]||u[4];var f;i&&a.substr(0,1)=="/"?f=i+a:f=o(a,t,n);var l=u[5]||u[6]?1:0;e=e.substr(0,s.lastIndex-a.length-l-1)+f+e.substr(s.lastIndex-l-1),s.lastIndex=s.lastIndex+(f.length-a.length)}return e};return f.convertURIBase=o,f}),define("css",["./normalize"],function(e){function t(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}if(typeof window=="undefined")return{load:function(e,t,n){n()}};var n=!1,r=document.getElementsByTagName("head")[0],i=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/),s=!1;!i||(i[1]||i[7]?(s=parseInt(i[1])<6||parseInt(i[7])<=9,i="trident"):i[2]?(s=!0,i="webkit"):i[3]||(i[4]?(s=parseInt(i[4])<18,i="gecko"):n&&alert("Engine detection failed")));var o={},u=/^\/|([^\:\/]*:)/;o.pluginBuilder="./css-builder";var a=[],f={},l=[];o.addBuffer=function(e){if(t(a,e)!=-1)return;if(t(l,e)!=-1)return;a.push(e),l.push(e)},o.setBuffer=function(t,n){var r=window.location.pathname.split("/");r.pop(),r=r.join("/")+"/";var i=require.toUrl("base_url").split("/");i.pop();var s=i.join("/")+"/";s=e.convertURIBase(s,r,"/"),s.match(u)||(s="/"+s),s.substr(s.length-1,1)!="/"&&(s+="/"),o.inject(e(t,s,r));for(var l=0;l<a.length;l++)(n&&a[l].substr(a[l].length-5,5)==".less"||!n&&a[l].substr(a[l].length-4,4)==".css")&&(function(e){f[e]=f[e]||!0,setTimeout(function(){typeof f[e]=="function"&&f[e](),delete f[e]},7)}(a[l]),a.splice(l--,1))},o.attachBuffer=function(e,n){for(var r=0;r<a.length;r++)if(a[r]==e)return f[e]=n,!0;if(f[e]===!0)return f[e]=n,!0;if(t(l,e)!=-1)return n(),!0};var c=function(e,t){setTimeout(function(){for(var n=0;n<document.styleSheets.length;n++){var r=document.styleSheets[n];if(r.href==e.href)return t()}c(e,t)},10)},h=function(e,t){setTimeout(function(){try{return e.sheet.cssRules,t()}catch(n){}h(e,t)},10)};if(i=="trident"&&s)var p=[],d=[],v=0,m=function(e,t){var n;d.push({url:e,cb:t}),n=p.shift(),!n&&v++<31&&(n=document.createElement("style"),r.appendChild(n)),n&&g(n)},g=function(e){var t=d.shift();if(!t){e.onload=b,p.push(e);return}e.onload=function(){t.cb(t.ss),g(e)};var n=e.styleSheet;t.ss=n.imports[n.addImport(t.url)]};var y=function(e){var t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.href=e,t},b=function(){};o.linkLoad=function(e,t){var o=setTimeout(function(){n&&alert("timeout"),t()},L*1e3-100),u=function(){clearTimeout(o),a&&(a.onload=b),setTimeout(t,7)};if(!s){var a=y(e);a.onload=u,r.appendChild(a)}else if(i=="webkit"){var a=y(e);c(a,u),r.appendChild(a)}else if(i=="gecko"){var f=document.createElement("style");f.textContent='@import "'+e+'"',h(f,u),r.appendChild(f)}else i=="trident"&&m(e,u)};var w=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],E={},S=function(e,t,n){if(E[e]){t(E[e]);return}var r,i,s;if(typeof XMLHttpRequest!="undefined")r=new XMLHttpRequest;else if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){s=w[i];try{r=new ActiveXObject(s)}catch(o){}if(r){w=[s];break}}r.open("GET",e,requirejs.inlineRequire?!1:!0),r.onreadystatechange=function(i){var s,o;r.readyState===4&&(s=r.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=r,n(o)):(E[e]=r.responseText,t(r.responseText)))},r.send(null)},x=0,T;o.inject=function(e){x<31&&(T=document.createElement("style"),T.type="text/css",r.appendChild(T),x++),T.styleSheet?T.styleSheet.cssText+=e:T.appendChild(document.createTextNode(e))};var N=/@import\s*(url)?\s*(('([^']*)'|"([^"]*)")|\(('([^']*)'|"([^"]*)"|([^\)]*))\))\s*;?/g,C=window.location.pathname.split("/");C.pop(),C=C.join("/")+"/";var k=function(t,n,r){t.match(u)||(t="/"+e.convertURIBase(t,C,"/")),S(t,function(i){i=e(i,t,C);var s=[],o=[],u=[],a;while(a=N.exec(i)){var f=a[4]||a[5]||a[7]||a[8]||a[9];s.push(f),o.push(N.lastIndex-a[0].length),u.push(a[0].length)}var l=0;for(var c=0;c<s.length;c++)(function(e){k(s[e],function(t){i=i.substr(0,o[e])+t+i.substr(o[e]+u[e]);var r=t.length-u[e];for(var a=e+1;a<s.length;a++)o[a]+=r;l++,l==s.length&&n(i)},r)})(c);s.length==0&&n(i)},r)};o.normalize=function(e,t){return e.substr(e.length-4,4)==".css"&&(e=e.substr(0,e.length-4)),t(e)};var L,A=!1;return o.load=function(e,t,r,i,u){L=L||i.waitSeconds||7;var a=e+(u?".less":".css");if(o.attachBuffer(a,r))return;var f=t.toUrl(a);!A&&n&&(alert(s?"hacking links":"not hacking"),A=!0),u?k(f,function(e){u&&(e=u(e,function(e){o.inject(e),setTimeout(r,7)}))}):o.linkLoad(f,r)},n&&(o.inspect=function(){if(stylesheet.styleSheet)return stylesheet.styleSheet.cssText;if(stylesheet.innerHTML)return stylesheet.innerHTML}),o}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("resources/framework/bundle/parcel/css/style.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,Oskari.registerLocalization({lang:"fi",key:"Parcel",value:{title:"Kohteet",desc:"",tools:{line:{tooltip:"Jaa kohde viivalla","new":"Halkaise kohde viivalla. Lisää viivan taitepiste klikkaamalla karttaa. Lopeta piirto tuplaklikkauksella.",edit:"Muokkaa viivaa raahaamalla viivan taitepisteitä.",save:"Tallenna muoto"},area:{tooltip:"Jaa kohde alueella","new":"Piirrä reikä kohteeseen. Lisää alueen taitepisteet klikkaamalla karttaa. Lopeta piirto tuplaklikkauksella.",edit:"Muokkaa muotoa raahaamalla reunaviivan taitepisteitä.",save:"Tallenna muoto"},selector:{tooltip:"Jaa kohde valitsemalla kokonainen palsta"},clear:{tooltip:"Tyhjennä"},save:{tooltip:"Tee piirros ja tulosta"}},buttons:{ok:"OK",cancel:"Peruuta",save:"Tulosta",movePlaces:"Siirrä kohteet ja poista"},placeform:{title:"Kohteen tiedot",tooltip:"Anna kohteelle nimi ja kuvaus. Kohteen data tallennetaan palvelimelle.",placename:{placeholder:"Anna kohteelle nimi"},placedesc:{placeholder:"Kuvaile kohdetta"}},notification:{placeLoading:{title:"Kohdetta ladataan",message:""},calculating:{title:"Lasketaan jakoa",message:""},placeAdding:{title:"Kohdetta tallennetaan",message:""},error:{title:"Virhe!",savePlace:"Kohteen tallentaminen ei onnistunut.",loadPlace:"Kohteen lataaminen ei onnistunut"}},validation:{title:"Tiedoissa puutteita:",placeName:"Kohteen nimi puuttuu."}}}),define("bundles/framework/bundle/parcel/locale/fi",function(){}),define("bundles/framework/bundle/parcel/module",["oskari","jquery","./event/FinishedDrawingEvent","./event/SaveDrawingEvent","./event/ParcelSelectedEvent","./event/ParcelInfoLayerRegisterEvent","./event/ParcelInfoLayerUnregisterEvent","./plugin/DrawPlugin","./request/SaveDrawingRequest","./request/StopDrawingRequest","./request/CancelDrawingRequest","./request/StartDrawingRequest","./request/SaveDrawingRequestHandler","./request/StopDrawingRequestHandler","./request/CancelDrawingRequestHandler","./request/StartDrawingRequestHandler","./service/ParcelService","./service/ParcelWfst","./service/ParcelPlot","./split/ParcelSplit","./view/MainView","./view/PlaceForm","./handler/ButtonHandler","./handler/ParcelSelectorHandler","./instance","css!resources/framework/bundle/parcel/css/style.css","./locale/fi"],function(e,t){return e.bundleCls("parcel").category({create:function(){var t=this,n=e.clazz.create("Oskari.mapframework.bundle.parcel.DrawingToolInstance");return n},update:function(e,t,n,r){e.alert("RECEIVED update notification "+r)}})}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer("div.parcelform div.help {\r\n  float: right; }\r\n\r\n/* Wide fields for place inputs  */\r\ndiv.parcelform div.field {\r\n  padding-bottom: 10px; }\r\n\r\ndiv.parcelform input {\r\n  width: 80%; }\r\n\r\ndiv.parcelform textarea, div.parcelform select {\r\n  width: 80%; }\r\n\r\ndiv.parcel div.buttons div.button {\r\n  margin: 10px;\r\n  padding: 10px;\r\n  border: 1px solid;\r\n  border-radius: 5px;\r\n  box-shadow: 5px 5px 5px #888; }\r\n\r\n.divmanazerpopup.parcel {\r\n  max-width: 260px; }\r\n")}),requirejs.s.contexts._.nextTick=requirejs.nextTick;