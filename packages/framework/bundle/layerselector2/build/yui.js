/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kes√§aika)) */ 
var Tooltip=RightJS.Tooltip=function(w,v){function u(b,h){h||(h=b,b="DIV");var g=new v.Class(v.Element.Wrappers[b]||v.Element,{initialize:function(j,i){this.key=j;var a=[{"class":"rui-"+j}];this instanceof v.Input||this instanceof v.Form||a.unshift(b),this.$super.apply(this,a),v.isString(i)&&(i=v.$(i)),i instanceof v.Element&&(this._=i._,"$listeners" in i&&(i.$listeners=i.$listeners),i={}),this.setOptions(i,this);return v.Wrapper.Cache[v.$uid(this._)]=this},setOptions:function(d,e){e&&(d=v.Object.merge(d,(new Function("return "+(e.get("data-"+this.key)||"{}")))())),d&&v.Options.setOptions.call(this,v.Object.merge(this.options,d));return this}}),f=new v.Class(g,h);v.Observer.createShortcuts(f.prototype,f.EVENTS||v([]));return f}var t=v,s=v.$,r=v.$w,q=v.$uid,o=v.Element,n=new u({extend:{version:"2.2.1",EVENTS:r("show hide"),Options:{cssRule:"[data-tooltip]",fxName:"fade",fxDuration:400,delay:400,move:!0,idSuffix:"-tooltip"},current:null,instances:t([]),find:function(e){var d=e.target;if(d.match(n.Options.cssRule)){var f=q(d);return n.instances[f]||(n.instances[f]=new n(d))}}},initialize:function(a,d){this.associate=a=s(a),this.$super("tooltip").setOptions(d,a).insert('<div class="rui-tooltip-arrow"></div><div class="rui-tooltip-container">'+(a.get("title")||a.get("alt"))+"</div>").on({mouseout:this._mouseOut,mouseover:this._cancelTimer}).insertTo(w.body),a.has("id")&&this.set("id",a.get("id")+this.options.idSuffix),a.set({title:"",alt:""})},hide:function(){this._cancelTimer(),this._timer=t(function(){o.prototype.hide.call(this,this.options.fxName,{engine:"javascript",duration:this.options.fxDuration}),n.current=null,this.fire("hide")}).bind(this).delay(100);return this},show:function(b){n.instances.each(function(c){c&&c!==this&&c.hide()},this),this._timer=t(function(){o.prototype.show.call(this.stop(),this.options.fxName,{engine:"javascript",duration:this.options.fxDuration}),n.current=this.fire("show")}).bind(this).delay(this.options.delay);return n.current=this},moveToEvent:function(b){this.options.move&&(this._.style.left=b.pageX+"px",this._.style.top=b.pageY+"px");return this},_cancelTimer:function(){this._timer&&(this._timer.cancel(),this._timer=null);return !1},_mouseOut:function(b){b.stop(),b.relatedTarget!==this.associate&&this.hide()}});s(w).on({mouseenter:function(d){var c=n.find(d);c&&c.show().moveToEvent(d)},mouseleave:function(d){var c=n.find(d);c&&c.hide()},mousemove:function(d){var c=n.current;c!==null&&c.options.move&&c.moveToEvent(d)}});var m=w.createElement("style"),l=w.createTextNode("div.rui-tooltip{display:none;position:absolute;z-index:99999;font-size:90%;margin-top:16pt;margin-left:5pt;color:#FFF;text-shadow:0 0 .2em #000;border:.3em solid rgba(255,255,255,0.2);background-color:rgba(25,25,25,0.92);background-color:#000 \\9;border:.3em solid #444 \\9;background-image:-webkit-gradient(linear,0% 0%,0% 100%,from(transparent) ,to(#000) );border-radius:.4em;-moz-border-radius:.4em;-webkit-border-radius:.4em;box-shadow:0 0 .4em #555;-moz-box-shadow:0 0 .4em #555;-webkit-box-shadow:0 0 .4em #555}div.rui-tooltip-container{margin:.4em .6em}");m.type="text/css",w.getElementsByTagName("head")[0].appendChild(m),m.styleSheet?m.styleSheet.cssText=l.nodeValue:m.appendChild(l);return n}(document,RightJS);Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance",function(){this.sandbox=null;this.started=false;this.plugins={};this.localization=null},{__name:"LayerSelector",getName:function(){return this.__name},setSandbox:function(a){this.sandbox=a},getSandbox:function(){return this.sandbox},getLocalization:function(a){if(!this._localization){this._localization=Oskari.getLocalization(this.getName())}if(a){return this._localization[a]}return this._localization},start:function(){var e=this;if(e.started){return}e.started=true;var b=Oskari.$("sandbox");e.sandbox=b;b.register(e);for(p in e.eventHandlers){b.registerForEventByName(e,p)}var d=b.getRequestBuilder("userinterface.AddExtensionRequest")(this);b.request(this,d);e.createUi();var a=this.sandbox.getService("Oskari.mapframework.service.MapLayerService");
b.registerAsStateful(this.mediator.bundleId,this);var c=function(){e.createUi()};var f=function(){alert(e.getLocalization("errors").loadFailed)};a.loadAllLayersAjax(c,f)},init:function(){return null},update:function(){},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},eventHandlers:{AfterMapLayerRemoveEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(a.getMapLayer(),false)},AfterMapLayerAddEvent:function(a){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(a.getMapLayer(),true)},MapLayerEvent:function(d){var b=this.sandbox.getService("Oskari.mapframework.service.MapLayerService");var a=d.getLayerId();if(d.getOperation()==="update"){var c=b.findMapLayer(a);this.plugins["Oskari.userinterface.Flyout"].handleLayerModified(c)}else{if(d.getOperation()==="add"){var c=b.findMapLayer(a);this.plugins["Oskari.userinterface.Flyout"].handleLayerAdded(c);this.plugins["Oskari.userinterface.Tile"].refresh()}else{if(d.getOperation()==="remove"){this.plugins["Oskari.userinterface.Flyout"].handleLayerRemoved(a);this.plugins["Oskari.userinterface.Tile"].refresh()}}}}},stop:function(){var a=this.sandbox();for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}var b=a.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);a.request(this,b);this.sandbox.unregisterStateful(this.mediator.bundleId);this.sandbox.unregister(this);this.started=false},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Flyout",this);this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null;this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){var a=this;this.plugins["Oskari.userinterface.Flyout"].createUi();this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(a){this.plugins["Oskari.userinterface.Flyout"].setContentState(a)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]});Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Flyout",function(a){this.instance=a;this.container=null;this.template=null;this.templateLayer=null;this.templateLayerGroup=null;this.templateGroupingTool=null;this.state=null;this.grouping="getInspireName";this.groupingTools=[]},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Flyout"},setEl:function(c,b,a){this.container=c[0];if(!jQuery(this.container).hasClass("layerselector2")){jQuery(this.container).addClass("layerselector2")}},startPlugin:function(){var a=this;this.template=jQuery('<div class="groupingTabs"><ul></ul></div><br clear="all"/><div class="allLayersTabContent"><div class="filter"><input name="text-filter" type="text" /></div><div class="layerList volatile"></div></div>');this.templateLayer=jQuery('<div class="layer"><input type="checkbox" /> <div class="layer-tools"><div class="layer-icon"></div><div class="layer-info"></div></div><div class="layer-title"></div><div class="layer-keywords"></div></div>');this.templateLayerGroup=jQuery('<div class="layerGroup"><div class="groupHeader"><span class="groupName"></span><span class="layerCount"></span></div></div>');this.groupingTools=[{title:this.instance.getLocalization("filter").inspire,callback:function(){a.doGrouping("getInspireName")}},{title:this.instance.getLocalization("filter").organization,callback:function(){a.doGrouping("getOrganizationName")}}];this.templateGroupingTool=jQuery('<li><a href="JavaScript:void(0);"></a></li>')},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")
},getOptions:function(){},setState:function(a){this.state=a;console.log("Flyout.setState",this,a)},_teardownContentState:function(){jQuery(this.container).find("div.groupingTabs li").removeClass("active");var a=jQuery(this.container).find("div.layerList div.layerGroup");a.removeClass("open");jQuery(this.container).find("input[name=text-filter]").val("")},setContentState:function(e){this._teardownContentState();if(!e){e={}}if(!e.tab){e.tab=this.groupingTools[0].title}var a=jQuery(this.container).find("div.groupingTabs li:contains("+e.tab+")");a.addClass("active");for(var b=0;b<this.groupingTools.length;++b){var g=this.groupingTools[b];if(g.title==e.tab){g.callback()}}var c=e.filter;if(!c){c=""}jQuery(this.container).find("input[name=text-filter]").val(c);this._filterLayers(e.filter);if(!e.filter&&e.groups){var h=jQuery(this.container).find("div.layerList div.layerGroup");for(var b=0;b<e.groups.length;++b){var g=e.groups[b];var d=h.find("span.groupName:contains("+g+")");if(d){var f=d.parent().parent();f.addClass("open");f.find("div.layer").show()}}}},getContentState:function(){var f=jQuery(this.container).find("input[name=text-filter]").val();var b=[];var e=jQuery(this.container).find("div.layerList div.layerGroup.open");for(var c=0;c<e.length;++c){var d=e[c];b.push(jQuery(d).find(".groupName").text())}var a=jQuery(this.container).find("div.groupingTabs li.active").text();return{tab:a,filter:f,groups:b}},createUi:function(){var e=this;var j=e.instance.getSandbox();var f=jQuery(this.container);f.empty();var d=this.template.clone();f.append(d);var c=f.find("div.groupingTabs ul");this._populateGroupingTools(c);var h=f.find("input[name=text-filter]");h.attr("placeholder",this.instance.getLocalization("filter").text);h.keyup(function(){var k=jQuery(this);var i=k.val();e._filterLayers(i)});var g=f.find("div.layerList");this._populateLayerList(g);var a=j.findAllSelectedMapLayers();for(var b=0;b<a.length;++b){this.handleLayerSelectionChanged(a[b],true)}},_filterLayers:function(a){var b=jQuery("div.layerList div.layerGroup");if(a&&a.length>0){b.show();b.find("div.layer").hide();b.find("div.layer div.layer-keywords:contains("+a.toLowerCase()+")").parent().show();b.each(function(c){var d=jQuery(this);var e=d.find("div.layer").filter(":visible");if(e.length==0){d.removeClass("open");d.hide()}else{if(!d.hasClass("open")){d.addClass("open")}e.removeClass("odd");e.filter(":odd").addClass("odd")}})}else{b.show();b.removeClass("open");b.find("div.layer").hide()}},_layerListComparator:function(d,c){var f=d[this.grouping]().toLowerCase();var e=c[this.grouping]().toLowerCase();if(f==e){f=d.getName().toLowerCase();e=c.getName().toLowerCase()}if(f<e){return -1}if(f>e){return 1}return 0},_populateLayerList:function(k){var j=this;var l=this.instance.getSandbox();k.empty();var e=l.getService("Oskari.mapframework.service.MapLayerService");var c=e.getAllLayers();c.sort(function(q,n){return j._layerListComparator(q,n)});var b=null;var m=null;var h=0;var o=true;for(var a=0;a<c.length;++a){var f=c[a];var i=this._createLayerContainer(f);var d=f[this.grouping]();if(m!=d){if(b){b.find("span.layerCount").html(" ("+h+")")}b=this._createLayerGroupContainer(d);k.append(b);m=d;h=0;o=true}if(o){i.addClass("odd")}o=!o;b.append(i);h++}if(b){b.find("span.layerCount").html(" ("+h+")");var g=jQuery(this.container).find("input[name=text-filter]").val();j._filterLayers(g)}},doGrouping:function(a){this.grouping=a;var b=jQuery(this.container).find("div.layerList");this._populateLayerList(b)},_populateGroupingTools:function(e){var d=this;for(var c=0;c<this.groupingTools.length;++c){var b=this.groupingTools[c];var a=this.templateGroupingTool.clone();if(c==0){a.addClass("active")}a.find("a").html(b.title);e.append(a);a.bind("click",function(){var f=jQuery(this);var g=f.index();d.groupingTools[g].callback();f.closest("ul").find("li").removeClass("active");f.addClass("active")})}},_createLayerGroupContainer:function(e){var d=this;var b=d.instance.getSandbox();var a=this.templateLayerGroup.clone();var c=jQuery(a).find("div.groupHeader");c.find("span.groupName").append(e);c.click(function(){var h=jQuery(this).parent();
var f=h.hasClass("open");if(f){h.removeClass("open");h.find("div.layer").hide()}else{h.addClass("open");var g=jQuery(d.container).find("input[name=text-filter]").val();if(g){h.find("div.layer div.layer-keywords:contains("+g.toLowerCase()+")").parent().show()}else{var i=h.find("div.layer");i.removeClass("odd");i.filter(":odd").addClass("odd");i.show()}}});return a},_createLayerContainer:function(e){var g=this;var i=g.instance.getSandbox();var a=i.getRequestBuilder("AddMapLayerRequest");var b=i.getRequestBuilder("RemoveMapLayerRequest");var j=this.templateLayer.clone();var c=jQuery(j).find(".layer-keywords");c.append(e.getName().toLowerCase());c.append(" "+e.getInspireName().toLowerCase());c.append(" "+e.getOrganizationName().toLowerCase());c.hide();var f=this.instance.getLocalization("tooltip");var d=jQuery(j).find("div.layer-tools");var h=d.find("div.layer-icon");if(e.isBaseLayer()){h.addClass("layer-base");h.attr("title",f["type-base"])}else{if(e.isLayerOfType("WMS")){if(e.isGroupLayer()){h.addClass("layer-group")}else{h.addClass("layer-wms")}h.attr("title",f["type-wms"])}else{if(e.isLayerOfType("WMTS")){h.addClass("layer-wmts");h.attr("title",f["type-wms"])}else{if(e.isLayerOfType("WFS")){h.addClass("layer-wfs");h.attr("title",f["type-wfs"])}else{if(e.isLayerOfType("VECTOR")){h.addClass("layer-vector");h.attr("title",f["type-wms"])}}}}}if(e.getDataUrl()){d.find("div.layer-info").addClass("icon-info");d.find("div.layer-info").click(function(){alert("TODO: send ShowOverlayPopupRequest with "+e.getDataUrl())})}jQuery(j).attr("layer_id",e.getId());jQuery(j).find(".layer-title").append(e.getName());jQuery(j).find("input").change(function(){var l=jQuery(this);var k=null;if(l.is(":checked")){k=a(e.getId(),true)}else{k=b(e.getId())}i.request(g.instance.getName(),k)});return j},handleLayerSelectionChanged:function(c,b){var a=jQuery(this.container).find("div[layer_id="+c.getId()+"]");a.find("input").attr("checked",(b==true))},handleLayerModified:function(b){var c=this;var a=jQuery(this.container).find("div[layer_id="+b.getId()+"]");jQuery(a).find(".layer-title").html(b.getName())},handleLayerAdded:function(a){var c=this;var b=jQuery(this.container).find("div.layerList");this._populateLayerList(b)},handleLayerRemoved:function(a){var c=this;var b=jQuery(this.container).find("div.layerList");this._populateLayerList(b)}},{protocol:["Oskari.userinterface.Flyout"]});Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Tile",function(a){this.instance=a;this.container=null;this.template=null;this.badge=Oskari.clazz.create("Oskari.userinterface.component.Badge")},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Tile"},setEl:function(d,c,a){this.container=jQuery(d);var b=this.container.children(".oskari-tile-status");this.badge.insertTo(b)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(a){console.log("Tile.setState",this,a)},refresh:function(){var f=this;var a=f.instance;var e=this.container;var d=this.template;var c=a.getSandbox();var b=c.getService("Oskari.mapframework.service.MapLayerService");var g=b.getAllLayers();this.badge.setContent(""+g.length)}},{protocol:["Oskari.userinterface.Tile"]});