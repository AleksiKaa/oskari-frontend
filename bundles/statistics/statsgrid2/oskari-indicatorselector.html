<link rel="import"
      href="libs/polymer/polymer.html">

<link href="libs/promise-polyfill/promise-polyfill.html" rel="import">
<link href="libs/iron-ajax/iron-ajax.html" rel="import">

<dom-module id="oskari-indicatorselector">

<template>
  <iron-ajax
    auto
    url="{{ajaxUrl}}"
    params='{"action_route": "GetIndicatorsMetadata"}'
    handle-as="json"
    last-response="{{sources}}"
    debounce-duration="300"
    on-response="handleResponse"
    id="indicatorsAjax"></iron-ajax>
    <form class="statsgrid2_indicator_selector">
      <div class="indicator-cont">
        <label>
          <span>{{locale.tab.grid.organization}}</span>
          <select name="datasource" style="width: 300px;" value="{{datasourceId::change}}">
            <template is="dom-repeat" items="[[getDatasources(sources)]]">
              <option value="{{item.val}}">{{item.text}}</option>
            </template>
          </select>
        </label>
        <label>
          <span>{{locale.indicators}}</span>
          <select name="indicator" style="width: 300px;" value="{{indicatorId::change}}">
            <template is="dom-repeat" items="[[getIndicators(sources,datasourceId)]]">
              <option value="{{item.val}}">{{item.text}}</option>
            </template>
          </select>
        </label>
        <!-- The optional selectors will be populated here when the above have been selected. -->
        <div id="indicatorSelectors">
          <template is="dom-repeat" items="[[getSelectors(sources,datasourceId,indicatorId)]]" as="selector">
            <label>
              <span>{{selectorOption.label}}</span>
              <select name="{{selector.name}}" style="width: 300px;" value="{{selector.value::change}}">
                <template is="dom-repeat" items="{{selector.values}}" as="selectorOption">
                  <option value="{{selectorOption.val}}">{{selectorOption.text}}</option>
                </template>
              </select>
            </label>
          </template>
        </div>
        <button type="button" on-click="onAdd">{{locale.addColumn}}</button>
      </div>
      <div class="parameters-cont"></div><div class="buttons-cont"></div>
      <content></content>
    </form>
  </template>

  <script>
    Polymer({
      is: "oskari-indicatorselector",
      properties: {
          "ajaxUrl": String,
          "sources": Object,
          "locale": Object,
          "language": String,
          "datasourceId": String,
          "indicatorId": String,
          "selectors": {
              "type": Array,
              "value": []
          },
          "selectedIndicators": {
              "type": Array,
              "value": []
          }
      },
      getDatasources: function(sources) {
          var me = this;
          return [{text: me.locale.selectDataSource}].concat(Object.keys(sources).map(function(sourceId) {
              return {
                  val: sourceId,
                  text: me.locale.statistic.plugins[sources[sourceId].localizationKey]
              };
          }));
      },
      getIndicators: function(sources, datasourceId) {
          var me = this,
            indicators = sources[datasourceId] && sources[datasourceId].indicators || [];
          return [{text: me.locale.selectIndicator}].concat(Object.keys(indicators).map(function(indicatorId) {
              var indicator = indicators[indicatorId];
              return {
                  val: indicatorId,
                  text: indicator.name[me.language]
              };
          }));
      },
      getSelectors: function(sources, datasourceId, indicatorId) {
          var me = this,
            indicator = sources[datasourceId].indicators[indicatorId],
            selectors = indicator && indicator.selectors || [];
          return selectors.map(function(selector) {
              return {
                  name: me.locale.selectors[selector.id],
                  value: selector.id,
                  values: [{text: me.locale.selectorPlaceholders[selector.id]}].concat(
                          selector.allowedValues.map(function (allowedValue) {
                      return {
                          val: allowedValue,
                          text: allowedValue
                      };
                  }))
              };
          });
      },
      onAdd: function(e) {
          var selectors = this.$.indicatorSelectors;
          var selects = selectors.querySelectorAll("select");
          var values = [];
          // Sorry about this, selects is a NodeList, not an Array, so no .map().
          for (var i = 0; i < selects.length; ++i) {
              var select = selects[i];
              values.push({
                  selectorId: select.name,
                  value: select.value
              });
          }
          this.selectedIndicators.push({
              datasourceId: this.datasourceId,
              indicatorId: this.indicatorId,
              selectors: values
          });
          console.log("Selected indicators: " + JSON.stringify(this.selectedIndicators));
      },
      ready: function() {
          // this.$.indicatorsAjax.generateRequest();
      },
      handleResponse: function(response) {
          console.log("Got response.");
      }
    });
  </script>
</dom-module>
