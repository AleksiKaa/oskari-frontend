/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kes√§aika)) */ 
Oskari.clazz.define("Oskari.mapframework.ui.module.layerselector.SelectedLayersModule",function(a){this._core;this._sandbox;this._publisherWizardStepNumber=a;this._layerPortal=null;this._layerOrder=null;this._items={layerItems:{}};this.loc={};this._scale=null},{getName:function(){return"SelectedLayersModule"},isPublisherWizardStep:function(a){if(this._publisherWizardStepNumber==a){return true}else{return false}},init:function(b){this._sandbox=b;b.printDebug("Initializing selected layers module...");for(p in this.eventHandlers){b.registerForEventByName(this,p)}this.createLocale();var a=this.createUI();this.updateCurrentState();return a},start:function(a){a.printDebug("Starting "+this.getName())},stop:function(a){},createLocale:function(){var a=this._sandbox;this.loc={leftpanel_selected_layers_title:a.getText("leftpanel_selected_layers_title"),leftpanel_style:a.getText("leftpanel_style"),mapservice_select_layer_style:a.getText("mapservice_select_layer_style"),mapservice_basemap_image_tooltip:a.getText("mapservice_basemap_image_tooltip"),mapservice_layer_delete_title:a.getText("mapservice_layer_delete_title"),mapservice_maplayer_image_tooltip:a.getText("mapservice_maplayer_image_tooltip"),mapservice_layer_show_info_title:a.getText("mapservice_layer_show_info_title"),selected_layers_module_published_basemaps_title:a.getText("selected_layers_module_published_basemaps_title"),selected_layers_module_published_maps_title:a.getText("selected_layers_module_published_maps_title"),selected_layers_module_wfs_icon_tooltip:a.getText("selected_layers_module_wfs_icon_tooltip"),selected_layers_module_vector_icon_tooltip:a.getText("selected_layers_module_vector_icon_tooltip"),selected_layers_module_highlight_wms_layer:a.getText("selected_layers_module_highlight_wms_layer"),selected_layers_module_highlight_wfs_layer:a.getText("selected_layers_module_highlight_wfs_layer"),selected_layers_module_highlight_wfs_layer:a.getText("selected_layers_module_highlight_wfs_layer")}},updateCurrentState:function(){var b=this._sandbox;var e=this;var f=b.findAllSelectedMapLayers();for(var d=0;d<f.length;d++){var c=f[d];var a=c.getId();b.printDebug("preselecting "+a);e.addMapLayerToSelection(a,c,true)}},createUI:function(){var b=this._sandbox;var f=this;var d=f.loc.leftpanel_selected_layers_title;if(this.isPublisherWizardStep(1)){d=f.loc.selected_layers_module_published_basemaps_title}else{if(this.isPublisherWizardStep(2)){d=f.loc.selected_layers_module_published_maps_title}}var e=Ext.create("Ext.app.PortalColumn",{id:"selectedLayersTab",autoWidth:true,autoScroll:false});this._items.selectedLayersTab=e;var a=Ext.create("Ext.app.PortalPanel",{id:"groupPanel",title:d,autoScroll:true,items:[e]});this._layerPortal=a;a.on("drop",function(h){var g=h.panel._layerId;f.updateLayerOrder(g)});a.on("beforedrop",function(){f.buildLayerOrder()});a.on("validatedrop",function(g){g.status=g.panel._layerId?true:false});var c=Ext.create("Ext.tab.Panel",{id:"selectedLayersTabPanel",layout:"fit",anchor:"100%, 50%",frame:false,border:false,autoScroll:false,items:[a]});this._items.selectedLayerPanel=c;return c},buildLayerOrder:function(){var b={};var c=this;var a=c._layerPortal;var d=Ext.ComponentQuery.query("portlet",a);Ext.Array.each(d,function(h,g,e){var f=h._layerId;b[f]=g});this._layerOrder=b},updateLayerOrder:function(d){var g=this;var f=this._layerPortal;var k=this._layerOrder;var b=Ext.ComponentQuery.query("portlet",f);var h={};Ext.Array.each(b,function(o,m,l){var n=o._layerId;h[n]=m});for(p in h){var a=p;if(d!=a){continue}var e=h[a];var j=k[a];if(j==e){continue}var i=b.length-e-1;var c=g._sandbox.getRequestBuilder("RearrangeSelectedMapLayerRequest")(d,i);g._sandbox.request(g.getName(),c);break}},getNewSelectedLayersInsidePanel:function(b,h,d,a,e){var g=this;var c=null;var i=new Array();var f=Ext.create("Ext.Panel",{id:"leftpanel-selected-layers-controls_basic_"+a,layout:{type:"hbox",align:"stretch",pack:"start"},baseCls:"",border:true,defaults:{padding:"5 5 0 5",baseCls:"",border:true},items:[{items:b},{items:h,flex:1},{items:e}]});i.push(f);if(d!=null){var j=Ext.create("Ext.Panel",{id:"leftpanel-selected-layers-controls_style_"+a,layout:{type:"hbox",align:"stretch",pack:"start"},baseCls:"",border:true,width:"100%",defaults:{padding:"0 5 0 5",baseCls:"",border:true},items:[{html:g.loc.leftpanel_style},{items:d,flex:1}]});
i.push(j)}c=Ext.create("Ext.Panel",{id:"leftpanel-selected-layers-controls_"+a,layout:{type:"vbox",align:"stretch",pack:"start"},cls:"leftpanel-selected-layers-controls",border:false,height:32*i.length,defaults:{padding:"0 5 0 5",flex:1},items:i});return c},getOpacityLabel:function(b,c){var a=Ext.create("Ext.form.Label",{text:b+"%"});return a},getOpacitySlider:function(c,g,d,a){var f=false;if(this.isPublisherWizardStep(1)||this.isPublisherWizardStep(2)){f=true}var b=this;var e=null;if(f==false){e={change:function(j,i){var h=b._sandbox;h.request("SelectedLayersModule",h.getRequestBuilder("ChangeMapLayerOpacityRequest")(g,this.getValue()));a.setText(this.getValue()+"%")}}}else{e={change:function(i,h){a.setText(this.getValue()+"%")},changecomplete:function(j,i){var h=b._sandbox;h.request("SelectedLayersModule",h.getRequestBuilder("ChangeMapLayerOpacityRequest")(g,this.getValue()))}}}return Ext.create("Ext.slider.Single",{width:100,minValue:0,maxValue:100,animate:true,value:c,listeners:e})},getNewSelectedLayersPanel:function(c,i){var a=c.getName();var b=c.getId();var h=c.isBaseLayer();var f=null;var e=this;var d=[];var g=null;if(h){g="layer_type_stack"}else{if(c.isGroupLayer&&c.isGroupLayer()){g="layer_type_group"}else{if(c.hasLegendImage&&c.hasLegendImage()){d.push({baseCls:"custom-tool",type:"gear",tooltip:e.loc.mapservice_layer_show_info_title,handler:function(){e._sandbox.requestByName("SelectedLayersModule","ShowMapLayerInfoRequest",[b])}})}if(c.isLayerOfType("WMS")){g="layer_type_wms"}else{if(c.isLayerOfType("WFS")){g="layer_type_wfs"}else{if(c.isLayerOfType("VECTOR")){g="layer_type_vector"}else{g="layer_type_wms"}}}}}if(c.getDataUrl()){d.push({type:"search",baseCls:"custom-tool",qtip:e.loc.mapservice_layer_show_info_title,handler:function(){e._sandbox.requestByName("SelectedLayersModule","ShowOverlayPopupRequest",[c.getDataUrl()])}})}d.push({type:"close",baseCls:"custom-tool",tooltip:e.loc.mapservice_layer_delete_title,handler:function(){e._sandbox.requestByName("SelectedLayersModule","RemoveMapLayerRequest",[b])}});f=Ext.create("Ext.app.Portlet",{_layerId:b,collapsible:false,id:"selectedLayer-"+b,iconCls:g,scroll:false,tools:d,title:e._layerNameRenderer(a),layout:"fit",items:i,frame:false,border:false,closable:false});return f},_layerNameRenderer:function(e){var c=this;if(!c._items.selectedLayerPanel.getVisibilityEl()){return e}var f=this._stringWidth(e);var d=e;var g=false;var b=110;var a=c._items.selectedLayerPanel.getWidth()-b;while(f>110&&f>a){g=true;d=d.substring(0,d.length-3);f=this._stringWidth(d)}if(g){d=d+"..."}return'<span data-qtip="'+e+'" style="width: 40px;overflow: hidden;">'+d+"</span>"},_stringWidth:function(d){var b="12px arial",c=jQuery("<div>"+d+"</div>").css({position:"absolute","float":"left",visibility:"hidden",font:b}).appendTo(jQuery("body")),a=c.width();c.remove();return a},getStyleCombo:function(b,e,f){var a=this._sandbox;var d=this;var c=Ext.create("Ext.form.ComboBox",{id:"layer-style_"+f,ctCls:"mapservice-combostyle",store:b,mode:"local",triggerAction:"all",emptyText:d.loc.mapservice_select_layer_style,hideLabel:true,autoSelect:true,editable:false,width:"100%",listeners:{select:function(h,i){var k=i[0].index;var g=e[k];var j=f;a.request("SelectedLayersModule",a.getRequestBuilder("ChangeMapLayerStyleRequest")(j,g))}}});return c},afterMapLayerAddEvent:function(c){var b=c.getMapLayer();var a=b.getId();var d=c.getKeepLayersOrder();this.addMapLayerToSelection(a,b,d);this.checkLayerScales()},addMapLayerToSelection:function(h,w,c){var v=this;var o={};this._items.layerItems[h]=o;var q=null;var g=null;var n=null;if(w.isBaseLayer()){g=this.getOpacityLabel(w.getOpacity(),h);q=this.getOpacitySlider(w.getOpacity(),h,true,g)}else{g=this.getOpacityLabel(w.getOpacity(),h);q=this.getOpacitySlider(w.getOpacity(),h,false,g)}o.slider=q;o.label=g;var k=false;if(this.isPublisherWizardStep(1)||this.isPublisherWizardStep(2)){k=true}var t=null;if(!w.isBaseLayer()&&w.getStyles&&!k){var e=w.getStyles();var j=new Array();var u=new Array();for(var s=0;s<w.getStyles().length;s++){j.push(w.getStyles()[s].getTitle());u.push(w.getStyles()[s].getName())
}if(u.length>1&&j.length>1){t=this.getStyleCombo(j,u,w.getId());if(w.getCurrentStyle()!=null&&w.getCurrentStyle()!=""&&w.getCurrentStyle().getName()!=""){var d=u.indexOf(w.getCurrentStyle().getName());var f=j[d];t.setValue(f)}else{var d=0;var f=j[d];t.setValue(f)}}}o.styleCombo=t;var r=false;if(w.isFeatureInfoEnabled){r=w.isFeatureInfoEnabled()}if(r&&!this.isPublisherWizardStep(1)){n=this.createHighlighButtonAndAttachHighlightHandlerForLayer(w)}o.buttonGetFeatures=n;var m=this.getNewSelectedLayersInsidePanel(q,g,t,w.getId(),n);o.chkPanel=m;var l=this.getNewSelectedLayersPanel(w,m);o.panel=l;var b=v._items.selectedLayersTab;if(b){if(w.isBaseLayer()){var a=b.items.length+1;if(c){b.insert(0,l)}else{b.insert(a,l)}}else{b.insert(0,l)}this._layerPortal.doLayout()}},createHighlighButtonAndAttachHighlightHandlerForLayer:function(c){var e=this;var b=e._sandbox;var d=c.getId();var a=null;var f=null;if(c.isLayerOfType("WMS")){a="wms-maplayer";f=e.loc.selected_layers_module_highlight_wms_layer}else{if(c.isLayerOfType("WFS")){a="wfs-maplayer";f=e.loc.selected_layers_module_highlight_wfs_layer}else{if(c.isLayerOfType("VECTOR")){a="wfs-maplayer";f=e.loc.selected_layers_module_highlight_wfs_layer}else{a="wms-maplayer";f=""}}}return Ext.create("Ext.Button",{iconCls:a,cls:"x-btn-icon",width:35,height:20,scale:"large",enableToggle:true,toggleGroup:"layerHighlightButtonGroup",tooltip:f,handler:function(){var g=b.isMapLayerHighLighted(d);if(g){b.request("SelectedLayersModule",b.getRequestBuilder("DimMapLayerRequest")(d))}else{b.request("SelectedLayersModule",b.getRequestBuilder("HighlightMapLayerRequest")(d))}}})},afterMapLayerRemoveEvent:function(b){var a=b.getMapLayer().getId();this.removeMapLayerFromSelection(a)},removeMapLayerFromSelection:function(a){var c=this._items.layerItems[a];var b=c.panel;c.panel=null;c.slider=null;c.label=null;c.buttonGetFeatures=null;b.destroy();this._items.layerItems[a]=null;this._layerPortal.doLayout()},checkLayerScales:function(){var b=this._scale=this._sandbox.getMap().getScale();var j=this._sandbox;var h=this._items.layerItems;var d=j.findAllSelectedMapLayers();for(var e=0;e<d.length;e++){var f=d[e];var c=f.getId();if(f.isBaseLayer()){continue}if(b>f.getMaxScale()&&b<f.getMinScale()){var g=h[c];var a=g.panel;if(a!=null){a.removeCls("layertree-scale-not-in-range")}}else{var g=h[c];var a=g.panel;if(a!=null){a.addCls("layertree-scale-not-in-range")}}}},afterChangeMapLayerOpacityEvent:function(e){var a=e.getMapLayer();var c=this._items.layerItems;var b=c[a.getId()];var d=b.slider;d.setValue(a.getOpacity())},afterChangeMapLayerStyleEvent:function(f){var a=f.getMapLayer();var e=this._items.layerItems;var c=e[a.getId()];var b=c.styleCombo;var d=f.getMapLayer().getCurrentStyle();if(b&&d){b.setValue(d)}},handleAfterHighlightMapLayerEvent:function(f){var c=f.getMapLayer();var a=this._sandbox;var e=this._items.layerItems;var d=e[c.getId()];var b=d.panel;b.addCls("higlighted");d.chkPanel.addCls("higlighted-panel-content")},handleAfterDimMapLayerEvent:function(f){var c=f.getMapLayer();var a=this._sandbox;var e=this._items.layerItems;var d=e[c.getId()];var b=d.panel;b.removeCls("higlighted");d.chkPanel.removeCls("higlighted-panel-content");if(d.buttonGetFeatures){d.buttonGetFeatures.toggle(false)}},handleMapLayerChange:function(h){var g=this;if(h.getOperation()==="update"){var b=h.getLayerId();var f=this._items.layerItems;var d=f[b];if(!d){return}var a=this._sandbox.getService("Oskari.mapframework.service.MapLayerService");var e=a.findMapLayer(b);var c=e.getName();d.panel.setTitle(this._layerNameRenderer(c))}},eventHandlers:{AfterMapLayerAddEvent:function(a){this.afterMapLayerAddEvent(a)},AfterMapLayerRemoveEvent:function(a){this.afterMapLayerRemoveEvent(a)},AfterMapMoveEvent:function(a){this.checkLayerScales()},AfterChangeMapLayerOpacityEvent:function(a){if(this._sandbox.getObjectCreator(a)!=this.getName()){this.afterChangeMapLayerOpacityEvent(a)}},AfterChangeMapLayerStyleEvent:function(a){if(this._sandbox.getObjectCreator(a)!=this.getName()){this.afterChangeMapLayerStyleEvent(a)}},AfterHighlightMapLayerEvent:function(a){this.handleAfterHighlightMapLayerEvent(a)
},AfterDimMapLayerEvent:function(a){this.handleAfterDimMapLayerEvent(a)},ToolSelectedEvent:function(b){var a=this._sandbox;var c=this._sandbox.findAllHighlightedLayers();if(c&&c.length>0){a.request("SelectedLayersModule",a.getRequestBuilder("DimMapLayerRequest")(c[0].getId()))}},MapLayerEvent:function(a){this.handleMapLayerChange(a)}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.bundle.DefaultLayerSelectionBundleInstance",function(a){this.name="layerselection";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{createPanel:function(){var b=this;var a=Ext.create("Ext.Panel",{region:"center",layout:"fit",height:512,border:false,items:[]});return a},start:function(){if(this.mediator.getState()=="started"){return}var b=this;b.facade=Oskari.$("UI.facade");b.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.layerselector.SelectedLayersModule");var a=b.createPanel();var c=b.facade.appendExtensionModule(b.impl,b.name,{},b,"NW",{fi:{title:"Valitut karttatasot"},sv:{title:"?"},en:{title:"Map Layers"}},a);b.def=c;a.add(c.initialisedComponent);b.impl.start(b.facade.getSandbox());b.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this);this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.DefaultLayerSelectionBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});