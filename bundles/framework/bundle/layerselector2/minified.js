Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance",function(){this.sandbox=null,this.started=!1,this.plugins={},this.localization=null},{__name:"LayerSelector",getName:function(){return this.__name},setSandbox:function(e){this.sandbox=e},getSandbox:function(){return this.sandbox},getLocalization:function(e){return this._localization||(this._localization=Oskari.getLocalization(this.getName())),e?this._localization[e]:this._localization},start:function(){var e=this;if(e.started)return;e.started=!0;var t=this.conf,n=(t?t.sandbox:null)||"sandbox",r=Oskari.getSandbox(n);e.sandbox=r,r.register(e);for(p in e.eventHandlers)r.registerForEventByName(e,p);var i=r.getRequestBuilder("userinterface.AddExtensionRequest")(this);r.request(this,i),e.createUi();var s=this.sandbox.getService("Oskari.mapframework.service.MapLayerService");r.registerAsStateful(this.mediator.bundleId,this);var o=function(){},u=function(){alert(e.getLocalization("errors").loadFailed)};s.loadAllLayersAjax(o,u)},init:function(){return null},update:function(){},onEvent:function(e){var t=this.eventHandlers[e.getName()];if(!t)return;return t.apply(this,[e])},eventHandlers:{AfterMapLayerRemoveEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!1)},AfterMapLayerAddEvent:function(e){this.plugins["Oskari.userinterface.Flyout"].handleLayerSelectionChanged(e.getMapLayer(),!0)},MapLayerEvent:function(e){var t=this.sandbox.getService("Oskari.mapframework.service.MapLayerService"),n=e.getLayerId();if(e.getOperation()==="update"){var r=t.findMapLayer(n);this.plugins["Oskari.userinterface.Flyout"].handleLayerModified(r)}else if(e.getOperation()==="add"){var r=t.findMapLayer(n);this.plugins["Oskari.userinterface.Flyout"].handleLayerAdded(r),this.plugins["Oskari.userinterface.Tile"].refresh()}else if(e.getOperation()==="remove")this.plugins["Oskari.userinterface.Flyout"].handleLayerRemoved(n),this.plugins["Oskari.userinterface.Tile"].refresh();else if(e.getOperation()==="sticky"){var r=t.findMapLayer(n);this.plugins["Oskari.userinterface.Flyout"].handleLayerSticky(r),this.plugins["Oskari.userinterface.Tile"].refresh()}}},stop:function(){var e=this.sandbox();for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);var t=e.getRequestBuilder("userinterface.RemoveExtensionRequest")(this);e.request(this,t),this.sandbox.unregisterStateful(this.mediator.bundleId),this.sandbox.unregister(this),this.started=!1},startExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Flyout",this),this.plugins["Oskari.userinterface.Tile"]=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.Tile",this)},stopExtension:function(){this.plugins["Oskari.userinterface.Flyout"]=null,this.plugins["Oskari.userinterface.Tile"]=null},getPlugins:function(){return this.plugins},getTitle:function(){return this.getLocalization("title")},getDescription:function(){return this.getLocalization("desc")},createUi:function(){var e=this;this.plugins["Oskari.userinterface.Flyout"].createUi(),this.plugins["Oskari.userinterface.Tile"].refresh()},setState:function(e){this.plugins["Oskari.userinterface.Flyout"].setContentState(e)},getState:function(){return this.plugins["Oskari.userinterface.Flyout"].getContentState()}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.userinterface.Extension"]}),define("bundles/framework/bundle/layerselector2/instance",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Flyout",function(e){this.instance=e,this.container=null,this.template=null,this.state=null,this.layerTabs=[]},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Flyout"},setEl:function(e,t,n){this.container=e[0],jQuery(this.container).hasClass("layerselector2")||jQuery(this.container).addClass("layerselector2")},startPlugin:function(){var e=this;this.template=jQuery('<div class="allLayersTabContent"></div>');var t=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.LayersTab",this.instance,this.instance.getLocalization("filter").inspire);t.groupingMethod="getInspireName";var n=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.LayersTab",this.instance,this.instance.getLocalization("filter").organization);n.groupingMethod="getOrganizationName",this.layerTabs.push(t),this.layerTabs.push(n);if(this.instance.conf&&this.instance.conf.showPublishedTab==1){var r=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.PublishedLayersTab",this.instance,this.instance.getLocalization("filter").published);this.layerTabs.push(r)}},stopPlugin:function(){},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){this.state=e},setContentState:function(e){e||(e={});for(var t=0;t<this.layerTabs.length;++t){var n=this.layerTabs[t];n.getTitle()==e.tab&&(this.tabContainer.select(n.getTabPanel()),n.setState(e))}},getContentState:function(){var e={};for(var t=0;t<this.layerTabs.length;++t){var n=this.layerTabs[t];if(this.tabContainer.isSelected(n.getTabPanel())){e=n.getState();break}}return e},createUi:function(){var e=this,t=e.instance.getSandbox(),n=jQuery(this.container);n.empty(),this.tabContainer=Oskari.clazz.create("Oskari.userinterface.component.TabContainer"),this.tabContainer.insertTo(n);for(var r=0;r<this.layerTabs.length;++r){var i=this.layerTabs[r];this.tabContainer.addPanel(i.getTabPanel())}this.populateLayers()},populateLayers:function(){var e=this.instance.getSandbox(),t=e.getService("Oskari.mapframework.service.MapLayerService"),n=t.getAllLayers();for(var r=0;r<this.layerTabs.length;++r){var i=this.layerTabs[r];if(i.groupingMethod){var s=n.slice(0),o=this._getLayerGroups(s,i.groupingMethod);i.showLayerGroups(o)}}},_getLayerGroups:function(e,t){var n=this,r=this.instance.getSandbox(),i=[];e.sort(function(e,r){return n._layerListComparator(e,r,t)});var s=null;for(var o=0;o<e.length;++o){var u=e[o];if(u.getMetaType&&u.getMetaType()=="published")continue;var a=u[t]();if(!s||s.getTitle()!=a)s=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",a),i.push(s);s.addLayer(u)}return i},_layerListComparator:function(e,t,n){var r=e[n]().toLowerCase(),i=t[n]().toLowerCase();return r==i&&e.getName()&&t.getName()&&(r=e.getName().toLowerCase(),i=t.getName().toLowerCase()),r<i?-1:r>i?1:0},handleLayerSelectionChanged:function(e,t){for(var n=0;n<this.layerTabs.length;++n){var r=this.layerTabs[n];r.setLayerSelected(e.getId(),t)}},handleLayerModified:function(e){var t=this;for(var n=0;n<this.layerTabs.length;++n){var r=this.layerTabs[n];r.updateLayerContent(e.getId(),e)}},handleLayerSticky:function(e){var t=this;for(var n=0;n<this.layerTabs.length;++n){var r=this.layerTabs[n];r.updateLayerContent(e.getId(),e)}},handleLayerAdded:function(e){var t=this;this.populateLayers()},handleLayerRemoved:function(e){var t=this;this.populateLayers()}},{protocol:["Oskari.userinterface.Flyout"]}),define("bundles/framework/bundle/layerselector2/Flyout",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.Tile",function(e){this.instance=e,this.container=null,this.template=null},{getName:function(){return"Oskari.mapframework.bundle.layerselector2.Tile"},setEl:function(e,t,n){this.container=jQuery(e)},startPlugin:function(){this.refresh()},stopPlugin:function(){this.container.empty()},getTitle:function(){return this.instance.getLocalization("title")},getDescription:function(){return this.instance.getLocalization("desc")},getOptions:function(){},setState:function(e){},refresh:function(){}},{protocol:["Oskari.userinterface.Tile"]}),define("bundles/framework/bundle/layerselector2/Tile",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",function(e){this.name=e,this.layers=[],this.searchIndex={}},{setTitle:function(e){this.name=e},getTitle:function(){return this.name},addLayer:function(e){this.layers.push(e),this.searchIndex[e.getId()]=this._getSearchIndex(e)},getLayers:function(){return this.layers},_getSearchIndex:function(e){var t=e.getName()+" "+e.getInspireName()+" "+e.getOrganizationName();return t.toLowerCase()},matchesKeyword:function(e,t){var n=this.searchIndex[e];return n.indexOf(t.toLowerCase())!=-1}}),define("bundles/framework/bundle/layerselector2/model/LayerGroup",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.Layer",function(e,t,n){this.sandbox=t,this.localization=n,this.layer=e,this.backendStatus="OK",this.ui=this._createLayerContainer(e)},{__template:'<div class="layer"><input type="checkbox" /> <div class="layer-tools"><div class="layer-backendstatus-icon backendstatus-ok"></div><div class="layer-icon"></div><div class="layer-info"></div></div><div class="layer-title"></div></div>',getId:function(){return this.layer.getId()},setVisible:function(e){e==1?this.ui.show():this.ui.hide()},setSelected:function(e){this.ui.find("input").attr("checked",e==1)},updateLayerContent:function(e){var t=e.getName();this.ui.find(".layer-title").html(t),e.isSticky()&&this.ui.find("input").attr("disabled","disabled");var n=this.backendStatus,r=e.getBackendStatus(),i=this.localization.backendStatus,s=n?i[n]:null,o=r?i[r]:null,u=s?s.iconClass:null,a=o?o.iconClass:null,f=s?s.tooltip:null,l=o?o.tooltip:null,c=this.ui.find(".layer-backendstatus-icon");u&&u!=a&&c.removeClass(u),a&&u!=a&&c.addClass(a),l?f!=l&&c.attr("title",l):f&&c.attr("title",""),this.backendStatus=r},getContainer:function(){return this.ui},_createLayerContainer:function(e){var t=this,n=this.sandbox,r=jQuery(this.__template),i=this.localization.tooltip,s=jQuery(r).find("div.layer-tools"),o=s.find("div.layer-icon");o.addClass(e.getIconClassname()),e.isBaseLayer()?o.attr("title",i["type-base"]):e.isLayerOfType("WMS")?o.attr("title",i["type-wms"]):e.isLayerOfType("WMTS")?o.attr("title",i["type-wms"]):e.isLayerOfType("WFS")?o.attr("title",i["type-wfs"]):e.isLayerOfType("VECTOR")&&o.attr("title",i["type-wms"]),e.getMetadataIdentifier()&&(s.find("div.layer-info").addClass("icon-info"),s.find("div.layer-info").click(function(){var t="catalogue.ShowMetadataRequest",r=e.getMetadataIdentifier(),i=[],s={};s[r]=!0;var o=e.getSubLayers();if(o&&o.length>0)for(var u=0;u<o.length;u++){var a=o[u].getMetadataIdentifier();a&&a!=""&&!s[a]&&(s[a]=!0,i.push({uuid:a}))}n.postRequestByName(t,[{uuid:r},i])})),jQuery(r).attr("layer_id",e.getId()),jQuery(r).find(".layer-title").append(e.getName()),jQuery(r).find("input").change(function(){var t=jQuery(this),r=null;t.is(":checked")?n.postRequestByName("AddMapLayerRequest",[e.getId(),!1,e.isBaseLayer()]):n.postRequestByName("RemoveMapLayerRequest",[e.getId()])});var u=s.find(".layer-backendstatus-icon");return u.click(function(){var t=e.getId();n.postRequestByName("ShowMapLayerInfoRequest",[t])}),r}},{protocol:["Oskari.mapframework.module.Module"]}),define("bundles/framework/bundle/layerselector2/view/Layer",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.LayersTab",function(e,t){this.instance=e,this.title=t,this.layerGroups=[],this.layerContainers={},this.templates={shortDescription:'<div class="field-description"></div>',description:'<div><h4 class="indicator-msg-popup"></h4><p></p></div>',relatedKeywords:'<div class="related-keywords"></div>',keywordsTitle:'<div class="keywords-title"></div>',keywordContainer:'<div class="keyword-cont"><div class="keyword"></div></div>',keywordType:'<div class="type"></div>'},this._createUI()},{getTitle:function(){return this.title},getTabPanel:function(){return this.tabPanel},getState:function(){var e={tab:this.getTitle(),filter:this.filterField.getValue(),groups:[]};return e},setState:function(e){if(!e)return;e.filter||(this.filterField.setValue(e.filter),this.filterLayers(e.filter)),e.groups&&e.groups.length>0},_createUI:function(){this._locale=this.instance._localization,this.tabPanel=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),this.tabPanel.setTitle(this.title);var e=this.getFilterField().getField();e.append(jQuery(this.templates.shortDescription).text(this._locale.filter.shortDescription)),this._createInfoIcon(e),this.tabPanel.getContainer().append(e),this.accordion=Oskari.clazz.create("Oskari.userinterface.component.Accordion"),this.accordion.insertTo(this.tabPanel.getContainer())},_createInfoIcon:function(e){var t=this,n=jQuery('<div class="icon-info"></div>'),r=e.find(".field-description");r.find(".icon-info").remove(),r.append(n),n.click(function(e){var n=Oskari.getLang(),r=jQuery(t.templates.description);r.find("p").text(t._locale.filter.description);var i=Oskari.clazz.create("Oskari.userinterface.component.Popup"),s=Oskari.clazz.create("Oskari.userinterface.component.Button");s.setTitle(t._locale.buttons.ok),s.addClass("primary"),s.setHandler(function(){i.close(!0)}),i.show(t._locale.filter.text,r,[s])})},getFilterField:function(){if(this.filterField)return this.filterField;var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.FormInput");return t.setPlaceholder(this.instance.getLocalization("filter").text),t.addClearButton(),t.bindChange(function(n){n.stopPropagation(),n.which&&n.which!=38&&n.which!=40&&n.which!=13&&(e.filterLayers(t.getValue()),e.clearRelatedKeywordsPopup(t.getValue(),jQuery(n.currentTarget).parents(".oskarifield")))},!0),t.bindEnterKey(function(n){e._relatedKeywordsPopup(t.getValue(),n,e)}),t.bindOnBlur(function(){this.relatedKeywords=null;var e=jQuery(t.getField()[0]);e.find("input").off("keydown")}),this.filterField=t,t},showLayerGroups:function(e){var t=this;this.accordion.removeAllPanels(),this.layerContainers=undefined,this.layerContainers={},this.layerGroups=e;for(var n=0;n<e.length;++n){var r=e[n],i=r.getLayers(),s=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");s.setTitle(r.getTitle()+" ("+i.length+")"),r.layerListPanel=s;var o=s.getContainer();for(var u=0;u<i.length;++u){var a=i[u],f=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.Layer",a,this.instance.sandbox,this.instance.getLocalization()),l=f.getContainer();o.append(l),this.layerContainers[a.getId()]=f}this.accordion.addPanel(s)}var c=this.instance.sandbox.findAllSelectedMapLayers();for(var n=0;n<c.length;++n)this.setLayerSelected(c[n].getId(),!0);this.filterLayers(this.filterField.getValue())},filterLayers:function(e){this.accordion.showPanels();if(!e||e.length==0){this._showAllLayers();return}var t=0;for(var n=0;n<this.layerGroups.length;++n){var r=this.layerGroups[n],i=r.getLayers(),s=0;for(var o=0;o<i.length;++o){var u=i[o],a=u.getId(),f=this.layerContainers[a],l=r.matchesKeyword(a,e);f.setVisible(l),l&&(s++,s%2==1?f.getContainer().addClass("odd"):f.getContainer().removeClass("odd"),r.layerListPanel.open())}r.layerListPanel.setVisible(s>0),r.layerListPanel.isVisible()&&t++,r.layerListPanel.setTitle(r.getTitle()+" ("+s+"/"+i.length+")")}if(t==0){var c=this.instance.getLocalization("errors");this.accordion.showMessage(c.noResults)}else this.accordion.removeMessage()},clearRelatedKeywordsPopup:function(e,t){if(this.sentKeyword&&this.sentKeyword!==e){var n=t.find(".related-keywords");t.find("input").off("keydown"),n.remove()}},_relatedKeywordsPopup:function(e,t,n){t.preventDefault();var r=jQuery(t.currentTarget).parents(".oskarifield");if(!e||e.length==0){this._showAllLayers();return}if(e.length<4){r.find(".related-keywords").remove();var i=r.find("input"),s=i.position().top+i.outerHeight(),o=i.position().left,u=n.instance.getLocalization("errors"),a=jQuery(n.templates.relatedKeywords);a.css({top:s,left:o,padding:"3px 5px"}),a.text(u.minChars),r.append(a);return}n.sentKeyword=e;if(n._selectedKeywordFromPopup(t,n))return;var f=this.instance.sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:f+"action_route=SearchKeywords&keyword="+e+"&lang="+Oskari.getLang(),success:function(e){n.relatedKeywords=e,n._showRelatedKeywords(e,r)},error:function(e,t){var r=n.instance.getLocalization("errors");n.accordion.showMessage(r.generic)}})},_selectedKeywordFromPopup:function(e,t){var n=jQuery(e.currentTarget).parents(".oskarifield"),r=n.find(".keyword-cont"),i=!1;for(var s=0;s<r.length;s++){var o=jQuery(r[s]);if(o.hasClass("focus")){t._filterRelatedLayers(o,t),i=o;break}}return i},_showRelatedKeywords:function(e,t){var n=this;this.clearRelatedKeywordsPopup(null,t);var r=t.find("input"),i=r.position().top+r.outerHeight(),s=r.position().left,o=jQuery(n.templates.relatedKeywords);o.css({top:i,left:s});if(e.length==1&&!e[0].type&&e[0].layers.length==0)o.append(jQuery(n.templates.keywordsTitle).text(n._locale.errors.noResultsForKeyword));else{o.append(jQuery(n.templates.keywordsTitle).text("Avainsanat:"));for(var u=0;u<e.length;u++){var a=e[u];if(a.layers.length>0){var f=jQuery(n.templates.keywordContainer);f.addClass(u%2!=0?" odd":"").attr("data-id",a.id).find(".keyword").text(a.keyword+" ("+a.layers.length+")");if(a.type){var l=jQuery(n.templates.keywordType);l.attr("title",n._locale.types[a.type]),f.append(l.text(a.type.toUpperCase()))}o.append(f)}}}t.append(o),o.find(".keyword-cont").on("click",function(e){t.off("keydown"),n._filterRelatedLayers(jQuery(e.currentTarget),n)}),n.filterField.bindDownKey(function(e){e.stopPropagation();var t=o.find(".keyword-cont"),n=!1;for(var r=0;r<t.length;r++){var i=jQuery(t[r]);if(i.hasClass("focus")){var s=(r+1)%(t.length+1);if(s>t.length)t.removeClass("focus");else{var u=jQuery(t[s]);t.removeClass("focus"),u.addClass("focus"),n=!0}break}}n||jQuery(t[0]).addClass("focus")}),n.filterField.bindUpKey(function(e){e.stopPropagation();var t=o.find(".keyword-cont"),n=!1;for(var r=0;r<t.length;r++){var i=jQuery(t[r]);if(i.hasClass("focus")){var s=(r-1)%(t.length+1);if(s>t.length)t.removeClass("focus");else{var u=jQuery(t[s]);t.removeClass("focus"),u.addClass("focus"),n=!0}break}}n||jQuery(t[t.length-1]).addClass("focus")})},_filterRelatedLayers:function(e,t){var n=e.attr("data-id"),r=t.relatedKeywords;for(var i=0;i<r.length;i++)if(r[i].id==n){r=r[i];break}e.parents(".oskarifield").find("input").val(r.keyword),e.parent().find(".keyword-cont").off();if(r.layers.length==0){var s=t.instance.getLocalization("errors");t.accordion.showMessage(s.noResults)}else t.accordion.removeMessage();var o=0;for(var i=0;i<this.layerGroups.length;++i){var u=this.layerGroups[i],a=u.getLayers(),f=0;for(var l=0;l<a.length;++l){var c=a[l],h=c.getId(),p=this.layerContainers[h],d=!1;for(var v=0;v<r.layers.length;v++)h==r.layers[v]&&(d=!0);p.setVisible(d),d&&(f++,f%2==1?p.getContainer().addClass("odd"):p.getContainer().removeClass("odd"),u.layerListPanel.open())}u.layerListPanel.setVisible(f>0),u.layerListPanel.isVisible()&&o++,u.layerListPanel.setTitle(u.getTitle()+" ("+f+"/"+a.length+")")}e.parents(".oskarifield").find(".related-keywords").remove()},_showAllLayers:function(){for(var e=0;e<this.layerGroups.length;++e){var t=this.layerGroups[e],n=t.getLayers();for(var r=0;r<n.length;++r){var i=n[r],s=i.getId(),o=this.layerContainers[s];o.setVisible(!0),r%2==1?o.getContainer().addClass("odd"):o.getContainer().removeClass("odd")}t.layerListPanel.setVisible(!0),t.layerListPanel.close(),t.layerListPanel.setTitle(t.getTitle()+" ("+n.length+")")}},setLayerSelected:function(e,t){var n=this.layerContainers[e];n&&n.setSelected(t)},updateLayerContent:function(e,t){var n=this.layerContainers[e];n&&n.updateLayerContent(t)}}),define("bundles/framework/bundle/layerselector2/view/LayersTab",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.layerselector2.view.PublishedLayersTab",function(e,t){this.instance=e,this.title=t,this.layerGroups=[],this.layerContainers={},this._createUI()},{getTitle:function(){return this.title},getTabPanel:function(){return this.tabPanel},getState:function(){var e={tab:this.getTitle(),filter:this.filterField.getValue(),groups:[]};return e},setState:function(e){if(!e)return;e.filter||(this.filterField.setValue(e.filter),this.filterLayers(e.filter)),e.groups&&e.groups.length>0},_createUI:function(){var e=this;this.tabPanel=Oskari.clazz.create("Oskari.userinterface.component.TabPanel"),this.tabPanel.setTitle(this.title),this.tabPanel.setSelectionHandler(function(t){t?e.tabSelected():e.tabUnselected()}),this.tabPanel.getContainer().append(this.getFilterField().getField()),this.accordion=Oskari.clazz.create("Oskari.userinterface.component.Accordion"),this.accordion.insertTo(this.tabPanel.getContainer())},getFilterField:function(){if(this.filterField)return this.filterField;var e=this,t=Oskari.clazz.create("Oskari.userinterface.component.FormInput");return t.setPlaceholder(this.instance.getLocalization("filter").text),t.addClearButton(),t.bindChange(function(n){e._searchTrigger(t.getValue())},!0),t.bindEnterKey(function(n){e._relatedSearchTrigger(t.getValue())}),this.filterField=t,t},_searchTrigger:function(e){var t=this;this.searchTimer&&clearTimeout(this.searchTimer),!e||e.length==0?t._search(e):this.searchTimer=setTimeout(function(){t._search(e),t.searchTimer=undefined},500)},_relatedSearchTrigger:function(e){var t=this;this.searchTimer&&clearTimeout(this.searchTimer),!e||e.length==0},tabSelected:function(){if(this.layerGroups.length==0){this.accordion.showMessage(this.instance.getLocalization("loading"));var e=this,t=this.instance.sandbox.getAjaxUrl();jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},url:t+"action_route=GetPublishedMyPlaceLayers",success:function(t){e._populateLayerGroups(t),e.showLayerGroups(e.layerGroups)},error:function(t,n){var r=e.instance.getLocalization("errors");e.accordion.showMessage(r.generic)}})}},tabUnselected:function(){},_populateLayerGroups:function(e){var t=this,n=this.instance.getSandbox();this.layerGroups=[];var r=n.getService("Oskari.mapframework.service.MapLayerService"),i=n.getUser().getUuid(),s=null;for(var o=0;o<e.length;++o){var u=e[o];if(!s||s.getTitle()!=u.name)s=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.model.LayerGroup",u.name),this.layerGroups.push(s);for(var a=0;a<u.layers.length;++a){var f=u.layers[a],l=this._getPublishedLayer(f,r,i==u.id);l.setDescription(u.name),s.addLayer(l)}}},_getPublishedLayer:function(e,t,n){var r=this._getMapLayerJsonBase();r.wmsUrl="/karttatiili/myplaces?myCat="+e.id+"&",r.name=e.name,r.id="myplaces_"+e.id,n?r.permissions={publish:"publication_permission_ok"}:r.permissions={publish:"no_publication_permission"};var i=t.createMapLayer(r);if(!n)try{t.addLayer(i)}catch(s){}return i},_getMapLayerJsonBase:function(){var e=this.instance.getLocalization("published"),t={wmsName:"ows:my_places_categories",type:"wmslayer",isQueryable:!0,opacity:50,metaType:"published",orgName:e.organization,inspire:e.inspire};return t},showLayerGroups:function(e){var t=this;this.accordion.removeAllPanels(),this.layerContainers=undefined,this.layerContainers={},this.layerGroups=e;for(var n=0;n<e.length;++n){var r=e[n],i=r.getLayers(),s=Oskari.clazz.create("Oskari.userinterface.component.AccordionPanel");s.setTitle(r.getTitle()+" ("+i.length+")"),r.layerListPanel=s;var o=s.getContainer();for(var u=0;u<i.length;++u){var a=i[u],f=Oskari.clazz.create("Oskari.mapframework.bundle.layerselector2.view.Layer",a,this.instance.sandbox,this.instance.getLocalization()),l=f.getContainer();o.append(l),this.layerContainers[a.getId()]=f}this.accordion.addPanel(s)}if(this.layerGroups.length==0){var c=this.instance.getLocalization("errors");this.accordion.showMessage(c.noResults)}else{var h=this.instance.sandbox.findAllSelectedMapLayers();for(var n=0;n<h.length;++n)this.setLayerSelected(h[n].getId(),!0)}},_search:function(e){var t=this;if(!e||e.length==0){this.updateLayerContent();return}this.showLayerGroups([]),this.accordion.showMessage(this.instance.getLocalization("loading")),jQuery.ajax({type:"GET",dataType:"json",beforeSend:function(e){e&&e.overrideMimeType&&e.overrideMimeType("application/j-son;charset=UTF-8")},data:{searchKey:e},url:ajaxUrl+"action_route=FreeFindFromMyPlaceLayers",success:function(e){t._populateLayerGroups(e),t.showLayerGroups(t.layerGroups)},error:function(e,n){var r=t.instance.getLocalization("errors");t.accordion.showMessage(r.generic)}})},setLayerSelected:function(e,t){var n=this.layerContainers[e];n&&n.setSelected(t)},updateLayerContent:function(e,t){this.showLayerGroups([]),this.tabSelected()}}),define("bundles/framework/bundle/layerselector2/view/PublishedLayersTab",function(){}),define("normalize",["require","module"],function(e,t){function o(e,t,n){if(e.indexOf("data:")===0)return e;e=r(e);if(e.match(/^\//)||e.match(s))return e;var i=n.match(s),o=t.match(s);return o&&(!i||i[1]!=o[1]||i[2]!=o[2])?u(e,t):a(u(e,t),n)}function u(e,t){e.substr(0,2)=="./"&&(e=e.substr(2));var n=t.split("/"),r=e.split("/");n.pop();while(curPart=r.shift())curPart==".."?n.pop():n.push(curPart);return n.join("/")}function a(e,t){var n=t.split("/");n.pop(),t=n.join("/")+"/",i=0;while(t.substr(i,1)==e.substr(i,1))i++;while(t.substr(i,1)!="/")i--;t=t.substr(i+1),e=e.substr(i+1),n=t.split("/");var r=e.split("/");out="";while(n.shift())out+="../";while(curPart=r.shift())out+=curPart+"/";return out.substr(0,out.length-1)}var n=/([^:])\/+/g,r=function(e){return e.replace(n,"$1/")},s=/[^\:\/]*:\/\/([^\/])*/,f=function(e,t,n,i){t=r(t),n=r(n);var s=/@import\s*("([^"]*)"|'([^']*)')|url\s*\(\s*(\s*"([^"]*)"|'([^']*)'|[^\)]*\s*)\s*\)/ig,u,a,e;while(u=s.exec(e)){a=u[3]||u[2]||u[5]||u[6]||u[4];var f;i&&a.substr(0,1)=="/"?f=i+a:f=o(a,t,n);var l=u[5]||u[6]?1:0;e=e.substr(0,s.lastIndex-a.length-l-1)+f+e.substr(s.lastIndex-l-1),s.lastIndex=s.lastIndex+(f.length-a.length)}return e};return f.convertURIBase=o,f}),define("css",["./normalize"],function(e){function t(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1}if(typeof window=="undefined")return{load:function(e,t,n){n()}};var n=!1,r=document.getElementsByTagName("head")[0],i=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/),s=!1;!i||(i[1]||i[7]?(s=parseInt(i[1])<6||parseInt(i[7])<=9,i="trident"):i[2]?(s=!0,i="webkit"):i[3]||(i[4]?(s=parseInt(i[4])<18,i="gecko"):n&&alert("Engine detection failed")));var o={},u=/^\/|([^\:\/]*:)/;o.pluginBuilder="./css-builder";var a=[],f={},l=[];o.addBuffer=function(e){if(t(a,e)!=-1)return;if(t(l,e)!=-1)return;a.push(e),l.push(e)},o.setBuffer=function(t,n){var r=window.location.pathname.split("/");r.pop(),r=r.join("/")+"/";var i=require.toUrl("base_url").split("/");i.pop();var s=i.join("/")+"/";s=e.convertURIBase(s,r,"/"),s.match(u)||(s="/"+s),s.substr(s.length-1,1)!="/"&&(s+="/"),o.inject(e(t,s,r));for(var l=0;l<a.length;l++)(n&&a[l].substr(a[l].length-5,5)==".less"||!n&&a[l].substr(a[l].length-4,4)==".css")&&(function(e){f[e]=f[e]||!0,setTimeout(function(){typeof f[e]=="function"&&f[e](),delete f[e]},7)}(a[l]),a.splice(l--,1))},o.attachBuffer=function(e,n){for(var r=0;r<a.length;r++)if(a[r]==e)return f[e]=n,!0;if(f[e]===!0)return f[e]=n,!0;if(t(l,e)!=-1)return n(),!0};var c=function(e,t){setTimeout(function(){for(var n=0;n<document.styleSheets.length;n++){var r=document.styleSheets[n];if(r.href==e.href)return t()}c(e,t)},10)},h=function(e,t){setTimeout(function(){try{return e.sheet.cssRules,t()}catch(n){}h(e,t)},10)};if(i=="trident"&&s)var p=[],d=[],v=0,m=function(e,t){var n;d.push({url:e,cb:t}),n=p.shift(),!n&&v++<31&&(n=document.createElement("style"),r.appendChild(n)),n&&g(n)},g=function(e){var t=d.shift();if(!t){e.onload=b,p.push(e);return}e.onload=function(){t.cb(t.ss),g(e)};var n=e.styleSheet;t.ss=n.imports[n.addImport(t.url)]};var y=function(e){var t=document.createElement("link");return t.type="text/css",t.rel="stylesheet",t.href=e,t},b=function(){};o.linkLoad=function(e,t){var o=setTimeout(function(){n&&alert("timeout"),t()},L*1e3-100),u=function(){clearTimeout(o),a&&(a.onload=b),setTimeout(t,7)};if(!s){var a=y(e);a.onload=u,r.appendChild(a)}else if(i=="webkit"){var a=y(e);c(a,u),r.appendChild(a)}else if(i=="gecko"){var f=document.createElement("style");f.textContent='@import "'+e+'"',h(f,u),r.appendChild(f)}else i=="trident"&&m(e,u)};var w=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],E={},S=function(e,t,n){if(E[e]){t(E[e]);return}var r,i,s;if(typeof XMLHttpRequest!="undefined")r=new XMLHttpRequest;else if(typeof ActiveXObject!="undefined")for(i=0;i<3;i+=1){s=w[i];try{r=new ActiveXObject(s)}catch(o){}if(r){w=[s];break}}r.open("GET",e,requirejs.inlineRequire?!1:!0),r.onreadystatechange=function(i){var s,o;r.readyState===4&&(s=r.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=r,n(o)):(E[e]=r.responseText,t(r.responseText)))},r.send(null)},x=0,T;o.inject=function(e){x<31&&(T=document.createElement("style"),T.type="text/css",r.appendChild(T),x++),T.styleSheet?T.styleSheet.cssText+=e:T.appendChild(document.createTextNode(e))};var N=/@import\s*(url)?\s*(('([^']*)'|"([^"]*)")|\(('([^']*)'|"([^"]*)"|([^\)]*))\))\s*;?/g,C=window.location.pathname.split("/");C.pop(),C=C.join("/")+"/";var k=function(t,n,r){t.match(u)||(t="/"+e.convertURIBase(t,C,"/")),S(t,function(i){i=e(i,t,C);var s=[],o=[],u=[],a;while(a=N.exec(i)){var f=a[4]||a[5]||a[7]||a[8]||a[9];s.push(f),o.push(N.lastIndex-a[0].length),u.push(a[0].length)}var l=0;for(var c=0;c<s.length;c++)(function(e){k(s[e],function(t){i=i.substr(0,o[e])+t+i.substr(o[e]+u[e]);var r=t.length-u[e];for(var a=e+1;a<s.length;a++)o[a]+=r;l++,l==s.length&&n(i)},r)})(c);s.length==0&&n(i)},r)};o.normalize=function(e,t){return e.substr(e.length-4,4)==".css"&&(e=e.substr(0,e.length-4)),t(e)};var L,A=!1;return o.load=function(e,t,r,i,u){L=L||i.waitSeconds||7;var a=e+(u?".less":".css");if(o.attachBuffer(a,r))return;var f=t.toUrl(a);!A&&n&&(alert(s?"hacking links":"not hacking"),A=!0),u?k(f,function(e){u&&(e=u(e,function(e){o.inject(e),setTimeout(r,7)}))}):o.linkLoad(f,r)},n&&(o.inspect=function(){if(stylesheet.styleSheet)return stylesheet.styleSheet.cssText;if(stylesheet.innerHTML)return stylesheet.innerHTML}),o}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.addBuffer("resources/framework/bundle/layerselector2/css/style.css")}),requirejs.s.contexts._.nextTick=requirejs.nextTick,Oskari.registerLocalization({lang:"fi",key:"LayerSelector",value:{title:"Karttatasot",desc:"",errors:{title:"Virhe!",generic:"Järjestelmässä tapahtui virhe. Yritä uudelleen myöhemmin.",loadFailed:"Karttatasojen latauksessa tapahtui virhe. Lataa sivu selaimeesi uudelleen ja valitse karttatasot.",noResults:"Haulla ei löytynyt yhtään tulosta.",noResultsForKeyword:"Karttatasoja ei löydy tällä avainsanalla.",minChars:"Kirjoita ainakin 4 merkkiä."},loading:"Ladataan...",filter:{text:"Hae karttatasoja",keywordsTitle:"Avainsanat:",shortDescription:"Hae karttasoa nimeen, tiedontuottajaan ja avainsanaan perustuen.",description:"Voit hakea karttatasoja kirjoittamalla osan karttatason tai tiedontuottajan nimestä. Kirjoittamalla vähintään 4 merkkiä ja painamalla enter-näppäintä voit hakea myös karttatasoihin liittyviä avainsanoja. Ehdotetuista avainsanoista voit valita uuden hakusanan. Lukema avainsanan perässä kertoo, kuinka moneen karttatasoon sana on liitetty.",inspire:"Aiheittain",organization:"Tiedontuottajittain",published:"Käyttäjät"},published:{organization:"Julkaistu taso",inspire:"Julkaistu taso"},tooltip:{"type-base":"Taustakartta","type-wms":"Karttataso","type-wfs":"Tietotuote"},backendStatus:{OK:{tooltip:"Karttataso on saatavilla tällä hetkellä.",iconClass:"backendstatus-ok"},DOWN:{tooltip:"Karttataso ei ole saatavilla tällä hetkellä.",iconClass:"backendstatus-down"},MAINTENANCE:{tooltip:"Karttatason saatavuudessa on tiedossa käyttökatkoja lähipäivinä.",iconClass:"backendstatus-maintenance"},UNKNOWN:{tooltip:"",iconClass:"backendstatus-ok"}},buttons:{ok:"OK"},types:{syn:"Synonyymi",lk:"Lähikäsite",vk:"Vieruskäsite",ak:"Alakäsite",yk:"Yläkäsite"}}}),define("bundles/framework/bundle/layerselector2/locale/fi",function(){}),Oskari.registerLocalization({lang:"sv",key:"LayerSelector",value:{title:"Kartlager",desc:"",errors:{title:"Fel!",generic:"Systemfel. Försök på nytt senare.",loadFailed:"Fel i laddningen av kartlager. Ladda ned sidan på nytt i din läsare och välj kartlagren.",noResults:"ökningen gav inga resultat.",noResultsForKeyword:"Ökningen gav inga nyckelorden.",minChars:"Minsta längd är 4 bokstäver."},loading:"Laddar...",filter:{text:"Sök kartlager",keywordsTitle:"Nyckerord:",shortDescription:"Sök kartlager efter namn, producent och nyckelord.",description:"Du kan söka kartlager genom att skriva några bokstäver som ingår i namnet eller producent av den dataprodukt. Genom att skriva minst 4 bokstäver och trycka enter-knappen, du kan också söka efter nyckelord som beskriver kartlager. Numret efter nyckelord i listan står för mängd av kartlager relaterad för det ord.",inspire:"Enligt tema",organization:"Enligt dataproducent",published:"Användare"},published:{organization:"Publicerad kartlager",inspire:"Publicerad kartlager"},tooltip:{"type-base":"Bakgrundskarta","type-wms":"kartlager","type-wfs":"Dataprodukt"},backendStatus:{OK:{tooltip:"Kartlagret är tillgängligt just nu.",iconClass:"backendstatus-ok"},DOWN:{tooltip:"Kartlagret är inte tillgängligt just nu.",iconClass:"backendstatus-down"},MAINTENANCE:{tooltip:"Avbrott i kartlagrets tillgänglighet är att vänta inom de närmaste dagarna.",iconClass:"backendstatus-maintenance"},UNKNOWN:{tooltip:"",iconClass:"backendstatus-ok"}},buttons:{ok:"OK"},types:{syn:"Synonym",lk:"Relaterat begrepp",vk:"Sidobegrepp",ak:"Underordnad begrepp",yk:"Överordnad begrepp"}}}),define("bundles/framework/bundle/layerselector2/locale/sv",function(){}),Oskari.registerLocalization({lang:"en",key:"LayerSelector",value:{title:"Map layers",desc:"",errors:{title:"Error!",generic:"System error. Please try again later.",loadFailed:"Error loading map layers. Reload the page in your browser and select map layers.",noResults:"The search returned no results.",noResultsForKeyword:"The search returned no keywords.",minChars:"Minimum length is 4 characters."},loading:"Loading...",filter:{text:"Search map layers",keywordsTitle:"Keywords:",shortDescription:"Search map layers by name, producer or keyword.",description:"You can search map layers by writing a part of the name or producer of the layer. By writing at 4 least characters and pushing enter key you can also search for keywords that are related to the layers. The number after the keyword in the list tells you how many map layers are related to it.",inspire:"By theme",organization:"By data providers",published:"Users"},published:{organization:"Published map layer",inspire:"Published map layer"},tooltip:{"type-base":"Background map","type-wms":"Map layer","type-wfs":"Data product"},backendStatus:{OK:{tooltip:"The map layer is currently available.",iconClass:"backendstatus-ok"},DOWN:{tooltip:"The map layer is currently unavailable.",iconClass:"backendstatus-down"},MAINTENANCE:{tooltip:"The map layer may be periodically unavailable during the next few days.",iconClass:"backendstatus-maintenance"},UNKNOWN:{tooltip:"",iconClass:"backendstatus-ok"}},buttons:{ok:"OK"},types:{syn:"Synonym",lk:"Related concept",vk:"Coordinate concept",ak:"Subordinate concept",yk:"Superordinate concept"}}}),define("bundles/framework/bundle/layerselector2/locale/en",function(){}),define("bundles/framework/bundle/layerselector2/module",["oskari","jquery","./instance","./Flyout","./Tile","./model/LayerGroup","./view/Layer","./view/LayersTab","./view/PublishedLayersTab","css!resources/framework/bundle/layerselector2/css/style.css","./locale/fi","./locale/sv","./locale/en"],function(e,t){return e.bundleCls("layerselector2").category({create:function(){var t=this,n=e.clazz.create("Oskari.mapframework.bundle.layerselector2.LayerSelectorBundleInstance");return n},update:function(e,t,n,r){}})}),requirejs.s.contexts._.nextTick=function(e){e()},require(["css"],function(e){e.setBuffer("/* layer group container */\r\ndiv.layerselector2 div.layerGroup {\r\n  background-color: #f3f3f3;\r\n  border: 1pt solid #c0d0d0;\r\n  margin: 0;\r\n  padding: 0; }\r\n\r\ndiv.layerselector2 div.layerGroup.open {\r\n  background-color: #FFFFFF; }\r\n\r\ndiv.layerselector2 div.layerGroup div.groupIcon {\r\n  display: inline-block;\r\n  margin-left: 12px;\r\n  vertical-align: middle; }\r\n\r\ndiv.layerselector2 div.layerGroup div.groupHeader {\r\n  display: inline-block;\r\n  font-weight: bold;\r\n  padding: 8px 10px 8px 12px;\r\n  font: 14pt Arial, sans-serif; }\r\n\r\n/* layer container */\r\ndiv.layerselector2 div.layer {\r\n  padding: 6px 10px 6px 40px;\r\n  background-color: #ffffff; }\r\n\r\ndiv.layerselector2 div.layer.odd {\r\n  background-color: #f3f3f3; }\r\n\r\ndiv.layerselector2 div.layer input {\r\n  float: left;\r\n  margin-right: 5px; }\r\n\r\ndiv.layerselector2 div.layer div.layer-tools {\r\n  float: right; }\r\n\r\ndiv.layerselector2 div.layer div.layer-icon {\r\n  float: left;\r\n  width: 16px;\r\n  height: 16px;\r\n  background-repeat: no-repeat; }\r\n\r\ndiv.layerselector2 div.layer div.layer-info {\r\n  width: 16px;\r\n  height: 16px;\r\n  margin-left: 5px;\r\n  float: right; }\r\n\r\ndiv.layerselector2 div.tab-content {\r\n  padding: 0; }\r\n\r\ndiv.layerselector2 div.tab-content div.oskarifield {\r\n  padding: 10px;\r\n  position: relative; }\r\n  div.layerselector2 div.tab-content div.oskarifield .field-description {\r\n    padding: 3px 0;\r\n    color: #666; }\r\n    div.layerselector2 div.tab-content div.oskarifield .field-description .icon-info {\r\n      display: inline-block; }\r\n  div.layerselector2 div.tab-content div.oskarifield .related-keywords {\r\n    position: absolute;\r\n    background-color: white;\r\n    -webkit-border-radius: 4px;\r\n    -moz-border-radius: 4px;\r\n    border-radius: 4px;\r\n    border: solid 1px #b7b7b7;\r\n    -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);\r\n    -moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);\r\n    box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.4);\r\n    overflow: hidden; }\r\n    div.layerselector2 div.tab-content div.oskarifield .related-keywords .keywords-title {\r\n      box-sizing: border-box;\r\n      height: 30px;\r\n      line-height: 30px;\r\n      padding: 0 10px;\r\n      color: black;\r\n      font-weight: bold; }\r\n    div.layerselector2 div.tab-content div.oskarifield .related-keywords .keyword-cont {\r\n      box-sizing: border-box;\r\n      height: 30px;\r\n      line-height: 30px;\r\n      padding: 0 10px;\r\n      color: black; }\r\n      div.layerselector2 div.tab-content div.oskarifield .related-keywords .keyword-cont .keyword {\r\n        float: left;\r\n        min-width: 91px; }\r\n      div.layerselector2 div.tab-content div.oskarifield .related-keywords .keyword-cont .type {\r\n        background-color: #333438;\r\n        border: solid 2px #FFDE00;\r\n        color: #FFDE00;\r\n        width: 34px;\r\n        line-height: 16px;\r\n        padding: 3px;\r\n        margin: 2px;\r\n        float: right;\r\n        display: inline-block;\r\n        text-align: center; }\r\n    div.layerselector2 div.tab-content div.oskarifield .related-keywords .odd {\r\n      background-color: #f3f3f3; }\r\n    div.layerselector2 div.tab-content div.oskarifield .related-keywords .focus {\r\n      background-color: #333438;\r\n      color: white; }\r\n    div.layerselector2 div.tab-content div.oskarifield .related-keywords .keyword-cont:hover {\r\n      background-color: #4E4E4E;\r\n      color: white; }\r\n\r\ndiv.layerselector2 div.accordion div.accordion_panel div.content {\r\n  padding: 0; }\r\n\r\ndiv.layerselector2 div.layer div.layer-backendstatus-icon {\r\n  float: left;\r\n  width: 20px;\r\n  height: 16px;\r\n  margin-right: 4px;\r\n  background-repeat: no-repeat; }\r\n\r\ndiv.layerselector2 div.layer div.backendstatus-down {\r\n  height: 20px !important;\r\n  margin-bottom: 2px;\r\n  cursor: pointer; }\r\n\r\ndiv.layerselector2 div.layer div.backendstatus-maintenance {\r\n  height: 20px !important;\r\n  margin-bottom: 2px;\r\n  cursor: pointer; }\r\n\r\ndiv.layerselector2 div.layer div.backendstatus-ok {\r\n  height: 20px !important;\r\n  margin-bottom: 2px;\r\n  cursor: pointer; }\r\n\r\ndiv.layerselector2 div.layer div.backendstatus-unknown {\r\n  height: 20px !important;\r\n  margin-bottom: 2px; }\r\n")}),requirejs.s.contexts._.nextTick=requirejs.nextTick;