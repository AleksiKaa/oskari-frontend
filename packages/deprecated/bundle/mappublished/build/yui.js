/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kesÃ¤aika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.statehandler.StateHandlerBundleInstance",function(){this._localization=null;this._pluginInstances={};this._startupState=null;this._historyPollingInterval=1500;this._historyTimer=null;this._historyPrevious=[];this._historyEnabled=true;this._historyNext=[];this._currentViewId=1},{__name:"StateHandler",getName:function(){return this.__name},setSandbox:function(a){this.sandbox=a},getSandbox:function(){return this.sandbox},start:function(){var c=this;if(c.started){return}c.started=true;var a=Oskari.$("sandbox");c.sandbox=a;a.register(c);for(p in c.eventHandlers){a.registerForEventByName(c,p)}var b="/web/fi/kartta?p_p_id=Portti2Map_WAR_portti2mapportlet&p_p_lifecycle=1&p_p_state=exclusive&p_p_mode=view&p_p_col_id=column-1&p_p_col_count=1&_Portti2Map_WAR_portti2mapportlet_fi.mml.baseportlet.CMD=ajax.jsp&";var d=Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.plugin.SaveViewPlugin",b);this.registerPlugin(d);this.startPlugin(d);a.addRequestHandler("StateHandler.SetStateRequest",this.requestHandlers.setStateHandler);a.addRequestHandler("StateHandler.SaveStateRequest",this.requestHandlers.saveStateHandler)},update:function(){},stop:function(){var a=this.sandbox();a.removeRequestHandler("StateHandler.SetStateRequest",this.requestHandlers.setStateHandler);a.removeRequestHandler("StateHandler.SaveStateRequest",this.requestHandlers.saveStateHandler);var b=a.getRequestBuilder("MapControls.ToolButtonRequest");if(b){a.request(this,b(this.toolbar.config,"remove"))}for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}this.sandbox.unregister(this);this.started=false},init:function(){var b=this;this.toolbar={config:{group:this.getName(),toolId:"statehandler.reset",iconCls:"statehandler_reset_tool",tooltip:this.getLocalization("reset"),callback:function(){b.resetState()}}};var a=Oskari.$("sandbox");this.requestHandlers={setStateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.request.SetStateRequestHandler",a,this),saveStateHandler:Oskari.clazz.create("Oskari.mapframework.bundle.statehandler.request.SaveStateRequestHandler",a,this)};return null},getLocalization:function(a){if(!this._localization){this._localization=Oskari.getLocalization(this.getName())}if(a){return this._localization[a]}return this._localization},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},eventHandlers:{AfterMapMoveEvent:function(b){var a=this;if(this._historyEnabled===true){if(this._historyTimer){clearTimeout(this._historyTimer);this._historyTimer=null}this._historyTimer=setTimeout(function(){var d=a.sandbox.getStatefulComponents()["mapfull"];if(d){var c=d.getState();a._historyPrevious.push(c)}},this._historyPollingInterval)}}},historyMoveNext:function(){if(this._historyNext.length>0){var a=this._historyNext.pop();this._historyPrevious.push(a);var b=this.sandbox.getStatefulComponents()["mapfull"];if(b){this._historyEnabled=false;b.setState(a);this._historyEnabled=true}}},historyMovePrevious:function(){if(this._historyPrevious.length>0){var a=this._historyPrevious.pop();this._historyNext.push(a);var b=this.sandbox.getStatefulComponents()["mapfull"];if(b){this._historyEnabled=false;b.setState(a);this._historyEnabled=true}}},registerPlugin:function(a){a.setHandler(this);var b=a.getName();this.sandbox.printDebug("["+this.getName()+"] Registering "+b);this._pluginInstances[b]=a},unregisterPlugin:function(a){var b=a.getName();this.sandbox.printDebug("["+this.getName()+"] Unregistering "+b);this._pluginInstances[b]=undefined;a.setHandler(null)},startPlugin:function(a){var b=a.getName();this.sandbox.printDebug("["+this.getName()+"] Starting "+b);a.startPlugin(this.sandbox)},stopPlugin:function(a){var b=a.getName();this.sandbox.printDebug("["+this.getName()+"] Starting "+b);a.stopPlugin(this.sandbox)},setCurrentViewId:function(a){this._currentViewId=a},getCurrentViewId:function(){return this._currentViewId}},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.enhancement.mapfull.StartMapWithLinkEnhancement",function(){},{enhance:function(v){v.printDebug("Checking if map is started with link...");
var o=v.getRequestParameter("coord");var n=v.getRequestParameter("zoomLevel");var h=v.getRequestParameter("mapLayers");var f=v.getRequestParameter("showMarker");var k=v.getRequestParameter("keepLayersOrder");if(k===null){k=true}v.getMap().setMarkerVisible(f=="true");if(o===null||n===null){return}var q;if(o.indexOf("_")>=0){q=o.split("_")}else{q=o.split("%20")}var j=q[0];var m=q[1];if(j===null||m===null){v.printDebug("Could not parse link location. Skipping.");return}v.getMap().moveTo(j,m,n);v.printDebug("This is startup by link, moving map...");if(h!==null&&h!==""){v.printDebug("Continuing by adding layers...");var a=h.split(",");for(var t=0;t<a.length;t++){var g=a[t].split("+");var e=g[0];var b=g[1];var u=g[2];if((e.indexOf("_")!=-1)&&(e.indexOf("base_")==-1)&&(e.indexOf("BASE_")==-1)){var w=e.split("_");e=null;var c=null;for(var d in w){if(d){c=v.findBaselayerBySublayerIdFromAllAvailable(w[d]);if(c){e=c.getId();break}}}}if(e!==null){var s=null;var l=null;s=v.getRequestBuilder("AddMapLayerRequest");l=s(e,k);v.processRequest(l);s=v.getRequestBuilder("ChangeMapLayerOpacityRequest");l=s(e,b);v.processRequest(l);s=v.getRequestBuilder("ChangeMapLayerStyleRequest");l=s(e,u);v.processRequest(l)}else{v.printWarn("[StartMapWithLinkEnhancement] Could not find baselayer for "+e)}}}}},{protocol:["Oskari.mapframework.enhancement.Enhancement"]});Oskari.clazz.define("Oskari.mapframework.bundle.mappublished.BaseMapPlugin",function(a){this.mapModule=null;this.pluginName=null;this._sandbox=null;this._map=null;this._conf=a;this._layers=[]},{__name:"mappublished.BaseMapPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(a){this.mapModule=a;this.pluginName=a.getName()+this.__name},init:function(a){},register:function(){},unregister:function(){},startPlugin:function(a){this._sandbox=a;this._map=this.getMapModule().getMap();a.register(this);for(p in this.eventHandlers){a.registerForEventByName(this,p)}this._buildLayersList(this._conf);this._createUI()},stopPlugin:function(a){for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}a.unregister(this);this._map=null;this._sandbox=null;jQuery("#baseMapSelection").unbind("change");jQuery("#basemap-div").remove()},start:function(a){},stop:function(a){},eventHandlers:{},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},_buildLayersList:function(c){if(!c||!c.baseMaps){return}var a=this._sandbox.getService("Oskari.mapframework.service.MapLayerService");var e=c.baseMaps;for(var b=0;b<e.length;b++){var d=a.findMapLayer(e[b]);if(d){this._layers.push(d)}}},_createUI:function(){if(this._layers.length<2||!this._conf.toolsContainer){return}var a=this._sandbox;jQuery("<div id='basemap-div'><select id='baseMapSelection'></select></div>").appendTo("#"+this._conf.toolsContainer);var c="";for(var b=0;b<this._layers.length;b++){var e=this._layers[b].getId();jQuery("<option id='BasemapButton-"+e+"' value='"+e+"' class='basemapButton'>"+this._layers[b].getName()+"</option>").appendTo("#baseMapSelection");if(c==""){c=e}}var d=this;jQuery("#baseMapSelection").change(function(){d._changeBaseLayer(jQuery(this).val())})},_changeBaseLayer:function(c){var b=this._sandbox;for(var e=0;e<this._layers.length;e++){try{var a=b.findMapLayerFromSelectedMapLayers(this._layers[e].getId());if(a){var g=b.getRequestBuilder("RemoveMapLayerRequest");var f=g(a.getId());b.request(this.getName(),f)}}catch(d){}}var g=b.getRequestBuilder("AddMapLayerRequest");var f=g(c,false,true);b.request(this.getName(),f)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]});Oskari.clazz.define("Oskari.mapframework.bundle.mappublished.SearchPlugin",function(a){this.mapModule=null;this.pluginName=null;this._sandbox=null;this._map=null;this._conf=a},{__name:"mappublished.SearchPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(a){this.mapModule=a;this.pluginName=a.getName()+this.__name},init:function(a){return"<div id='basemapButtonsDiv' class='search-div-with-basemap-buttons'></div>"
},register:function(){},unregister:function(){},startPlugin:function(a){this._sandbox=a;this._map=this.getMapModule().getMap();a.register(this);for(p in this.eventHandlers){a.registerForEventByName(this,p)}this._createUI()},stopPlugin:function(a){for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}a.unregister(this);this._map=null;this._sandbox=null;jQuery("#search-div").remove()},start:function(a){},stop:function(a){},eventHandlers:{},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},_createUI:function(){var a=this._sandbox;var d=this;this._searchBoxMessage=a.getText("rightpanel_search_find_places_textbox_value");var c=a.getText("rightpanel_search_find_places_button_value");var e=a.getText("rightpanel-searchresults-close_button_value");var b='<div id="search-div"><div id="search-textarea-and-button"><input id="search-string" value="'+this._searchBoxMessage+'" type="text" name="search-string" /><input id="search-button" type="button" value="'+c+'" name="search-button" /></div><div id="search-container" class="hidden"><img id="close-search-button" src="'+startup.imageLocation+'/resource/icons/poisto.png" alt="'+e+'" title="'+e+'"/><div id="search-results-header">&nbsp;</div><div id="search-results"></div></div></div>';jQuery(b).appendTo("#"+this._conf.toolsContainer);var d=this;jQuery("#search-string").focus(function(){a.request(d.getName(),a.getRequestBuilder("DisableMapKeyboardMovementRequest")());d._checkForKeywordClear()});jQuery("#search-string").blur(function(){a.request(d.getName(),a.getRequestBuilder("EnableMapKeyboardMovementRequest")());d._checkForKeywordInsert()});jQuery("#search-string").keypress(function(f){d._checkForEnter(f)});jQuery("#search-button").click(function(f){d._doSearch()});jQuery("#close-search-button").click(function(f){d._hideSearch()})},_checkForEnter:function(b){var a;if(window.event){a=window.event.keyCode}else{if(b){a=b.which}}if(b.keyCode==13){this._doSearch()}},_doSearch:function(){if(this._searchInProgess==true){return}var d=this;this._hideSearch();this._searchInProgess=true;jQuery("#search-string").addClass("search-loading");var e=jQuery("#search-string").val();var c=function(f){d._showResults(f)};var b=function(){d._enableSearch()};var a=this._sandbox.getRequestBuilder("SearchRequest")(encodeURIComponent(e),c,b);this._sandbox.request(this.getName(),a)},_showResults:function(c){var f=c.error;var k=this;if(f!=null){jQuery("#search-results").html("<div>"+f+"</div>");jQuery("#search-container").removeClass("hidden");return}var l=c.totalCount;if(l==0){jQuery("#search-results").html(this._sandbox.getText("search_published_map_no_results"));jQuery("#search-container").removeClass("hidden")}else{if(l==1){var b=c.locations[0].lon;var j=c.locations[0].lat;var m=c.locations[0].zoomLevel;this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(b,j,m,true))}else{var d="<table id='search-result-table'><thead><tr class='search-result-header-row'><th>"+this._sandbox.getText("searchservice_search_result_column_name")+"</th><th>"+this._sandbox.getText("searchservice_search_result_column_village")+"</th><th>"+this._sandbox.getText("searchservice_search_result_column_type")+"</th></tr></thead><tbody>";for(var e=0;e<l;e++){if(e>=100){d+="<tr><td class='search-result-too-many' colspan='3'>"+this._sandbox.getText("search_published_map_too_many_results")+"</td></tr>";break}var a=c.locations[e].name;var g=c.locations[e].village;var h=c.locations[e].type;var b=c.locations[e].lon;var j=c.locations[e].lat;var m=c.locations[e].zoomLevel;var o="class='search-result-white-row'";if(e%2==1){o="class='search-result-dark-row'"}var n="<tr "+o+" data-href='"+b+"---"+j+"---"+m+"'><td nowrap='nowrap'>"+a+"</td><td nowrap='nowrap'>"+g+"</td><td nowrap='nowrap'>"+h+"</td></tr>";d+=n}d+="</tbody></table>";jQuery("#search-results").html(d);jQuery("#search-container").removeClass("hidden");jQuery("#search-result-table tbody tr[data-href]").addClass("clickable").click(function(){k._resultClicked(jQuery(this).attr("data-href"))}).find("a").hover(function(){jQuery(this).parents("tr").unbind("click")
},function(){jQuery(this).parents("tr").click(function(){k._resultClicked(jQuery(this).attr("data-href"))})})}}},_resultClicked:function(c){var a=c.split("---");var e=a[0];var d=a[1];var b=a[2];this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("MapMoveRequest")(e,d,b,true))},_enableSearch:function(){this._searchInProgess=false;jQuery("#search-string").removeClass("search-loading")},_hideSearch:function(){jQuery("#search-container").addClass("hidden");this._sandbox.request(this.getName(),this._sandbox.getRequestBuilder("HideMapMarkerRequest")())},_checkForKeywordClear:function(){if(jQuery("#search-string").val()==this._searchBoxMessage){jQuery("#search-string").val("")}},_checkForKeywordInsert:function(){if(jQuery("#search-string").val()==""){jQuery("#search-string").val(this._searchBoxMessage)}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]});Oskari.clazz.define("Oskari.mapframework.bundle.mappublished.MapInfoPlugin",function(a){this.mapModule=null;this.pluginName=null;this._sandbox=null;this._map=null;this._conf=a},{__name:"mappublished.MapInfoPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(a){this.mapModule=a;this.pluginName=a.getName()+this.__name},init:function(a){},register:function(){},unregister:function(){},startPlugin:function(a){this._sandbox=a;this._map=this.getMapModule().getMap();a.register(this);for(p in this.eventHandlers){a.registerForEventByName(this,p)}this._createUI()},stopPlugin:function(a){for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}a.unregister(this);this._map=null;this._sandbox=null;jQuery("#finnish-geoportal-logo").unbind("click");jQuery("#logo-image").remove()},start:function(a){},stop:function(a){},eventHandlers:{},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},_createUI:function(){var a=this._sandbox;var b="<div id='logo-image'><img id='finnish-geoportal-logo' style='cursor: pointer;' src='"+startup.imageLocation+"/resource/images/logo_pieni.png'/></div>";jQuery(b).appendTo("#"+this._conf.parentContainer);jQuery("#finnish-geoportal-logo").click(function(){var d=a.generatePublishedMapLinkToFinnishGeoportalPage();window.open(d,"_blank")});var c="<span id='terms-of-use-link' class='link-no-hover-gray'><a href='"+this._conf.termsUrl+"'  target='_blank'>"+a.getText("published_map_terms_of_use")+"</a></span>";jQuery(c).appendTo("#logo-image")}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]});Oskari.clazz.define("Oskari.mapframework.bundle.mappublished.GetFeatureInfoPlugin",function(a){this.mapModule=null;this.pluginName=null;this._sandbox=null;this._map=null;this._conf=a;this._gfiLayers=[];this._toolTipVisible=false},{__name:"mappublished.GetFeatureInfoPlugin",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(a){this.mapModule=a;this.pluginName=a.getName()+this.__name},init:function(a){},register:function(){},unregister:function(){},startPlugin:function(a){this._sandbox=a;this._map=this.getMapModule().getMap();this._activateGFI()},stopPlugin:function(a){this._deactivateGFI()},start:function(a){},stop:function(a){},eventHandlers:{AfterGetFeatureInfoEvent:function(a){this._afterGetFeatureInfoEvent(a)},AfterAppendFeatureInfoEvent:function(a){this._afterAppendFeatureInfoEvent(a)},MapClickedEvent:function(a){this._handleMapClick(a.getMouseX(),a.getMouseY(),a.getLonLat())}},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},_activateGFI:function(){if(!this._conf||!this._conf.gfiLayer||!this._conf.gfiLayer.id||this._conf.gfiLayer.id.length===0){return}var a=this._sandbox;a.register(this);for(p in this.eventHandlers){a.registerForEventByName(this,p)}for(var d=0;d<this._conf.gfiLayer.id.length;d++){var c=a.findMapLayerFromAllAvailable(this._conf.gfiLayer.id[d]);if(c){this._gfiLayers.push(c)}}this._initializeFeatureInfoPopup(a);var b=a.getRequestParameter("showGetFeatureInfo");
if(b=="true"){var h=a.getMap().getX();var g=a.getMap().getY();var f=new OpenLayers.LonLat(h,g);var e=this._map.getPixelFromLonLat(f);this._handleMapClick(e.x,e.y,f)}},_deactivateGFI:function(){if(!this._conf&&!this._conf.gfiLayer){return}var a=this._sandbox;this._gfiLayers=[];for(p in this.eventHandlers){a.unregisterFromEventByName(this,p)}a.unregister(this);this._map=null;this._sandbox=null},_afterGetFeatureInfoEvent:function(a){},_afterAppendFeatureInfoEvent:function(c){var b=jQuery("div.qtip-content");var a=b.html();if(a!=""){a+="<hr/>"}var d=c.getMessage();if(d.startsWith("{parsed: {")){var e=jQuery.parseJSON(d);if(e&&e.parsed){d=this._formatJsonGFI(e.parsed)}}d='<div style="padding: 5px; font: 11px Tahoma, Arial, Helvetica, sans-serif;">'+d+"</div>";a+="<h3>"+c.getHeader()+"</h3>"+d;jQuery("div.qtip-content").html(a)},_formatJsonGFI:function(b){var a="<br/><table>";var d=false;for(attr in b){var c=b[attr];if(c.startsWith("http://")){c='<a href="'+c+'" target="_blank">'+c+"</a>"}a=a+'<tr style="padding: 5px;';if(!d){a=a+" background-color: #EEEEEE"}d=!d;a=a+'"><td style="padding: 2px">'+attr+'</td><td style="padding: 2px">'+c+"</td></tr>"}return a+"</table>"},_handleMapClick:function(d,c,b){var a="#"+this._conf.parentContainer;var e=jQuery(a).qtip("api");if(this._toolTipVisible===true){e.hide();this._toolTipVisible=false}else{jQuery("div.qtip-content").html("");var f=this._sandbox.getRequestBuilder("GetFeatureInfoRequest");r=f(this._gfiLayers,b.lon,b.lat,d,c);this._sandbox.request(this.getName(),r);e.show();this._toolTipVisible=true;this.mapModule.centerMapByPixels(d+100,c-100,true)}},_initializeFeatureInfoPopup:function(b){var a="#"+this._conf.parentContainer;jQuery(a).qtip({content:"",show:{when:false},hide:{when:false},position:{corner:{target:"center",tooltip:"bottomLeft"},adjust:{x:-100,y:100}},style:{width:200,height:200,padding:5,background:"#FFFFFF",color:"black",textAlign:"center","overflow-y":"auto","overflow-x":"auto",border:{width:1,radius:4,color:"#F5AF3C"},tip:"bottomLeft",name:"dark"}});var c=this}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]});