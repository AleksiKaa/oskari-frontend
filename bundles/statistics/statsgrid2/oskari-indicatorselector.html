<link rel="import"
      href="libs/polymer/polymer.html">

<link href="libs/promise-polyfill/promise-polyfill.html" rel="import">
<link href="libs/iron-ajax/iron-ajax.html" rel="import">
<link href="oskari-userindicator.html" rel="import">

<dom-module id="oskari-indicatorselector">

  <template>
    <iron-ajax
      auto
      url="{{ajaxUrl}}"
      params='{"action_route": "GetIndicatorsMetadata"}'
      handle-as="json"
      last-response="{{sources}}"
      debounce-duration="300"
      id="indicatorsAjax"></iron-ajax>
    <iron-ajax
      auto
      url="{{ajaxUrl}}"
      params='{"action_route": "GetUserIndicators"}'
      handle-as="json"
      last-response="{{userIndicators}}"
      debounce-duration="300"
      id="userIndicatorsAjax"></iron-ajax>
    <div hidden$="[[showUserIndicatorView]]">
      <form class="statsgrid2_indicator_selector">
        <div>
          <label for="datasource-selector">{{locale.tab.grid.organization}}</label>
          <select id="datasource-selector" style="width: 300px;" value="{{datasourceId::change}}">
            <template is="dom-repeat" items="[[getDatasources(sources)]]">
              <option value="{{item.val}}">{{item.text}}</option>
            </template>
          </select>
          <button type="button" on-click="onAddUserIndicator">[[locale.addDataButton]]</button>
        </div>
        <label for="indicator-selector">{{locale.indicators}}</label>
        <select id="indicator-selector" style="width: 300px;" value="{{indicatorId::change}}">
          <template is="dom-repeat" items="[[getIndicators(sources,datasourceId)]]">
            <option value="{{item.val}}">{{item.text}}</option>
          </template>
        </select>
        <div class="icon-info" on-click="showIndicatorInfo" hidden$="[[!indicatorSelected]]"></div>
        <!-- The optional selectors will be populated here when the above have been selected. -->
        <div id="indicatorSelectors" hidden$="[[!indicatorSelected]]">
          <template is="dom-repeat" items="[[selectorItems]]" as="selector">
            <label for="{{selector.name}}">{{selectorOption.label}}</label>
            <select id="{{selector.name}}" style="width: 300px;" value="{{selector.value::change}}"
              on-change="onSelectorsChanged">
              <template is="dom-repeat" items="{{selector.values}}" as="selectorOption">
                <option value="{{selectorOption.val}}">{{selectorOption.text}}</option>
              </template>
            </select>
          </template>
        </div>
        <button type="button" on-click="onAddIndicatorToGrid" hidden$="[[!indicatorSelected]]"
          disabled$="[[!allSelectorsSelected]]">{{locale.addColumn}}</button>
      </form>
      <oskari-statsgrid locale="[[locale]]" language="[[language]]" ajax-url="[[ajaxUrl]]"
        sources="{{sources}}" selected-indicators="{{selectedIndicators}}" selected-layer="{{selectedLayer}}"
        layer-info="{{layerInfo}}" region-info="{{regionInfo}}" user-indicators="[[userIndicators]]"
        selector-selected-indicator-key="{{selectorSelectedIndicatorKey}}" sandbox="{{sandbox}}"
        hidden$="[[!showGrid]]" id="statsgrid""></oskari-statsgrid>
    </div>
    <div hidden$="[[!showUserIndicatorView]]">
      <oskari-userindicator ajax-url="[[ajaxUrl]]"
        locale="[[locale]]" language="[[language]]" user="[[user]]"
        sources="[[sources]]" selected-layer="{{selectedLayer}}"
        layer-info="[[layerInfo]]" region-info="[[regionInfo]]"
        show-user-indicator-view="{{showUserIndicatorView}}"></oskari-userindicator>
    </div>
    <content></content>
  </template>

  <script>
    Polymer({
      "is": "oskari-indicatorselector",
      "properties": {
          "ajaxUrl": String,
          "locale": Object,
          "language": String,
          "user": Object,
          "sources": {
              "type": Object,
              "notify": true
          },
          "userIndicators": {
              "type": Object,
              "notify": true
          },
          "datasourceId": {
              "type": String,
              "notify": true
          },
          "indicatorId": {
              "type": String,
              "notify": true
          },
          "indicatorSelected": {
              "type": Boolean,
              "value": false,
              "notify": true
          },
          "allSelectorsSelected": {
              "type": Boolean,
              "value": false,
              "notify": true
          },
          "selectors": {
              "type": Array,
              "value": [],
              "notify": true
          },
          "selectorItems": {
              "type": Array,
              "value": [],
              "notify": true
          },
          "selectedIndicators": {
              "type": Array,
              "value": [],
              "notify": true
          },
          "showUserIndicatorView": {
              "type": Boolean,
              "value": false,
              "notify": true
          },
          "showGrid": {
              "type": Boolean,
              "notify": true,
              "value": false
          },
          "selectorSelectedIndicatorKey": {
              "type": String,
              "notify": true
          },
          "dialog": Object
      },
      "observers": [
          "datasourceChanged(datasourceId)",
          "indicatorChanged(indicatorId)",
          "getSelectors(sources, datasourceId, indicatorId)",
          "selectedIndicatorsChanged(ajaxUrl, selectedIndicators.splices)",
          "selectorsChanged(selectorItems.splices)",
          "selectorsChanged(selectors)"
      ],
      "sendTooltipData": function(feature) {
          return this.$.statsgrid.sendTooltipData(feature);
      },
      "selectedIndicatorsChanged": function() {
          this.set("showGrid", !this.showUserIndicatorView && !!this.selectedIndicators
                  && this.selectedIndicators.length > 0);
      },
      "selectorsChanged": function() {
          var me = this;
          me.set("allSelectorsSelected", true);
          if (this.selectorItems === undefined ||Â this.selectorItems === null) {
              return;
          }
          this.selectorItems.forEach(function(select) {
              if (!select.value || select.value === null || select.value === "undefined") {
                  me.set("allSelectorsSelected", false);
              }
          });
      },
      "onSelectorsChanged": function(event) {
          this.selectorsChanged(this.sources, this.datasourceId, this.indicatorId);
      },
      "datasourceChanged": function(datasourceId) {
          var me = this;
          this.set("indicatorId", undefined);
      },
      "indicatorChanged": function(indicatorId) {
          var me = this;
          this.indicatorSelected = indicatorId !== undefined && indicatorId !== null && indicatorId !== "undefined";
          $.ajax({
            url: me.ajaxUrl,
            data: {
                "action_route": "GetIndicatorSelectorMetadata",
                "plugin_id": me.datasourceId,
                "indicator_id": indicatorId
            },
            dataType: 'json',
            success: function(results) {
                me.set("indicator", results);
                me.sources[me.datasourceId].indicators[me.indicatorId] = results;
                me.set("selectors", me.indicator.selectors);
                me.getSelectors(me.sources, me.datasourceId, me.indicatorId);
            }
        });
      },
      "onAddUserIndicator": function() {
          var me = this;
		  this.showUserIndicatorView = true;
          // Warn the user if they're not logged in
          if (!me.user || !me.user.isLoggedIn()) {
              var dialog = Oskari.clazz.create(
                      'Oskari.userinterface.component.Popup'
                  ),
                  okBtn = Oskari.clazz.create(
                      'Oskari.userinterface.component.buttons.OkButton'
                  );
              okBtn.setPrimary(true);
              okBtn.setHandler(function () {
                  dialog.close(true);
                  me.createIndicatorForm(container);
              });
              dialog.show(
                  me._locale.addDataTitle,
                  me._locale.loginToSaveIndicator, [okBtn]
              );
          }
      },
      "getLocalizationFrom": function(localizedNames, fallback, lang) {
          var name = localizedNames[lang];
          if (!name) {
              name = localizedNames["fi"];
          }
          if (!name) {
              name = localizedNames["en"];
          }
          if (!name) {
              if (Object.keys(localizedNames) > 0) {
                  // Taking the first one.
                  name = localizedNames[Object.keys(localizedNames)[0]];
              } else {
                  name = fallback;
              }
          }
          return name;
      },
      "showIndicatorInfo": function() {
          var me = this,
              indicatorCont = new jQuery('<div>' +
                  '<h4 class="indicator-msg-popup-title"></h4>' +
                  '<p class="indicator-msg-popup-title"></p>' +
                  '<h4 class="indicator-msg-popup-source"></h4>' +
                  '<p class="indicator-msg-popup-source"></p>' +
                  '</div>'),
              indicators = me.sources[me.datasourceId].indicators,
              indicator = indicators[me.indicatorId],
              source = indicator.source,
              description = indicator.description;
          indicatorCont.find('h4.indicator-msg-popup-title').append(me.locale.stats.descriptionTitle);
          indicatorCont.find('p.indicator-msg-popup-title').append(
                  me.getLocalizationFrom(description, "", me.language));
          indicatorCont.find('h4.indicator-msg-popup-source').append(me.locale.stats.sourceTitle);
          indicatorCont.find('p.indicator-msg-popup-source').append(
                  me.getLocalizationFrom(source, "", me.language));
          me.showDialog(me.getLocalizationFrom(indicator.name, "", me.language), indicatorCont);
      },
      "showDialog": function(title, message, buttons) {
          var me = this;
          // Oskari components aren't available in a published map.
          if (me.dialog) {
              me.dialog.close(true);
              me.dialog = null;
              return;
          }

          me.dialog = Oskari.clazz.create('Oskari.userinterface.component.Popup');
          if (buttons) {
              me.dialog.show(title, message, buttons);
          } else {
              var okBtn = Oskari.clazz.create('Oskari.userinterface.component.buttons.OkButton');
              okBtn.setHandler(function () {
                  me.dialog.close(true);
                  me.dialog = null;
              });
              me.dialog.show(title, message, [okBtn]);
          }
      },
      "getDatasources": function(sources) {
          var me = this;
          if (!sources) {
              return [];
          }
          return [{text: me.locale.selectDataSource}]
              .concat(Object.keys(sources).map(function(sourceId) {
              return {
                  val: sourceId,
                  text: me.locale.statistic.plugins[sources[sourceId].localizationKey]
              };
          }));
      },
      "getIndicators": function(sources, datasourceId) {
          var me = this,
            indicators = sources[datasourceId] && sources[datasourceId].indicators || [];
          return [{text: me.locale.selectIndicator}].concat(Object.keys(indicators).map(function(indicatorId) {
              var indicator = indicators[indicatorId];
              return {
                  val: indicatorId,
                  text: indicator.name[me.language] || indicator.name.fi || indicatorId
              };
          }));
      },
      "getSelectors": function(sources, datasourceId, indicatorId) {
          var me = this,
            indicator = sources[datasourceId].indicators[indicatorId];
          me.set("selectors", indicator && indicator.selectors || []);
          me.set("selectorItems", me.selectors.map(function(selector) {
              return {
                  name: selector.id,
                  values: [{text: me.locale.selectorPlaceholders[selector.id]}].concat(
                          selector.allowedValues.map(function (allowedValue) {
                      return {
                          val: allowedValue,
                          text: allowedValue
                      };
                  }))
              };
          }));
      },
      "getSelectorsKey": function() {
          var selectors = {};
          this.selectorItems.forEach(function(selector) {
              selectors[selector.name] = selector.value;
          });
          return selectors;
      },
      "getIndicatorKey": function(datasourceId, indicatorId, selectedLayer, selectorsString) {
          return datasourceId + ":" + indicatorId + ":" + selectedLayer + ":" + selectorsString;
      },
      "onAddIndicatorToGrid": function(e) {
          var selectors = this.$.indicatorSelectors,
            selects = this.selectorItems,
            values = [];
          this.selectorItems.forEach(function(select) {
              values.push({
                  selectorId: select.name,
                  value: select.value
              });
          });
          this.push('selectedIndicators', {
              datasourceId: this.datasourceId,
              indicatorId: this.indicatorId,
              selectors: values
          });
          this.selectorSelectedIndicatorKey = this.getIndicatorKey(this.datasourceId, this.indicatorId,
              this.selectedLayer, this.getSelectorsKey());
      }
    });
  </script>
</dom-module>
