/* This is a packed Oskari bundle (bundle script version Thu Feb 23 2012 11:08:28 GMT+0200 (Suomen normaaliaika)) */ 
Oskari.clazz.define("Oskari.mapframework.service.MyFeaturesService",function(c){this._config=c;this._categoryList=new Array();this._placesList=new Array();this.wfstStore=Oskari.clazz.create("Oskari.mapframework.service.MyFeaturesLocalStore",c.url,c.user);this.wfstStore.connect();this._sandbox=c.sandbox;this.defaults=c.defaults;var f=this;var e=function(){if(f.getAllCategories().length===0){}else{f._notifyDataChanged()}};var a=false;var b=false;var g=function(){a=true;if(f.getAllCategories().length===0&&c.defaults){var h=Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",{name:c.defaults.categoryName,lineWidth:c.defaults.lineWidth,lineColor:c.defaults.lineColor,fillColor:c.defaults.fillColor,dotColor:c.defaults.dotColor,dotSize:c.defaults.dotSize,isDefault:true});f.saveCategory(h,e)}else{if(b){f._notifyDataChanged()}}};var d=function(){b=true;if(a){f._notifyDataChanged()}b=true};this.wfstStore.getCategories(this,g);this.wfstStore.getMyPlaces(this,d)},{__qname:"Oskari.mapframework.service.MyPlacesService",getQName:function(){return this.__qname},__name:"MyPlacesService",getName:function(){return this.__name},_addCategory:function(a){this._categoryList.push(a)},_movePlacesToCategory:function(g,c,f){var e=this;var b=this.getPlacesInCategory(g);if(b.length==0){f(true);return}for(var d=0;d<b.length;d++){b[d].set("categoryID",c)}var a=function(i,h){e._notifyDataChanged();f(i,h[0])};this.wfstStore.commitMyPlaces(b,a)},_deletePlacesInCategory:function(f,g){var b=this.getPlacesInCategory(f);var e=[];for(var c=0;c<b.length;c++){e.push(b[c].get("id"))}if(e.length==0){g(true);return}var d=this;var a=function(k,j){if(k){for(var h=0;h<b.length;h++){d._removeMyPlace(j[h])}d._notifyDataChanged()}g(k)};this.wfstStore.deleteMyPlaces(e,a)},parseDate:function(c){if(!c&&c.length<10){return[]}var j=c.substring(0,4);var h=c.substring(5,7);var k=c.substring(8,10);var a=[k+"."+h+"."+j];var b="";if(c.length==29){b=c.substring(11);var i=b.split("+");b=i[0];b=b.split(".")[0];var f=b.split(":");var d=f[0];var e=f[1];var g=f[2];b=d+":"+e+":"+g;a.push(b)}return a},getPlacesInCategory:function(b){var c=[];for(var a=0;a<this._placesList.length;a++){if(this._placesList[a].get("categoryID")===b){c.push(this._placesList[a])}}return c},deleteCategory:function(e,d,f){var c=this;var a=function(h,g){if(h){c._deleteEmptyCategory(e,f)}else{f(h)}};if(d===true){var b=c.getDefaultCategory();c._movePlacesToCategory(e,b.get("id"),a)}else{c._deletePlacesInCategory(e,a)}},_deleteEmptyCategory:function(c,d){var b=this;var a=function(f,e){if(f){b._removeCategory(e[0])}d(f);b._notifyDataChanged()};this.wfstStore.deleteCategories([c],a)},_removeCategory:function(b){for(var a=0;a<this._categoryList.length;a++){if(this._categoryList[a].get("id")==b){this._categoryList.splice(a,1);break}}},saveCategory:function(d,e){var c=this;var a=!(d.get("id"));var b=function(g,f){if(a&&g){c._addCategory(f[0])}else{}c._notifyDataChanged();e(g,f[0],a)};this.wfstStore.commitCategories([d],b)},getAllCategories:function(){return this._categoryList},getDefaultCategory:function(){var a=this.findBy(this._categoryList,"isDefault",true);if(a!==-1){return this._categoryList[a]}throw"Should not happen"},_addMyPlace:function(a){this._placesList.push(a)},_removeMyPlace:function(b){var a=this.findBy(this._placesList,"id",b);if(a!==-1){this._placesList.splice(a,1)}},_notifyDataChanged:function(){var a=this._sandbox.getEventBuilder("MyPlaces.MyPlacesChangedEvent")();this._sandbox.notifyAll(a)},deleteMyPlace:function(b,d){var c=this;var a=function(f,e){if(f){c._removeMyPlace(e[0]);c._notifyDataChanged()}d(f,e[0])};this.wfstStore.deleteMyPlaces([b],a)},findMyPlaceByLonLat:function(g,f){var c=[];var h=this.getAllMyPlaces();for(var d=0;d<h.length;++d){var e=h[d].get("geometry");var b=false;if("OpenLayers.Geometry.Point"===e.CLASS_NAME){var a=720-(f*f*5);if(f>10){a=5}else{if(f>8){a=20}else{if(f>5){a=50}}}b=e.atPoint(g,a,a)}else{b=e.atPoint(g)}if(b){c.push(h[d])}}return c},findMyPlace:function(b){var a=this.findBy(this._placesList,"id",b);if(a!==-1){return this._placesList[a]}return null},findCategory:function(b){var a=this.findBy(this._categoryList,"id",b);
if(a!==-1){return this._categoryList[a]}return null},findBy:function(c,b,d){for(var a=0;a<c.length;a++){if(c[a].get(b)===d){return a}}return -1},saveMyPlace:function(b,e){var d=this;var a=!(b.get("id"));var c=function(h,g){if(a&&h){d._addMyPlace(g[0])}else{var f=d.findMyPlace(g[0].get("id"));if(f){f.set("updateDate",g[0].get("updateDate"))}else{h=false}}d._notifyDataChanged();e(h,g[0],a)};this.wfstStore.commitMyPlaces([b],c)},getAllMyPlaces:function(){return this._placesList}},{protocol:["Oskari.mapframework.service.Service"]});Oskari.clazz.define("Oskari.mapframework.service.MyFeaturesLocalStore",function(a,b){this.uuid=b;this.protocols={};this.url=a;this.backend={tables:{categories:[],myplaces:[]},indices:{categories:{},myplaces:{}},sequences:{categories:0,myplaces:0}}},{sucsFunc:function(){return true},failFunc:function(){return false},_commit:function(j,a){var g=this;var h=g.backend.indices[j];var e=g.backend.tables[j];var i=[];for(var b=0;b<a.length;b++){var f=a[b];if(f.state==OpenLayers.State.INSERT){f.fid=j+"."+(++g.backend.sequences[j]);h[f.fid]=f;i.push(f.fid);e.push(f)}else{if(f.state==OpenLayers.State.UPDATE){h[f.fid]=f;for(var c=0;c<e.length;c++){if(e[c].fid==f.fid){e[c]=f}}}}}var d={insertIds:i,reqFeatures:a,success:g.sucsFunc};return d},_delete:function(j,a){var h=this;var i=h.backend.indices[j];var c=h.backend.tables[j];for(var d=0,g=a.length;d<g;d++){var e=d;delete i[e.fid]}var b={success:h.sucsFunc};return b},connect:function(){var a=this.url;this.protocols.categories=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",featureType:"categories",featureNS:"http://www.paikkatietoikkuna.fi",url:a});this.protocols.my_places=new OpenLayers.Protocol.WFS({version:"1.1.0",srsName:"EPSG:3067",geometryName:"geometry",featureType:"my_places",featureNS:"http://www.paikkatietoikkuna.fi",url:a})},getCategories:function(b,a){var e=this.uuid;var h=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:e});var g=this.protocols.categories;var f=this;function d(){return true}var c={features:f.backend.tables.categories,success:d};f._handleCategoriesResponse(c,b,a)},_handleCategoriesResponse:function(e,i,d){var a=this.uuid;var g=e.features;if(g==null||g.length==0){if(d){d()}return}for(var c=0;c<g.length;c++){var h=g[c];var l=h.attributes;var b=this._parseNumericId(h.fid);var j=false;if("true"===l["default"]){j=true}var k={id:b,name:l.category_name,isDefault:j,lineWidth:l.stroke_width,lineColor:l.stroke_color,fillColor:l.fill_color,dotColor:l.dot_color,dotSize:l.dot_size,uuid:a};i._addCategory(Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlacesCategory",k))}if(d){d()}},commitCategories:function(j,n){var a=this.uuid;var b=this.protocols.categories;var k=this;var c=[];for(var f=0;f<j.length;f++){var d=j[f];var h=d.get("id");var e=d.get("isDefault");if(!e){e=false}var o={category_name:d.get("name"),"default":e,stroke_width:d.get("lineWidth"),stroke_color:d.get("lineColor"),fill_color:d.get("fillColor"),dot_color:d.get("dotColor"),dot_size:d.get("dotSize"),uuid:a};var i=new OpenLayers.Feature.Vector(null,o);if(!h){i.toState(OpenLayers.State.INSERT)}else{i.fid=b.featureType+"."+h;i.state=OpenLayers.State.UPDATE}c.push(i)}var g=k._commit("categories",c);k._handleCommitCategoriesResponse(g,j,n)},_handleCommitCategoriesResponse:function(f,j,d){if(f.success()){var c=f.reqFeatures;var a,l;var e=[];var k=f.insertIds||[];for(var g=0,h=c.length;g<h;++g){l=c[g];a=l.state;if(a){if(a==OpenLayers.State.INSERT){l.fid=k[g];l.attributes.id=l.fid;var b=this._parseNumericId(l.fid);j[g].set("id",b)}l.state=null}}d(true,j)}else{d(false,j)}},deleteCategories:function(h,j){var b=this.protocols.categories;var a=this.uuid;var c=[];for(var d=0;d<h.length;d++){var f=h[d];if(!f){continue}var k={uuid:a};var g=new OpenLayers.Feature.Vector(null,k);g.fid=b.featureType+"."+f;g.state=OpenLayers.State.DELETE;c.push(g)}var i=this;var e=i._delete("categories",c);i._handleDeleteCategoriesResponse(e,h,j)},_handleDeleteCategoriesResponse:function(b,c,a){if(b.success()){a(true,c)}else{a(false,c)}},_parseNumericId:function(a){var b=a.split(".")[1];
return b},getMyPlaces:function(b,a){var e=this.uuid;var g=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:e});var f=this;function d(){return true}var c={features:f.backend.tables.myplaces,success:d};f._handleMyPlacesResponse(c,b,a)},_handleMyPlacesResponse:function(e,i,d){var a=this.uuid;var g=e.features;if(g==null){return}if(g.length==0){return}for(var c=0;c<g.length;c++){var h=g[c];var k=h.attributes;var b=this._parseNumericId(h.fid);var j={id:b,name:k.name,description:k.place_desc,categoryID:k.category_id,createDate:k.created,updateDate:k.updated,uuid:a,geometry:h.geometry};i._addMyPlace(Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",j))}if(d){d()}},getMyPlacesByIdList:function(f,a){var d=this.uuid;var g=this.protocols.my_places;var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"uuid",value:d}),new OpenLayers.Filter.FeatureId({fids:f})]});var e=this;var b=[];for(var h=0;h<f.length;h++){b.push(e.backend.indices.myplaces[f[h]])}e._handleMyPlaceByIdResponse({features:b},a)},_handleMyPlaceByIdResponse:function(g,e){var a=this.uuid;var h=g.features;if(h==null||h.length==0){return}var c=[];for(var d=0;d<h.length;d++){var i=h[d];var k=i.attributes;var b=this._parseNumericId(i.fid);var j={id:b,name:k.name,description:k.place_desc,categoryID:k.category_id,createDate:k.created,updateDate:k.updated,uuid:a,geometry:i.geometry};c.push(Ext.create("Oskari.mapframework.bundle.myplaces.model.MyPlace",j))}if(e){e(c)}},commitMyPlaces:function(i,n){var b=this.protocols.my_places;var a=this.uuid;var c=[];for(var e=0;e<i.length;e++){var d=i[e];var g=d.get("id");var k=d.get("geometry");var o={name:d.get("name"),place_desc:d.get("description"),category_id:d.get("categoryID"),uuid:a};var h=new OpenLayers.Feature.Vector(k,o);if(!g){h.toState(OpenLayers.State.INSERT)}else{h.fid=b.featureType+"."+g;h.state=OpenLayers.State.UPDATE}c.push(h)}var j=this;var f=j._commit("myplaces",c);j._handleCommitMyPlacesResponse(f,i,n)},_handleCommitMyPlacesResponse:function(f,k,d){if(f.success()){var c=f.reqFeatures;var a,n;var e=[];var m=f.insertIds||[];var l=[];for(var h=0,j=c.length;h<j;++h){n=c[h];a=n.state;if(a){if(a==OpenLayers.State.INSERT){n.fid=m[h];n.attributes.id=n.fid;var b=this._parseNumericId(n.fid);k[h].set("id",b);l.push(n.fid)}else{l.push(n.fid)}n.state=null}}var g=function(i){d(true,i)};this.getMyPlacesByIdList(l,g)}else{d(false,k)}},deleteMyPlaces:function(h,j){var b=this.protocols.my_places;var a=this.uuid;var c=[];for(var d=0;d<h.length;d++){var f=h[d];if(!f){continue}var k={uuid:a};var g=new OpenLayers.Feature.Vector(null,k);g.fid=b.featureType+"."+f;g.state=OpenLayers.State.DELETE;c.push(g)}var i=this;var e=i._delete("myplaces",c);i._handleDeleteMyPlacesResponse(e,h,j)},_handleDeleteMyPlacesResponse:function(b,c,a){if(b.success()){a(true,c)}else{a(false,c)}},disconnect:function(){}},{protocol:["Oskari.mapframework.myplaces.service.Store"]});Oskari.clazz.define("Oskari.mapframework.ui.module.myplaces.MyFeaturesModule",function(a){a={userKey:"e88fa3a1-5881-46d5-9929-20024f27a6d7",actionUrl:"/myplaces",wmsUrl:"/myplaces/wms?CQL_FILTER=uuid='e88fa3a1-5881-46d5-9929-20024f27a6d7'"};this._sandbox=null;this.uiItems={};this._config=a;this.myPlacesService=null;this.disableMapEvents=false;this.initialLoad=true;this.selectedMyPlace=null;this.localization={};this.defaults={};this.idPrefix="myplaces";this.defaults.dotColor="993300";this.defaults.lineColor="993300";this.defaults.fillColor="993300";this.defaults.lineWidth="1";this.defaults.dotSize="4";this.defaults.categoryName="Omat paikat"},{__name:"MyFeaturesModule",getName:function(){return this.__name},setDisableMapEvents:function(a){this.disableMapEvents=(a===true)},init:function(g){this._sandbox=g;var j=g;var f=this;j.printDebug("Initializing my places module...");this._populateLanguageSet(j);var d=j.getUser();if(d.isLoggedIn()){f._config.userKey=d.getUuid();this.defaults.categoryName=this.defaults.categoryName+" - "+d.getName()
}var i=j.findRegisteredModuleInstance("MainMapModule");var a=Oskari.clazz.create("Oskari.mapframework.myplaces.mapmodule.DrawPlugin");i.registerPlugin(a);i.startPlugin(a);this.drawPlugin=a;var h=Oskari.clazz.create("Oskari.mapframework.myplaces.mapmodule.HoverPlugin");i.registerPlugin(h);i.startPlugin(h);this.hoverPlugin=h;this.myPlacesService=Oskari.clazz.create("Oskari.mapframework.service.MyFeaturesService",{sandbox:j,user:f._config.userKey,url:f._config.actionUrl,defaults:f.defaults});for(var b in this.eventHandlers){j.registerForEventByName(this,b)}var e=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesGridPanel",{id:"myplaces-gridpanel",oskariConfig:{module:f,sandbox:j,service:f.myPlacesService,localizationSet:f.localization}});this.uiItems.gridPanel=e;var c=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesMainPanel",{id:"myplaces-mainpanel",oskariConfig:{module:f,sandbox:j,localizationSet:f.localization}});this.uiItems.mainPanel=c;this.wizardPanel=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesWizard",{oskariConfig:{service:f.myPlacesService,sandbox:f._sandbox,localizationSet:f.localization,module:f}});return c},_populateLanguageSet:function(b){var c=b.getLanguage();var a=Oskari.clazz.create("Oskari.mapframework.bundle.myplaces.ui.module.Locale",c);a.loc.title="Omat kohteet";a.loc.grid.title="Omat kohteet";this.localization=a.getCurrentLocale();if("en"===c){this.defaults.categoryName="My places"}else{if("sv"===c){this.defaults.categoryName="Mina platser"}}if(!this.localization){this.localization=a.getLocale("fi")}},saveMyPlaceGeometry:function(){if(!this.selectedMyPlace){return}var b=this;var c=function(d){b.uiItems.mainPanel.setLoading(b.localization.savemask);b.selectedMyPlace.set("geometry",d);var e=function(f){b._saveMyPlaceGeometryCallback(f)};b.myPlacesService.saveMyPlace(b.selectedMyPlace,e)};var a=this._sandbox.getRequestBuilder("MyPlaces.GetGeometryRequest")(c);this._sandbox.request(this.getName(),a)},_saveMyPlaceGeometryCallback:function(k){var j=this;this.uiItems.mainPanel.setLoading(false);if(k){var g=this.getMapLayerId();var j=this;var b=j.selectedMyPlace.get("categoryID");var f=[];var d=j.myPlacesService.getPlacesInCategory(b);for(var e=0;e<d.length;e++){var a=d[e];var l={};var i=new OpenLayers.Feature.Vector(null,l);i.geometry=a.get("geometry");f.push(i)}var g=this.getMapLayerId(b);var h=this._sandbox.findMapLayerFromSelectedMapLayers(g);var c=this._sandbox.getEventBuilder("FeaturesAvailableEvent")(h,f,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");this._sandbox.notifyAll(c)}else{alert(this.localization.errorSave)}},myPlaceFinished:function(c,d){var b=this;if(c){if(this.wizardPanel){this.wizardPanel.setLoading(this.localization.savemask)}var a=function(g,f,e){b._commitMyPlaceCallback(g,c,e,d)};this.myPlacesService.saveMyPlace(c,a)}else{this.cleanupAfterMyPlaceOperation()}},_commitMyPlaceCallback:function(p,b,k,o){var m=this;if(this.wizardPanel){this.wizardPanel.setLoading(false)}this.uiItems.mainPanel.setLoading(false);if(p){this.cleanupAfterMyPlaceOperation();var c=b.get("categoryID");this.uiItems.gridPanel.showCategory(c);var m=this;var g=[];var e=m.myPlacesService.getPlacesInCategory(c);for(var f=0;f<e.length;f++){var b=e[f];var q={};var l=new OpenLayers.Feature.Vector(null,q);l.geometry=b.get("geometry");g.push(l)}var h=this.getMapLayerId(c);var j=this._sandbox.findMapLayerFromSelectedMapLayers(h);console.log("NEW",c,h,j,g,e);var d=this._sandbox.getEventBuilder("FeaturesAvailableEvent")(j,g,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");this._sandbox.notifyAll(d);if(o!=null&&o!=""&&o!=c){var i=[];var a=m.myPlacesService.getPlacesInCategory(o);for(var f=0;f<a.length;f++){var b=a[f];var q={};var l=new OpenLayers.Feature.Vector(null,q);l.geometry=b.get("geometry");i.push(l)}var h=this.getMapLayerId(o);var j=this._sandbox.findMapLayerFromSelectedMapLayers(h);console.log("OLD",o,h,j,i,a);var d=this._sandbox.getEventBuilder("FeaturesAvailableEvent")(j,i,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");this._sandbox.notifyAll(d)
}}else{alert(this.localization.errorSave)}},cleanupAfterMyPlaceOperation:function(){var a=this._sandbox.getEventBuilder("MyPlaces.MyPlaceSelectedEvent")();this._sandbox.notifyAll(a);this.uiItems.mainPanel.sendStopDrawRequest();this.closeWizard()},startWizard:function(){var b=this;if(this.wizardPanel&&this.wizardPanel.isVisible()){this.closeWizard()}this.wizardPanel=Ext.create("Oskari.mapframework.bundle.myplaces.ui.view.MyPlacesWizard",{oskariConfig:{service:b.myPlacesService,sandbox:b._sandbox,localizationSet:b.localization,module:b}});var a=this.uiItems.gridPanel.getSelectedCategory();if(a){this.wizardPanel.setSelectedCategory(a.get("id"))}this.wizardPanel.show();if(this.selectedMyPlace){this.wizardPanel.setPlace(this.selectedMyPlace)}},closeWizard:function(){if(this.wizardPanel){this.wizardPanel.hide();this.wizardPanel.removeAll(true);this.wizardPanel.destroy();this.wizardPanel=null}},start:function(a){a.printDebug("Starting "+this.getName());Oskari.$("UI.facade").addUIComponent(this.getName()+"_grid",this.uiItems.gridPanel,"S")},stop:function(a){Oskari.$("UI.facade").removeUIComponent(this.getName()+"_grid")},processStartupLinkLayers:function(k){var c=k.getRequestParameter("mapLayers");if(c===null||c===""){return}var g=c.split(",");var d=true;for(var f=0;f<g.length;f++){var j=g[f].split("+");var e=j[0];var h=j[1];if(e!==null&&e.indexOf(this.idPrefix)!==-1){var b=null;var a=null;b=k.getRequestBuilder("AddMapLayerRequest");a=b(e,d);k.request(this.getName(),a);b=k.getRequestBuilder("ChangeMapLayerOpacityRequest");a=b(e,h);k.request(this.getName(),a)}}},getDrawModeFromGeometry:function(b){var a=b.CLASS_NAME;if("OpenLayers.Geometry.Point"===a){return"point"}else{if("OpenLayers.Geometry.LineString"===a){return"line"}else{if("OpenLayers.Geometry.Polygon"===a){return"area"}}}return null},formatMessage:function(d,c){var b=d;for(var a in c){b=b.replace("{"+a+"}",c[a])}return b},deleteMyPlace:function(){var b=this;if(this.selectedMyPlace){this.uiItems.mainPanel.setLoading(this.localization.deletemask);var a=function(c){b._deleteMyPlaceCallback(c)};this.myPlacesService.deleteMyPlace(this.selectedMyPlace.get("id"),a)}},_deleteMyPlaceCallback:function(k){var j=this;var m=this.selectedMyPlace.get("categoryID");var g=this.getMapLayerId();this.uiItems.mainPanel.setLoading(false);if(k){this.cleanupAfterMyPlaceOperation()}else{alert(this.localization.errorDelete)}var j=this;var b=m;var f=[];var d=j.myPlacesService.getPlacesInCategory(b);for(var e=0;e<d.length;e++){var a=d[e];var l={};var i=new OpenLayers.Feature.Vector(null,l);i.geometry=a.get("geometry");f.push(i)}var g=this.getMapLayerId(b);var h=this._sandbox.findMapLayerFromSelectedMapLayers(g);var c=this._sandbox.getEventBuilder("FeaturesAvailableEvent")(h,f,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");this._sandbox.notifyAll(c)},handleFinishedDrawingEvent:function(a){if(!a.isModification()){this.startWizard()}},getSelectedPlace:function(){return this.selectedMyPlace},_handlePlacesChanged:function(){if(this.wizardPanel){this.wizardPanel.refreshCategories()}var e=this._sandbox.getService("Oskari.mapframework.service.MapLayerService");var d=this.myPlacesService.getAllCategories();var b=e.getAllLayersByMetaType(this.idPrefix);for(var c=0;c<b.length;++c){var f=b[c];var k=false;for(var g=0;g<d.length;++g){var h=d[g];if(this.getMapLayerId(h.get("id"))===f.getId()){k=true}}if(!k){this._sandbox.requestByName(this.getName(),"RemoveMapLayerRequest",[f.getId()]);e.removeLayer(f.getId());var j=f.getId().substring(this.idPrefix.length+1);this.uiItems.gridPanel.removeCategory(j)}}for(var g=0;g<d.length;++g){var h=d[g];var k=false;for(var c=0;c<b.length;++c){if(this.getMapLayerId(h.get("id"))===b[c].getId()){k=true;if(h.get("name")!==b[c].getName()){var a={name:h.get("name")};e.updateLayer(b[c].getId(),a)}}}if(!k){this.addVectorLayer(h)}this.uiItems.gridPanel.addOrUpdateCategory(h)}if(this.initialLoad){this.processStartupLinkLayers(this._sandbox);this.initialLoad=false;this.uiItems.gridPanel.showCategory()}},handleMyPlaceSelected:function(a){this.selectedMyPlace=a;if(this.wizardPanel&&this.wizardPanel.isVisible()){this.wizardPanel.setPlace(this.selectedMyPlace)
}this.uiItems.mainPanel.placeSelected(a)},eventHandlers:{"MyPlaces.FinishedDrawingEvent":function(a){this.handleFinishedDrawingEvent(a)},"MyPlaces.MyPlaceSelectedEvent":function(a){Oskari.$("UI.facade").expandPart("E");this.uiItems.mainPanel.expand(true);this.handleMyPlaceSelected(a.getPlace());if(a.isDblClick()){this.startWizard()}},"MyPlaces.MyPlacesChangedEvent":function(a){this._handlePlacesChanged()},"MyPlaces.MyPlaceHoverEvent":function(a){if(this.disableMapEvents===false){this.uiItems.gridPanel.handleHover(a)}},AfterMapLayerRemoveEvent:function(d){var c=d.getMapLayer();if(c.getMetaType&&c.getMetaType()===this.idPrefix){var a=this._sandbox.getService("Oskari.mapframework.service.MapLayerService");var b=a.getAllLayersByMetaType(this.idPrefix);if(b.length===0){this.hoverPlugin.deactivate()}}},MapClickedEvent:function(a){if(this.disableMapEvents===false){this.uiItems.gridPanel.handleMapClick(a)}},AfterMapLayerAddEvent:function(b){var a=b.getMapLayer();if(a.getMetaType&&a.getMetaType()===this.idPrefix){}},AfterAddExternalMapLayerEvent:function(a){},AfterRemoveExternalMapLayerEvent:function(a){}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])},addLayerToMap:function(d){var a=this.getMapLayerId(d);var b=this._sandbox.findMapLayerFromSelectedMapLayers(a);if(!b){var c=this._sandbox.getRequestBuilder("AddMapLayerRequest")(a,true);this._sandbox.request(this.getName(),c)}},getMapLayerId:function(b){if(!b){if(this.selectedMyPlace){b=this.selectedMyPlace.get("categoryID")}else{var a=this.myPlacesService.getDefaultCategory();if(a){b=a.get("id")}else{b="-99"}}}return this.idPrefix+"_"+b},getMapLayerJson:function(b){var a=this._getMapLayerJsonBase();a.wmsUrl=this._config.wmsUrl+"+AND+category_id="+b.get("id")+"&";a.name=b.get("name");a.id=this.getMapLayerId(b.get("id"));return a},_getMapLayerJsonBase:function(){var a={wmsName:"ows:my_places_categories",descriptionLink:"",orgName:this.localization.title,type:"wmslayer",metaType:this.idPrefix,baseLayerId:-1,legendImage:"",gfi:"disabled",formats:{value:"text/html"},isQueryable:false,minScale:12000000,opacity:75,inspire:this.localization.title,maxScale:1};return a},styledLayerDescriptors:{"default":'<StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"     xmlns="http://www.opengis.net/sld"     xmlns:ogc="http://www.opengis.net/ogc"     xmlns:xlink="http://www.w3.org/1999/xlink"     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">   <NamedLayer>     <Name>Simple point with stroke</Name>    <UserStyle><Title>GeoServer SLD Cook Book: Simple point with stroke</Title>     <FeatureTypeStyle><Rule><PointSymbolizer> <Graphic><Mark><WellKnownName>circle</WellKnownName><Fill>        <CssParameter name="fill">#00A000</CssParameter>       </Fill><Stroke>          <CssParameter name="stroke">#000000</CssParameter>           <CssParameter name="stroke-width">2</CssParameter>          </Stroke></Mark><Size>12</Size></Graphic>     </PointSymbolizer><PolygonSymbolizer><Fill>        <CssParameter name="fill">#f0c0d0</CssParameter>          <CssParameter name="opacity">70</CssParameter>       </Fill><Stroke>          <CssParameter name="stroke">#a00000</CssParameter>           <CssParameter name="stroke-width">2</CssParameter>          </Stroke>     </PolygonSymbolizer><LineSymbolizer><Stroke>          <CssParameter name="stroke">#a00000</CssParameter>           <CssParameter name="stroke-width">4</CssParameter>          </Stroke>     </LineSymbolizer><TextSymbolizer><Label><ogc:PropertyName>title</ogc:PropertyName></Label><Fill><CssParameter name="fill">#000000</CssParameter></Fill></TextSymbolizer></Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>'},layerDefaults:{minScale:800000,maxScale:1},addVectorLayer:function(f){var a=this.styledLayerDescriptors["default"];var i={text:"",type:"vectorlayer",styles:{title:"Trains",legend:"",name:"1"},orgName:this.localization.title,metaType:this.idPrefix,descriptionLink:"http://www.google.fi/",legendImage:"",info:"",isQueryable:true,formats:{value:"text/html"},minScale:this.layerDefaults.minScale,maxScale:this.layerDefaults.maxScale,style:"",dataUrl:"",wmsUrl:"x",opacity:100,checked:"false",styledLayerDescriptor:a};
var g=i;g.wmsUrl=this._config.wmsUrl+"+AND+category_id="+f.get("id")+"&";g.name=f.get("name");g.id=this.getMapLayerId(f.get("id"));var h=g.id,d=true,b=false;var e=this._sandbox.getRequestBuilder("AddExternalMapLayerRequest")(h,i);this._sandbox.request(this.getName(),e);var c=this._sandbox.getRequestBuilder("AddMapLayerRequest")(h,d);this._sandbox.request(this.getName(),c)},removeVectorLayer:function(a){var b=this._sandbox.getRequestBuilder("RemoveMapLayerRequest")(a);this._sandbox.request(this.getName(),b);var c=this._sandbox.getRequestBuilder("RemoveExternalMapLayerRequest")(a);this._sandbox.request(this.getName(),c)}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.bundle.MyFeaturesBundleInstance",function(a){this.name="myplaces";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{start:function(){if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");this.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.myplaces.MyFeaturesModule",this.conf);var a=this.facade.appendExtensionModule(this.impl,this.name,{},this,"E",{fi:{title:"Omat kohteet"},sv:{title:"?"},en:{title:"My Places"}});this.def=a;this.impl.start(this.facade.getSandbox());this.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this,this.def);this.def=null;this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.MyPlacesBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});