/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kesÃ¤aika)) */ 
Oskari.clazz.category("Oskari.mapframework.core.Core","feature-info-methods",{handleGetFeatureInfoRequest:function(d){this.printDebug("Handling OF getFeatureInfo TB refactored...");if(this.getMap().isMoving()){return}var j=false;if(d.getMapLayers().length==1){if(d.getMapLayers()[0].isLayerOfType("WFS")){j=true}}if(d.getMapLayers().length>0&&!j){var b=this.getEventBuilder("AfterGetFeatureInfoEvent")(true,false);this.copyObjectCreatorToFrom(b,d);this.dispatch(b);for(var e=0;e<d.getMapLayers().length;e++){this.actionInProgressGetFeatureInfo();var f=d.getMapLayers()[e];var g=f.getName();var m=f.getQueryFormat();if(f.getQueryable()==true&&m!=""&&m!=null&&!(f.isLayerOfType("WFS"))){var c=f.getWmsUrls()[0];if(c.indexOf("?")<0){c=c+"?"}var l=d.getBoundingBox().left+","+d.getBoundingBox().bottom+","+d.getBoundingBox().right+","+d.getBoundingBox().top;c=c+"REQUEST=GetFeatureInfo&EXCEPTIONS=application/vnd.ogc.se_xml&SRS="+d.getSRS()+"&VERSION=1.1.1&BBOX="+l+"&X="+d.getX()+"&Y="+d.getY()+"&INFO_FORMAT="+m+"&QUERY_LAYERS="+f.getWmsName()+"&WIDTH="+d.getMapWidth()+"&HEIGHT="+d.getMapHeight()+"&FEATURE_COUNT=1&FORMAT=image/png&SERVICE=WMS&STYLES="+f.getCurrentStyle().getName()+"&LAYERS="+f.getWmsName();var k=Oskari.$().startup.useGetFeatureInfoProxy;if(k!=null&&k=="true"){c="/cgi-bin/proxy.cgi?url="+encodeURIComponent(c)}var a=function(i,o){this._name=i;this._format=o;this.parseOkMessage=function(p){var q=this.parseInfoResponse(p,this._format);var r=this.getEventBuilder("AfterAppendFeatureInfoEvent")(i,q);this.copyObjectCreatorToFrom(r,d);this.dispatch(r)};this.parseFailedMessage=function(p){var q=this.getEventBuilder("AfterAppendFeatureInfoEvent")(i,p.responseText);this.copyObjectCreatorToFrom(q,d);this.dispatch(q)}};var n=new a(g,m);Ext.Ajax.request({url:c,scope:this,success:n.parseOkMessage,failure:n.parseFailedMessage})}else{var h="";h=this.getText("rightpanel_wms_getfeatureinfo_not_supported_txt")+": "+g+".";var b=this.getEventBuilder("AfterAppendFeatureInfoEvent")(g,h);this.copyObjectCreatorToFrom(b,d);this.dispatch(b)}}this.parseInfoResponse=function(o,p){var i;if(p=="application/vnd.ogc.gml"||p=="application/vnd.ogc.se_xml"){i=this.renderInfoGML(o)}else{if(p=="application/vnd.ogc.wms_xml"||p=="text/xml"){i=this.renderInfoXML(o)}else{i='<div style="font: 11px Tahoma, Arial, Helvetica, sans-serif;">'+o.responseText+"</div>";if(o.responseText==""){i=this.getText("mapcontrolsservice_not_found_wms_feature_info")}}}if(i==""||i=="<table></table>"){i=this.getText("mapcontrolsservice_not_found_wms_feature_info")}return i};this.renderInfoGML=function(i){return i.responseText.replace(/</g,"&lt;").replace(/>/g,"&gt;")};this.renderInfoXML=function(i){return i.responseText.replace(/</g,"&lt;").replace(/>/g,"&gt;")}}else{var b=this.getEventBuilder("AfterGetFeatureInfoEvent")(false,j);this.copyObjectCreatorToFrom(b,d);this.dispatch(b)}}});Oskari.clazz.category("Oskari.mapframework.core.Core","map-layer-methods",{findMapLayer:function(f,e){if(!e){return null}for(var c=0;c<e.length;c++){var b=e[c];if(b.getId()==f){return b}var d=b.getSubLayers();var a=this.findMapLayer(f,d);if(a!=null){return a}}return null},isLayerAlreadySelected:function(b){var a=this.findMapLayer(b,this._selectedLayers);return(a!=null)},findMapLayerFromSelectedMapLayers:function(a){return this.findMapLayer(a,this._selectedLayers)},isMapLayerAlreadyHighlighted:function(b){var a=this.findMapLayer(b,this._mapLayersHighlighted);if(a==null){this.printDebug("[core-map-layer-methods] "+b+" is not yet highlighted.")}return(a!=null)},handleAddMapLayerRequest:function(g){var d=g.getMapLayerId();var e=g.getKeepLayersOrder();var b=g.isBasemap();this.printDebug("Trying to add map layer with id '"+d+"' AS "+(b?" BASE ":" NORMAL "));if(this.isLayerAlreadySelected(d)){this.printDebug("Attempt to select already selected layer '"+d+"'");return}var k=this.findMapLayerFromAllAvailable(d);if(!k){return}this.printDebug("MAPLAYER isBaseLayer WAS "+k.isBaseLayer());if(b==true){k.setType("BASE_LAYER")}this.printDebug("MAPLAYER isBaseLayer IS "+k.isBaseLayer());if(e!=null&&e){this._selectedLayers.push(k)
}else{if(k.isBaseLayer()||b==true){var j=this._selectedLayers;var c=new Array();c.push(k);for(var h=0;h<j.length;h++){c.push(j[h])}delete this._selectedLayers;this._selectedLayers=c}else{this._selectedLayers.push(k)}}var a=this.getEventBuilder("AfterMapLayerAddEvent")(k,e,b);this.copyObjectCreatorToFrom(a,g);this.dispatch(a);var f=new Array();f.push(k);this.doSniffing(f)},handleRemoveMapLayerRequest:function(d){var g=d.getMapLayerId();this.printDebug("Trying to remove map layer with id '"+g+"'");if(!this.isLayerAlreadySelected(g)){this.printDebug("Attempt to remove layer '"+g+"' that is not selected.");return}var a=this.findMapLayerFromAllAvailable(g);var b=-1;for(var f=0;f<this._selectedLayers.length;f++){if(this._selectedLayers[f]===a){b=f}}this._selectedLayers.splice(b,1);if(this.isMapLayerAlreadyHighlighted(g)){this.printDebug("Maplayer is also highlighted, removing it from highlight list.");if(this._allowMultipleHighlightLayers==true){this.destroyOneHighLightedMapLayers(g)}else{this.destroyAllHighLightedMapLayers()}}if(a.isLayerOfType("WFS")){var e=this.getService("Oskari.mapframework.service.OgcSearchService");e.removeWFsLayerRequests(a);e.removeWFSLayerGridRequests(a)}var c=this.getEventBuilder("AfterMapLayerRemoveEvent")(a);this.copyObjectCreatorToFrom(c,d);this.dispatch(c)},findMapLayerFromAllAvailable:function(c){var a=this.getService("Oskari.mapframework.service.MapLayerService");var b=a.findMapLayer(c);if(b==null){this.printDebug("Cannot find map layer with id '"+c+"' from all available. Check that current user has VIEW permissions to that layer.")}return b},findBaselayerBySublayerIdFromAllAvailable:function(g){var e=null;var a=this.getService("Oskari.mapframework.service.MapLayerService");var c=a.getAllLayers();for(var d=0;d<c.length;d++){if(c[d].isBaseLayer()){for(var b=0;b<c[d].getSubLayers().length;b++){var f=c[d].getSubLayers()[b];if(f.getId()==g){e=c[d];break}}}if(e!=null){break}}return e},findMapLayerFromSelected:function(b){var a=this.findMapLayer(b,this._selectedLayers);if(a==null){this.printDebug("Cannot find map layer with id '"+b+"' from selected layers")}return a},handleShowMapLayerInfoRequest:function(c){var a=this.findMapLayerFromAllAvailable(c.getMapLayerId());var b=this.getEventBuilder("AfterShowMapLayerInfoEvent")(a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)},handleRearrangeSelectedMapLayerRequest:function(f){var d=f.getToPosition();var e=f.getMapLayerId();var g=null;var l=0;if(e!=null&&d!=null){g=this.findMapLayerFromSelected(e);var b=new Array();var c=0;var k=0;for(var h=0;c<d;h++){k++;var j=this._selectedLayers[h];if(j.getId()==e){l=h;continue}b.push(j);c++}b.push(g);for(var h=k;h<this._selectedLayers.length;h++){var j=this._selectedLayers[h];if(j.getId()==e){l=h;continue}b.push(j)}delete this._selectedLayers;this._selectedLayers=b}var a=this.getEventBuilder("AfterRearrangeSelectedMapLayerEvent")(g,l,d);this.copyObjectCreatorToFrom(a,f);this.dispatch(a)},handleChangeMapLayerOpacityRequest:function(c){var a=this.findMapLayerFromSelected(c.getMapLayerId());if(!a){return}a.setOpacity(c.getOpacity());var b=this.getEventBuilder("AfterChangeMapLayerOpacityEvent")(a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)},handleChangeMapLayerStyleRequest:function(c){var a=this.findMapLayerFromSelected(c.getMapLayerId());if(!a){return}if(c.getStyle()!="!default!"){a.selectStyle(c.getStyle());var b=this.getEventBuilder("AfterChangeMapLayerStyleEvent")(a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)}},getAllSelectedLayers:function(){return this._selectedLayers},getAllSelectedWfsLayers:function(){var a=[];if(this._selectedLayers!=null){for(var b=0;b<this._selectedLayers.length;b++){if(this._selectedLayers[b].isLayerOfType("WFS")){a.push(this._selectedLayers[b])}}}return a},isWfsLayersSelected:function(){var a=this.getAllSelectedWfsLayers();return a.length>0},getAllHighlightedMapLayers:function(){return this._mapLayersHighlighted},destroyAllHighLightedMapLayers:function(){var b=this.getAllHighlightedMapLayers();for(var c=0;c<b.length;c++){var a=b[c];var d=this.getEventBuilder("AfterDimMapLayerEvent")(a);
this.dispatch(d)}this._mapLayersHighlighted=[]},destroyOneHighLightedMapLayers:function(d){var b=this.getAllHighlightedMapLayers();for(var c=0;c<b.length;c++){var a=b[c];if(a.getId()==d){b.splice(c);return}}},handleHighlightMapLayerRequest:function(g){var d=this.getObjectCreator(g);var a=this.getRequestBuilder("ToolSelectionRequest");var f=a("map_control_select_tool");this._sandbox.request(d,f);var h=g.getMapLayerId();this.printDebug("[core-map-layer-methods] Trying to highlight map layer with id '"+h+"'");if(this.isMapLayerAlreadyHighlighted(h)){this.printWarn("[core-map-layer-methods] Attempt to highlight already highlighted wms feature info map layer '"+h+"'");return}if(this._allowMultipleHighlightLayers==true){this.destroyOneHighLightedMapLayers(h)}else{this.destroyAllHighLightedMapLayers()}var c=this.findMapLayerFromSelected(h);if(!c){return}this._mapLayersHighlighted.push(c);this.printDebug("[core-map-layer-methods] Adding "+c+" ("+c.getId()+") to highlighted list.");var e=this.getEventBuilder("AfterHighlightMapLayerEvent")(c);this.copyObjectCreatorToFrom(e,g);this.dispatch(e)},handleDimMapLayerRequest:function(d){var a=d.getMapLayerId();if(this._allowMultipleHighlightLayers==true){this.destroyOneHighLightedMapLayers(a)}else{this.destroyAllHighLightedMapLayers()}var b=this.findMapLayerFromAllAvailable(a);if(!b){return}var c=this.getEventBuilder("AfterDimMapLayerEvent")(b);this.copyObjectCreatorToFrom(c,d);this.dispatch(c)},allowMultipleHighlightLayers:function(a){this._allowMultipleHighlightLayers=a}});Oskari.clazz.category("Oskari.mapframework.core.Core","map-methods",{updateMousePositionOnMap:function(a,c){var b=this._map;b.updateMousePosition(a,c)},handleEnableMapKeyboardMovementRequest:function(b){var c=this._map;c.setMapKeyboardMovementsEnabled(true);var a=this.getEventBuilder("AfterEnableMapKeyboardMovementEvent")();this.copyObjectCreatorToFrom(a,b);this.dispatch(a)},handleDisableMapKeyboardMovementRequest:function(b){var c=this._map;c.setMapKeyboardMovementsEnabled(false);var a=this.getEventBuilder("AfterDisableMapKeyboardMovementEvent")();this.copyObjectCreatorToFrom(a,b);this.dispatch(a)},doSniffing:function(f){if(this._doSniffing){var a=this.getService("Oskari.mapframework.service.UsageSnifferService");var h=new Array();var g=this._map.getScale();for(var e=0;e<f.length;e++){var d=f[e];for(var b=0;b<d.getSubLayers().length;b++){var c=d.getSubLayers()[b];if(c.isVisible()&&c.getMinScale()>=g&&c.getMaxScale()<=g){h.push(c)}}if(!d.isBaseLayer()&&d.isVisible()&&d.getMinScale()>=g&&d.getMaxScale()<=g){h.push(d)}}if(h.length>0){a.registerMapMovement(h,this._map.getX(),this._map.getY(),this._map.getZoom(),this._map.getBbox().toBBOX(),this._mapIdFromUrl)}}},handleStartMapPublisherRequest:function(b){if(this._mapPublisherWizardUrl==null){throw"User cannot move to wizard!"}var a=this.getEventBuilder("AfterStartMapPublisherEvent")(this._mapPublisherWizardUrl);this.copyObjectCreatorToFrom(a,b);this.dispatch(a)},handleGenerateHtmlLinkToMapRequest:function(b){var a=this.getEventBuilder("AfterGenerateHtmlLinkToMapEvent")(this.generateUrlToCurrentPage()+this.generateHtmlLinkParameters(this._map,this._selectedLayers,null));this.copyObjectCreatorToFrom(a,b);this.dispatch(a)},handleGenerateHtmlPrintToMapRequest:function(b){var a=this.getEventBuilder("AfterGenerateHtmlPrintToMapEvent")(this.generateUrlToPrintPage()+this.generateHtmlLinkParameters(this._map,this._selectedLayers,"print=true"));this.copyObjectCreatorToFrom(a,b);this.dispatch(a)},generateUrlToPrintPage:function(){var a=Oskari.$().startup.printUrl;if(a==null){throw"Print url is not set. Cannot print."}return a},generateUrlToCurrentPage:function(){var b=window.location.pathname;if(b.match(";")){b=b.substring(0,b.indexOf(";"))}var a=window.location.protocol+"//"+window.location.host+b;return a},generatePublishedMapLinkToFinnishGeoportalPage:function(){var b=new Array();for(var a=0;a<this._selectedLayers.length;a++){if(this._selectedLayers[a].isBaseLayer()){b.push(this._selectedLayers[a])}}for(var a=0;a<this._selectedLayers.length;a++){if(!this._selectedLayers[a].isBaseLayer()){b.push(this._selectedLayers[a])
}}return Oskari.$().startup.finnishGeoportalMapUrl+this.generateHtmlLinkParameters(this._map,b,"keepLayersOrder=false")},generateHtmlLinkParameters:function(c,f,d){var o=",";var e="+";var p=c.getZoom();var n=c.getX();var b=c.getY();var h="";for(var g=0;g<f.length;g++){var k=f[g];if(h.length>0){h+=o}var m=k.getOpacity();var a;if(k.isBaseLayer()||typeof k.getCurrentStyle!="function"||k.getCurrentStyle()==null||k.getCurrentStyle().getName()==null){a="!default!"}else{a=k.getCurrentStyle().getName()}h+=k.getId()+e+m+e+a}var l="false";if(c.isMarkerVisible()){l="true"}if(d!=null){d="&"+d}else{d=""}var j="?zoomLevel="+p+"&coord="+n+"_"+b+"&mapLayers="+h+"&showMarker="+l+"&forceCache=true"+d;return j},handleDrawPolygonRequest:function(c){var a=c.getPolygon();var b=this.getEventBuilder("AfterDrawPolygonEvent")(a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)},handleDrawSelectedPolygonRequest:function(c){var a=c.getPolygon();var b=this.getEventBuilder("AfterDrawSelectedPolygonEvent")(a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)},handleSelectPolygonRequest:function(c){var d=c.getId();var a=c.getGroupId();var b=this.getEventBuilder("AfterSelectPolygonEvent")(d,a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)},handleUpdateHiddenValueRequest:function(c){var a=c.getPolygon();var b=this.getEventBuilder("AfterUpdateHiddenValueEvent")(a);this.copyObjectCreatorToFrom(b,c);this.dispatch(b)},handleErasePolygonRequest:function(b){var c=b.getId();var a=this.getEventBuilder("AfterErasePolygonEvent")(c);this.copyObjectCreatorToFrom(a,b);this.dispatch(a)},handleRemovePolygonRequest:function(d){var e=d.getId();var a=d.getGroupId();var b=d.getShowPol();var c=this.getEventBuilder("AfterRemovePolygonEvent")(e,a,b);this.copyObjectCreatorToFrom(c,d);this.dispatch(c)},handleHideMapMarkerRequest:function(b){this._map.setMarkerVisible(false);var a=this.getEventBuilder("AfterHideMapMarkerEvent")();this.copyObjectCreatorToFrom(a,b);this.dispatch(a)}});Oskari.clazz.category("Oskari.mapframework.core.Core","status-methods",{handleActionReadyRequest:function(a){var b=a.getId();this._ongoingActions[b]=null;this.notifyModulesThatActionsHaveChanged(a);if(a.isWfsPngAction()){this._currentlyFetchingWfsTiles--}},handleActionStartRequest:function(a){var b=a.getId();this._ongoingActions[b]=a.getActionDescription();this.notifyModulesThatActionsHaveChanged(a);if(a.isWfsPngAction()){this._currentlyFetchingWfsTiles++}},notifyModulesThatActionsHaveChanged:function(e){var a={};for(var b in this._ongoingActions){var g=this._ongoingActions[b];if(g!=null){a[g]=g}}var f=new Array();for(var c in a){if(c!=null&&c!=undefined){f.push(c)}}var d=this.getEventBuilder("ActionStatusesChangedEvent")(f);this.copyObjectCreatorToFrom(d,e);this.dispatch(d)},actionInProgressWfsGrid:function(){var b=this.getText("status_wfs_update_grid");var a=this.getRequestBuilder("ActionStartRequest")("WFS_GRID",b,false);this.handleActionStartRequest(a)},actionInProgressSearch:function(){var b=this.getText("status_search");var a=this.getRequestBuilder("ActionStartRequest")("SEARCH",b,false);this.handleActionStartRequest(a)},actionInProgressGetFeatureInfo:function(){var b=this.getText("status_get_feature_info");var a=this.getRequestBuilder("ActionStartRequest")("GET_FEATURE_INFO",b,false);this.handleActionStartRequest(a)}});