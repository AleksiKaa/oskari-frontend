/* This is a packed Oskari bundle (bundle script version Thu Feb 23 2012 11:08:28 GMT+0200 (Suomen normaaliaika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.Sade3BundleInstance",function(a){this.name="sade3";this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{defaults:{minScale:40000,maxScale:1},start:function(){if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");var a=Oskari.$("sandbox");var b=this.facade.appendExtensionModule(this,this.name,this.eventHandlers,this,null,{fi:{title:"Sade"},sv:{title:"?"},en:{title:"Sade"}});this.def=b;this.adapt(a);this.mediator.setState("started");return this},init:function(a){return null},getUserInterface:function(){return this.ui},getApp:function(){return this.app},adapt:function(j){var b=this.libs.ext;var e=this;var c=Oskari.clazz.create("Oskari.poc.sade3.SadeApp",{});this.app=c;c.setSandbox(j);var a=Oskari.clazz.create("Oskari.poc.sade3.Mediator");c.setMediator(a);var d=Oskari.clazz.create("Oskari.poc.sade3.SadeWorker",{urls:{KTJkiiWFS:"../../../wfs-dispatch/ktjkii-wfs/wfs",RakennustiedotWFS:"../../../wfs-dispatch/rahu/wfs",NimistoWFS:"../../../wfs-dispatch/nimisto/wfs",MaastoWFS:"../../../wfs-dispatch/maasto/wfs"}});var g=this;var f=Oskari.clazz.create("Oskari.poc.sade3.LayerManager",j,d.workerLayers,this.defaults,true,g.getName());this.layerManager=f;c.setLayerManager(f);f.createLayer("sade",true,null);d.mapplet.setLayerManager(f);d.mapplet.mapProj=new OpenLayers.Projection("EPSG:3067");d.setupWorkers();c.setWorker(d);var h=Oskari.clazz.create("Oskari.poc.sade3.SadeUI");h.setMapAdapter(f);h.setApp(c);h.createUserInterface({close:function(){g.stop();var m=g.mediator.manager;var l=g.mediator.instanceid;e=null;m.destroyInstance(l)}});this.ui=h;var i=Oskari.clazz.create("Oskari.poc.sade3.Adapter",c,h);c.setAdapter(i);h.showUserInterface();this.worker=d;d.start();return null},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.worker.stop();this.layerManager.destroyLayers();this.facade.removeExtensionModule(this,this.name,this.eventHandlers,this,this.def);this.def=null;this.app=null;this.ui=null;this.mediator.setState("stopped");return this},eventHandlers:{"MyPlaces.MyPlaceSelectedEvent":function(a){this.app.getLayerManager().dimMapLayer()},AfterMapMoveEvent:function(c){var b=this;var a=this.sandbox;var f=c.getScale();if(!(f<this.defaults.minScale&&f>this.defaults.maxScale)){return}var g=c.getCenterY();var d=c.getCenterX()},FeaturesGetInfoEvent:function(a){var c=this.libs.ext;var b=a.getLon();var h=a.getLat();var e=a.getMapLayer();var i=this.layerManager.sandbox;if(e.getId()!=this.layerManager.layers.sade.layerId){return}var f=this;var g=f.ui;g.reset();f.worker.reset();f.worker.reset();var d=new OpenLayers.LonLat(b,h);f.worker.searchAnyByLonLat(d)},AfterAddExternalMapLayerEvent:function(b){var a=b.getLayer();this.layerManager.registerLayerImpl(a)},AfterRemoveExternalMapLayerEvent:function(a){}},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.Sade3BundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.mapframework.bundle.extension.Extension","Oskari.mapframework.bundle.extension.EventListener"]});Oskari.clazz.define("Oskari.poc.sade3.Layer",function(c,a,b){this.layerId=a;this.layer=null;this.spec=b;this.layerImpl=null;this.lm=c},{getLayerId:function(){return this.layerId},setOpacity:function(a){this.opacity=a},getVisibility:function(){return true},addFeatures:function(a){var b=this.lm.sandbox.getEventBuilder("FeaturesAvailableEvent")(this.layer,a,"application/nlsfi-x-openlayers-feature","EPSG:3067",null);this.lm.sandbox.notifyAll(b)},destroyFeatures:function(){var a=this.lm.sandbox.getEventBuilder("FeaturesAvailableEvent")(this.layer,[],"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");this.lm.sandbox.notifyAll(a)}});Oskari.clazz.define("Oskari.poc.sade3.LayerManager",function(a,c,e,d,b){this.layersAndWorkers=c;this.layers={};this.defaults=e;this.sandbox=a;this.shared=d;this.name=b},{getName:function(){return this.name
},styledLayerDescriptors:{"default":'<StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"     xmlns="http://www.opengis.net/sld"     xmlns:ogc="http://www.opengis.net/ogc"     xmlns:xlink="http://www.w3.org/1999/xlink"     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">   <NamedLayer>     <Name>Simple point with stroke</Name>    <UserStyle><Title>GeoServer SLD Cook Book: Simple point with stroke</Title>     <FeatureTypeStyle><Rule><PointSymbolizer> <Graphic><Mark><WellKnownName>circle</WellKnownName><Fill>        <CssParameter name="fill">#00A000</CssParameter>       </Fill><Stroke>          <CssParameter name="stroke">#000000</CssParameter>           <CssParameter name="stroke-width">2</CssParameter>          </Stroke></Mark><Size>12</Size></Graphic>     </PointSymbolizer><LineSymbolizer><Stroke>          <CssParameter name="stroke">#a00000</CssParameter>           <CssParameter name="stroke-width">4</CssParameter>          </Stroke>     </LineSymbolizer><PolygonSymbolizer> <Fill>        <CssParameter name="fill">#c0d0e0</CssParameter>       </Fill><Stroke>          <CssParameter name="stroke">#0000a0</CssParameter>           <CssParameter name="stroke-width">2</CssParameter>          </Stroke>     </PolygonSymbolizer><TextSymbolizer><Label><ogc:PropertyName>title</ogc:PropertyName></Label><Fill><CssParameter name="fill">#000000</CssParameter></Fill></TextSymbolizer></Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>'},createLayer:function(c,d,m){if(this.shared&&this.sharedLayer){return this.sharedLayer}var j=c,f=true,b=false;var a=this.styledLayerDescriptors["default"];var l={name:c,wmsName:"1",orgName:"SADE",type:"vectorlayer",styles:{title:"Default",legend:"",name:"1"},descriptionLink:"http://en.wikipedia.org/",leaf:"true",legendImage:"",info:"",isQueryable:true,formats:{value:"text/html"},id:j,minScale:this.defaults.minScale,maxScale:this.defaults.maxScale,style:"",dataUrl:"",wmsUrl:"x",opacity:70,checked:"false",styledLayerDescriptor:a};var i=Oskari.clazz.create("Oskari.poc.sade3.Layer",this,c,l);this.layers[c]=i;if(this.shared&&!this.sharedLayer){this.sharedLayer=i}try{var h=this.sandbox.getRequestBuilder("AddExternalMapLayerRequest")(j,l);this.sandbox.request(this.getName(),h)}catch(g){}var e=this.sandbox.getRequestBuilder("AddMapLayerRequest")(j,f);this.sandbox.request(this.getName(),e);return i},registerLayerImpl:function(a){console.log("### registerLayerImpl",a);if(this.shared){this.sharedLayer.layer=a}else{this.layers[a.getId()].layer=a}},destroyLayers:function(){for(p in this.layers){this.destroyLayer(p)}},destroyLayer:function(a){var b=this.sandbox.getRequestBuilder("RemoveMapLayerRequest")(a);this.sandbox.request(this.getName(),b);var c=this.sandbox.getRequestBuilder("RemoveExternalMapLayerRequest")(a);this.sandbox.request(this.getName(),c)},zoomTo:function(e,c,d){var b=this.sandbox.getMap().getZoom();var a=this.sandbox.getRequestBuilder("MapMoveRequest")(e,c,b,false,20000);this.sandbox.request(this.name,a)},clearFeatures:function(){if(this.shared){this.sharedLayer.destroyFeatures()}},highlightMapLayer:function(){var a=this.sharedLayer.getLayerId();this.sandbox.request(this.name,this.sandbox.getRequestBuilder("HighlightMapLayerRequest")(a))},dimMapLayer:function(){var a=this.sharedLayer.getLayerId();this.sandbox.request(this.name,this.sandbox.getRequestBuilder("DimMapLayerRequest")(a))}});Oskari.clazz.define("Oskari.poc.sade3.SadeApp",function(b){this.args=b||{};this.uiManager=null;this.core=null;this.userInterfaceLanguage=this.args.lang||"fi";this.locale=Oskari.clazz.create("Oskari.poc.sade3.SadeLocale",this.userInterfaceLanguage);this.worker=null;this.mediator=null;this.adapter=null;this.sandbox=null;this.layermanager=null},{getWorker:function(a){return this.worker},setWorker:function(a){this.worker=a},getLocale:function(){return this.locale},getMediator:function(){return this.mediator},setMediator:function(a){this.mediator=a},setAdapter:function(b){this.adapter=b},getAdapter:function(){return this.adapter},setSandbox:function(a){this.sandbox=a
},getSandbox:function(){return this.sandbox},setLayerManager:function(a){this.layermanager=a},getLayerManager:function(){return this.layermanager}});Oskari.clazz.define("Oskari.NLSFI.OpenLayers.Strategy.QueuedTile",function(a){var b={op:null,bounds:null,feature:null,filter:null,propertyNames:null,tileFeature:null,filterType:null};for(p in b){this[p]=b[p]}this.op=a.op;this.filterType=a.filterType?a.filterType:OpenLayers.Filter.Spatial.BBOX;this.bounds=a.bounds;this.feature=a.feature;this.tileFeature=a.tileFeature;this.filter=a.filter;this.propertyNames=a.propertyNames},{clone:function(){return Oskari.clazz.create("Oskari.NLSFI.OpenLayers.Strategy.QueuedTile",{bounds:this.bounds.clone(),feature:this.feature,tileFeature:this.tileFeature})},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTile"});Oskari.clazz.define("Oskari.NLSFI.OpenLayers.Strategy.TileQueue",function(a){this.queue=[]},{getLength:function(){return this.queue.length},popJob:function(){var c=this.queue;var b=c.length;if(b===0){return null}if(b<4){return c.shift(-1)}var a=null;var d=Math.floor(b/2);a=c[d];this.queue=c.slice(0,d).concat(c.slice(d+1));return a},pushJob:function(a){this.queue.push(a)},flushQueue:function(){this.queue=[]},CLASS_NAME:"NLSFI.OpenLayers.Strategy.TileQueue"});Oskari.clazz.define("Oskari.NLSFI.OpenLayers.Strategy.QueuedTilesGrid",function(a){var b={map:null,tileSize:null,maxExtent:null,grid:null,buffer:0,numLoadingTiles:0};for(p in b){this[p]=b.p}for(p in a){this[p]=a.p}this.grid=[]},{destroy:function(){this.clearGrid();this.grid=null;this.tileSize=null},clearGrid:function(){if(this.grid){for(var f=0,b=this.grid.length;f<b;f++){var e=this.grid[f];for(var c=0,a=e.length;c<a;c++){var d=e[c];d.destroy()}}this.grid=[]}},clone:function(a){if(a==null){a=new OpenLayers.Layer.QueuedTilesGrid(this.map)}if(this.tileSize!=null){a.tileSize=this.tileSize.clone()}a.grid=[];return a},moveTo:function(d,a){d=d||this.map.getExtent();if(d!=null){var c=!this.grid.length||a;var b=this.getTilesBounds();if(c||!b.containsBounds(d,true)){this.initGriddedTiles(d)}else{this.moveGriddedTiles(d)}}},setTileSize:function(a){},getTilesBounds:function(){var e=null;if(this.grid.length){var a=this.grid.length-1;var d=this.grid[a][0];var b=this.grid[0].length-1;var c=this.grid[0][b];e=new OpenLayers.Bounds(d.bounds.left,d.bounds.bottom,c.bounds.right,c.bounds.top)}return e},calculateGridLayout:function(a,q,e){var l=e*this.tileSize.w;var c=e*this.tileSize.h;var i=a.left-q.left;var m=Math.floor(i/l)-this.buffer;var j=i/l-m;var f=-j*this.tileSize.w;var n=q.left+m*l;var b=a.top-(q.bottom+c);var h=Math.ceil(b/c)+this.buffer;var o=h-b/c;var d=-o*this.tileSize.h;var g=q.bottom+h*c;return{tilelon:l,tilelat:c,tileoffsetlon:n,tileoffsetlat:g,tileoffsetx:f,tileoffsety:d}},initGriddedTiles:function(i){var g=this.map.getSize();var z=Math.ceil(g.h/this.tileSize.h)+Math.max(1,2*this.buffer);var B=Math.ceil(g.w/this.tileSize.w)+Math.max(1,2*this.buffer);var q=this.maxExtent;var t=this.map.getResolution();var s=this.calculateGridLayout(i,q,t);var f=Math.round(s.tileoffsetx);var c=Math.round(s.tileoffsety);var l=s.tileoffsetlon;var o=s.tileoffsetlat;var e=s.tilelon;var j=s.tilelat;this.origin=new OpenLayers.Pixel(f,c);var w=f;var A=l;var v=0;var a=parseInt(this.map.layerContainerDiv.style.left);var u=parseInt(this.map.layerContainerDiv.style.top);do{var h=this.grid[v++];if(!h){h=[];this.grid.push(h)}l=A;f=w;var d=0;do{var b=new OpenLayers.Bounds(l,o,l+e,o+j);var n=f;n-=a;var m=c;m-=u;var r=new OpenLayers.Pixel(n,m);var C=h[d++];if(!C){C=this.addTile(b,r);h.push(C)}else{C.moveTo(b,r,false)}l+=e;f+=this.tileSize.w}while((l<=i.right+e*this.buffer)||d<B);o-=j;c+=this.tileSize.h}while((o>=i.bottom-j*this.buffer)||v<z);this.removeExcessTiles(v,d)},addTile:function(e,b){var c=e;var d=c.toGeometry();var a=new OpenLayers.Feature.Vector(d);this.layer.addFeatures([a]);return new OpenLayers.Tile(this.layer,e,b,"",this.tileSize)},moveGriddedTiles:function(c){var b=this.buffer||1;while(true){var a=this.grid[0][0].position;var d=this.map.getViewPortPxFromLayerPx(a);if(d.x>-this.tileSize.w*(b-1)){this.shiftColumn(true)
}else{if(d.x<-this.tileSize.w*b){this.shiftColumn(false)}else{if(d.y>-this.tileSize.h*(b-1)){this.shiftRow(true)}else{if(d.y<-this.tileSize.h*b){this.shiftRow(false)}else{break}}}}}},shiftRow:function(o){var c=(o)?0:(this.grid.length-1);var b=this.grid;var f=b[c];var e=this.map.getResolution();var h=(o)?-this.tileSize.h:this.tileSize.h;var g=e*-h;var n=(o)?b.pop():b.shift();for(var j=0,m=f.length;j<m;j++){var d=f[j];var a=d.bounds.clone();var l=d.position.clone();a.bottom=a.bottom+g;a.top=a.top+g;l.y=l.y+h;n[j].moveTo(a,l)}if(o){b.unshift(n)}else{b.push(n)}},shiftColumn:function(n){var d=(n)?-this.tileSize.w:this.tileSize.w;var c=this.map.getResolution();var l=c*d;for(var e=0,g=this.grid.length;e<g;e++){var m=this.grid[e];var j=(n)?0:(m.length-1);var b=m[j];var a=b.bounds.clone();var f=b.position.clone();a.left=a.left+l;a.right=a.right+l;f.x=f.x+d;var h=n?this.grid[e].pop():this.grid[e].shift();h.moveTo(a,f);if(n){m.unshift(h)}else{m.push(h)}}},removeExcessTiles:function(e,c){while(this.grid.length>e){var f=this.grid.pop();for(var b=0,a=f.length;b<a;b++){var d=f[b];d.destroy()}}while(this.grid[0].length>c){for(var b=0,a=this.grid.length;b<a;b++){var f=this.grid[b];var d=f.pop();d.destroy()}}},onMapResize:function(){},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesGrid"});Oskari.$("Oskari.NLSFI.OpenLayers.Strategy.QueuedTilesStrategy",OpenLayers.Class(OpenLayers.Strategy,{minZoom:9,keepFeatures:false,tileQueue:null,flushTileQueue:function(){var b=this.tileQueue.queue;var a=[];for(var c=0;c<b.length;c++){if(b[c].tileFeature!=null){a.push(b[c].tileFeature);b[c].tileFeature=null}}if(a.length>0){this.layer.destroyFeatures(a)}this.tileQueue.flushQueue()},unloadOutOfViewFeatures:function(){},grid:null,bounds:null,ratio:1.2,response:null,initialize:function(a){OpenLayers.Strategy.prototype.initialize.apply(this,[a]);this.tileQueue=a.tileQueue},activate:function(){var a=OpenLayers.Strategy.prototype.activate.call(this);if(a){this.grid=Oskari.clazz.create("Oskari.NLSFI.OpenLayers.Strategy.QueuedTilesGrid",{map:this.layer.map,layer:this.layer,maxExtent:this.layer.map.getMaxExtent(),tileSize:this.layer.map.getTileSize()});this.layer.events.on({moveend:this.updateMoveEnd,scope:this});this.layer.events.on({refresh:this.updateRefresh,scope:this})}return a},deactivate:function(){var a=OpenLayers.Strategy.prototype.deactivate.call(this);if(a){this.layer.events.un({moveend:this.update,scope:this});this.layer.events.un({refresh:this.update,scope:this});this.grid.destroy();this.grid=null}return a},updateRefresh:function(a){this.update()},updateMoveEnd:function(a){this.update()},update:function(b){var a=this.layer.map.getExtent();this.grid.moveTo(a,true);this.flushTileQueue();window.console.log("FLUSHED TILE QUEUE");if(!this.keepFeatures){this.triggerUnload(a)}var c=this.layer.map.getZoom();if(c<this.minZoom){return}this.triggerRead()},invalidBounds:function(a){if(!a){a=this.layer.map.getExtent()}return !this.bounds||!this.bounds.containsBounds(a)},triggerUnload:function(a){this.layer.destroyFeatures()},triggerRead:function(){var b=this.grid.grid;var e=[];for(var a=0;a<b.length;a++){for(var g=0;g<b[a].length;g++){var n=b[a][g].bounds.clone();var l=n.clone();var j=new OpenLayers.Geometry.Point(n.left,n.bottom);var m=new OpenLayers.Geometry.Point(n.right,n.top);var i=new OpenLayers.Geometry.Point(n.left,n.top);var h=new OpenLayers.Geometry.Point(n.right,n.bottom);var f=new OpenLayers.Geometry.LineString([j,h,m,i,j]);var d=new OpenLayers.Feature.Vector(f,{featureClassName:this.CLASS_NAME,description:""});d.renderIntent="tile";var o=new NLSFI.OpenLayers.Strategy.QueuedTile({bounds:l,tileFeature:d});this.tileQueue.pushJob(o);e.push(d)}}window.console.log(this.tileQueue.getLength());this.layer.addFeatures(e)},merge:function(b){var a=b.features;if(a&&a.length>0){this.layer.addFeatures(a)}},CLASS_NAME:"NLSFI.OpenLayers.Strategy.QueuedTilesStrategy"}));Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.ArcInterPoints",OpenLayers.Class({initialize:function(){return this},arcInterPointsFromPosList:function(a){return this.InterPoints(a[0],a[2],a[1],7,1)},InterPoints:function(h,b,c,e,a){var g=[];
var f=h.distanceTo(b);if(f<1){g.push(h);g.push(b);return g}g=this.doInterPoints(h.x,h.y,b.x,b.y,c.x,c.x,e,a);return g},doInterPoints:function(c,s,o,g,a,l,q,m){var h=Math.floor(Math.pow(2,q)+1);if(q<1){return[]}var f=new Array(h);f[0]=new OpenLayers.Geometry.Point(c,s);f[h-1]=new OpenLayers.Geometry.Point(o,g);for(k=q;k>0;k--){var i=Math.floor(Math.pow(2,k));var j=-1;for(k2=0;k2<h;k2+=i){if(j>-1){var r=f[j].x;var n=f[j].y;var d=f[k2].x;var b=f[k2].y;var e=this.kaarenValipiste(r,n,d,b,a,l,m);f[Math.floor((k2-j)/2+j)]=e;if(m<1){m=1.1}}j=k2}}return f},kaarenValipiste:function(g,s,q,a,u,d,h){var o;var c=Math.sqrt((u-g)*(u-g)+(d-s)*(d-s));var b=Math.sqrt((u-q)*(u-q)+(d-a)*(d-a));o=Math.max(c,b);var n=Math.acos((g-u)/o);if(s<d){n=-1*n}var m=Math.acos((q-u)/o);if(a<d){m=-1*m}while(m<n){m=m+2*Math.PI}var l=(m+n)/2;var f=Math.cos(l)*o+u;var t=Math.sin(l)*o+d;var j=Math.sqrt((f-g)*(f-g)+(t-s)*(t-s));var e=u-Math.cos(l)*o;var r=d-Math.sin(l)*o;var i=Math.sqrt((e-g)*(e-g)+(r-s)*(r-s));var v=new OpenLayers.Geometry.Point(0,0);if(h<1){if(j<i){v.x=e;v.y=r}else{v.x=f;v.y=t}}else{if(j<i){v.x=f;v.y=t}else{v.x=e;v.y=r}}return v}}));var ktjkiiWfsNs="http://xml.nls.fi/ktjkiiwfs/2010/02";var ktjkiiWfsNsPrefix="ktjkiiwfs";Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.KTJkiiWFS",OpenLayers.Class(OpenLayers.Format.GML.v3,{arcInterPoints:null,alerted:true,stats:{},featureTypeSchema:null,otherFeatureTypes:null,knownFeatureTypes:{},namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},initialize:function(a){OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[a]);this.singleFeatureType=false;this.namespaces[ktjkiiWfsNsPrefix]=ktjkiiWfsNs;this.namespaceAlias[ktjkiiWfsNs]=ktjkiiWfsNsPrefix;this.arcInterPoints=new (Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.ArcInterPoints"))();this.featureTypeSchema=a.featureTypeSchema;this.otherFeatureTypes=a.otherFeatureTypes;if(this.featureTypeSchema!=null){this.knownFeatureTypes[this.featureTypeSchema.typeName]=this.featureTypeSchema}if(this.otherFeatureTypes!=null){for(var c=0;c<this.otherFeatureTypes.length;c++){var b=this.otherFeatureTypes[c];this.knownFeatureTypes[b.typeName]=b}}},readers:{gml:OpenLayers.Util.applyDefaults({Curve:function(b,a){var d={points:[]};this.readChildNodes(b,d);if(!a.components){a.components=[]}if(a.interpolate=="circularArc3Points"){if(!this.alerted){this.alerted=true;window.alert("OpenLayers 2.8 does not implement Curve Segment interpolation: "+a.interpolate)}var c=d.points;a.components.push(new OpenLayers.Geometry.LineString(c))}else{if(a.interpolate=="linear"){a.components.push(new OpenLayers.Geometry.LineString(d.points))}}},"*":function(a,b){this.readChildNodes(a,b)}},OpenLayers.Format.GML.v3.prototype.readers.gml),feature:OpenLayers.Format.GML.Base.prototype.readers.feature,wfs:OpenLayers.Util.applyDefaults({},OpenLayers.Format.GML.v3.prototype.readers.wfs),ktjkiiwfs:{_feature:function(d,e){var b={interpolate:"linear",components:[],attributes:{},features:e.features,featSchema:e.featSchema,featType:e.featType};this.readChildNodes(d,b);if(b.name){b.attributes.name=b.name}b.attributes.featType=e.featType;var c=new OpenLayers.Feature.Vector(b.components[0],b.attributes);if(!this.singleFeatureType){c.type=d.nodeName.split(":").pop();c.namespace=d.namespaceURI}var f=d.getAttribute("fid")||this.getAttributeNS(d,this.namespaces.gml,"id");if(f){c.fid=f}if(b.bounds&&c.geometry){c.geometry.bounds=b.bounds}if(this.internalProjection&&this.externalProjection&&c.geometry){c.geometry.transform(this.externalProjection,this.internalProjection)}if(c.geometry){var a="geometry";if(this.stats[a]==null){this.stats[a]=1}else{this.stats[a]+=1}}e.features.push(c)},"*":function(d,f){var b=d.localName||d.nodeName.split(":").pop();var c=d.namespaceURI;if(c==this.featureNS){if(this.stats[b]==null){this.stats[b]=1}else{this.stats[b]+=1}}if(c==this.featureNS&&b==this.featureType){f.featType=b;f.featSchema=this.knownFeatureTypes[b];this.readers.ktjkiiwfs["_feature"].apply(this,[d,f])}else{if(c==this.featureNS&&this.knownFeatureTypes[b]!=null){var a="HACK_"+b;
if(this.stats[a]==null){this.stats[a]=1}else{this.stats[a]+=1}f.featType=b;f.featSchema=this.knownFeatureTypes[b];this.readers.ktjkiiwfs["_feature"].apply(this,[d,f])}else{if(c==this.featureNS&&b=="RekisteriyksikonPalstanTietoja"){var a="HACK_"+b;if(this.stats[a]==null){this.stats[a]=1}else{this.stats[a]+=1}this.readers.ktjkiiwfs["_feature"].apply(this,[d,f])}else{if(d.childNodes.length==0||(d.childNodes.length==1&&d.firstChild.nodeType==3)){if(this.extractAttributes){var e=this.getChildValue(d);if(f.attributes!=null){f.attributes[b]=e}}}}}}this.readChildNodes(d,f)}}},readNode:function(d,f){if(!f){f={}}var b=this.namespaceAlias[d.namespaceURI];var e=this.readers[b];var c=d.localName||d.nodeName.split(":").pop();if(e){var a=e[c]||e["*"];if(a){a.apply(this,[d,f])}}return f},read:function(e){if(typeof e=="string"){e=OpenLayers.Format.XML.prototype.read.apply(this,[e])}if(e&&e.nodeType==9){e=e.documentElement}this.stats={};var c=[];this.readNode(e,{features:c});if(c.length==0){var d=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMember");if(d.length){for(var b=0,a=d.length;b<a;++b){this.readNode(d[b],{features:c})}}else{var d=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMembers");if(d.length){this.readNode(d[0],{features:c})}}}return c},CLASS_NAME:"NLSFI.OpenLayers.Format.GML.KTJkiiWFS"}));Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.WFSResponse",OpenLayers.Class(OpenLayers.Format.GML.v3,{arcInterPoints:null,alerted:true,stats:{},featureTypeSchema:null,otherFeatureTypes:null,knownFeatureTypes:{},namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",ows:"http://www.opengis.net/ows"},initialize:function(a){OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[a]);this.singleFeatureType=false;this.namespaces[a.nsPrefix]=a.ns;this.namespaceAlias[a.ns]=a.nsPrefix;this.setNamespace("feature",a.ns);this.featureTypeSchema=a.featureTypeSchema;this.otherFeatureTypes=a.otherFeatureTypes;if(this.featureTypeSchema!=null){this.knownFeatureTypes[this.featureTypeSchema.typeName]=this.featureTypeSchema}if(this.otherFeatureTypes!=null){for(var c=0;c<this.otherFeatureTypes.length;c++){var b=this.otherFeatureTypes[c];this.knownFeatureTypes[b.typeName]=b}}},readers:{ows:{ExceptionReport:function(c,d){var b=c.getAttribute("version");var a={version:b,exceptions:null};this.readChildNodes(c,a);if(a.exceptions&&a.exceptions.length>0){this.stats.ERROR_COUNT=a.exceptions.length}},Exception:function(a,c){var b=a.getAttribute("exceptionCode");var d={exceptionCode:b,exceptionTexts:null};this.readChildNodes(a,c);if(c.exceptions==null){c.exceptions=[]}c.exceptions.push(d)},ExceptionText:function(a,b){var c=this.getChildValue(a);if(b.exceptionTexts==null){b.exceptionTexts=[]}b.exceptionTexts.push(c?c:"?");if(c){this.stats.ERROR_LAST=c}}},gml:OpenLayers.Util.applyDefaults({"*":function(a,b){this.readChildNodes(a,b)}},OpenLayers.Format.GML.v3.prototype.readers.gml),wfs:OpenLayers.Util.applyDefaults({},OpenLayers.Format.GML.v3.prototype.readers.wfs),feature:OpenLayers.Util.applyDefaults({_feature:function(d,e){var b={interpolate:"linear",components:[],attributes:{},features:e.features,featSchema:e.featSchema,featType:e.featType};this.readChildNodes(d,b);if(b.name){b.attributes.name=b.name}b.attributes.featType=e.featType;var c=new OpenLayers.Feature.Vector(b.components[0],b.attributes);if(!this.singleFeatureType){c.type=d.nodeName.split(":").pop();c.namespace=d.namespaceURI}var f=d.getAttribute("fid")||this.getAttributeNS(d,this.namespaces.gml,"id");if(f){c.fid=f}if(b.bounds&&c.geometry){c.geometry.bounds=b.bounds}if(this.internalProjection&&this.externalProjection&&c.geometry){c.geometry.transform(this.externalProjection,this.internalProjection)}if(c.geometry){var a="geometry";if(this.stats[a]==null){this.stats[a]=1}else{this.stats[a]+=1}}e.features.push(c)},"*":function(d,f){var b=d.localName||d.nodeName.split(":").pop();var c=d.namespaceURI;if(c==this.featureNS){if(this.stats[b]==null){this.stats[b]=1}else{this.stats[b]+=1}}if(c==this.featureNS&&b==this.featureType){f.featType=b;
f.featSchema=this.knownFeatureTypes[b];this.readers.feature["_feature"].apply(this,[d,f])}else{if(c==this.featureNS&&this.knownFeatureTypes[b]!=null){var a="HACK_"+b;if(this.stats[a]==null){this.stats[a]=1}else{this.stats[a]+=1}f.featType=b;f.featSchema=this.knownFeatureTypes[b];this.readers.feature["_feature"].apply(this,[d,f])}else{if(d.childNodes.length==0||(d.childNodes.length==1&&d.firstChild.nodeType==3)){if(this.extractAttributes){var e=this.getChildValue(d);if(f.attributes!=null){f.attributes[b]=e}}}}}this.readChildNodes(d,f)}},OpenLayers.Format.GML.Base.prototype.readers.feature)},readNode:function(d,f){if(!f){f={}}var b=this.namespaceAlias[d.namespaceURI];var e=this.readers[b];var c=d.localName||d.nodeName.split(":").pop();if(e){var a=e[c]||e["*"];if(a){a.apply(this,[d,f])}}return f},read:function(e){if(typeof e=="string"){e=OpenLayers.Format.XML.prototype.read.apply(this,[e])}if(e&&e.nodeType==9){e=e.documentElement}this.stats={};var c=[];this.readNode(e,{features:c});if(c.length==0){var d=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMember");if(d.length){for(var b=0,a=d.length;b<a;++b){this.readNode(d[b],{features:c})}}else{var d=this.getElementsByTagNameNS(e,this.namespaces.gml,"featureMembers");if(d.length){this.readNode(d[0],{features:c})}}}return c},CLASS_NAME:"NLSFI.OpenLayers.Format.GML.WFSResponse"}));Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.KTJkiiMappletGML",OpenLayers.Class(OpenLayers.Format.GML.Base,{alerted:0,schemaLocation:"http://www.opengis.net/gml http://schemas.opengis.net/gml/2.1.2/feature.xsd",initialize:function(a){OpenLayers.Format.GML.Base.prototype.initialize.apply(this,[a]);return this},readers:{feature:OpenLayers.Util.applyDefaults({"*":function(c,d){var a;var b=c.localName||c.nodeName.split(":").pop();if(!this.singleFeatureType&&(OpenLayers.Util.indexOf(this.featureType,b)!=-1)){a="_typeName"}else{if(b==this.featureType){a="_typeName"}else{if(c.childNodes.length==0||(c.childNodes.length==1&&c.firstChild.nodeType==3)){if(this.extractAttributes){a="_attribute"}}else{a="_geometry"}}}if(a){this.readers.feature[a].apply(this,[c,d])}},_typeName:function(d,e){var a={components:[],attributes:{},features:e.features};this.readChildNodes(d,a);if(a.name){a.attributes.name=a.name}var b=d.getAttribute("name");if(b){a.attributes.featureClassName=b}var c=new OpenLayers.Feature.Vector(a.components[0],a.attributes);if(!this.singleFeatureType){c.type=d.nodeName.split(":").pop();c.namespace=d.namespaceURI}var f=d.getAttribute("fid")||this.getAttributeNS(d,this.namespaces.gml,"id");if(f){c.fid=f}if(this.internalProjection&&this.externalProjection&&c.geometry){c.geometry.transform(this.externalProjection,this.internalProjection)}if(a.bounds){c.geometry.bounds=a.bounds}if(c.geometry!=null){e.features.push(c)}},_geometry:function(a,b){this.readChildNodes(a,b)},_attribute:function(b,d){var a=b.localName||b.nodeName.split(":").pop();var c=this.getChildValue(b);if(d!=null&&d.attributes){d.attributes[a]=c}},LineString:function(b,a){var c={};this.readChildNodes(b,c);if(!a.components){a.components=[]}a.components.push(new OpenLayers.Geometry.LineString(c.points))},coordinates:function(e,g){var h=this.getChildValue(e).replace(this.regExes.trimSpace,"");h=h.replace(this.regExes.trimComma,",");var a=h.split(this.regExes.splitSpace);var f;var d=a.length;var c=new Array(d);for(var b=0;b<d;++b){f=a[b].split(",");if(this.xy){c[b]=new OpenLayers.Geometry.Point(f[0],f[1],f[2])}else{c[b]=new OpenLayers.Geometry.Point(f[1],f[0],f[2])}}g.points=c},outerBoundaryIs:function(b,a){var c={};this.readChildNodes(b,c);a.outer=c.components[0]},innerBoundaryIs:function(b,a){var c={};this.readChildNodes(b,c);a.inner.push(c.components[0])},Box:function(d,b){var e={};this.readChildNodes(d,e);if(!b.components){b.components=[]}var c=e.points[0];var a=e.points[1];b.components.push(new OpenLayers.Bounds(c.x,c.y,a.x,a.y))}},OpenLayers.Format.GML.Base.prototype.readers.gml),wfs:OpenLayers.Format.GML.Base.prototype.readers.wfs},CLASS_NAME:"NLSFI.OpenLayers.Format.GML.KTJkiiMappletGML"}));var kmltp="http://ktjkii.nls.fi/aineistopalvelu/aineistosiirto";
Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.KTJkiiAtp",OpenLayers.Class(OpenLayers.Format.GML.v3,{alerted:0,namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs"},initialize:function(a){if(a==null){a={}}a=OpenLayers.Util.extend(a,{featurePrefix:"kmltp",featureNS:kmltp,featureType:["Kiinteistoraja","Palsta","Rajamerkki","Kayttooikeusyksikko"],geometryName:"sijainti"});OpenLayers.Format.GML.v3.prototype.initialize.apply(this,[a]);this.namespaces.kmltp=kmltp;this.namespaceAlias[kmltp]="kmltp"},readers:{gml:OpenLayers.Util.applyDefaults({},OpenLayers.Format.GML.v3.prototype.readers.gml),kmltp:OpenLayers.Util.applyDefaults({TietoaKiinteistorekisterista:function(a,b){this.readChildNodes(a,b)},palstat:function(a,b){this.readChildNodes(a,b)},rajamerkit:function(a,b){this.readChildNodes(a,b)},kiinteistorajat:function(a,b){this.readChildNodes(a,b)},rekisteriyksikot:function(a,b){this.readChildNodes(a,b)},"*":function(c,d){var a;var b=c.localName||c.nodeName.split(":").pop();if(!this.singleFeatureType&&(OpenLayers.Util.indexOf(this.featureType,b)!=-1)){a="_typeName"}else{if(b==this.featureType){a="_typeName"}}if(a){if(a=="_typeName"){this.readers.kmltp[a].apply(this,[c,d])}}else{this.readChildNodes(c,d)}},_typeName:function(c,d){var a={components:[],attributes:{}};this.readChildNodes(c,a);if(a.name){a.attributes.name=a.name}var b=new OpenLayers.Feature.Vector(a.components[0],a.attributes);if(!this.singleFeatureType){b.type=c.nodeName.split(":").pop();b.namespace=c.namespaceURI}var e=c.getAttribute("fid")||this.getAttributeNS(c,this.namespaces.gml,"id");if(e){b.fid=e}if(this.internalProjection&&this.externalProjection&&b.geometry){b.geometry.transform(this.externalProjection,this.internalProjection)}if(a.bounds){b.geometry.bounds=a.bounds}d.features.push(b)},sijainti:function(a,b){this.readChildNodes(a,b)},Alue:function(a,b){this.readers.gml.Polygon.apply(this,[a,b])},Murtoviiva:function(a,b){this.readers.gml.LineString.apply(this,[a,b])},Piste:function(a,b){this.readers.gml.Point.apply(this,[a,b])}},OpenLayers.Format.GML.Base.prototype.readers.feature)},CLASS_NAME:"NLSFI.OpenLayers.Format.GML.KTJkiiAtp"}));Oskari.$("Oskari.NLSFI.OpenLayers.Format.WFS.WFSCapabilities",OpenLayers.Class(OpenLayers.Format.XML,{statsFunc:null,namespaces:{gml:"http://www.opengis.net/gml",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance",wfs:"http://www.opengis.net/wfs",ogc:"http://www.opengis.net/ogc",xlink:"http://www.w3.org/1999/xlink",ows:"http://www.opengis.net/ows"},defaultPrefix:"wfs",regExes:{trimSpace:(/^\s*|\s*$/g),removeSpace:(/\s*/g),splitSpace:(/\s+/),trimComma:(/\s*,\s*/g)},getChildValue:function(d,b,c,f){var e;var a=this.getElementsByTagNameNS(d,b,c);if(a&&a[0]&&a[0].firstChild&&a[0].firstChild.nodeValue){e=a[0].firstChild.nodeValue}else{e=(f==undefined)?"":f}return e},getChildValueAsString:function(a,c){var b=c||"";if(a){for(var d=a.firstChild;d;d=d.nextSibling){switch(d.nodeType){case 3:case 4:b+=d.nodeValue}}}return b},initialize:function(a){OpenLayers.Format.XML.prototype.initialize.apply(this,[a])},read:function(b){if(typeof b=="string"){b=OpenLayers.Format.XML.prototype.read.apply(this,[b])}if(b&&b.nodeType==9){b=b.documentElement}var a={capabilities:null};this.readNode(b,a);return a.capabilities},readNode:function(c,e){var b=c.localName||c.nodeName.split(":").pop();if(this.statsFunc){this.statsFunc(b)}if(!e){e={}}var d=this.readers[c.namespaceURI?this.namespaceAlias[c.namespaceURI]:this.defaultPrefix];if(!d){return e}var a=d[b]||d["*"];if(!a){return e}a.apply(this,[c,e]);return e},readChildNodes:function(c,d){if(!d){d={}}var b=c.childNodes;var a;for(var e=0,g=b.length;e<g;++e){a=b[e];if(a.nodeType!=1){continue}var j=this.readers[a.namespaceURI?this.namespaceAlias[a.namespaceURI]:this.defaultPrefix];if(!j){continue}var h=a.localName||a.nodeName.split(":").pop();var f=j[h]||j["*"];if(!f){continue}f.apply(this,[a,d])}return d},readers:{ows:{"*":function(a,b){this.readChildNodes(a,b)},ServiceProvider:function(d,e){var c=this.getChildValue(d,this.namespaces.ows,"ProviderName",null);
var b=this.getChildValue(d,this.namespaces.ows,"ProviderSite",null);var f=b?this.getAttributeNS(b,this.namespaces.xlink,"href"):null;var a=b?this.getAttributeNS(b,this.namespaces.xlink,"type"):null;if(!e.ows){e.ows={}}e.ows.ServiceProvider={ProviderName:c,ProviderSite:{linkHref:f,linkType:a}}},ServiceIdentification:function(b,c){var a=this.getChildValue(b,this.namespaces.ows,"Title",null);var d=this.getChildValue(b,this.namespaces.ows,"Abstract",null);if(!c.ows){c.ows={}}c.ows.ServiceIdentification={Title:a,Abstract:d}},OperationsMetadata:function(a,b){},Operation:function(a,b){},DCP:function(a,b){},Get:function(a,b){},Post:function(a,b){},Parameter:function(a,b){},Value:function(a,b){},Constraint:function(a,b){}},gml:OpenLayers.Format.GML.v3.prototype.readers.gml,wfs:{"*":function(a,b){this.readChildNodes(a,b)},WFS_Capabilities:function(c,e){var a={};var b=c.getAttribute("version");var d=c.getAttribute("updateSequence");a.version=b;a.updateSequence=d;this.readChildNodes(c,a);e.capabilities=a},FeatureTypeList:function(b,c){var a={featureTypes:[]};this.readChildNodes(b,a);c.featureTypeList=a},FeatureType:function(c,g){var a=g.featureTypes;var m=this.namespaces.wfs;var b=this.getChildValue(c,m,"Name");var h=this.getChildValue(c,m,"Title");var j=this.getChildValue(c,m,"Abstract");var d=this.getChildValue(c,m,"DefaultSRS");var e=b.split(":");var n=e[1];var i=e[0];var f=this.lookupNamespaceURI(c,i);var l={Name:b,Title:h,DefaultSRS:d,name:b,title:h,"abstract":j,featureTypeName:b,featureName:n,featurePrefix:i,featureNS:f};a.push(l)}},ogc:{Id_Capabilities:function(a,b){},Spatial_Capabilities:function(a,c){var b={};this.readChildNodes(a,b);c.Spatial_Capabilities=b},GeometryOperands:function(b,c){var a={};c.GeometryOperands=a},SpatialOperator:function(b,c){var a=b.getAttribute("name");c[a]=a},SpatialOperators:function(b,c){var a={};this.readChildNodes(b,a);c.SpatialOperators=a},Filter_Capabilities:function(b,c){var a={};this.readChildNodes(b,a);if(!c.ogc){c.ogc={}}c.ogc.Filter_Capabilities=a},"*":function(a,b){this.readChildNodes(a,b)}}},CLASS_NAME:"NLSFI.OpenLayers.Format.WFS.WFSCapabilities"}));Oskari.$("Oskari.NLSFI.OpenLayers.Filter.LogoFilter",OpenLayers.Class({wkt:null,format:null,feature:null,initialize:function(){this.wkt="POLYGON((359805.51580930536 6700903.887126887,359357.49955983716 6700755.88175961,359117.49085477553 6700527.8734911205,358909.48331041145 6700187.861160831,358833.4805538576 6699863.849410737,358885.4824400446 6699471.835194731,359001.4866476218 6699031.819237824,359245.4954978691 6698783.810244012,359569.5072497832 6698583.802990895,359973.5219033377 6698519.800669874,360361.53597649024 6698583.802990854,360737.5496143154 6698843.812419841,360937.5568684308 6699127.822719232,361077.56194628496 6699491.835919925,361085.562236367 6699911.8511514235,360941.5570133014 6700271.86420703,360741.5497590546 6700599.876102138,360349.53554079356 6700803.883500259,359873.5182757365 6700903.8871268835,358885.4824400216 6699579.839111333,359149.49201566214 6699571.838821218,359777.5147938048 6700431.870009586,359781.51493905747 6699599.839836584,359945.5208875227 6699603.839981678,359949.5210326455 6699403.832728575,360625.5455518594 6699419.833308745,359937.52059753076 6698751.809083476,359937.52059757215 6698547.801685277,359933.5204524923 6698535.801250075,361077.5619462582 6699631.84099702,359953.5211776948 6699615.8404168775,359897.51914624905 6700911.887416978,359805.51580930536 6700903.887126887))";this.format=new OpenLayers.Format.WKT();this.feature=this.format.read(this.wkt)},CLASS_NAME:"NLSFI.OpenLayers.Filter.LogoFilter"}));Oskari.clazz.define("Oskari.NLSFI.Worker.Scheduler",function(){this.workers=null;this.workersStats=null;this.t=null;this.tquit=false;this.queueInterval=250;this.queueSpeed=1000;this.lastErrors=[]},{errorHandler:function(a){window.alert(a.errorText)},stepHandler:function(a){},create:function(a){this.workers=a;this.workersStats=[];for(var b=0;b<this.workers.length;b++){this.workers[b].errorHandler=this.errorHandler;this.workersStats.push(this.workers[b].stats)}},pushWorker:function(a){a.errorHandler=this.errorHandler;
this.workers.push(a);this.workersStats.push(a.stats)},setQueueSpeed:function(a){this.queueSpeed=a},callbackFunc:function(){for(var d=0;d<this.workers.length;d++){var a=this.workers[d];if(a!=null){try{a.step()}catch(c){if(this.lastErrors.length>15){this.lastErrors.shift()}var b=new Date();var e={timestamp:b,errorText:b.toUTCString()+": "+c};this.lastErrors.push(e);this.errorHandler(e)}}}this.stepHandler(this.workersStats)},startWorker:function(){var a=this;this.t=setInterval(function(){a.callbackFunc()},this.queueInterval)},stopWorker:function(){this.tquit=true;if(this.t!=null){clearInterval(this.t)}},CLASS_NAME:"NLSFI.Worker.Scheduler"});Oskari.clazz.define("Oskari.NLSFI.Worker.WFSWorker",function(d){var b=d||{};var a={description:null,stats:null,workerCount:0,processedRequests:0,cancelledRequests:0,cancelledPending:0,cancelledOutOfView:0,cancelledExists:0,loadedSnapshot:0,unloadedSnapshot:0,errorsEncountered:0,hasGaugeChanged:true,statsDataFeatureCount:0,statsDataErrorCount:0,statsDataProcessTime:0,request:null,layer:null,statsFuncs:null,responseStats:null,requestFormat:null,responseFormat:null,map:null,mapProj:null,dataProj:null,url:null,strategy:null,tileQueue:null};var c={ns:null,nsPrefix:null,featureType:null,geometryName:null,featurePropertyNames:null};for(p in a){this[p]=a[p]}for(p in c){this[p]=c[p]}this.stats={queued:0,processed:0,totalt:0};this.statsFuncs={queueStatus:function(l,n,e,m,h,j,i,g,f){},requestStatus:function(g,e,h,f){},responseStatus:function(g,f,e){}};this.strategy=b.strategy;this.tileQueue=this.strategy.tileQueue;this.featureType=b.featureType;this.description=b.description||b.featureType;this.geometryName=b.geometryName;this.ns=b.featureNS;this.nsPrefix=b.featurePrefix;this.responseFormat=b.responseFormat},{create:function(b,a,c,e,d){this.layer=b;this.map=a;this.mapProj=c;this.dataProj=e;this.url=d;this.responseStats={requestTS:null,responseTS:null,processedTS:null};this.requestFormat=OpenLayers.Format.WFST({version:"1.1.0",featureType:this.featureType,geometryName:this.nsPrefix+":"+this.geometryName,featurePrefix:this.nsPrefix,featureNS:this.ns,srsName:this.dataProj.getCode()})},processResponse:function(e,d){this.responseStats.responseTS=new Date();var f=e.responseXML;if(!f||!f.documentElement){f=e.responseText}var c=this.responseFormat.read(f);this.layer.addFeatures(c);this.responseStats.processedTS=new Date();if(c&&c.length){this.statsDataFeatureCount+=c.length}var b=this.responseFormat.stats;if(b){var a=b.ERROR_COUNT?b.ERROR_COUNT:0;this.statsDataErrorCount+=a}this.statsFuncs.responseStatus(f,c,this.responseStats,b);if(d.callback&&d.scope){window.console.log("Worker Callback");OpenLayers.Function.bind(d.callback,d.scope)(d.args,c,e,d.request)}this.request=null;this.loadedSnapshot++;f=null;c=null},processJob:function(i){if(i==null){return}var r=i.feature;var a=i.bounds;var s=i.filter;var u=i.propertyNames||this.featurePropertyNames;var j=null;if(a==null&&r==null&&s==null){return}window.console.log("processJob...BBOX/FEAT/FILTER "+a);if(a!=null&&(isNaN(a.left)||isNaN(a.top)||isNaN(a.right)||isNaN(a.bottom))){return}var c=null;var l=null;if(u!=null&&u.length>0){j=[];var o=this.nsPrefix+":";var g="";for(var t=0;t<u.length;t++){var q=o+u[t];j.push(q);g+=q+"\n"}}var b=null;var d=null;if(a!=null){b=a.clone().transform(this.mapProj,this.dataProj);s=new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:b,projection:this.dataProj.getCode()});var e={filter:s,propertyNames:j};c=OpenLayers.Format.XML.prototype.write.apply(this.requestFormat,[this.requestFormat.writeNode("wfs:GetFeature",e)])}else{if(r!=null&&r.geometry!=null){var d=r.geometry.clone().transform(this.mapProj,this.dataProj);var h=i.filterType?i.filterType:OpenLayers.Filter.Spatial.INTERSECTS;if(h==OpenLayers.Filter.Spatial.BBOX){d=d.getBounds()}s=new OpenLayers.Filter.Spatial({type:h,value:d,projection:this.dataProj.getCode()});var e={filter:s,propertyNames:j};c=OpenLayers.Format.XML.prototype.write.apply(this.requestFormat,[this.requestFormat.writeNode("wfs:GetFeature",e)])}else{if(s!=null){var e={filter:s,propertyNames:j};
c=OpenLayers.Format.XML.prototype.write.apply(this.requestFormat,[this.requestFormat.writeNode("wfs:GetFeature",e)])}else{return}}}if(c!=null){}else{window.console.log("getFeatureObj == null");return}this.statsFuncs.requestStatus(s,c,b,d);if(this.request!=null){this.request.abort();this.request=null;this.cancelledRequests++}this.responseStats.requestTS=new Date();this.responseStats.responseTS=null;this.responseStats.processedTS=null;var f=this.url;var m=this;this.request=OpenLayers.Request.POST({url:this.url,success:function(n){m.processResponse(n,{callback:i.callback,scope:i.scope,args:i.args,request:c})},failure:this.processFailure,scope:this,data:c})},CLASS_NAME:"NLSFI.Worker.WFSWorker",setQueueSpeed:function(a){this.queueSpeed=a},step:function(){if(this.layer.getVisibility()==false){this.stats.queued=0;this.stats.processed=0;this.stats.totalt=0;return}if(this.queueSpeed==0){return}this.workerCount+=this.queueInterval;if(this.workerCount<this.queueSpeed){return}this.workerCount=0;if(this.request!=null){return}var c=this.tileQueue.getLength();var b=this.processedRequests;var a=c+b;this.stats.queued=c;this.stats.processed=b;this.stats.totalt=a;this.statsFuncs.queueStatus(c,b,this.cancelledRequests,this.cancelledPending,this.cancelledOutOfView,this.unloadedSnapshot,this.loadedSnapshot,this.errorsEncountered,a);var d=c;if(d==0){this.processedRequests=0;this.cancelledRequests=0;this.cancelledPending=0;this.cancelledOutOfView=0;this.cancelledExists=0;this.unloadedSnapshot=0;this.loadedSnapshot=0;return}window.console.log("Step..."+c);this.popJob()},errorHandler:function(a){window.alert(this.CLASS_NAME+":"+a)},popJob:function(){var a=this.tileQueue.popJob();if(a==null){return false}var b=a.tileFeature;if(b!=null){this.layer.destroyFeatures([b]);a.tileFeature=null}try{this.processJob(a)}catch(c){window.alert(c);this.errorsEncountered++}a.bounds=null;a=null;this.processedRequests++;this.hasGaugeChanged=true;return true},processFailure:function(b){this.request=null;this.responseStats.requestTS=new Date();this.responseStats.processedTS=this.responseStats.requestTS;this.errorsEncountered++;var a="PROTOCOL FAILURE";var c={errorText:a};this.errorHandler(c)}});Oskari.clazz.define("Oskari.poc.sade3.service.KTJkiiWFS",function(b,a){this.mapplet=b;this.url=a},{KiinteistorajanSijaintitiedot:function(c){var d=this.mapplet;var e={featureType:"KiinteistorajanSijaintitiedot",geometryName:"sijainti",featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs"};var a=this.url;var b=d.createWfsResponseLWQ(c,"Kiinteistörajat (KTJkii-WFS) Live",true,false,e,a);b.worker.featurePropertyNames=["sijainti"];b.layer.previewTile="kiinra";return b},PalstanTunnuspisteenSijaintitiedot:function(d){var e=this.mapplet;var f={featureType:"PalstanTunnuspisteenSijaintitiedot",geometryName:"tunnuspisteSijainti",featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs"};var a=this.url;var c=new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#800000",label:"${tekstiKartalla}",fontColor:"navy",fontSize:"8pt",fontFamily:"Sans Serif",fontWeight:"normal",labelAlign:"rt"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:0.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});var b=e.createWfsResponseLWQ(d,"Palstan tunnuspisteet (KTJkii-WFS) Live",true,false,f,a,c);b.strategy.minZoom=10;b.layer.previewTile="pts";return b},PalstanTietoja:function(d){var e=this.mapplet;var f={featureType:"PalstanTietoja",geometryName:"sijainti",featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs"};var a=this.url;var c=new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#800000",label:"${tekstiKartalla}",fontColor:"navy",fontSize:"8pt",fontFamily:"Sans Serif",fontWeight:"normal",labelAlign:"rt"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:0.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});
var b=e.createWfsResponseLWQ(d,"Palstan Tietoja (KTJkii-WFS) ",false,true,f,a,c);b.strategy.minZoom=10;b.layer.previewTile="pt";b.layer.setOpacity(0.7);return b},RekisteriyksikonTietoja:function(d){var e=this.mapplet;var f={featureType:"RekisteriyksikonTietoja",featureNS:"http://xml.nls.fi/ktjkiiwfs/2010/02",featurePrefix:"ktjkiiwfs"};var a=this.url;var c=new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#0000A0",fontColor:"navy",fontSize:"8pt",fontFamily:"Sans Serif",fontWeight:"normal",labelAlign:"rt"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:0.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});var b=e.createWfsResponseLWQ(d,"RekisteriyksikonTietoja (KTJkii-WFS)",false,true,f,a,c);b.worker.featurePropertyNames=["kiinteistotunnus","olotila","rekisteriyksikkolaji","rekisterointipvm","lakkaamispvm","nimi","maapintaala","vesipintaala","rekisteriyksikonPalstanTietoja"];b.strategy.minZoom=5;b.layer.previewTile="rt";b.layer.setOpacity(0.7);return b}});Oskari.clazz.define("Oskari.poc.sade3.service.NimistoWFS",function(b,a){this.mapplet=b;this.url=a},{});Oskari.clazz.define("Oskari.poc.sade3.service.RakennustiedotWFS",function(b,a){this.mapplet=b;this.url=a},{RakennuksenOminaisuustiedot:function(c){var d=this.mapplet;var e={featureType:"RakennuksenOminaisuustiedot",geometryName:"sijainti",featureNS:"http://xml.nls.fi/Rakennustiedot/VTJRaHu/2009/02",featurePrefix:"rhr"};var a=this.url;var b=d.createWfsResponseLWQ(c,"RakennuksenOminaisuustiedot (Rakennustiedot)",false,true,e,a);b.worker.featurePropertyNames=["sijainti","rakennustunnus","kiinteistotunnus","postinumero","osoite","tarkistusmerkki","rakennusnumero","tilanNimi","kiinteistoyksikonMaaraalatunnus","syntymahetkenRakennustunnus","rakennustunnuksenVoimassaolo","valmistumispaiva","rakennuspaikanHallintaperuste","kayttotarkoitus","kaytossaolotilanne","julkisivumateriaali","kerrosala","kerrosluku","kokonaisala","tilavuus","lammitystapa","lammonlahde","rakennusmateriaali","rakennustapa","sahko","kaasu","viemari","vesijohto","lamminvesi","aurinkopaneeli","hissi","ilmastointi","saunojenLukumaara","uimaaltaidenLukumaara","vaestosuojanKoko","viemariliittyma","vesijohtoliittyma","sahkoliittyma","kaasuliittyma","kaapeliliittyma","poikkeuslupa","perusparannus","perusparannuspaiva","sijaintiepavarmuus","luontiAika","muutosAika"];b.layer.previewTile="oso";return b},RakennuksenOsoitepiste:function(c){var d=this.mapplet;var e={featureType:"Osoitepiste",geometryName:"sijainti",featureNS:"http://xml.nls.fi/Osoitteet/Osoitepiste/2011/02",featurePrefix:"oso",otherFeatureTypes:[{typeName:"Osoite"}]};var a=this.url;var b=d.createWfsResponseLWQ(c,"Osoitepiste (Rakennustiedot)",false,true,e,a);b.worker.featurePropertyNames=["sijainti","rakennustunnus","kiinteistotunnus","kuntanimiFin","kuntanimiSwe","kuntatunnus","osoite"];b.layer.previewTile="oso";return b},RakennuksenOsoitenimi:function(c){var d=this.mapplet;var e={featureType:"Osoitenimi",geometryName:"sijainti",featureNS:"http://xml.nls.fi/Osoitteet/Osoitepiste/2011/02",featurePrefix:"oso",otherFeatureTypes:[{typeName:"Osoite"}]};var a=this.url;var b=d.createWfsResponseLWQ(c,"Osoitenimi (Rakennustiedot)",false,true,e,a);b.worker.featurePropertyNames=["sijainti","rakennustunnus","katunimi","katunumero","kieli","postinumero","kiinteistotunnus","kuntanimiFin","kuntanimiSwe","kuntatunnus"];b.layer.previewTile="oso";return b}});Oskari.clazz.define("Oskari.poc.sade3.service.MaastoWFS",function(b,a){this.mapplet=b;this.url=a},{MaastotietokannanOsoitepiste:function(c){var d=this.mapplet;var e={featureType:"Osoitepiste",geometryName:"sijainti",featureNS:"http://xml.nls.fi/Osoitteet/Osoitepiste/2011/02",featurePrefix:"oso",otherFeatureTypes:[{typeName:"Osoite"}]};var a=this.url;var b=d.createWfsResponseLWQ(c,"Osoitepiste (Rakennustiedot)",false,true,e,a);b.worker.featurePropertyNames=["sijainti","rakennustunnus","kiinteistotunnus","kuntanimiFin","kuntanimiSwe","kuntatunnus","osoite"];b.layer.previewTile="oso";
return b},MaastotietokannanOsoitenimi:function(c){var d=this.mapplet;var e={featureType:"Osoitenimi",geometryName:"sijainti",featureNS:"http://xml.nls.fi/Osoitteet/Osoitepiste/2011/02",featurePrefix:"oso",otherFeatureTypes:[{typeName:"Osoite"}]};var a=this.url;var b=d.createWfsResponseLWQ(c,"Osoitenimi (Rakennustiedot)",false,true,e,a);b.worker.featurePropertyNames=["sijainti","rakennustunnus","katunimi","katunumero","kieli","postinumero","kiinteistotunnus","kuntanimiFin","kuntanimiSwe","kuntatunnus"];b.layer.previewTile="oso";return b}});Oskari.clazz.define("Oskari.poc.sade3.SADEMapplet",function(a){this.mapControls=null;this.map=null;this.layersAndWorkers=null;this.mapProj=null;this.dataProj=null;this.googleProj=null;this.vlayer=null,this.layersAndWorkers={};this.dataProj=new OpenLayers.Projection("EPSG:3067");this.googleProj=new OpenLayers.Projection("EPSG:4326");this.urls=a.urls;return this},{setMap:function(a){this.map=a},setLayerManager:function(a){this.layerManager=a},createLayerImpl:function(b,a,c){return this.layerManager.createLayer(b,a,c)},createWfsResponseLWQ:function(h,b,a,d,l,c,i){var f={layer:null,worker:null,queue:null,strategy:null,lwqId:h,layerOptions:l};var m=i?i:new OpenLayers.StyleMap({"default":new OpenLayers.Style({pointRadius:3,strokeColor:"red",strokeWidth:2,fillColor:"#800000"}),tile:new OpenLayers.Style({strokeColor:"#008080",strokeWidth:5,fillColor:"#ffcc66",fillOpacity:0.5}),select:new OpenLayers.Style({fillColor:"#66ccff",strokeColor:"#3399ff"})});var e=Oskari.clazz.create("Oskari.NLSFI.OpenLayers.Strategy.TileQueue");var g={tileQueue:e};var j=[];f.queue=e;f.strategy=g;f.layer=this.createLayerImpl(h,d,m);f.worker=Oskari.clazz.create("Oskari.NLSFI.Worker.WFSWorker",{strategy:g,featureType:l.featureType,geometryName:l.geometryName,featureNS:l.featureNS,featurePrefix:l.featurePrefix,responseFormat:l.responseFormat,featureTypeSchema:l.featureTypeSchema,otherFeatureTypes:l.otherFeatureTypes,responseFormat:new (Oskari.$("Oskari.NLSFI.OpenLayers.Format.GML.WFSResponse"))({featureNS:l.featureNS,featureType:l.featureType,geometryName:l.geometryName,featurePrefix:l.featurePrefix,externalProjection:this.dataProj,internalProjection:this.mapProj,featureTypeSchema:l.featureTypeSchema,otherFeatureTypes:l.otherFeatureTypes,extractAttributes:true})});f.worker.description=b;f.worker.create(f.layer,this.map,this.mapProj,this.dataProj,c);this.layersAndWorkers[h]=f;return f},CLASS_NAME:"SADEMapplet"});Oskari.clazz.define("Oskari.poc.sade3.SadeWorker",function(a){this.opts=a||{};this.urls=this.opts.urls;this.mapplet=Oskari.clazz.create("Oskari.poc.sade3.SADEMapplet",a);this.scheduler=Oskari.clazz.create("Oskari.NLSFI.Worker.Scheduler");this.scheduler.queueInterval=1000;this.scheduler.errorHandler=function(b){console.log(b)};this.scheduler.statsFuncs={queueStatus:function(h,j,b,i,e,g,f,d,c){mediator.log(""+h+"/"+j)},requestStatus:function(d,b,e,c){mediator.log("REQUEST "+b)},responseStatus:function(d,c,b){mediator.log("RESPONSE ")}};this.scheduler.create([]);this.workerLayers={};this.services={};this.adapters={}},{log:function(a){},start:function(){this.scheduler.queueInterval=500;this.scheduler.setQueueSpeed(2000);this.scheduler.startWorker()},stop:function(){this.scheduler.stopWorker()},setupMap:function(a){this.mapplet.createAsPorttiKarttaikkuna(a);this.mapplet.createSijaintirajausLayer()},setAdapter:function(b,a){this.adapters[b]=a},setupWorkers:function(){var a=this.opts;var d=this;var e=this.mapplet;var g=[];var h=Oskari.clazz.create("Oskari.poc.sade3.service.KTJkiiWFS",e,this.urls.KTJkiiWFS);this.services.KTJkiiWFS=h;g.push(h.PalstanTunnuspisteenSijaintitiedot("ktj_pts"));g.push(h.KiinteistorajanSijaintitiedot("ktj_ks"));g.push(h.RekisteriyksikonTietoja("ktj_rt"));g.push(h.PalstanTietoja("ktj_pt"));var f=Oskari.clazz.create("Oskari.poc.sade3.service.RakennustiedotWFS",e,this.urls.RakennustiedotWFS);this.services.RakennustiedotWFS=f;g.push(f.RakennuksenOsoitepiste("rhr_osoitepiste"));g.push(f.RakennuksenOminaisuustiedot("rhr_rakennuksen_ominaisuustiedot"));g.push(f.RakennuksenOsoitenimi("rhr_osoitenimi"));var i=Oskari.clazz.create("Oskari.poc.sade3.service.MaastoWFS",e,this.urls.MaastoWFS);
this.services.MaastoWFS=i;g.push(i.MaastotietokannanOsoitepiste("mtk_osoitepiste"));g.push(i.MaastotietokannanOsoitenimi("mtk_osoitenimi"));var j=this.scheduler;for(var c=0;c<g.length;c++){var b=g[c];this.workerLayers[b.lwqId]=b;j.pushWorker(b.worker)}},searchCUByQualifiedIdentifier:function(f,g){var e=g||{};var c="ktj_rt";var a=this.workerLayers[c];var d=a.layerOptions;var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"ktjkiiwfs:kiinteistotunnus",value:f});a.queue.pushJob({filter:b,callback:this.requestProcessedCallback,scope:this,args:{lwq:a,zoomToExtent:e.zoomToExtent}})},searchCUUnitByBounds:function(f,e){var d=e||{};var b="ktj_pt";var a=this.workerLayers[b];var c=a.layerOptions;a.queue.pushJob({bounds:f,callback:this.bboxRequestProcessedCallback,scope:this,args:{lwq:a,zoomToExtent:d.zoomToExtent}})},searchCUAddressByQualifiedIdentifier:function(f,g){var e=g||{};var c="rhr_osoitepiste";var a=this.workerLayers[c];var d=a.layerOptions;var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"oso:kiinteistotunnus",value:f});a.queue.pushJob({filter:b,callback:this.requestProcessedCallback,scope:this,args:{lwq:a}})},searchCUBuildingsByQualifiedIdentifier:function(e){var c="rhr_rakennuksen_ominaisuustiedot";var a=this.workerLayers[c];var d=a.layerOptions;var b=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"rhr:kiinteistotunnus",value:e});a.queue.pushJob({filter:b,callback:this.requestProcessedCallback,scope:this,args:{lwq:a}})},searchAnyByLonLat:function(d,e,c,a){var b=new OpenLayers.Bounds();b.extend(new OpenLayers.LonLat(d.lon-0.5,d.lat-0.5));b.extend(new OpenLayers.LonLat(d.lon+0.5,d.lat+0.5));this.searchCUUnitByBounds(b,a)},searchAnyByCUQualifiedIdentifier:function(a,b){this.searchCUByQualifiedIdentifier(a,b);this.searchCUAddressByQualifiedIdentifier(a,b);this.searchCUBuildingsByQualifiedIdentifier(a,b)},searchCUByBuildingAddress:function(f,i,d,g){var b=g||{};var h="mtk_osoitenimi";var e=this.workerLayers[h];var j=e.layerOptions;var a=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"oso:katunimi",value:f});var l=new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"oso:katunumero",value:i});var c=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[a,l]});e.queue.pushJob({filter:c,callback:this.requestProcessedCallback,scope:this,args:{lwq:e,zoomToExtent:b.zoomToExtent}})},requestProcessedCallback:function(c,e,g,f){var d=this.mapplet;var a=c.lwq;var b=this.adapters[a.lwqId];if(b){b(c,e,g,f)}},bboxRequestProcessedCallback:function(c,e,g,f){var d=this.mapplet;var a=c.lwq;var b=this.adapters[a.lwqId];if(b){b(c,e,g,f)}},clearWorkerLayers:function(){for(p in this.workerLayers){var a=this.workerLayers[p];a.layer.destroyFeatures(a.layer.features)}},reset:function(){this.clearWorkerLayers()}});Oskari.clazz.define("Oskari.poc.sade3.SadeLocale",function(a){this.lang=a},{def:{},getLang:function(){return this.lang},get:function(a,b){return(this[a][b]||this.def)[this.lang]||(this.context+"_"+b+" "+this.lang+"???")},app:{map:{fi:{title:"Kartta"}}}});Oskari.clazz.define("Oskari.poc.sade3.Mediator",function(){if(!Ext.ClassManager.get("RakennuksenOminaisuustiedot")){Ext.define("RakennuksenOminaisuustiedot",{extend:"Ext.data.Model",fields:[{name:"rakennustunnus"},{name:"kiinteistotunnus"},{name:"tarkistusmerkki"},{name:"rakennusnumero"},{name:"tilanNimi"},{name:"kiinteistoyksikonMaaraalatunnus"},{name:"syntymahetkenRakennustunnus"},{name:"postinumero"},{name:"rakennustunnuksenVoimassaolo"},{name:"valmistumispaiva"},{name:"rakennuspaikanHallintaperuste"},{name:"kayttotarkoitus"},{name:"kaytossaolotilanne"},{name:"julkisivumateriaali"},{name:"kerrosala"},{name:"kerrosluku"},{name:"kokonaisala"},{name:"tilavuus"},{name:"lammitystapa"},{name:"lammonlahde"},{name:"rakennusmateriaali"},{name:"rakennustapa"},{name:"sahko"},{name:"kaasu"},{name:"viemari"},{name:"vesijohto"},{name:"lamminvesi"},{name:"aurinkopaneeli"},{name:"hissi"},{name:"ilmastointi"},{name:"saunojenLukumaara"},{name:"uimaaltaidenLukumaara"},{name:"vaestosuojanKoko"},{name:"viemariliittyma"},{name:"vesijohtoliittyma"},{name:"sahkoliittyma"},{name:"kaasuliittyma"},{name:"kaapeliliittyma"},{name:"poikkeuslupa"},{name:"perusparannus"},{name:"perusparannuspaiva"},{name:"sijaintiepavarmuus"},{name:"luontiAika"},{name:"muutosAika"}]})
}var a=Ext.create("Ext.data.Store",{model:"RakennuksenOminaisuustiedot",autoLoad:false,proxy:{type:"memory",reader:{type:"json",model:"RakennuksenOminaisuustiedot",totalProperty:"total",successProperty:"success",idProperty:"id",root:"data",messageProperty:"message"}}});this["RakennuksenOminaisuustiedot"]=a},{getStore:function(a){return this[a]},reset:function(){this.getStore("RakennuksenOminaisuustiedot").removeAll()}});Oskari.clazz.define("Oskari.poc.sade3.SadeFormView",function(a){this.component=null;this.ui=a;this.tabs={};this.grids={};this.fields={};this.modhost={}},{samples:[["17842000070103","17842000070103"],["09101700160001","09101700160001"]],createFields:function(c,d){var a=c.getApp().getSandbox();var b={focus:function(e){a.request("SearchModule",a.getRequestBuilder("DisableMapKeyboardMovementRequest")())},blur:function(e){a.request("SearchModule",a.getRequestBuilder("EnableMapKeyboardMovementRequest")())}};this.fields.tf_CU_identifier=Ext.create("Ext.form.field.Text",{xtype:"textfield",fieldLabel:"( 91-17-16-1 )",name:"cuidentifier",anchor:"95%",allowBlank:false,value:"",store:this.samples,typeAhead:true,forceSelection:true,triggerAction:"all",emptyText:"Kiinteistötunnus...",selectOnFocus:true,listeners:b});this.fields.tf_CU_name=Ext.create("Ext.form.field.Text",{xtype:"textfield",fieldLabel:"Nimi",name:"cuname",anchor:"95%",value:"",disabled:true});this.fields.tf_CU_registered=Ext.create("Ext.form.field.Text",{xtype:"textfield",fieldLabel:"Rekisteröintipvm",name:"curegistered",anchor:"95%",value:"",disabled:true});this.fields.tf_CU_type=Ext.create("Ext.form.field.Text",{xtype:"textfield",fieldLabel:"Rekisteriyksikkölaji",name:"cutype",anchor:"95%",value:"",disabled:true});this.fields.tf_CU_area_land=Ext.create("Ext.form.field.Text",{xtype:"textfield",fieldLabel:"Maapinta-ala",name:"cutype",anchor:"95%",value:"",disabled:true});this.fields.tf_CU_area_sea=Ext.create("Ext.form.field.Text",{xtype:"textfield",fieldLabel:"Vesipinta-ala",name:"cutype",anchor:"95%",value:"",disabled:true});this.fields.tf_address=Ext.create("Ext.form.field.Text",{fieldLabel:"Katunimi",name:"address",allowBlank:false,value:"",listeners:b});this.fields.tf_address_no=Ext.create("Ext.form.field.Text",{fieldLabel:"Katunumero",name:"address_no",allowBlank:false,value:"",listeners:b});this.fields.tf_postalcode=Ext.create("Ext.form.field.Text",{fieldLabel:"Postinumero",name:"zipcode",disabled:true,value:"",allowBlank:false})},createTab1:function(b,c){var a=this;return Ext.create("Ext.form.Panel",{anchor:"100% 15%",region:"center",labelAlign:"top",title:"Perustiedot",layout:"column",border:false,items:[{columnWidth:0.35,border:false,items:[Ext.create("Ext.form.field.Text",{fieldLabel:"Henkilötunnus",allowBlank:false,disabled:true}),{border:false,html:"(Ei WFS -palvelua)"}]},{columnWidth:0.35,border:false,items:[Ext.create("Ext.form.field.Text",{fieldLabel:"Nimi",disabled:true})]},{columnWidth:0.3,border:false,items:[{xtype:"button",text:"Tallenna",handler:function(){alert("OK")}},{xtype:"button",text:"Tyhjennö",handler:function(){a.reset();b.getApp().getWorker().reset();b.getApp().getMediator().reset()}}]}]})},createTab2:function(h,f){var g=this;var d=this.fields.tf_CU_identifier;var i=this.fields.tf_CU_name;var b=this.fields.tf_CU_registered;var e=this.fields.tf_CU_type;var c=this.fields.tf_CU_area_land;var a=this.fields.tf_CU_area_sea;return Ext.create("Ext.form.Panel",{bodyFrame:false,bodyCls:"formpart",anchor:"100% 30%",region:"north",height:256,labelAlign:"top",title:"Rekisteriyksikön tietoja",layout:"column",border:false,items:[{columnWidth:0.66,border:false,items:[d,b,e,i,c,a]},{columnWidth:0.33,border:false,items:[{xtype:"button",text:"Valitse kartalta",handler:function(){var j=h.getApp().getLayerManager().highlightMapLayer()}},{xtype:"button",text:"Hae sijaintitiedot",handler:function(){h.getApp().getWorker().searchAnyByCUQualifiedIdentifier(d.getValue(),{zoomToExtent:true})}},{xtype:"button",text:"Hae kiinteistörekisteriote",handler:function(){var j=d.getValue();if(!j||j==""){return}var l="http://kb109.nls.fi:4021/cocoon-2.1.8/rekisteriotepalvelu/tietovarasto/palvelu/rekisteriote/kiinteistorekisterin_tietoja/tuloste.pdf?kiinteistotunnus="+j;
var m=window.open(l,"name","height=640,width=640,resizable=yes")}},{border:false,html:'<a href="http://sosuli.nls.fi/catalogue/ui/index.html?queryType=instancesByCompositionExternalId&cxid=9fa9e554-93dc-4789-bab6-7c7728c10298" target="_blank">KTJkii WFS-palvelun Skeema</a>'}]}]})},createTab3:function(d,e){var c=this;var a=this.fields.tf_address;var b=this.fields.tf_address_no;var f=this.fields.tf_postalcode;return Ext.create("Ext.form.Panel",{bodyFrame:false,bodyCls:"formpart",anchor:"100% 40%",region:"center",labelAlign:"top",title:"Rakennuksen Osoitetiedot",layout:"column",border:false,items:[{columnWidth:0.66,border:false,items:[a,b,f]},{columnWidth:0.33,border:false,items:[{xtype:"button",text:"Hae tiedot (WFS)",handler:function(){d.getApp().getWorker().searchCUByBuildingAddress(a.getValue(),b.getValue(),f.getValue(),{zoomToExtent:false})}},{border:false,html:"Maastotietokannassa ei ole kiinteistötunnusta, joten linkitys kiinteistörekisteriin sijainnin perusteella"}]}]})},createModulesHostPanel:function(a){return Ext.create("Ext.tab.Panel",{region:"center",items:[]})},getModulesHost:function(){return this.modhost},createView:function(d){var f=d.getLocale().get("app","map");this.createFields(d);this.grids.RakennuksenOminaisuustiedot=this.createGrid(d);this.tabs.tab2=this.createTab2(d,f);this.tabs.tab3=this.createTab3(d,f);var c=this;var b=this.createModulesHostPanel(d);this.modhost=b;b.add(this.tabs.tab2);var e=Ext.create("Ext.panel.Panel",{title:"Rakennustiedot",region:"south",layout:"anchor",align:"stretch",items:[this.tabs.tab3,this.grids.RakennuksenOminaisuustiedot]});b.add(e);var a=Ext.create("Ext.panel.Panel",{region:"center",layout:"border",items:[b],bodyBorder:false,border:0,bodyCls:"webformcontainer"});this.component=Ext.create("Ext.panel.Panel",{layout:"border",height:600,width:500,bodyBorder:false,border:0,bodyCls:"formpart",items:[a],bbar:[{xtype:"button",text:"Lähetä lomake",handler:function(){Ext.MessageBox.show({title:"Tallennetaan",msg:"...",progressText:"...",width:300,progress:true,closable:false,icon:"logo",modal:false});window.setTimeout(function(){Ext.MessageBox.hide()},500)}},{xtype:"button",text:"Sulje lomake",handler:function(){d.hideUserInterface()}},Ext.create("Ext.ProgressBar",{width:256})]});return this.component},reset:function(){var e=this.fields.tf_CU_identifier;var i=this.fields.tf_CU_name;var a=this.fields.tf_CU_registered;var g=this.fields.tf_CU_type;var c=this.fields.tf_CU_area_land;var b=this.fields.tf_CU_area_sea;var h=this.fields.tf_address;var d=this.fields.tf_address_no;var f=this.fields.tf_postalcode;e.setValue("");i.setValue("");a.setValue("");g.setValue("");c.setValue("");b.setValue("");h.setValue("");d.setValue("");f.setValue("");this.grids.RakennuksenOminaisuustiedot.getStore().removeAll()},setAddress:function(d){var a=this.fields.tf_address;var b=this.fields.tf_address_no;var c=this.fields.tf_postalcode;a.setValue(d.katunimi||"");b.setValue(d.katunumero||"");c.setValue(d.postinumero||"")},setCU:function(g){var d=this.fields.tf_CU_identifier;var c=this.fields.tf_CU_name;var b=this.fields.tf_CU_registered;var f=this.fields.tf_CU_type;var e=this.fields.tf_CU_area_land;var a=this.fields.tf_CU_area_sea;d.setValue(g.kiinteistotunnus);c.setValue(g.nimi);b.setValue(g.rekisterointipvm);f.setValue(g.rekisteriyksikkolaji);e.setValue(g.maapintaala);a.setValue(g.vesipintaala)},createGrid:function(a){return Ext.create("Ext.grid.Panel",{bodyBorder:false,border:0,bodyCls:"formpart",autoScroll:true,stripeRows:true,anchor:"100% 60%",title:"Rekisteriyksikön rakennustiedot",viewConfig:{forceFit:true},store:a.getApp().getMediator().getStore("RakennuksenOminaisuustiedot"),columns:[{header:"rakennustunnus",dataIndex:"rakennustunnus"},{hidden:true,header:"kiinteistotunnus",dataIndex:"kiinteistotunnus"},{hidden:true,header:"tarkistusmerkki",dataIndex:"tarkistusmerkki"},{header:"rakennusnumero",dataIndex:"rakennusnumero"},{header:"luontiAika",dataIndex:"luontiAika"},{header:"muutosAika",dataIndex:"muutosAika"},{header:"tilanNimi",dataIndex:"tilanNimi"},{hidden:true,header:"kiinteistoyksikonMaaraalatunnus",dataIndex:"kiinteistoyksikonMaaraalatunnus"},{hidden:true,header:"syntymahetkenRakennustunnus",dataIndex:"syntymahetkenRakennustunnus"},{hidden:true,header:"postinumero",dataIndex:"postinumero"},{hidden:true,header:"rakennustunnuksenVoimassaolo",dataIndex:"rakennustunnuksenVoimassaolo"},{hidden:true,header:"valmistumispaiva",dataIndex:"valmistumispaiva"},{hidden:true,header:"rakennuspaikanHallintaperuste",dataIndex:"rakennuspaikanHallintaperuste"},{hidden:true,header:"kayttotarkoitus",dataIndex:"kayttotarkoitus"},{hidden:true,header:"kaytossaolotilanne",dataIndex:"kaytossaolotilanne"},{hidden:true,header:"julkisivumateriaali",dataIndex:"julkisivumateriaali"},{hidden:true,header:"kerrosala",dataIndex:"kerrosala"},{hidden:true,header:"kerrosluku",dataIndex:"kerrosluku"},{hidden:true,header:"kokonaisala",dataIndex:"kokonaisala"},{hidden:true,header:"tilavuus",dataIndex:"tilavuus"},{hidden:true,header:"lammitystapa",dataIndex:"lammitystapa"},{hidden:true,header:"lammonlahde",dataIndex:"lammonlahde"},{hidden:true,header:"rakennusmateriaali",dataIndex:"rakennusmateriaali"},{hidden:true,header:"rakennustapa",dataIndex:"rakennustapa"},{hidden:true,header:"sahko",dataIndex:"sahko"},{hidden:true,header:"kaasu",dataIndex:"kaasu"},{hidden:true,header:"viemari",dataIndex:"viemari"},{hidden:true,header:"vesijohto",dataIndex:"vesijohto"},{hidden:true,header:"lamminvesi",dataIndex:"lamminvesi"},{hidden:true,header:"aurinkopaneeli",dataIndex:"aurinkopaneeli"},{hidden:true,header:"hissi",dataIndex:"hissi"},{hidden:true,header:"ilmastointi",dataIndex:"ilmastointi"},{hidden:true,header:"saunojenLukumaara",dataIndex:"saunojenLukumaara"},{hidden:true,header:"uimaaltaidenLukumaara",dataIndex:"uimaaltaidenLukumaara"},{hidden:true,header:"vaestosuojanKoko",dataIndex:"vaestosuojanKoko"},{hidden:true,header:"viemariliittyma",dataIndex:"viemariliittyma"},{hidden:true,header:"vesijohtoliittyma",dataIndex:"vesijohtoliittyma"},{hidden:true,header:"sahkoliittyma",dataIndex:"sahkoliittyma"},{hidden:true,header:"kaasuliittyma",dataIndex:"kaasuliittyma"},{hidden:true,header:"kaapeliliittyma",dataIndex:"kaapeliliittyma"},{hidden:true,header:"poikkeuslupa",dataIndex:"poikkeuslupa"},{hidden:true,header:"perusparannus",dataIndex:"perusparannus"},{hidden:true,header:"perusparannuspaiva",dataIndex:"perusparannuspaiva"},{hidden:true,header:"sijaintiepavarmuus",dataIndex:"sijaintiepavarmuus"}]})
}});Oskari.clazz.define("Oskari.poc.sade3.SadeUI",function(){this.form=Oskari.clazz.create("Oskari.poc.sade3.SadeFormView");this.ui=null;this.app=null;this.panel=null;this.mapAdapter=null},{getFormView:function(){return this.form},getLocale:function(){return this.app.getLocale()},setApp:function(b){this.app=b},getApp:function(){return this.app},setMapAdapter:function(a){return this.mapAdapter=a},getUserInterface:function(){return this.ui},setUserInterface:function(a){this.ui=a},createUserInterface:function(b){var a=this.form.createView(this);this.panel=a;var c=Ext.create("Ext.panel.Panel",{hideMode:"offsets",floating:true,shadow:"sides",frame:false,autoShow:false,preventHeader:true,width:768,height:480,x:40+120,y:96,closable:false,resizable:true,resizeHandles:"se",bodyBorder:false,layout:"fit",border:0,items:[a],bodyCls:"webform",items:[a],listeners:b});this.ui=c},showUserInterface:function(){this.ui.show()},hideUserInterface:function(){this.ui.hide()},setAddress:function(a){this.form.setAddress(a)},setCU:function(a){this.form.setCU(a)},reset:function(){this.form.reset();this.clearFeaturesFromMap()},zoomTo:function(c,a,b){if(this.mapAdapter){this.mapAdapter.zoomTo(c,a,b)}},clearFeaturesFromMap:function(a){if(this.mapAdapter){this.mapAdapter.clearFeatures(a)}}});Oskari.clazz.define("Oskari.poc.sade3.Adapter",function(c,b){var a=c.getWorker();a.setAdapter("rhr_osoitepiste",function(d,e,h,g){if(e&&e.length>0){for(var i=0;i<e.length;i++){var f=e[i];if(f.attributes.featType!="Osoite"){continue}b.setAddress(f.attributes);break}}});a.setAdapter("rhr_rakennuksen_ominaisuustiedot",function(l,h,f,j){var m=c.getMediator().getStore("RakennuksenOminaisuustiedot");m.removeAll(true);var g=0;if(h&&h.length>0){for(var e=0;e<h.length;e++){var i=h[e];if(i.attributes.featType!="RakennuksenOminaisuustiedot"){continue}var d=Ext.create("RakennuksenOminaisuustiedot",i.attributes);d.setId(++g);m.add(d)}}});a.setAdapter("ktj_rt",function(d,e,h,g){if(e&&e.length>0){var f=e[0];b.setCU(f.attributes);var i=f.geometry.getBounds().getCenterLonLat();b.zoomTo(i.lon,i.lat)}});a.setAdapter("ktj_pt",function(d,e,h,g){var j=null;if(e&&e.length==1){var f=e[0];j=f.attributes.rekisteriyksikonKiinteistotunnus;b.setCU({kiinteistotunnus:j});var i=f.geometry.getBounds().getCenterLonLat();b.zoomTo(i.lon,i.lat)}if(!j){return}a.searchAnyByCUQualifiedIdentifier(j)});a.setAdapter("rhr_osoitenimi",function(d,e,h,g){var i=null;if(e&&e.length>0){for(var j=0;j<e.length;j++){var f=e[j];b.setAddress(f.attributes);i=f.attributes.kiinteistotunnus}}if(!i){return}a.searchAnyByCUQualifiedIdentifier(i,{zoomToExtent:true})});a.setAdapter("mtk_osoitenimi",function(d,e,h,g){var j=null;if(e&&e.length>0){for(var l=0;l<e.length;l++){var f=e[l];b.setAddress(f.attributes);var i=new OpenLayers.LonLat(f.geometry.x,f.geometry.y);a.searchAnyByLonLat(i,null,null,{zoomToExtent:true});break}}})},{});