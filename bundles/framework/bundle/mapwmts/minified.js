/**
 * Let's add missing TileMatrixLimits support 
 * (c) 2011-11 NLSFI 
 */

/* Copyright (c) 2006-2011 by OpenLayers Contributors (see authors.txt for 
 * full list of contributors). Published under the Clear BSD license.  
 * See http://svn.openlayers.org/trunk/openlayers/license.txt for the
 * full text of the license. */

/**
 * Let's fix missing tileMatrixSetLimits handling for WMTS layers. (c) 2011-11
 * NLSFI
 */

/*
 * Copyright (c) 2006-2011 by OpenLayers Contributors (see authors.txt for full
 * list of contributors). Published under the Clear BSD license. See
 * http://svn.openlayers.org/trunk/openlayers/license.txt for the full text of
 * the license.
 */

Oskari.clazz.define("Oskari.mapframework.wmts.mapmodule.plugin.WmtsLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this._wmtsLayerClazz=Oskari.clazz.create("Oskari.openlayers.Patch.layer.WMTS"),this.config=e},{__name:"WmtsLayerPlugin",getName:function(){return this.pluginName},getMap:function(){return this._map},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},register:function(){this.getMapModule().setLayerPlugin("WmtsLayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("WmtsLayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),n=e.getService("Oskari.mapframework.service.MapLayerService");if(n){n.registerLayerModel("wmtslayer","Oskari.mapframework.wmts.domain.WmtsLayer");var r=Oskari.clazz.create("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder");n.registerLayerModelBuilder("wmtslayer",r)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p)},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(e){},stop:function(e){},eventHandlers:{AfterMapLayerAddEvent:function(e){this.afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this.afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this.afterChangeMapLayerOpacityEvent(e)},AfterChangeMapLayerStyleEvent:function(e){this.afterChangeMapLayerStyleEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){var t=this._sandbox;for(var n=0;n<e.length;n++){var r=e[n],i=r.getId();if(!r.isLayerOfType("WMTS"))continue;t.printDebug("preselecting "+i),this.addMapLayerToMap(r,!0,r.isBaseLayer())}},afterMapLayerAddEvent:function(e){this.addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},addMapLayerToMap:function(e,t,n){if(!e.isLayerOfType("WMTS"))return;var r=this,i=r.getMap(),s=e.getWmtsMatrixSet().matrixIds,o=e.getWmtsLayerDef(),u=null;e.isBaseLayer()||e.isGroupLayer()?u="basemap_"+e.getId():u="layer_"+e.getId();var a=this._sandbox,f=e.getWmtsUrls()[0],l=e.getWmtsMatrixSet(),c={visibility:!0,transparent:!0,format:"image/png",url:f,layer:e.getWmtsName(),style:e.getCurrentStyle().getName(),matrixIds:l.matrixIds,matrixSet:l.identifier,isBaseLayer:e.isBaseLayer(),buffer:0,minScale:e.getMinScale(),maxScale:e.getMaxScale()};a.printDebug("[WmtsLayerPlugin] creating WMTS Layer "+l.identifier+" / "+c.id+"/"+c.layer+"/"+c.url);var h=OpenLayers.Util.applyDefaults(c,{url:f,name:u,style:e.getCurrentStyle().getName(),matrixIds:l.matrixIds,layerDef:o}),p=this._wmtsLayerClazz.getPatch(),d=new p(h);d.opacity=e.getOpacity()/100,a.printDebug("[WmtsLayerPlugin] created WMTS layer "+d),i.addLayers([d])},afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();this.removeMapLayerFromMap(t)},removeMapLayerFromMap:function(e){if(!e.isLayerOfType("WMTS"))return;if(e.isBaseLayer()||e.isGroupLayer()){var t="";if(e.getSubLayers().length>0)for(var n=0;n<e.getSubLayers().length;n++){var r=this._map.getLayersByName("basemap_"+e.getSubLayers()[n].getId());r[0].destroy()}else{var r=this._map.getLayersByName("layer_"+e.getId());r[0].destroy()}}else{var r=this._map.getLayersByName("layer_"+e.getId());r[0].destroy()}},getOLMapLayers:function(e){if(!e.isLayerOfType("WMTS"))return null;if(!e.isBaseLayer()&&!e.isGroupLayer())return this._map.getLayersByName("layer_"+e.getId());var t="";if(e.getSubLayers().length>0){for(var n=0;n<e.getSubLayers().length;n++)return this._map.getLayersByName("basemap_"+e.getSubLayers()[n].getId());return null}return this._map.getLayersByName("layer_"+e.getId())},afterChangeMapLayerOpacityEvent:function(e){var t=e.getMapLayer();if(!t.isLayerOfType("WMTS"))return;if(t.isBaseLayer()||t.isGroupLayer())if(t.getSubLayers().length>0)for(var n=0;n<t.getSubLayers().length;n++){var r=this._map.getLayersByName("basemap_"+t.getSubLayers()[n].getId());r[0].setOpacity(t.getOpacity()/100)}else{var r=this._map.getLayersByName("layer_"+t.getId());r[0]!=null&&r[0].setOpacity(t.getOpacity()/100)}else{this._sandbox.printDebug("Setting Layer Opacity for "+t.getId()+" to "+t.getOpacity());var r=this._map.getLayersByName("layer_"+t.getId());r[0]!=null&&r[0].setOpacity(t.getOpacity()/100)}},afterChangeMapLayerStyleEvent:function(e){var t=e.getMapLayer();if(!t.isLayerOfType("WMTS"))return;if(!t.isBaseLayer()){var n=this._map.getLayersByName("layer_"+t.getId());n!=null&&n[0].mergeNewParams({styles:t.getCurrentStyle().getName()})}}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/mapwmts/plugin/wmtslayer/WmtsLayerPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.wmts.domain.WmtsLayer",function(){this._WmtsLayerName=null,this._WmtsMatrixSet=null,this._WmtsUrls=[],this._layerType="WMTS"},{setWmtsName:function(e){this._WmtsName=e},getWmtsName:function(){return this._WmtsName},setWmtsMatrixSet:function(e){this._WmtsMatrixSet=e},getWmtsMatrixSet:function(){return this._WmtsMatrixSet},setWmtsLayerDef:function(e){this._WmtsLayerDef=e},getWmtsLayerDef:function(){return this._WmtsLayerDef},addWmtsUrl:function(e){this._WmtsUrls.push(e)},getWmtsUrls:function(){return this._WmtsUrls}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),define("bundles/framework/bundle/mapwmts/domain/WmtsLayer",function(){}),Oskari.clazz.define("Oskari.mapframework.wmts.service.WMTSLayerService",function(e){this.mapLayerService=e,this.capabilities={},this.capabilitiesClazz=Oskari.clazz.create("Oskari.openlayers.Patch.WMTSCapabilities_v1_0_0")},{setCapabilities:function(e,t){this.capabilities[e]=t},getCapabilities:function(e){return this.capabilities[e]},readWMTSCapabilites:function(e,t,n){var r=this,i=this.capabilitiesClazz.getPatch(),s=new i;OpenLayers.Request.GET({url:t,params:{SERVICE:"WMTS",VERSION:"1.0.0",REQUEST:"GetCapabilities"},success:function(t){var i=t.responseXML;if(!i||!i.documentElement)i=t.responseText;var o=s.read(i);r.setCapabilities(e,o),r.parseCapabilitiesToLayers(e,o,n)},failure:function(){alert("Trouble getting capabilities doc"),OpenLayers.Console.error.apply(OpenLayers.Console,arguments)}})},parseCapabilitiesToLayers:function(e,t,n){var r=this,i=this.mapLayerService,s=null;t.operationsMetadata.GetTile.dcp.http.getArray?s=t.operationsMetadata.GetTile.dcp.http.getArray:s=t.operationsMetadata.GetTile.dcp.http.get;var o=t.contents.layers,u=t.contents,n=u.tileMatrixSets[n];for(var a=0;a<o.length;a++){var f=o[a],l=f.identifier,c=f.identifier,h={wmtsName:l,descriptionLink:"",orgName:"WMTS",type:"wmtslayer",legendImage:"",formats:{value:"text/html"},isQueryable:!0,minScale:1024e4,style:"",dataUrl:"",name:l,opacity:100,inspire:"WMTS",maxScale:1},p=Oskari.clazz.create("Oskari.mapframework.wmts.domain.WmtsLayer");p.setAsNormalLayer(),p.setId(l),p.setName(h.name),p.setWmtsName(h.wmtsName),p.setOpacity(h.opacity),p.setMaxScale(h.maxScale),p.setMinScale(h.minScale),p.setDescription(h.info),p.setDataUrl(h.dataUrl),p.setOrganizationName(h.orgName),p.setInspireName(h.inspire),p.setWmtsMatrixSet(n),p.setWmtsLayerDef(f),p.addWmtsUrl(s);var d=Oskari.clazz.builder("Oskari.mapframework.domain.Style"),v;for(var m=0,g=f.styles.length;m<g;++m){v=f.styles[m];var y=d();y.setName(v.identifier),y.setTitle(v.identifier),p.addStyle(y);if(v.isDefault){p.selectStyle(v.identifier);break}}i.addLayer(p,!1)}}}),define("bundles/framework/bundle/mapwmts/service/WmtsLayerService",function(){}),Oskari.clazz.define("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder",function(){},{parseLayerData:function(e,t,n){e.setWmtsName(t.wmsName);if(t.wmsUrl){var r=t.wmsUrl.split(",");for(var i=0;i<r.length;i++)e.addWmtsUrl(r[i])}var s=Oskari.clazz.builder("Oskari.mapframework.domain.Style"),o;for(var i=0,u=t.styles.length;i<u;++i){o=t.styles[i];var a=s();a.setName(o.identifier),a.setTitle(o.identifier),e.addStyle(a);if(o.isDefault){e.selectStyle(o.identifier);break}}e.setFeatureInfoEnabled(!0),t.tileMatrixSetData&&(e.setWmtsMatrixSet(t.tileMatrixSetData),e.setWmtsLayerDef(t.tileLayerData))}}),define("bundles/framework/bundle/mapwmts/service/WmtsLayerModelBuilder",function(){}),Oskari.clazz.define("Oskari.openlayers.Patch.WMTSCapabilities_v1_0_0",function(){},{getPatch:function(){return this.patch?this.patch:this.buildPatch()},buildPatch:function(){return this.patch=OpenLayers.Class(OpenLayers.Format.OWSCommon.v1_1_0,{version:"1.0.0",namespaces:{ows:"http://www.opengis.net/ows/1.1",wmts:"http://www.opengis.net/wmts/1.0",xlink:"http://www.w3.org/1999/xlink"},yx:null,defaultPrefix:"wmts",initialize:function(e){OpenLayers.Format.XML.prototype.initialize.apply(this,[e]),this.options=e;var t=OpenLayers.Util.extend({},OpenLayers.Format.WMTSCapabilities.prototype.yx);this.yx=OpenLayers.Util.extend(t,this.yx)},read:function(e){typeof e=="string"&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e])),e&&e.nodeType==9&&(e=e.documentElement);var t={};return this.readNode(e,t),t.version=this.version,t},props:{wmts:{TileMatrixLimits:{MinTileRow:["minTileRow",parseInt],MaxTileRow:["maxTileRow",parseInt],MinTileCol:["minTileCol",parseInt],MaxTileCol:["maxTileCol",parseInt],TileMatrix:["tileMatrix",null]}}},readers:{wmts:{Capabilities:function(e,t){this.readChildNodes(e,t)},Contents:function(e,t){t.contents={},t.contents.layers=[],t.contents.tileMatrixSets={},this.readChildNodes(e,t.contents)},Layer:function(e,t){var n={styles:[],formats:[],tileMatrixSetLinks:[],tileMatrixSetLinksMap:{}};n.layers=[],this.readChildNodes(e,n),t.layers.push(n)},Style:function(e,t){var n={};n.isDefault=e.getAttribute("isDefault")==="true",this.readChildNodes(e,n),t.styles.push(n)},Format:function(e,t){t.formats.push(this.getChildValue(e))},TileMatrixSetLink:function(e,t){var n={};this.readChildNodes(e,n),t.tileMatrixSetLinks.push(n),t.tileMatrixSetLinksMap[n.tileMatrixSet]=n},TileMatrixSet:function(e,t){if(t.layers){var n={matrixIds:[]};this.readChildNodes(e,n),t.tileMatrixSets[n.identifier]=n}else t.tileMatrixSet=this.getChildValue(e)},TileMatrix:function(e,t){var n={supportedCRS:t.supportedCRS};this.readChildNodes(e,n),t.matrixIds.push(n)},ScaleDenominator:function(e,t){t.scaleDenominator=parseFloat(this.getChildValue(e))},TopLeftCorner:function(e,t){var n=this.getChildValue(e),r=n.split(" "),i;if(t.supportedCRS){var s=t.supportedCRS.replace(/urn:ogc:def:crs:(\w+):.+:(\w+)$/,"urn:ogc:def:crs:$1::$2");i=!!this.yx[s]}i?t.topLeftCorner=new OpenLayers.LonLat(r[1],r[0]):t.topLeftCorner=new OpenLayers.LonLat(r[0],r[1])},TileWidth:function(e,t){t.tileWidth=parseInt(this.getChildValue(e))},TileHeight:function(e,t){t.tileHeight=parseInt(this.getChildValue(e))},MatrixWidth:function(e,t){t.matrixWidth=parseInt(this.getChildValue(e))},MatrixHeight:function(e,t){t.matrixHeight=parseInt(this.getChildValue(e))},ResourceURL:function(e,t){t.resourceUrl=t.resourceUrl||{},t.resourceUrl[e.getAttribute("resourceType")]={format:e.getAttribute("format"),template:e.getAttribute("template")}},WSDL:function(e,t){t.wsdl={},t.wsdl.href=e.getAttribute("xlink:href")},ServiceMetadataURL:function(e,t){t.serviceMetadataUrl={},t.serviceMetadataUrl.href=e.getAttribute("xlink:href")},TileMatrixSetLimits:function(e,t){var n={tileMatrixLimits:[]};t.tileMatrixSetLimits=n,this.readChildNodes(e,n);var r={};for(var i=0;i<n.tileMatrixLimits.length;i++){var s=n.tileMatrixLimits[i];r[s.tileMatrix]=s}t.tileMatrixSetLimitsMap=r},TileMatrixLimits:function(e,t){var n=this.getElementsByTagNameNS(e,this.namespaces.wmts,"*"),r=this.props.wmts.TileMatrixLimits,i={};for(var s=0;s<n.length;s++){var o=n[s],u=this.getChildValue(o),a=o.localName||o.nodeName.split(":").pop(),f=r[a][0],l=r[a][1];i[f]=l?l(u):u}t.tileMatrixLimits.push(i)}},ows:OpenLayers.Util.applyDefaults({HTTP:function(e,t){t.http={},this.readChildNodes(e,t.http)},Get:function(e,t){var n=this.getAttributeNS(e,this.namespaces.xlink,"href");t.get||(t.get=n),t.getArray||(t.getArray=[]),t.getArray.push(n)}},OpenLayers.Format.OWSCommon.v1_1_0.prototype.readers.ows)},CLASS_NAME:"OpenLayers.Format.WMTSCapabilities.v1_0_0"}),this.patch}},{protocol:["Oskari.openlayers.Patch"]}),define("bundles/framework/bundle/mapwmts/format/WMTS_1_0_0_capabilities",function(){}),Oskari.clazz.define("Oskari.openlayers.Patch.layer.WMTS",function(){},{getPatch:function(){return this.patch?this.patch:this.buildPatch()},buildPatch:function(){return this.patch=OpenLayers.Class(OpenLayers.Layer.Grid,{isBaseLayer:!0,version:"1.0.0",requestEncoding:"KVP",url:null,layer:null,layerDef:null,matrixSet:null,style:null,format:"image/jpeg",tileOrigin:null,tileFullExtent:null,formatSuffix:null,matrixIds:null,dimensions:null,params:null,zoomOffset:0,formatSuffixMap:{"image/png":"png","image/png8":"png","image/png24":"png","image/png32":"png",png:"png","image/jpeg":"jpg","image/jpg":"jpg",jpeg:"jpg",jpg:"jpg"},matrix:null,initialize:function(e){var t={url:!0,layer:!0,style:!0,matrixSet:!0};for(var n in t)if(!(n in e))throw new Error("Missing property '"+n+"' in layer configuration.");e.params=OpenLayers.Util.upperCaseObject(e.params);var r=[e.name,e.url,e.params,e];OpenLayers.Layer.Grid.prototype.initialize.apply(this,r),this.formatSuffix||(this.formatSuffix=this.formatSuffixMap[this.format]||this.format.split("/").pop());if(this.matrixIds){var i=this.matrixIds.length;if(i&&typeof this.matrixIds[0]=="string"){var s=this.matrixIds;this.matrixIds=new Array(i);for(var o=0;o<i;++o)this.matrixIds[o]={identifier:s[o]}}}},setMap:function(){OpenLayers.Layer.Grid.prototype.setMap.apply(this,arguments),this.updateMatrixProperties()},updateMatrixProperties:function(){this.matrix=this.getMatrix(),this.matrix&&(this.matrix.topLeftCorner&&(this.tileOrigin=this.matrix.topLeftCorner),this.matrix.tileWidth&&this.matrix.tileHeight&&(this.tileSize=new OpenLayers.Size(this.matrix.tileWidth,this.matrix.tileHeight)),this.tileOrigin||(this.tileOrigin=new OpenLayers.LonLat(this.maxExtent.left,this.maxExtent.top)),this.tileFullExtent||(this.tileFullExtent=this.maxExtent))},moveTo:function(e,t,n){return(t||!this.matrix)&&this.updateMatrixProperties(),OpenLayers.Layer.Grid.prototype.moveTo.apply(this,arguments)},clone:function(e){return e==null&&(e=new OpenLayers.Layer.WMTS(this.options)),e=OpenLayers.Layer.Grid.prototype.clone.apply(this,[e]),e},getMatrix:function(){var e;if(!this.matrixIds||this.matrixIds.length===0)e={identifier:this.map.getZoom()+this.zoomOffset};else if("scaleDenominator"in this.matrixIds[0]){var t=OpenLayers.METERS_PER_INCH*OpenLayers.INCHES_PER_UNIT[this.units]*this.map.getResolution()/28e-5,n=Number.POSITIVE_INFINITY,r;for(var i=0,s=this.matrixIds.length;i<s;++i)r=Math.abs(1-this.matrixIds[i].scaleDenominator/t),r<n&&(n=r,e=this.matrixIds[i])}else e=this.matrixIds[this.map.getZoom()+this.zoomOffset];return e},getTileInfo:function(e){var t=this.map.getResolution(),n=(e.lon-this.tileOrigin.lon)/(t*this.tileSize.w),r=(this.tileOrigin.lat-e.lat)/(t*this.tileSize.h),i=Math.floor(n),s=Math.floor(r);return{col:i,row:s,i:Math.floor((n-i)*this.tileSize.w),j:Math.floor((r-s)*this.tileSize.h)}},getURL:function(e){e=this.adjustBounds(e);var t="";if(!!this.tileFullExtent&&!this.tileFullExtent.intersectsBounds(e))return t;var n=e.getCenterLonLat(),r=this.getTileInfo(n),i=this.matrix.identifier;if(this.layerDef&&this.layerDef.tileMatrixSetLinksMap){var s=this.layerDef.tileMatrixSetLinksMap[this.matrixSet],o=s?s.tileMatrixSetLimitsMap[this.matrix.identifier]:null,u=o?r.row>=o.minTileRow&&r.row<=o.maxTileRow:!1,a=o?r.col>=o.minTileCol&&r.col<=o.maxTileCol:!1;if(!u||!a)return OpenLayers.Util.getImagesLocation()+"blank.gif"}if(this.requestEncoding.toUpperCase()==="REST"){var f=this.version+"/"+this.layer+"/"+this.style+"/";if(this.dimensions)for(var l=0;l<this.dimensions.length;l++)this.params[this.dimensions[l]]&&(f=f+this.params[this.dimensions[l]]+"/");f=f+this.matrixSet+"/"+this.matrix.identifier+"/"+r.row+"/"+r.col+"."+this.formatSuffix,OpenLayers.Util.isArray(this.url)?t=this.selectUrl(f,this.url):t=this.url,t.match(/\/$/)||(t+="/"),t+=f}else if(this.requestEncoding.toUpperCase()==="KVP"){var c={SERVICE:"WMTS",REQUEST:"GetTile",VERSION:this.version,LAYER:this.layer,STYLE:this.style,TILEMATRIXSET:this.matrixSet,TILEMATRIX:this.matrix.identifier,TILEROW:r.row,TILECOL:r.col,FORMAT:this.format};t=OpenLayers.Layer.Grid.prototype.getFullRequestString.apply(this,[c])}return t},mergeNewParams:function(e){if(this.requestEncoding.toUpperCase()==="KVP")return OpenLayers.Layer.Grid.prototype.mergeNewParams.apply(this,[OpenLayers.Util.upperCaseObject(e)])},CLASS_NAME:"OpenLayers.Layer.WMTS"}),this.patch}},{protocol:["Oskari.openlayers.Patch"]}),define("bundles/framework/bundle/mapwmts/layer/WMTS",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.MapWmtsBundleInstance",function(e){this.name="MapWmts",this.mediator=null,this.sandbox=null,this.service=null,this.ui=null},{start:function(){if(this.mediator.getState()=="started")return;var e=this,t=e.conf,n=(t?t.sandbox:null)||"sandbox",r=Oskari.getSandbox(n);this.sandbox=r;var i=r.getService("Oskari.mapframework.service.MapLayerService");i.registerLayerModel("wmtslayer","Oskari.mapframework.wmts.domain.WmtsLayer");var s=Oskari.clazz.create("Oskari.mapframework.wmts.service.WmtsLayerModelBuilder");i.registerLayerModelBuilder("wmtslayer",s);var o=Oskari.clazz.create("Oskari.mapframework.wmts.service.WMTSLayerService",i);return this.service=o,this.mediator.setState("started"),this},update:function(e,t,n,r){e.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+r)},stop:function(){return this.mediator.setState("stopped"),this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.MapWmtsBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]}),define("bundles/framework/bundle/mapwmts/instance",function(){}),define("bundles/framework/bundle/mapwmts/module",["oskari","jquery","./plugin/wmtslayer/WmtsLayerPlugin","./domain/WmtsLayer","./service/WmtsLayerService","./service/WmtsLayerModelBuilder","./format/WMTS_1_0_0_capabilities","./layer/WMTS","./instance"],function(e,t){return e.bundleCls("mapwmts").category({create:function(){return e.clazz.create("Oskari.mapframework.bundle.MapWmtsBundleInstance")},update:function(e,t,n,r){e.alert("RECEIVED update notification "+r)}})});