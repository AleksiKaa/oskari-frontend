/* This is a packed Oskari bundle (bundle script version Wed Feb 15 2012 20:10:12 GMT+0200 (Suomen normaaliaika)) */ 
Oskari.clazz.define("Oskari.mapframework.bundle.GridCalcBundleUI",function(b,a){this.libs=b;this.form=null;this.ui=null;this.store=null;this.form=null;this.grid=null;this.bundle=a;this.items={};this.gridmath=null},{clear:function(){this.store=null;this.form=null;this.libs=null;this.ui=null;this.grid=null},setLibs:function(a){this.libs=a},get:function(){return this.pnl},setStore:function(a){this.store=a},getStore:function(){return this.store},getGrid:function(){return this.grid},showArticle:function(a){this.bundle.showArticle(a)},showTile:function(a){this.items.lbl.setValue(a.title||"")},showTileDetails:function(b){var a=this.getStore()},create:function(){var a=this.libs.ext;var a=this.libs.ext;var e=this;var c=a.create("Ext.grid.Panel",{store:e.getStore(),width:400,height:200,title:"gridcalc",columns:[{xtype:"actioncolumn",width:50,items:[{icon:"../resource/silk-icons/control_play.png",tooltip:"Show",handler:function(h,j,g){var i=e.getStore().getAt(j)}}]},{text:"Left",flex:1,dataIndex:"left"},{text:"Bottom",flex:1,dataIndex:"bottom"},{text:"Right",flex:1,dataIndex:"right"},{text:"Top",flex:1,dataIndex:"top"}]});this.grid=c;var f=a.create("Ext.form.field.Text",{name:"name",fieldLabel:"Name",allowBlank:false});this.items.lbl=f;var d=a.create("Ext.form.Panel",{items:[f,c]});this.form=d;var b=a.create("Ext.Panel",{bodyStyle:"padding:5px 5px 0",height:384,layout:"fit",defaults:{bodyPadding:4},items:[d]});this.pnl=b;return b}});Oskari.clazz.define("Oskari.mapframework.bundle.GridCalcBundleInstance",function(a){this.name="gridcalc";this.mediator=null;this.sandbox=null;this.layerId=null;this.layer=null;this.ui=null;this.features=null},{getStore:function(){return this.store},clear:function(){this.store.clearData();this.store.destroyStore();this.store=null},start:function(){var b=this;if(this.mediator.getState()=="started"){return}this.libs={ext:Oskari.$("Ext")};this.facade=Oskari.$("UI.facade");this.createProjs();this.createGridMath();this.createModels();this.createStores();var a=this.libs.ext;var c=this.facade.appendExtensionModule(this,this.name,this.eventHandlers,this,"E",{fi:{title:" gridcalc"},sv:{title:"?"},en:{title:" gridcalc"}});this.def=c;this.layerId="____gridcalc___"+this.mediator.instanceid;this.addVectorLayer();this.mediator.setState("started");return this},createGridMath:function(){var a=Oskari.clazz.create("Oskari.mapframework.gridcalc.TileQueue");var b=Oskari.clazz.create("Oskari.mapframework.gridcalc.QueuedTilesStrategy",{tileQueue:a});this.tileQueue=a;this.tileStrategy=b},startWorker:function(){var c=this;var b=this.libs.ext;var a={run:this.func,interval:3200};this.task=a;b.TaskManager.start(a)},stopWorker:function(){var b=this;var a=this.libs.ext;a.TaskManager.stop(b.task)},createProjs:function(){var a=this;a.projs={"EPSG:3067":new OpenLayers.Projection("EPSG:3067")}},createModels:function(){var a=this.libs.ext;var b=this;if(!a.ClassManager.get("GridTile")){a.define("GridTile",{extend:"Ext.data.Model",fields:["left","bottom","right","top"]})}},createStores:function(){var b=this.libs.ext;var c=this;var a=b.create("Ext.data.Store",{model:"GridTile",autoLoad:false});this.store=a},init:function(a){this.sandbox=a;var b=Oskari.clazz.create("Oskari.mapframework.bundle.GridCalcBundleUI",this.libs,this);this.ui=b;b.setLibs(this.libs);b.setStore(this.getStore());b.create();return b.get()},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){var a=this.libs.ext;this.removeVectorLayer();this.facade.removeExtensionModule(this,this.name,this.eventHandlers,this,this.def);this.def=null;this.sandbox.printDebug("Clearing STORE etc");this.ui.clear();this.ui=null;this.clear();this.mediator.setState("stopped");return this},setNE:function(b,a){this.n=b;this.e=a},onEvent:function(a){return this.eventHandlers[a.getName()].apply(this,[a])},defaults:{minScale:12000000,maxScale:1},getFeatureInfo:function(i,h,a){var d=this;if(!d.features){return}var g=new OpenLayers.Geometry.Point(i,h);var j=OpenLayers.Geometry.Polygon.createRegularPolygon(g,32,8);d.ui.showTile({});for(var e=0;e<d.features.length;
e++){var b=d.features[e];if(!b.geometry){continue}if(j.intersects(b.geometry)){if(a){d.ui.showTile(b.attributes)}else{d.ui.showTileDetails(b.attributes)}}}},eventHandlers:{AfterMapLayerRemoveEvent:function(d){var c=d.getMapLayer();if(c.getId()==this.layerId){if(this.sandbox.getObjectCreator(d)!=this.getName()){this.stop();var b=this.mediator.manager;var a=this.mediator.instanceid;b.destroyInstance(a)}}},AfterMapMoveEvent:function(c){var b=this;var a=this.sandbox;var f=c.getScale();if(!(f<this.defaults.minScale&&f>this.defaults.maxScale)){return}var g=c.getCenterY();var d=c.getCenterX();b.sandbox.printDebug("N:"+g+" E:"+d);b.setNE(g,d);b.processGrid()},FeaturesGetInfoEvent:function(d){var b=this.sandbox;var c=d.getMapLayer();var a=c.getId();if(a!=this.layerId){b.printDebug("FeaturesGetInfoEvent@gridcalc: "+this.layerId+" vs. queried "+a);return}b.printDebug("Handling FeaturesGetInfoEvent for "+this.layerId);var f=d.getLon();var e=d.getLat();this.getFeatureInfo(f,e)},MouseHoverEvent:function(c){var a=c.getLon();var b=c.getLat();this.getFeatureInfo(a,b,true)},AfterAddExternalMapLayerEvent:function(a){if(a.getMapLayerId()==this.layerId){this.layer=a.getLayer()}},AfterRemoveExternalMapLayerEvent:function(a){if(a.getMapLayerId()==this.layerId){this.layer=null}}},processGrid:function(){var k=this;var d=this.n;var j=this.e;var c=k.sandbox.getMap().getTileQueue();if(!c){return}var m=c.getQueue();var g=[];var q=m.length;for(var p=0;p<q;p++){var i=m[p];var o=i.getBounds();var a=new OpenLayers.Bounds(o.left,o.bottom,o.right,o.top);var l=a.toGeometry();var f={title:a.toString()};var h=new OpenLayers.Feature.Vector(l,f);g.push(h)}k.features=g;k.sandbox.printDebug("SENDING "+m.length+" FEATURES");var b=k.sandbox.getEventBuilder("FeaturesAvailableEvent")(this.layer,g,"application/nlsfi-x-openlayers-feature","EPSG:3067","replace");k.sandbox.notifyAll(b)},addVectorLayer:function(){var c=this.layerId,b=true,g=false;var h=this.tileStrategy;var f=[h];var a={name:"gridcalc",wmsName:"1",type:"vectorlayer",styles:{title:"gridcalc",legend:"",name:"1"},descriptionLink:"http://en.gridcalc.org/",legendImage:"",info:"",isQueryable:true,formats:{value:"text/html"},id:c,minScale:this.defaults.minScale,maxScale:this.defaults.maxScale,style:"",dataUrl:"",wmsUrl:"x",opacity:20,checked:"false",styledLayerDescriptor:'<StyledLayerDescriptor version="1.0.0" xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"     xmlns="http://www.opengis.net/sld"     xmlns:ogc="http://www.opengis.net/ogc"     xmlns:xlink="http://www.w3.org/1999/xlink"     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">   <NamedLayer>     <Name>Simple point with stroke</Name>    <UserStyle><Title>GeoServer SLD Cook Book: Simple point with stroke</Title>     <FeatureTypeStyle><Rule><PolygonSymbolizer><Fill><CssParameter name="fill">#ffffff</CssParameter></Fill><Stroke><CssParameter name="stroke">#ff0000</CssParameter><CssParameter name="stroke-width">5</CssParameter></Stroke></PolygonSymbolizer></Rule></FeatureTypeStyle></UserStyle></NamedLayer></StyledLayerDescriptor>',strategies:f};var d=this.sandbox.getRequestBuilder("AddExternalMapLayerRequest")(c,a);this.sandbox.request(this.getName(),d);var e=this.sandbox.getRequestBuilder("AddMapLayerRequest")(c,b);this.sandbox.request(this.getName(),e)},removeVectorLayer:function(){var a=this.layerId;var b=this.sandbox.getRequestBuilder("RemoveMapLayerRequest")(a);this.sandbox.request(this.getName(),b);var c=this.sandbox.getRequestBuilder("RemoveExternalMapLayerRequest")(a);this.sandbox.request(this.getName(),c)},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.GridCalcBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.module.Module","Oskari.mapframework.bundle.extension.Extension","Oskari.mapframework.bundle.extension.EventListener"]});