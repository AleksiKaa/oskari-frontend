Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.plugin.AnalysisLayerPlugin",function(e){this.mapModule=null,this.pluginName=null,this._sandbox=null,this._map=null,this._supportedFormats={},this.config=e,this.ajaxUrl=null,e&&e.ajaxUrl&&(this.ajaxUrl=e.ajaxUrl)},{__name:"AnalysisLayerPlugin",_layerType:"ANALYSIS",getName:function(){return this.pluginName},getMapModule:function(){return this.mapModule},setMapModule:function(e){this.mapModule=e,this.pluginName=e.getName()+this.__name},hasUI:function(){return!1},register:function(){this.getMapModule().setLayerPlugin("analysislayer",this)},unregister:function(){this.getMapModule().setLayerPlugin("analysislayer",null)},init:function(e){var t=(this.config?this.config.sandbox:null)||"sandbox",e=Oskari.getSandbox(t),n=e.getService("Oskari.mapframework.service.MapLayerService");if(n){n.registerLayerModel("analysislayer","Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayer");var r=Oskari.clazz.create("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayerModelBuilder",e);n.registerLayerModelBuilder("analysislayer",r)}},startPlugin:function(e){this._sandbox=e,this._map=this.getMapModule().getMap(),e.register(this);for(p in this.eventHandlers)e.registerForEventByName(this,p);this.ajaxUrl||(this.ajaxUrl=e.getAjaxUrl()+"action_route=GetAnalysis?")},stopPlugin:function(e){for(p in this.eventHandlers)e.unregisterFromEventByName(this,p);e.unregister(this),this._map=null,this._sandbox=null},start:function(e){},stop:function(e){},eventHandlers:{AfterMapLayerAddEvent:function(e){this._afterMapLayerAddEvent(e)},AfterMapLayerRemoveEvent:function(e){this._afterMapLayerRemoveEvent(e)},AfterChangeMapLayerOpacityEvent:function(e){this._afterChangeMapLayerOpacityEvent(e)},"MapAnalysis.AnalysisVisualizationChangeEvent":function(e){this._afterAnalysisVisualizationChangeEvent(e)}},onEvent:function(e){return this.eventHandlers[e.getName()].apply(this,[e])},preselectLayers:function(e){var t=this._sandbox;for(var n=0;n<e.length;n++){var r=e[n],i=r.getId();if(!r.isLayerOfType(this._layerType))continue;t.printDebug("preselecting "+i),this._addMapLayerToMap(r,!0,r.isBaseLayer())}},_afterMapLayerAddEvent:function(e){this._addMapLayerToMap(e.getMapLayer(),e.getKeepLayersOrder(),e.isBasemap())},_addMapLayerToMap:function(e,t,n){if(!e.isLayerOfType(this._layerType))return;var r=this,i=this._map.getLayersByName("Markers");if(i)for(var s=0;s<i.length;s++)i[s]&&this._map.removeLayer(i[s],!1);var o="layer_"+e.getId(),u=e.getWpsUrl()+"wpsLayerId="+e.getWpsLayerId(),a=this.getMapModule().calculateLayerScales(e.getMaxScale(),e.getMinScale()),f=new OpenLayers.Layer.WMS(o,u,{layers:e.getWpsName(),transparent:!0,format:"image/png"},{scales:a,isBaseLayer:!1,displayInLayerSwitcher:!1,visibility:!0,singleTile:!0,buffer:0});f.opacity=e.getOpacity()/100,this._map.addLayer(f),this._sandbox.printDebug("#!#! CREATED OPENLAYER.LAYER.WMS for AnalysisLayer "+e.getId()),t?this._map.setLayerIndex(f,this._map.layers.length):this._map.setLayerIndex(f,0);if(i)for(var s=0;s<i.length;s++)i[s]&&this._map.addLayer(i[s])},_afterMapLayerRemoveEvent:function(e){var t=e.getMapLayer();if(!t.isLayerOfType(this._layerType))return;this._removeMapLayerFromMap(t)},_removeMapLayerFromMap:function(e){if(!e.isLayerOfType(this._layerType))return;var t=this.getOLMapLayers(e);t[0].destroy()},getOLMapLayers:function(e){return e.isLayerOfType(this._layerType)?this._map.getLayersByName("layer_"+e.getId()):null},_afterChangeMapLayerOpacityEvent:function(e){},_afterAnalysisVisualizationChangeEvent:function(e){var t=e.getLayer(),n=e.getParams(),r=this.getOLMapLayers(t)}},{protocol:["Oskari.mapframework.module.Module","Oskari.mapframework.ui.module.common.mapmodule.Plugin"]}),define("bundles/framework/bundle/mapanalysis/plugin/AnalysisLayerPlugin",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayer",function(){this._layerType="ANALYSIS"},{setFields:function(e){this._fields=e},getFields:function(){return this._fields},setWpsUrl:function(e){this._wpsUrl=e},getWpsUrl:function(){return this._wpsUrl},setWpsName:function(e){this._wpsName=e},getWpsName:function(){return this._wpsName},setWpsLayerId:function(e){this._wpsLayerId=e},getWpsLayerId:function(){return this._wpsLayerId}},{extend:["Oskari.mapframework.domain.AbstractLayer"]}),define("bundles/framework/bundle/mapanalysis/domain/AnalysisLayer",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.domain.AnalysisLayerModelBuilder",function(e){this.localization=Oskari.getLocalization("MapAnalysis"),this.sandbox=e},{parseLayerData:function(e,t,n){var r=this;t.fields&&e.setFields(t.fields),t.name&&e.setName(t.name),t.wpsName&&e.setWpsName(t.wpsName),t.wpsUrl&&e.setWpsUrl(t.wpsUrl),t.wpsLayerId&&e.setWpsLayerId(t.wpsLayerId)}}),define("bundles/framework/bundle/mapanalysis/domain/AnalysisLayerModelBuilder",function(){}),Oskari.clazz.define("Oskari.mapframework.bundle.mapanalysis.event.AnalysisVisualizationChangeEvent",function(e,t){this._layer=e,this._params=t},{getName:function(){return"MapAnalysis.AnalysisVisualizationChangeEvent"},getLayer:function(){return this._layer},getParams:function(){return this._params}},{protocol:["Oskari.mapframework.event.Event"]}),define("bundles/framework/bundle/mapanalysis/event/AnalysisVisualizationChangeEvent",function(){}),define("bundles/framework/bundle/mapanalysis/module",["oskari","jquery","./plugin/AnalysisLayerPlugin","./domain/AnalysisLayer","./domain/AnalysisLayerModelBuilder","./event/AnalysisVisualizationChangeEvent"],function(e,t){return e.bundleCls("mapanalysis").category({create:function(){return null},update:function(e,t,n,r){e.alert("RECEIVED update notification "+r)}})});