<link rel="import"
      href="libs/polymer/polymer.html">

<link href="libs/promise-polyfill/promise-polyfill.html" rel="import">
<link href="libs/iron-ajax/iron-ajax.html" rel="import">
<link href="oskari-userindicator.html" rel="import">
<link href="oskari-spinner.html" rel="import">

<dom-module id="oskari-indicatorselector">

  <template>
    <iron-ajax
      auto
      url="{{ajaxUrl}}"
      params='{"action_route": "GetIndicatorsMetadata"}'
      handle-as="json"
      last-response="{{sources}}"
      debounce-duration="300"
      id="indicatorsAjax"
      on-response="hideSpinner"
      on-error="ajaxError"></iron-ajax>
    <template is="dom-if" if="{{user._loggedIn}}">
    <iron-ajax
      auto
      url="{{ajaxUrl}}"
      params='{"action_route": "GetUserIndicators"}'
      handle-as="json"
      last-response="{{userIndicators}}"
      debounce-duration="300"
      id="userIndicatorsAjax"
      on-error="ajaxError"></iron-ajax>
    </template>
    <oskari-spinner visible="[[showSpinner]]" spinner-id="indicatorsMetadataSpinner">
    </oskari-spinner>
    <div hidden$="{{hideIndicatorSelector(embedded, showUserIndicatorView)}}" id="indicatorSelectorDiv">
      <form class="statsgrid2_indicator_selector">
        <div>
          <label for="datasource-selector">{{locale.tab.grid.organization}}</label>
          <select id="datasource-selector" style="width: 300px;" value="{{datasourceId::change}}">
            <template is="dom-repeat" items="[[getDatasources(sources)]]">
              <option value="{{item.val}}">{{item.text}}</option>
            </template>
          </select>
          <button type="button" on-click="onAddUserIndicator">[[locale.addDataButton]]</button>
        </div>
        <label for="indicator-selector">{{locale.indicators}}</label>
        <select id="indicator-selector" style="width: 300px;" value="{{indicatorId::change}}">
          <template is="dom-repeat" items="[[getIndicators(sources,datasourceId)]]">
            <option value="{{item.val}}">{{item.text}}</option>
          </template>
        </select>
        <div class="icon-info" on-click="showIndicatorInfo" hidden$="[[!indicatorSelected]]"></div>
        <!-- The optional selectors will be populated here when the above have been selected. -->
        <div id="indicatorSelectors" hidden$="[[!indicatorSelected]]">
          <template is="dom-repeat" items="[[selectorItems]]" as="selector">
            <label for="{{selector.name}}">{{selectorOption.label}}</label>
            <select id="{{selector.name}}" style="width: 300px;" value="{{selector.value::change}}"
              on-change="onSelectorsChanged">
              <template is="dom-repeat" items="{{selector.values}}" as="selectorOption">
                <option value="{{selectorOption.val}}">{{selectorOption.text}}</option>
              </template>
            </select>
          </template>
        </div>
        <button type="button" on-click="onAddIndicatorToGrid" hidden$="[[!indicatorSelected]]"
          disabled$="[[!allSelectorsSelected]]">{{locale.addColumn}}</button>
      </form>
    </div>
    <oskari-statsgrid locale="[[locale]]" language="[[language]]" ajax-url="[[ajaxUrl]]"
      sources="{{sources}}" selected-indicators="{{selectedIndicators}}" selected-layer="{{selectedLayer}}"
      layer-info="{{layerInfo}}" region-info="{{regionInfo}}" user-indicators="[[userIndicators]]"
      selector-selected-indicator-key="{{selectorSelectedIndicatorKey}}" selected-indicator-key="{{selectedIndicatorKey}}"
      sandbox="{{sandbox}}" hidden$="[[hideGrid]]"
      id="statsgrid" embedded="[[embedded]]"></oskari-statsgrid>
    <div hidden$="[[!showUserIndicatorView]]" id="userindicatordiv">
      <oskari-userindicator ajax-url="[[ajaxUrl]]"
        locale="[[locale]]" language="[[language]]" user="[[user]]"
        sources="[[sources]]" selected-layer="{{selectedLayer}}"
        layer-info="[[layerInfo]]" region-info="[[regionInfo]]"
        show-user-indicator-view="{{showUserIndicatorView}}" sandbox="{{sandbox}}"></oskari-userindicator>
    </div>
    <content></content>
  </template>

  <script src="oskari-indicatorselector.js">
  </script>
</dom-module>
