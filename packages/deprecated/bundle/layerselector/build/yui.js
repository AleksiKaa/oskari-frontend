/* This is a packed Oskari bundle (bundle script version Thu May 31 2012 12:23:19 GMT+0300 (Suomen kes√§aika)) */ 
Oskari.clazz.define("Oskari.mapframework.ui.module.layerselector.AllLayersModule",function(){this.sandbox=null;var a=Oskari.$("startup");this.conf=a;this.stores={};this.items={};this.selected={};this.scale=null;this.refreshTools=null;this.refreshLayerNames=null},{__name:"AllLayersModule",getName:function(){return this.__name},refresh:function(){this.items.grid.getView().refresh()},init:function(a){this.sandbox=a;a.printDebug("[AllLayersModule] Initializing all layers module...");this.scale=a.getMap().getScale();for(var c in this.eventHandlers){a.registerForEventByName(this,c)}this.createModels();this.createStores();var b=this.createUI();this.updateCurrentState();return b},updateCurrentState:function(){var b=this.sandbox;var e=b.findAllSelectedMapLayers();for(var d=0;d<e.length;d++){var c=e[d];var a=c.getId();this.selected[a]=c;b.printDebug("[AllLayersModule] preselecting "+a)}},createModels:function(){if(!Ext.ClassManager.get("MapLayer")){var a=["id","type","name","inspire","orgName","dataUrl","minScale","maxScale","orderNumber"];Ext.define("MapLayer",{extend:"Ext.data.Model",fields:a})}},getLayersData:function(){var e=this;var b=e.sandbox.getService("Oskari.mapframework.service.MapLayerService");var f=b.getAllLayers();var a=new Array();for(var d=0;d<f.length;d++){var c=Ext.create("MapLayer",{id:f[d].getId(),name:f[d].getName(),inspire:f[d].getInspireName(),orgName:f[d].getOrganizationName(),dataUrl:f[d].getDataUrl(),minScale:f[d].getMinScale(),maxScale:f[d].getMaxScale(),orderNumber:f[d].getOrderNumber()});if(f[d].isBaseLayer()){c.set("type","base")}else{if(f[d].isLayerOfType("WMS")){if(f[d].isGroupLayer()){c.set("type","group")}else{c.set("type","wmslayer")}}else{if(f[d].isLayerOfType("WMTS")){c.set("type","wmtslayer")}else{if(f[d].isLayerOfType("WFS")){c.set("type","wfslayer")}else{if(f[d].isLayerOfType("VECTOR")){c.set("type","vector")}}}}}a.push(c)}return a},createStores:function(){var b=this.getLayersData();var a=Ext.create("Ext.data.Store",{model:"MapLayer",autoLoad:true,groupField:"inspire",data:[b]});this.regStore("allLayersStore",a)},regStore:function(b,a){this.stores[b]=a},getStore:function(a){return this.stores[a]},createUI:function(){var m=this;var e=m.sandbox.getLanguage();function p(r,s,t){return'<div id="layerName_'+t.get("id")+'">'+n(r,t)+"</div>"}function n(r,t){var s=t.get("minScale");var u=t.get("maxScale");if(m.scale>u&&m.scale<s){return r}else{return'<span style="color: #c0c0c0;">'+r+"</span>"}}function c(s,t,r){return'<div id="layerTools_'+r.get("id")+'">'+j(r)+"</div>"}Ext.QuickTips.init();function j(s){var v="/framework/bundle/layerselector/images/taso.png";var u="mapservice_maplayer_image_tooltip";if(s.get("type")=="wfslayer"){v="/framework/bundle/layerselector/images/database.png";u="selected_layers_module_wfs_icon_tooltip"}else{if(s.get("type")=="group"){v="/framework/bundle/layerselector/images/group.png";u="mapservice_basemap_image_tooltip"}else{if(s.get("type")=="base"){v="/framework/bundle/layerselector/images/pino.png";u="mapservice_basemap_image_tooltip"}}}var t='<img src="'+Oskari.$().startup.imageLocation+v+'" style="vertical-align: top;" data-qtip="'+m.sandbox.getText(u)+'"/> ';var r=s.get("id");if(isNaN(r)){r="'"+r+"'"}if(m.selected[s.get("id")]){t=t+'<a href="#" onclick="Oskari.$().sandbox.requestByName(\''+m.getName()+"', 'RemoveMapLayerRequest',["+r+']);return false;" data-qtip="'+m.sandbox.getText("mapservice_layer_delete_title")+'"><img src="'+Oskari.$().startup.imageLocation+'/framework/bundle/layerselector/images/poisto.png" height="15" /></a>'}else{if("base"==s.get("type")){t=t+'<a href="#" onclick="Oskari.$().sandbox.requestByName(\''+m.getName()+"', 'AddMapLayerRequest',["+r+',false]);return false;" data-qtip="'+m.sandbox.getText("leftpanel_add_layer")+'"><img src="'+Oskari.$().startup.imageLocation+'/framework/bundle/layerselector/images/lisays_vihrea.png" height="15" alt="add"/></a>'}else{t=t+'<a href="#" onclick="Oskari.$().sandbox.requestByName(\''+m.getName()+"', 'AddMapLayerRequest',["+r+',true]);return false;" data-qtip="'+m.sandbox.getText("leftpanel_add_layer")+'"><img src="'+Oskari.$().startup.imageLocation+'/framework/bundle/layerselector/images/lisays_vihrea.png" height="15" alt="add" /></a>'
}}var w=s.get("dataUrl");if(w){t=t+' <a href="#" onclick="Oskari.$().sandbox.requestByName(\''+m.getName()+"', 'ShowOverlayPopupRequest',['"+w+'\']);return false;" data-qtip="'+m.sandbox.getText("mapservice_layer_show_info_title")+'"><img src="'+Oskari.$().startup.imageLocation+'/framework/bundle/layerselector/images/kysymysmerkki.png" height="15"/></a>'}return t}function b(s){var t=m.getStore("allLayersStore").findBy(function(v){return v.get("id")==s});var r=m.getStore("allLayersStore").getAt(t);var u=Ext.get("layerTools_"+s);if(u){u.update(j(r))}}m.refreshTools=b;function i(){m.getStore("allLayersStore").each(function(s){var r=Ext.get("layerName_"+s.get("id"));if(r){var t=s.get("name");r.update(n(t,s))}})}m.refreshLayerNames=i;var l="Nimi";if(e=="sv"){l="Namn"}else{if(e=="en"){l="Name"}}var h=[{header:"Actions",width:64,renderer:c},{header:l,dataIndex:"name",flex:1,renderer:p}];var o=this.sandbox;var q=Ext.create("Ext.form.TextField",{height:25,emptyText:m.sandbox.getText("leftpanel_find_maplayers_value"),margin:0,padding:0,listeners:{focus:function(r){Oskari.$().sandbox.request(m.getName(),Oskari.$().sandbox.getRequestBuilder("DisableMapKeyboardMovementRequest")())},blur:function(r){Oskari.$().sandbox.request(m.getName(),Oskari.$().sandbox.getRequestBuilder("EnableMapKeyboardMovementRequest")())},change:{fn:k,scope:this,buffer:100}}});this.items.searchtf=q;var g=Ext.create("Ext.grid.feature.Grouping",{groupHeaderTpl:"{name} ({rows.length})",startCollapsed:true});var a=Ext.create("Ext.grid.Panel",{flex:1,margin:0,padding:0,hideHeaders:true,store:m.getStore("allLayersStore"),viewConfig:{stripeRows:true},features:[g],columns:h});a.getStore().sort([{property:"inspire",direction:"ASC"},{property:"orderNumber",direction:"ASC"}]);this.items.grid=a;var d=Ext.createWidget("tabpanel",{flex:1,activeTab:0,defaults:{bodyPadding:0},listeners:{tabchange:function(t,u,s,r){s.removeAll(false);a.getStore().clearGrouping();a.getStore().group(u.getId());a.getStore().sort([{property:u.getId(),transform:function(v){return v.toLowerCase()},direction:"ASC"},{property:"orderNumber",direction:"ASC"}]);u.add(a)}},items:[{title:m.sandbox.getText("leftpanel_thema_title"),id:"inspire",layout:"fit",items:a},{title:m.sandbox.getText("leftpanel_organisation_title"),id:"orgName",layout:"fit"}]});function k(){var s=q.getValue();var r=(s!="");g.startCollapsed=true;m.getStore("allLayersStore").clearFilter(r);if(r){g.startCollapsed=false;m.getStore("allLayersStore").filterBy(function(t,x){var w=t.get("name");var u=t.get("orgName");var v=new RegExp(s,"gi");if(v.test(w)||v.test(u)){return true}})}}var f=Ext.create("Ext.panel.Panel",{bodyPadding:0,margin:0,id:"AllLayersModule",padding:0,layout:{type:"vbox",padding:0,align:"stretch"},items:[q,d]});return f},start:function(a){a.printDebug("[AllLayersModule] Starting "+this.getName())},stop:function(a){},checkLayerScales:function(a){},afterMapLayerAddEvent:function(c){var a=c.getMapLayer();var b=this;b.selected[a.getId()]=a;this.refreshTools(a.getId())},afterMapLayerRemoveEvent:function(c){var a=c.getMapLayer();var b=this;b.selected[a.getId()]=undefined;this.refreshTools(a.getId())},afterMapMoveEvent:function(b){var a=b.getScale();if(a==this.scale||!a){return}this.scale=a;this.refreshLayerNames()},handleMapLayerChange:function(a){var h=this;if(a.getOperation()==="update"){var e=this.sandbox.getService("Oskari.mapframework.service.MapLayerService");var c=a.getLayerId();var f=e.findMapLayer(c);var b=f.getName();var i=h.getStore("allLayersStore");var d=i.getById(c);d.set("name",b)}else{var g=this.getLayersData();h.getStore("allLayersStore").loadData(g)}},eventHandlers:{AfterMapLayerAddEvent:function(a){this.afterMapLayerAddEvent(a)},AfterMapLayerRemoveEvent:function(a){this.afterMapLayerRemoveEvent(a)},AfterMapMoveEvent:function(a){this.afterMapMoveEvent(a)},MapLayerEvent:function(a){this.handleMapLayerChange(a)}},onEvent:function(b){var a=this.eventHandlers[b.getName()];if(!a){return}return a.apply(this,[b])}},{protocol:["Oskari.mapframework.module.Module"]});Oskari.clazz.define("Oskari.mapframework.bundle.DefaultLayerSelectorBundleInstance",function(a){this.name="layerselector";
this.mediator=null;this.sandbox=null;this.impl=null;this.ui=null},{createPanel:function(){var b=this;var a=Ext.create("Ext.Panel",{region:"center",layout:"fit",height:384,items:[]});return a},start:function(){if(this.mediator.getState()=="started"){return}var b=this;b.facade=Oskari.$("UI.facade");b.impl=Oskari.clazz.create("Oskari.mapframework.ui.module.layerselector.AllLayersModule");var a=this.createPanel();var c=b.facade.appendExtensionModule(b.impl,b.name,{},b,"E",{fi:{title:"Kaikki tasot"},sv:{title:"?"},en:{title:"Map Layers"}},a);b.def=c;a.add(c.initialisedComponent);b.impl.start(this.facade.getSandbox());b.mediator.setState("started");return this},update:function(d,a,c,e){d.alert("RECEIVED update notification @BUNDLE_INSTANCE: "+e)},stop:function(){this.impl.stop();this.facade.removeExtensionModule(this.impl,this.name,this.impl.eventHandlers,this,this.def);this.def=null;this.impl=null;this.mediator.setState("stopped");return this},getName:function(){return this.__name},__name:"Oskari.mapframework.bundle.DefaultLayerSelectorBundleInstance"},{protocol:["Oskari.bundle.BundleInstance","Oskari.mapframework.bundle.extension.Extension"]});